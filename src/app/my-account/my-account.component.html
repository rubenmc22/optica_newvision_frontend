<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-9">
            <div class="card">
                <!-- Pestañas de Navegación -->
                <ul class="nav nav-tabs nav-justified" id="myAccountTabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="edit-personal-info-tab" data-bs-toggle="tab"
                            href="#editPersonalInfo" role="tab" aria-controls="editPersonalInfo" aria-selected="true"
                            (click)="switchTab('personalInfo')">
                            <i class="fas fa-user-edit"></i> Editar Información Personal
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="edit-password-tab" data-bs-toggle="tab" href="#editPassword" role="tab"
                            aria-controls="editPassword" aria-selected="false" (click)="switchTab('password')">
                            <i class="fas fa-key"></i> Editar Contraseña
                        </a>
                    </li>
                </ul>

                <!-- Contenido de las Pestañas -->
                <div class="tab-content mt-4" id="myAccountTabContent">
                    <!-- Tab: Editar Información Personal -->
                    <div class="tab-pane fade show active" id="editPersonalInfo" role="tabpanel"
                        aria-labelledby="edit-personal-info-tab">
                        <!-- Widget de Imagen -->
                        <div class="text-center mb-4">
                            <div class="avatar-widget">
                                <!-- Imagen del Avatar -->
                                <img [src]="avatarUrl || 'assets/default-photo.png'" alt="Avatar del Usuario"
                                    class="avatar-img">

                                <!-- Overlay para Cargar Imagen (siempre presente, pero oculto cuando hay imagen) -->
                                <div class="avatar-overlay" [ngClass]="{'show-on-hover': avatarUrl}">
                                    <label for="avatarUpload">
                                        <i class="fas fa-camera"></i>
                                    </label>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;"
                                        (change)="onFileSelected($event)">
                                </div>
                            </div>
                        </div><br>

                        <!-- Formulario de Información Personal -->
                        <form #personalInfoForm="ngForm">
                            <div class="form-row">
                                <!-- Campo: Nombre Completo -->
                                <div class="form-group col-md-6">
                                    <label for="nombreCompleto">Nombre Completo</label>
                                    <input type="text" id="nombreCompleto" class="form-control"
                                        [(ngModel)]="user.nombreCompleto" name="nombreCompleto"
                                        pattern="^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$" #nombreCompleto="ngModel" required
                                        (input)="detectChanges()" />
                                    <small *ngIf="nombreCompleto.invalid && nombreCompleto.touched" class="text-danger">
                                        Solo se permiten letras y espacios.
                                    </small>
                                </div>

                                <!-- Campo: Correo Electrónico -->
                                <div class="form-group col-md-6">
                                    <label for="correo">Correo Electrónico</label>
                                    <input type="email" id="correo" class="form-control" [(ngModel)]="user.correo"
                                        name="correo" email #correo="ngModel" required (input)="detectChanges()" />
                                    <small *ngIf="correo.invalid && correo.touched" class="text-danger">
                                        Introduzca un correo electrónico válido.
                                    </small>
                                </div>
                            </div>

                            <div class="form-row">
                                <!-- Campo: Fecha de Nacimiento -->
                                <div class="form-group col-md-6">
                                    <label for="fechaNacimiento">Fecha de Nacimiento</label>
                                    <input type="date" id="fechaNacimiento" class="form-control"
                                        [(ngModel)]="user.fechaNacimiento" name="fechaNacimiento" required
                                        (input)="detectChanges()" />
                                </div>

                                <!-- Campo: Teléfono -->
                                <div class="form-group col-md-6">
                                    <label for="telefono">Teléfono</label>
                                    <input type="tel" id="telefono" class="form-control" [(ngModel)]="user.telefono"
                                        name="telefono" pattern="^[0-9]{12}$" #telefono="ngModel" required
                                        (input)="detectChanges()" />
                                    <small *ngIf="telefono.invalid && telefono.touched" class="text-danger">
                                        Introduzca un número de teléfono válido (12 dígitos).
                                    </small>
                                </div>
                            </div>

                            <div class="text-right">
                                <button type="button" class="btn btn-success"
                                    [disabled]="!isFormEdited || !isPersonalInfoValid()"
                                    (click)="openModal('personalInfoModal')">
                                    Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>


                    <!-- Tab: Editar Contraseña -->
                    <div class="tab-pane fade" id="editPassword" role="tabpanel" aria-labelledby="edit-password-tab">
                        <form #passwordForm="ngForm">
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="contrasena">Nueva Contraseña</label>
                                    <input type="password" id="contrasena" class="form-control"
                                        [(ngModel)]="user.contrasena" name="contrasena" (input)="validatePasswords()"
                                        minlength="8" required />
                                    <small *ngIf="!passwordValid && user.contrasena" class="text-danger">
                                        La contraseña debe tener al menos 8 caracteres.
                                    </small>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="confirmarContrasena">Confirmar Contraseña</label>
                                    <input type="password" id="confirmarContrasena" class="form-control"
                                        [(ngModel)]="confirmarContrasena" name="confirmarContrasena"
                                        (input)="validatePasswords()" required />
                                    <small *ngIf="!passwordsMatch && confirmarContrasena" class="text-danger">
                                        Las contraseñas no coinciden.
                                    </small>
                                </div>
                            </div>

                            <div class="text-right">
                                <button type="button" class="btn btn-success" [disabled]="!formValid"
                                    (click)="initiatePasswordChange()">
                                    Cambiar Contraseña
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmación de Información Personal -->
    <div class="modal fade" id="personalInfoModal" tabindex="-1" aria-labelledby="personalInfoModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="personalInfoModalLabel">
                        Confirmar Información Personal
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿La información ingresada es correcta? Presione confirmar para proceder.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" (click)="savePersonalInfo()" data-bs-dismiss="modal">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Confirmación de OTP -->
    <div class="modal fade" id="otpModal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="otpModalLabel">
                        Código OTP Requerido
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Hemos enviado un código OTP de 6 dígitos al correo electrónico registrado.
                    Por favor, ingréselo a continuación:
                    <div class="form-group mt-3">
                        <input type="text" maxlength="6" class="form-control text-center" [(ngModel)]="otpCode"
                            name="otpCode" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" (click)="verifyOtp()" data-bs-dismiss="modal">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>