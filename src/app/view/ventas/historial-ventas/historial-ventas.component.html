<div class="card contenedor-historial-venta" style="margin-bottom: 0rem;">
  <!-- Header modernizado del m√≥dulo -->
  <div class="card-header-moderno">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-clock-history"></i>
      </div>
      <div class="header-text">
        <h4 class="header-title">Historial de Ventas</h4>
        <div class="header-subtitle">Consulta y gestiona el historial completo de transacciones</div>
      </div>
    </div>
    <div class="header-actions">
      <!-- Bot√≥n para abrir resumen financiero -->
      <button class="btn btn-resumen-financiero" (click)="abrirModalResumenFinanciero()">
        <i class="bi bi-graph-up me-2"></i>
        <span>Resumen Financiero</span>
      </button>


      <button class="btn-icon-refresh" (click)="recargarEstadisticas()" [disabled]="estadisticasCargando"
        [class.loading]="estadisticasCargando" title="Actualizar estad√≠sticas">
        <div class="icon-container">
          <svg class="refresh-icon" viewBox="0 0 24 24">
            <path fill="currentColor"
              d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" />
          </svg>
          <div class="loading-spinner" *ngIf="estadisticasCargando"></div>
        </div>
        <div class="status-indicator"></div>
      </button>
    </div>
  </div>

  <div class="card-body">
    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
      <!-- Total Ventas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon total me-3">
                <i class="bi bi-cart-check"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number">{{ getTotalVentas() }}</div>
                <div class="summary-label">Total Ventas</div>
                <div class="summary-subtext">Per√≠odo actual</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Completadas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon completed me-3">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-success">{{ getVentasCompletadas() }}</div>
                <div class="summary-label">Completadas</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Pendientes -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon pending me-3">
                <i class="bi bi-clock-history"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-warning">{{ getVentasPendientes() }}</div>
                <div class="summary-label">Pendientes</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Canceladas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon cancelled me-3">
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-danger">{{ getVentasCanceladas() }}</div>
                <div class="summary-label">Canceladas</div>
                <div class="summary-subtext">Ventas anuladas</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros y b√∫squedas - Dise√±o Mejorado -->
    <div class="card mb-4 border-0 shadow-sm" style="margin-top: -30px;">
      <div class="card-header bg-light py-3">
        <div class="d-flex align-items-center">
          <i class="bi bi-funnel me-2 text-primary"></i>
          <h6 class="mb-0 fw-semibold">Filtros de B√∫squeda</h6>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 filtros-responsive">

          <!-- Fila 1: Buscador, Estado, Forma de Pago -->
          <div class="col-12 col-md-6">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-search me-1"></i>Buscador General
              </label>
              <div class="input-group-moderno">
                <input type="text" class="form-control-moderno" placeholder="C√©dula, nombre, N¬∞ control..."
                  [(ngModel)]="filtros.busquedaGeneral" (ngModelChange)="onBusquedaInput($event)"
                  (blur)="onBusquedaBlur()" (keydown.enter)="onBusquedaEnter($event)">
                <span class="input-icon">
                  <i class="bi bi-search"></i>
                </span>
              </div>
              <small class="form-text text-muted mt-1">
                üí° Presiona Enter o haz clic fuera del campo para buscar
              </small>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-clipboard-check me-1"></i>Estado de Venta
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.estado" (change)="onFiltroChange()">
                <option value="">Todos los estados</option>
                <option value="completada">Completada</option>
                <option value="pendiente">Pendiente por pago</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-credit-card me-1"></i>Forma de Pago
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.formaPago" (change)="onFiltroChange()">
                <option value="">Todas las formas</option>
                <option value="contado">Contado</option>
                <option value="contado-pendiente">Contado - Pendiente</option>
                <option value="abono">Abono</option>
                <option value="cashea">Cashea</option>
                <option value="credito">Cr√©dito</option>
              </select>
            </div>
          </div>

          <!-- Fila 2: Asesor, Especialista, Rango de Fechas -->
          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-person-badge me-1"></i>Asesor Comercial
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.asesor" (change)="onFiltroChange()">
                <option value="">Todos los asesores ({{ asesores.length }})</option>
                <option *ngFor="let asesor of asesores" [value]="asesor.id">
                  {{ asesor.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-heart-pulse me-1"></i>Especialista M√©dico
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.especialista" (change)="onFiltroChange()">
                <option value="">Todos los especialistas ({{ especialistas.length }})</option>
                <option *ngFor="let esp of especialistas" [value]="esp.id">
                  {{ esp.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-calendar-range me-1"></i>Rango de Fechas
              </label>
              <div class="date-selector-moderno">
                <button class="btn-datepicker-moderno" type="button" (click)="toggleDatepicker()">
                  <i class="bi bi-calendar3 me-2"></i>
                  <span class="fecha-display">{{ getFechaDisplay() }}</span>
                  <i class="bi bi-chevron-down ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Fila 3: Acciones -->
          <div class="col-md-3">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn-limpiar-filtros" type="button" (click)="limpiarFiltros()">
                <i class="bi bi-arrow-counterclockwise me-2"></i>
                Limpiar Filtros
              </button>
            </div>
          </div>

        </div>

        <!-- Filtros Activos -->
        <div class="filtros-activos mt-3" *ngIf="hayFiltrosActivos()">
          <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="filtros-label text-muted small">
              <i class="bi bi-funnel me-1"></i>Filtros aplicados:
            </span>

            <span class="filtro-tag" *ngIf="filtros.busquedaGeneral">
              <i class="bi bi-search me-1"></i>"{{filtros.busquedaGeneral}}"
              <i class="bi bi-x ms-1" (click)="filtros.busquedaGeneral = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.estado">
              <i class="bi bi-clipboard-check me-1"></i>{{ getEstadoDisplay(filtros.estado) }}
              <i class="bi bi-x ms-1" (click)="filtros.estado = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.formaPago">
              <i class="bi bi-credit-card me-1"></i>{{ getFormaPagoDisplay(filtros.formaPago) }}
              <i class="bi bi-x ms-1" (click)="filtros.formaPago = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.asesor">
              <i class="bi bi-person-badge me-1"></i>{{ getAsesorNombre(filtros.asesor) }}
              <i class="bi bi-x ms-1" (click)="filtros.asesor = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.especialista">
              <i class="bi bi-heart-pulse me-1"></i>{{ getEspecialistaNombre(filtros.especialista) }}
              <i class="bi bi-x ms-1" (click)="filtros.especialista = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.fechaDesde || filtros.fechaHasta">
              <i class="bi bi-calendar3 me-1"></i>{{ getFechaDisplay() }}
              <i class="bi bi-x ms-1" (click)="limpiarFechas(); onFiltroChange()"></i>
            </span>
          </div>
        </div>
      </div>
    </div>


    <!-- Modal de Datepicker Flotante -->
    <div class="modal fade show" [class.d-block]="showDatepicker" tabindex="-1" *ngIf="showDatepicker">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Seleccionar rango de fechas</h5>
            <button type="button" class="btn-close btn-close-white" (click)="closeDatepicker()"
              style="color: white !important;"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <!-- Selector de fecha √∫nica -->
              <div class="col-12">
                <label class="form-label fw-semibold">üìå Fecha √∫nica</label>
                <input type="date" class="form-control" [(ngModel)]="fechaUnica" [max]="maxDate" [min]="minDate"
                  (change)="onFechaUnicaChange()">
                <div class="form-text">Selecciona una fecha espec√≠fica</div>
              </div>

              <div class="col-12 text-center d-flex align-items-center justify-content-center">
                <hr class="my-3">
                <span class="text-muted">O selecciona un rango</span>
              </div>

              <!-- Rango de fechas -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Desde</label>
                <input type="date" class="form-control" [max]="filtros.fechaHasta || maxDate" [min]="minDate"
                  [(ngModel)]="filtros.fechaDesde" (change)="onRangoChange()">
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Hasta</label>
                <input type="date" class="form-control" [min]="filtros.fechaDesde || minDate" [max]="maxDate"
                  [(ngModel)]="filtros.fechaHasta" (change)="onRangoChange()">
              </div>

              <!-- Presets r√°pidos -->
              <div class="col-12">
                <label class="form-label fw-semibold">Rangos predefinidos</label>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'hoy'"
                    [class.btn-outline-secondary]="presetActivo !== 'hoy'" (click)="setRangoPreset('hoy')">
                    Hoy
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'ayer'"
                    [class.btn-outline-secondary]="presetActivo !== 'ayer'" (click)="setRangoPreset('ayer')">
                    Ayer
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana'"
                    [class.btn-outline-secondary]="presetActivo !== 'semana'" (click)="setRangoPreset('semana')">
                    Esta semana
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana_pasada'"
                    [class.btn-outline-secondary]="presetActivo !== 'semana_pasada'"
                    (click)="setRangoPreset('semana_pasada')">
                    Semana pasada
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes'"
                    [class.btn-outline-secondary]="presetActivo !== 'mes'" (click)="setRangoPreset('mes')">
                    Este mes
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes_pasado'"
                    [class.btn-outline-secondary]="presetActivo !== 'mes_pasado'"
                    (click)="setRangoPreset('mes_pasado')">
                    Mes pasado
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'trimestre'"
                    [class.btn-outline-secondary]="presetActivo !== 'trimestre'" (click)="setRangoPreset('trimestre')">
                    Este trimestre
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="limpiarFechas()">
              <i class="bi bi-x-circle me-1"></i> Limpiar
            </button>
            <button type="button" class="btn btn-primary" (click)="aplicarFechas()">
              <i class="bi bi-check-circle me-1"></i> Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay para cerrar al hacer click fuera -->
    <div class="modal-backdrop fade show" *ngIf="showDatepicker" (click)="closeDatepicker()"></div>

    <!-- Controles de ordenamiento -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <span class="text-muted">Ordenar por:</span>
        <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="ordenamiento.campo">
          <option value="fecha">Fecha</option>
          <option value="numeroControl">N¬∞ Control</option>
          <option value="montoTotal">Monto Total</option>
          <option value="paciente">Paciente</option>
        </select>
        <button class="btn btn-outline-secondary btn-sm" (click)="cambiarOrden()">
          <i class="bi" [class.bi-arrow-up]="ordenamiento.ascendente"
            [class.bi-arrow-down]="!ordenamiento.ascendente"></i>
        </button>
      </div>

      <div class="text-muted">
        Mostrando {{ventasFiltradas.length}} de {{paginacion.totalItems}} ventas
      </div>
    </div>

    <!-- Lista de ventas - Dise√±o Innovador -->
    <div class="card border-0 shadow-sm">
      <div class="card-body p-0">
        <!-- Mensaje cuando no hay resultados -->
        <div *ngIf="ventasFiltradas.length === 0" class="text-center py-5">
          <div class="empty-state">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">No se encontraron ventas</h4>
            <p class="text-muted mb-4">
              <span *ngIf="hayFiltrosActivos()">
                No hay ventas que coincidan con los filtros aplicados.
              </span>
              <span *ngIf="!hayFiltrosActivos()">
                No hay ventas registradas en el historial.
              </span>
            </p>
            <button *ngIf="hayFiltrosActivos()" class="btn btn-primary" (click)="limpiarFiltros()">
              <i class="bi bi-arrow-counterclockwise me-1"></i>
              Limpiar filtros
            </button>
          </div>
        </div>

        <div class="ventas-grid" *ngIf="ventasFiltradas.length > 0">
          <div *ngFor="let venta of ventasFiltradas" class="venta-card">
            <!-- Tarjeta Principal -->
            <div class="venta-header" (click)="toggleDetalleVenta(venta.key)">
              <!-- Avatar y Info Principal -->
              <div class="venta-avatar">
                <div class="avatar-circle" [ngClass]="{
                            'avatar-success': venta.estado === 'completada',
                            'avatar-warning': venta.estado === 'pendiente',
                            'avatar-danger': venta.estado === 'cancelada'
                        }">
                  <i class="bi" [class.bi-check-lg]="venta.estado === 'completada'"
                    [class.bi-clock]="venta.estado === 'pendiente'" [class.bi-x-lg]="venta.estado === 'cancelada'"></i>
                </div>
              </div>

              <!-- Informaci√≥n Central -->
              <div class="venta-info">
                <div class="venta-title">
                  <h6 class="mb-1 fw-bold text-dark">
                    {{venta.paciente.nombre}}
                    <span class="estatus-pago-text" [ngClass]="getEstatusPagoClase(venta)">
                      ({{getEstatusPago(venta)}})
                    </span>
                  </h6>
                  <div class="venta-meta">
                    <span class="meta-item">
                      <i class="bi bi-person-badge text-muted"></i>
                      CI. {{venta.paciente.cedula}}
                    </span>
                    <span class="meta-divider">‚Ä¢</span>
                    <span class="meta-item">
                      <i class="bi bi-calendar3 text-muted"></i>
                      {{venta.fecha | date:'dd/MM/yyyy'}}
                    </span>
                    <span class="meta-divider">‚Ä¢</span>
                    <span class="meta-item">
                      <i class="bi bi-clock text-muted"></i>
                      {{venta.fecha | date:'HH:mm'}}
                    </span>
                  </div>
                </div>

                <!-- Informaci√≥n Adicional -->
                <div class="venta-details">
                  <div class="detail-item">
                    <small class="text-muted">Control</small>
                    <strong class="text-primary">#{{venta.numeroControl}}</strong>
                  </div>
                  <div class="detail-item">
                    <small class="text-muted">Asesor</small>
                    <span class="text-dark">{{venta.asesor.nombre}}</span>
                  </div>
                  <div class="detail-item">
                    <small class="text-muted">Forma Pago</small>
                    <span class="text-capitalize badge forma-pago-badge" [ngClass]="{
                                    'forma-contado': venta.formaPago === 'contado',
                                    'forma-cashea': venta.formaPago === 'cashea',
                                    'forma-abono': venta.formaPago === 'abono'
                                }">
                      {{venta.formaPago}}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Lado Derecho - Estado y Monto -->
              <div class="venta-sidebar">
                <!-- Estado -->
                <div class="estado-badge" [ngClass]="{
                            'estado-completada': venta.estado === 'completada',
                            'estado-pendiente': venta.estado === 'pendiente',
                            'estado-cancelada': venta.estado === 'cancelada'
                        }">
                  <div class="estado-dot"></div>
                  <span class="estado-text">{{venta.estado | titlecase}}</span>
                </div>

                <!-- Monto -->
                <div class="monto-display">
                  <div class="monto-amount text-primary fw-bold">
                    {{ getMontoParaMostrar(venta, venta.montoTotal) }}
                  </div>
                  <div class="monto-label text-muted small">Total</div>
                </div>

                <!-- √çcono Expandir -->
                <div class="expand-icon">
                  <i class="bi" [class.bi-chevron-down]="!venta.mostrarDetalle"
                    [class.bi-chevron-up]="venta.mostrarDetalle"></i>
                </div>
              </div>
            </div>

            <!-- Panel Expandible - Dise√±o Moderno -->
            <div *ngIf="venta.mostrarDetalle" class="venta-expandible">
              <div class="expandible-content">
                <div class="resumen-rapido">
                  <div class="resumen-item">
                    <i class="bi bi-cart-check text-primary"></i>
                    <div>
                      <small class="text-muted">Productos</small>
                      <div class="fw-semibold">{{venta.productos?.length || 0}} items</div>
                    </div>
                  </div>

                  <div class="resumen-item">
                    <i class="bi bi-currency-dollar text-success"></i>
                    <div>
                      <small class="text-muted">Subtotal</small>
                      <div class="fw-semibold">{{ getMontoParaMostrar(venta, venta.subtotal) }}</div>
                    </div>
                  </div>

                  <div class="resumen-item">
                    <i class="bi bi-percent text-info"></i>
                    <div>
                      <small class="text-muted">IVA ({{venta.impuesto || 16}}%)</small>
                      <div class="fw-semibold text-info">
                        {{ getMontoParaMostrar(venta, venta.totalIva || 0) }}
                      </div>
                    </div>
                  </div>

                  <div class="resumen-item">
                    <i class="bi bi-percent text-warning"></i>
                    <div>
                      <small class="text-muted">Descuento</small>
                      <div class="fw-semibold text-danger">
                        -{{ getMontoParaMostrar(venta, getTotalDescuentoMoneda(venta)) }}
                      </div>
                      <small class="text-muted" *ngIf="getPorcentajeDescuentoCalculado(venta) > 0">
                        ({{ getPorcentajeDescuentoCalculado(venta) | number:'1.1-1' }}% sobre subtotal)
                      </small>
                    </div>
                  </div>

                  <div class="resumen-item">
                    <i class="bi bi-cash-coin text-info"></i>
                    <div>
                      <small class="text-muted">Pagado</small>
                      <div class="fw-semibold">{{ getMontoParaMostrar(venta, getTotalPagadoVenta(venta)) }}</div>
                    </div>
                  </div>

                  <div class="resumen-item" *ngIf="getDeudaPendiente(venta) > 0">
                    <i class="bi bi-clock-history text-danger"></i>
                    <div>
                      <small class="text-muted">Deuda Pendiente</small>
                      <div class="fw-semibold text-danger">
                        {{ getMontoParaMostrar(venta, getDeudaPendiente(venta)) }}
                        <small *ngIf="venta.formaPago === 'cashea'" class="text-muted d-block">
                          {{ venta.cantidadCuotas - venta.cuotasAdelantadas.length }} cuota pendiente
                        </small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n Media: Detalles Espec√≠ficos -->
                <!-- <div class="detalles-grid">
                  <div class="detalle-seccion">
                    <h6 class="seccion-titulo">
                      <i class="bi bi-credit-card me-2"></i>
                      M√©todos de Pago
                    </h6>
                    <div class="metodos-pago">
                      <div *ngFor="let metodo of venta.metodosPago" class="metodo-item-detallado">
                       <div class="metodo-header">
                          <div class="metodo-icono" [ngClass]="'metodo-' + metodo.tipo">
                              <i class="bi" [class.bi-cash]="metodo.tipo === 'efectivo'"
                                  [class.bi-credit-card]="metodo.tipo === 'debito' || metodo.tipo === 'credito'"
                                  [class.bi-phone]="metodo.tipo === 'pagomovil'"
                                  [class.bi-bank]="metodo.tipo === 'transferencia'"
                                  [class.bi-currency-dollar]="metodo.tipo === 'zelle'"></i>
                          </div>
                          <div class="metodo-info">
                              <span class="metodo-tipo text-capitalize fw-semibold">{{getTipoPagoDisplay(metodo.tipo)}}</span>
                              <span class="metodo-monto">
                                  {{ getMontoDisplayMetodoPago(metodo, venta) }}
                              </span>
                          </div>
                      </div>

                        <div class="metodo-detalles">
                          <div class="detalle-linea-combinada" *ngIf="getEquivalenteDisplay(metodo, venta)">
                            <div class="detalle-item-combinado">
                              <i class="bi bi-arrow-left-right text-muted"></i>
                              <span class="detalle-texto">{{ getEquivalenteDisplay(metodo, venta) }}</span>
                            </div>
                            <div class="detalle-item-combinado">
                              <i class="bi bi-graph-up text-muted"></i>
                              <span class="detalle-texto">{{ getEquivalenteDisplay(metodo, venta) }}</span>
                            </div>
                          </div>

                          <div class="detalle-linea-combinada" *ngIf="metodo.referencia || getBancoDisplay(metodo)">
                            <div class="detalle-item-combinado" *ngIf="metodo.referencia">
                              <i class="bi bi-receipt text-muted"></i>
                              <span class="detalle-texto">
                                Ref: <strong>{{metodo.referencia}}</strong>
                              </span>
                            </div>

                            <div class="detalle-item-combinado" *ngIf="getBancoDisplay(metodo) && 
                              (metodo.tipo === 'pagomovil' || metodo.tipo === 'transferencia')">
                              <i class="bi bi-building text-muted"></i>
                              <span class="detalle-texto">
                                Banco: <strong>{{ getBancoDisplay(metodo) }}</strong>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="detalle-seccion">
                    <h6 class="seccion-titulo">
                      <i class="bi bi-info-circle me-2"></i>
                      Informaci√≥n Adicional
                    </h6>
                    <div class="info-adicional-grid">

                      <div class="info-fila">
                        <div class="info-item destacado">
                          <div class="info-icono">
                            <i class="bi bi-person-badge"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Especialista</span>
                            <span class="info-value" [ngClass]="{'text-muted': !venta.especialista?.nombre}">
                              {{venta.especialista?.nombre || 'No asignado'}}
                              <span *ngIf="venta.especialista?.tipo" class="info-subtext">
                                - {{venta.especialista.tipo}}
                              </span>
                            </span>
                          </div>
                        </div>

                        <div class="info-item">
                          <div class="info-icono">
                            <i class="bi bi-person-gear"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Tipo Cliente</span>
                            <span class="info-value">
                              {{venta.paciente?.tipoPersona || 'Natural' | titlecase}}
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="info-fila">
                        <div class="info-item">
                          <div class="info-icono">
                            <i class="bi bi-box-seam"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Productos</span>
                            <span class="info-value">
                              {{venta.productos?.length || 0}}
                              <small class="text-muted d-block" *ngIf="venta.productos?.length === 1">
                                {{venta.productos[0]?.nombre}}
                              </small>
                              <small class="text-muted d-block" *ngIf="venta.productos?.length > 1">
                                {{venta.productos[0]?.nombre}} +{{venta.productos.length - 1}} m√°s
                              </small>
                            </span>
                          </div>
                        </div>

                        <div class="info-item" *ngIf="venta.formaPago === 'abono' || venta.formaPago === 'cashea'">
                          <div class="info-icono">
                            <i class="bi" [class.bi-piggy-bank]="venta.formaPago === 'abono'"
                              [class.bi-calendar-check]="venta.formaPago === 'cashea'"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label" *ngIf="venta.formaPago === 'abono'">Plan Abonos</span>
                            <span class="info-label" *ngIf="venta.formaPago === 'cashea'">Plan Cashea</span>
                            <span class="info-value">
                              <span *ngIf="venta.formaPago === 'abono'">
                                Abonado: {{getMontoParaMostrar(venta, venta.montoAbonado)}}
                                <small class="text-muted d-block">
                                  Pendiente: {{getMontoParaMostrar(venta, getDeudaPendiente(venta))}}
                                </small>
                              </span>
                              <span *ngIf="venta.formaPago === 'cashea'">
                                {{venta.cuotasAdelantadas?.length || 0}}/{{venta.cantidadCuotas}} cuotas
                                <small class="text-muted d-block">
                                  Nivel: {{venta.nivelCashea}} ‚Ä¢ Cuota: {{getMontoParaMostrar(venta,
                                  venta.montoPorCuota)}}
                                </small>
                              </span>
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="info-fila" *ngIf="venta.observaciones">
                        <div class="info-item observaciones" style="grid-column: 1 / -1;">
                          <div class="info-icono">
                            <i class="bi bi-chat-left-text"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Observaciones</span>
                            <span class="info-value observacion-texto">{{venta.observaciones}}</span>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>-->

                <!-- Secci√≥n Inferior: Acciones -->
                <div class="acciones-venta">
                  <div class="acciones-left">
                    <span class="text-muted small">
                      <i class="bi bi-clock-history me-1"></i>
                      Creado el {{venta.fecha | date:'dd/MM/yyyy'}}
                    </span>
                  </div>
                  <div class="acciones-right">
                    <button *ngIf="mostrarBotonRealizarPago(venta)" class="btn btn-outline-primary btn-sm accion-btn"
                      (click)="abrirModalPagoCompleto(venta)">
                      <i class="bi bi-cash-stack"></i>
                      <span>Realizar Pago</span>
                    </button>

                    <button *ngIf="mostrarBotonEditar(venta)" class="btn btn-outline-primary btn-sm accion-btn"
                      (click)="editarVenta(venta)">
                      <i class="bi-cash-coin"></i>
                      <span>Abonar</span>
                    </button>

                    <button class="btn btn-outline-primary btn-sm accion-btn" (click)="verDetalleCompleto(venta)">
                      <i class="bi bi-eye"></i>
                      <span>Detalles</span>
                    </button>

                    <button class="btn btn-outline-primary btn-sm accion-btn" (click)="verRecibo(venta)">
                      <i class="bi bi-receipt"></i>
                      <span>Ver recibo</span>
                    </button>
                    <button *ngIf="venta.estado !== 'cancelada'" class="btn btn-outline-danger btn-sm accion-btn"
                      (click)="cancelarVenta(venta)">
                      <i class="bi bi-x-circle"></i>
                      <span>Anular venta</span>
                    </button>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n Estilo Bancario -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="row align-items-center">
          <!-- Informaci√≥n de resultados -->
          <div class="col-md-4">
            <div class="d-flex align-items-center gap-3">
              <span class="text-muted small">
                Mostrando <strong>{{ ventasFiltradas.length }}</strong> de
                <strong>{{ paginacion.totalItems }}</strong> registros
              </span>

              <div class="vr"></div>

              <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="paginacion.itemsPorPagina"
                (change)="cambiarItemsPorPagina()">
                <option *ngFor="let opcion of paginacion.itemsPorPaginaOpciones" [value]="opcion">
                  {{ opcion }} por p√°gina
                </option>
              </select>
            </div>
          </div>

          <!-- Controles de paginaci√≥n centrados -->
          <div class="col-md-4">
            <div class="d-flex justify-content-center align-items-center gap-1">
              <!-- Navegaci√≥n r√°pida -->
              <button class="btn btn-sm btn-outline-secondary" (click)="primeraPagina()"
                [disabled]="paginacion.paginaActual === 1" title="Primera p√°gina">
                <i class="bi bi-chevron-double-left"></i>
              </button>

              <button class="btn btn-sm btn-outline-secondary" (click)="paginaAnterior()"
                [disabled]="paginacion.paginaActual === 1" title="P√°gina anterior">
                <i class="bi bi-chevron-left"></i>
              </button>

              <!-- N√∫meros de p√°gina -->
              <div class="btn-group mx-2" role="group">
                <button *ngFor="let pagina of paginacion.rangoPaginas" class="btn btn-sm"
                  [class.btn-primary]="pagina === paginacion.paginaActual"
                  [class.btn-outline-secondary]="pagina !== paginacion.paginaActual && pagina !== -1"
                  [class.btn-light]="pagina === -1" (click)="pagina !== -1 && irAPagina(pagina)"
                  [disabled]="pagina === -1">
                  {{ pagina === -1 ? '...' : pagina }}
                </button>
              </div>

              <button class="btn btn-sm btn-outline-secondary" (click)="paginaSiguiente()"
                [disabled]="paginacion.paginaActual === paginacion.totalPaginas" title="P√°gina siguiente">
                <i class="bi bi-chevron-right"></i>
              </button>

              <button class="btn btn-sm btn-outline-secondary" (click)="ultimaPagina()"
                [disabled]="paginacion.paginaActual === paginacion.totalPaginas" title="√öltima p√°gina">
                <i class="bi bi-chevron-double-right"></i>
              </button>
            </div>
          </div>

          <!-- Informaci√≥n de p√°gina -->
          <div class="col-md-4 text-end">
            <div class="d-flex align-items-center justify-content-end gap-3">
              <span class="text-muted small">
                P√°gina <strong>{{ paginacion.paginaActual }}</strong> de
                <strong>{{ paginacion.totalPaginas }}</strong>
              </span>

              <div class="vr"></div>

              <!-- Salto r√°pido a p√°gina -->
              <div class="input-group input-group-sm" style="width: 120px;">
                <input type="number" class="form-control" #paginaInput [min]="1" [max]="paginacion.totalPaginas"
                  placeholder="Ir a...">
                <button class="btn btn-outline-secondary" type="button" (click)="irAPagina(paginaInput.valueAsNumber)"
                  [disabled]="!paginaInput.value || paginaInput.valueAsNumber < 1 || paginaInput.valueAsNumber > paginacion.totalPaginas">
                  <i class="bi bi-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n M√≥vil (solo se muestra en pantallas peque√±as) -->
    <div class="d-lg-none mt-3">
      <div class="card">
        <div class="card-body py-2">
          <div class="row align-items-center">
            <div class="col-4">
              <button
                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                (click)="paginaAnterior()" [disabled]="paginacion.paginaActual === 1">
                <i class="bi bi-chevron-left"></i>
                <span>Ant</span>
              </button>
            </div>
            <div class="col-4 text-center">
              <span class="text-muted small">
                {{ paginacion.paginaActual }}/{{ paginacion.totalPaginas }}
              </span>
            </div>
            <div class="col-4">
              <button
                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                (click)="paginaSiguiente()" [disabled]="paginacion.paginaActual === paginacion.totalPaginas">
                <span>Sig</span>
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmaci√≥n para Cancelar Venta -->
<ng-template #cancelarVentaModal let-modal>
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Confirmar Cancelaci√≥n
    </h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <!-- Cambiamos alert-warning por alert-info con fondo azul claro -->
    <div class="alert alert-info" role="alert">
      <h6 class="alert-heading fw-bold">¬øEst√° seguro de que desea cancelar esta venta?</h6>
      <p class="mb-0 mt-2">
        <strong>Venta {{ formatNumeroVenta(selectedVenta?.id) }}</strong><br>
        <span *ngIf="selectedVenta?.paciente?.nombre">Paciente: {{ selectedVenta.paciente.nombre }}</span><br>
        <span *ngIf="selectedVenta?.montoTotal">Monto: {{ selectedVenta.montoTotal | currency }}</span>
      </p>
    </div>

    <div class="form-group mt-3">
      <label for="motivoCancelacion" class="form-label">
        <strong>Motivo de cancelaci√≥n:</strong>
      </label>
      <textarea id="motivoCancelacion" class="form-control" rows="3"
        placeholder="Ingrese el motivo de la cancelaci√≥n..." [(ngModel)]="motivoCancelacion" maxlength="500">
      </textarea>
      <small class="text-muted">{{ motivoCancelacion?.length || 0 }}/500 caracteres</small>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">
      <i class="bi bi-x-circle me-1"></i> Cancelar
    </button>
    <button type="button" class="btn btn-danger" (click)="confirmarCancelacion(modal)">
      <i class="bi bi-check-circle me-1"></i> Confirmar Cancelaci√≥n
    </button>
  </div>
</ng-template>


<!-- Modal de Detalle Completo de Venta - Dise√±o Simplificado -->
<ng-template #detalleVentaModal let-modal>
  <!-- Header con gradiente -->
  <div class="modal-header-detalle">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-file-earmark-text"></i>
      </div>
      <div class="header-text">
        <h5 class="modal-title">Detalle de Venta</h5>
        <div class="header-subtitle">
          <span class="badge badge-primary">#{{selectedVenta?.numeroControl}}</span>
          <span class="separator">‚Ä¢</span>
          <span class="fecha">{{selectedVenta?.fecha | date:'dd/MM/yyyy'}}</span>
        </div>
      </div>
    </div>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()" aria-label="Cerrar"></button>
  </div>

  <div class="modal-body-detalle">
    <!-- Tarjeta de Informaci√≥n Principal -->
    <div class="info-card principal">
      <div class="card-header-detalle">
        <i class="bi bi-person-circle"></i>
        <span>Informaci√≥n del Paciente</span>
      </div>
      <div class="card-body-detalle">
        <div class="info-grid-2cols">
          <!-- Fila 1 -->
          <div class="info-row">
            <div class="info-item-detalle">
              <label>üë§ Paciente</label>
              <div class="value">{{selectedVenta?.paciente?.nombre}}</div>
            </div>
            <div class="info-item-detalle">
              <label>üÜî C√©dula</label>
              <div class="value">{{selectedVenta?.paciente?.cedula || 'No especificada'}}</div>
            </div>
          </div>

          <!-- Fila 2 -->
          <div class="info-row">
            <div class="info-item-detalle">
              <label>üìß Email</label>
              <div class="value">{{selectedVenta?.paciente?.email || 'No especificado'}}</div>
            </div>
            <div class="info-item-detalle">
              <label>üìû Tel√©fono</label>
              <div class="value">{{selectedVenta?.paciente?.telefono || 'No especificado'}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Personal Asignado -->
    <div class="info-card personal">
      <div class="card-header-detalle">
        <i class="bi bi-people"></i>
        <span>Personal Asignado</span>
      </div>
      <div class="card-body-detalle">
        <div class="personal-grid">
          <!-- Asesor -->
          <div class="info-item-detalle">
            <label>üë®‚Äçüíº Asesor</label>
            <div class="value">
              <div class="nombre-personal">{{selectedVenta?.asesor?.nombre || 'No asignado'}}</div>
              <div class="cedula-personal" *ngIf="selectedVenta?.asesor?.cedula">
                C.I. {{selectedVenta?.asesor?.cedula}}
              </div>
              <div class="cedula-personal" *ngIf="!selectedVenta?.asesor?.cedula">
                <small class="text-muted">C√©dula no disponible</small>
              </div>
            </div>
          </div>

          <!-- Especialista -->
          <div class="info-item-detalle">
            <label>üë®‚Äç‚öïÔ∏è Especialista</label>
            <div class="value">
              <div class="nombre-personal">{{selectedVenta?.especialista?.nombre || 'No asignado'}}</div>
              <div class="cedula-personal" *ngIf="selectedVenta?.especialista?.cedula">
                C.I. {{selectedVenta?.especialista?.cedula}}
              </div>
              <div class="cedula-personal" *ngIf="!selectedVenta?.especialista?.cedula">
                <small class="text-muted">C√©dula no disponible</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Formulaci√≥n Cl√≠nica (si existe) -->
    <div class="info-card formulacion" *ngIf="selectedVenta?.historiaMedica?.formulacion">
      <div class="card-header-detalle">
        <i class="bi bi-eyeglasses"></i>
        <span>Formulaci√≥n Cl√≠nica</span>
      </div>
      <div class="card-body-detalle">
        <div class="formulacion-grid">
          <!-- Ojo Derecho -->
          <div class="ojo-card">
            <div class="ojo-header ojo-derecho">
              <i class="bi bi-eye"></i>
              <span>Ojo Derecho (OD)</span>
            </div>
            <div class="ojo-params">
              <div class="param">
                <span class="param-label">Esfera (Esf)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.esf || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Cilindro (Cil)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.cil || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Eje</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.eje || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Add</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.add || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Altura</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.alt || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">DP</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.dp || '‚Äî'}}</span>
              </div>
            </div>
          </div>

          <!-- Ojo Izquierdo -->
          <div class="ojo-card">
            <div class="ojo-header ojo-izquierdo">
              <i class="bi bi-eye"></i>
              <span>Ojo Izquierdo (OI)</span>
            </div>
            <div class="ojo-params">
              <div class="param">
                <span class="param-label">Esfera (Esf)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.esf || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Cilindro (Cil)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.cil || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Eje</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.eje || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Add</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.add || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Altura</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.alt || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">DP</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.dp || '‚Äî'}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recomendaciones -->
        <div class="recomendaciones" *ngIf="selectedVenta?.historiaMedica?.recomendaciones">
          <div class="recomendaciones-header">
            <i class="bi bi-stars"></i>
            <span>Recomendaciones</span>
          </div>
          <div class="recomendaciones-grid">
            <div class="recomendacion-item">
              <span class="rec-label">Montura</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.montura || '‚Äî'}}</span>
            </div>
            <div class="recomendacion-item">
              <span class="rec-label">Material</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.material || '‚Äî'}}</span>
            </div>
            <div class="recomendacion-item">
              <span class="rec-label">Cristal</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.cristal || '‚Äî'}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Productos - Dise√±o Compacto y Moderno -->
    <div class="info-card productos">
      <div class="card-header-detalle">
        <i class="bi bi-cart"></i>
        <span>Productos y Servicios</span>
      </div>
      <div class="card-body-detalle">
        <div class="productos-list-compacto">
          <div *ngFor="let producto of getProductosSegurosDetalle()" class="producto-item-compacto">

            <!-- Header del producto -->
            <div class="producto-header-compacto">
              <div class="producto-titulo">
                <span class="producto-nombre">{{producto.nombre}}</span>
                <span class="producto-codigo">{{producto.codigo}}</span>
              </div>
            </div>

            <!-- L√≠nea principal de c√°lculo -->
            <div class="calculo-linea">
              <!-- Cantidad √ó Precio base -->
              <div class="calculo-parte">
                <span class="cantidad">{{producto.cantidad}} und √ó</span>
                <span class="precio-base">{{formatearMoneda(producto.precioUnitarioSinIva)}}</span>
                <span class="moneda">{{getMonedaDisplay(selectedVenta?.moneda)}}</span>

                <!-- Subtotal base en par√©ntesis -->
                <span class="subtotal-base">
                  ({{formatearMoneda(producto.precioUnitarioSinIva * producto.cantidad)}})
                </span>
              </div>

              <!-- Separador solo si tiene IVA -->
              <span *ngIf="producto.tieneIva" class="separador-calc">+</span>

              <!-- IVA total -->
              <div *ngIf="producto.tieneIva" class="calculo-parte">
                <span class="iva-total">{{formatearMoneda(producto.ivaTotalProducto)}}</span>
                <span class="iva-label">IVA</span>
              </div>

              <!-- Igual y total final -->
              <span class="igual">=</span>

              <div class="calculo-parte total-final">
                <span class="total-producto">{{formatearMoneda(producto.total)}}</span>
              </div>
            </div>

            <!-- Informaci√≥n de IVA por unidad (solo si aplica) -->
            <div *ngIf="producto.tieneIva && producto.cantidad > 1" class="info-iva-unidad">
              <span class="info-label">IVA por unidad:</span>
              <span class="info-valor">{{formatearMoneda(producto.ivaPorUnidad)}}</span>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Configuraci√≥n de Pago -->
    <div class="info-card pago">
      <div class="card-header-detalle">
        <i class="bi bi-credit-card"></i>
        <span>Configuraci√≥n de Pago</span>
      </div>
      <div class="card-body-detalle">
        <div class="pago-grid-compact">

          <!-- Fila 1: Informaci√≥n B√°sica -->
          <div class="pago-row">
            <div class="pago-item-compact">
              <label>Forma de Pago</label>
              <div class="value highlight">{{getFormaPagoDisplay(selectedVenta?.formaPago)}}</div>
            </div>
            <div class="pago-item-compact">
              <label>Moneda</label>
              <div class="value">{{getMonedaDisplay(selectedVenta?.moneda)}}</div>
            </div>
            <div class="pago-item-compact" *ngIf="selectedVenta?.descuento > 0">
              <label>Descuento</label>
              <div class="value discount">{{selectedVenta?.descuento || 0}}%</div>
            </div>
          </div>

          <!-- Informaci√≥n espec√≠fica por tipo de pago -->

          <!-- Cashea: Dise√±o compacto -->
          <div *ngIf="selectedVenta?.formaPago === 'cashea'" class="pago-especifico">
            <div class="pago-row">
              <div class="pago-item-compact">
                <label><i class="bi bi-graph-up"></i> Nivel</label>
                <div class="value small">{{selectedVenta?.nivelCashea}}</div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-cash-coin"></i> Inicial</label>
                <div class="value small">
                  {{selectedVenta?.montoInicial | number:'1.2-2'}} {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-calendar-week"></i> Cuotas</label>
                <div class="value small">
                  {{selectedVenta?.cantidadCuotas}}x {{selectedVenta?.montoPorCuota | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact" *ngIf="selectedVenta?.cuotasAdelantadas?.length > 0">
                <label><i class="bi bi-lightning"></i> Adelantadas</label>
                <div class="value small info">
                  {{selectedVenta?.cuotasAdelantadas?.length}} ({{getTotalCuotasAdelantadas() | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}})
                </div>
              </div>
            </div>
          </div>

          <!-- Abono: Dise√±o compacto en l√≠nea -->
          <div *ngIf="selectedVenta?.formaPago === 'abono'" class="pago-especifico">
            <div class="pago-row">
              <div class="pago-item-compact">
                <label><i class="bi bi-check-circle"></i> Abonado</label>
                <div class="value small success">
                  {{selectedVenta?.montoAbonado | number:'1.2-2'}} {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-clock"></i> Pendiente</label>
                <div class="value small warning">
                  {{(selectedVenta?.total - selectedVenta?.montoAbonado) | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-percent"></i> Progreso</label>
                <div class="value small">{{getPorcentajeAbonado()}}%</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Tarjeta de M√©todos de Pago -->
    <div class="info-card metodos-pago-detalle" *ngIf="selectedVenta?.metodosPago?.length">
      <div class="card-header-detalle">
        <i class="bi bi-wallet2"></i>
        <span>M√©todos de Pago</span>
      </div>
      <div class="card-body-detalle">
        <div class="metodos-grid">
          <!-- Iterar sobre los grupos de pago -->
          <div *ngFor="let pagoGroup of selectedVenta?.metodosPago" class="pago-group">
            <!-- Mostrar informaci√≥n del grupo si existe -->
            <div class="pago-group-header" *ngIf="selectedVenta?.metodosPago?.length > 1">
              <span class="badge bg-info">Abono #{{pagoGroup.numero_pago}}</span>
              <span class="ms-2">Total: {{pagoGroup.montoAbonado | number:'1.2-2'}} {{getMonedaVentaDisplay()}}</span>
            </div>

            <!-- Iterar sobre los m√©todos dentro de cada grupo -->
            <div *ngFor="let metodo of pagoGroup.metodosPago" class="metodo-item-detalle">
              <div class="metodo-icono">
                <i [class]="'bi ' + getIconoMetodoPago(metodo.tipo)"></i>
              </div>
              <div class="metodo-info-detalle">
                <div class="metodo-tipo">{{ getTipoPagoDisplay(metodo.tipo) }}</div>

                <!-- DISPLAY MONTOS -->
                <div class="montos-linea">
                  <!-- Pago en BOLIVARES -->
                  <div *ngIf="metodo.moneda_id === 'bolivar'" class="monto-simple text-success">
                    {{ metodo.monto | number:'1.2-2' }} Bs.
                  </div>

                  <!-- Pago en D√ìLARES -->
                  <div *ngIf="metodo.moneda_id === 'dolar'" class="monto-simple text-success">
                    {{ metodo.monto | number:'1.2-2' }} USD
                  </div>

                  <!-- Pago en EUROS -->
                  <div *ngIf="metodo.moneda_id === 'euro'" class="monto-simple text-success">
                    {{ metodo.monto | number:'1.2-2' }} EUR
                  </div>

                  <!-- Mostrar conversi√≥n si aplica -->
                  <div *ngIf="metodo.monto_moneda_base && metodo.moneda_id !== selectedVenta?.moneda"
                    class="monto-convertido small text-muted ms-2">
                    ‚âà {{ metodo.monto_moneda_base | number:'1.2-2' }} {{getMonedaVentaDisplay()}}
                  </div>
                </div>

                <!-- INFORMACI√ìN ADICIONAL -->
                <div class="metodo-detalles-adicionales">
                  <!-- Referencia -->
                  <div class="detalle-adicional" *ngIf="metodo.referencia">
                    <i class="bi bi-receipt"></i>
                    <span>Ref: {{metodo.referencia}}</span>
                  </div>

                  <!-- Banco -->
                  <div class="detalle-adicional" *ngIf="metodo.bancoNombre">
                    <i class="bi bi-building"></i>
                    <span>Banco: {{metodo.bancoNombre}}</span>
                  </div>

                  <!-- Fecha -->
                  <div class="detalle-adicional">
                    <i class="bi bi-calendar"></i>
                    <span>{{metodo.fechaRegistro | date:'dd/MM/yyyy HH:mm'}}</span>
                  </div>

                  <!-- Tasa de cambio si aplica -->
                  <div *ngIf="metodo.moneda_id === 'bolivar' && metodo.tasa_moneda && metodo.tasa_moneda !== 1"
                    class="detalle-adicional">
                    <i class="bi bi-arrow-left-right"></i>
                    <span>Tasa: 1 {{getMonedaVentaDisplay()}} = {{metodo.tasa_moneda | number:'1.2-2'}} Bs</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Observaciones del grupo -->
            <div class="pago-group-observaciones" *ngIf="pagoGroup.observaciones">
              <i class="bi bi-chat-left-text"></i>
              <span>{{pagoGroup.observaciones}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Resumen Financiero -->
    <div class="info-card resumen">
      <div class="card-header-detalle">
        <i class="bi bi-calculator"></i>
        <span>Resumen Financiero</span>
      </div>
      <div class="card-body-detalle">
        <div class="resumen-grid">
          <div class="resumen-item">
            <span class="resumen-label">Subtotal</span>
            <span class="resumen-value">{{selectedVenta?.subtotal | number:'1.2-2'}} {{selectedVenta?.moneda ===
              'dolar'
              ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item" *ngIf="selectedVenta?.totalIva">
            <span class="resumen-label">IVA Total</span>
            <span class="resumen-value">{{selectedVenta?.totalIva | number:'1.2-2'}} {{selectedVenta?.moneda ===
              'dolar'
              ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item" *ngIf="selectedVenta?.totalDescuento">
            <span class="resumen-label">Descuento</span>
            <span class="resumen-value">-{{selectedVenta?.totalDescuento | number:'1.2-2'}} {{selectedVenta?.moneda
              ===
              'dolar' ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item total">
            <span class="resumen-label">Total</span>
            <span class="resumen-value">{{selectedVenta?.total | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar'
              ?
              'USD' : 'BS'}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Observaciones -->
    <div class="info-card observaciones" *ngIf="selectedVenta?.observaciones">
      <div class="card-header-detalle">
        <i class="bi bi-chat-left-text"></i>
        <span>Observaciones</span>
      </div>
      <div class="card-body-detalle">
        <p class="observaciones-text">{{selectedVenta?.observaciones}}</p>
      </div>
    </div>
  </div>

  <!-- Footer del Modal -->
  <div class="modal-footer-detalle">
    <div class="footer-actions">
      <button type="button" class="btn btn-secondary btn-detalle" (click)="modal.dismiss()">
        <i class="bi bi-x-circle me-2"></i>
        Cerrar
      </button>
    </div>
  </div>
</ng-template>


<!-- Modal de Realizar Abono -->
<ng-template #editarVentaModal let-modal>
  <div class="modal-content">
    <!-- Header compacto -->
    <div class="modal-header-compact">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-pencil-square"></i>
        </div>
        <div class="header-text">
          <h5 class="modal-title">Realizar Abono</h5>
          <div class="header-subtitle">
            <span class="badge">#{{selectedVenta?.numeroControl}}</span>
            <span class="separator">‚Ä¢</span>
            <span>{{selectedVenta?.paciente?.nombre}}</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Cerrar"></button>
    </div>

    <div class="modal-body-compact">
      <!-- Resumen r√°pido -->
      <div class="resumen-mini">
        <!-- Total Venta -->
        <div class="mini-card">
          <div class="mini-header">
            <div class="mini-icon total">
              <i class="bi bi-currency-dollar"></i>
            </div>
            <span class="mini-label">Total venta</span>
          </div>
          <div class="mini-valores">
            <div class="mini-principal">
              <span class="mini-monto">{{ formatearMoneda(selectedVenta?.total, getMonedaVenta()) }}</span>
            </div>

          </div>
        </div>

        <!-- Abonado -->
        <div class="mini-card">
          <div class="mini-header">
            <div class="mini-icon abonado">
              <i class="bi bi-check-circle"></i>
            </div>
            <span class="mini-label">Abonado</span>
          </div>
          <div class="mini-valores">
            <div class="mini-principal">
              <span class="mini-monto">{{ formatearMoneda(selectedVenta?.montoAbonado, getMonedaVenta()) }}</span>
            </div>
            <div class="mini-progreso">
              <div class="progreso-bar"
                [style.width.%]="(selectedVenta?.montoAbonado || 0) / (selectedVenta?.total || 1) * 100"></div>
              <span class="progreso-text">{{ ((selectedVenta?.montoAbonado || 0) / (selectedVenta?.total || 1) * 100) |
                number:'1.0-0' }}%</span>
            </div>

          </div>
        </div>

        <!-- Pendiente -->
        <div class="mini-card destacado">
          <div class="mini-header">
            <div class="mini-icon pendiente">
              <i class="bi bi-clock"></i>
            </div>
            <span class="mini-label">Pendiente</span>
          </div>
          <div class="mini-valores">
            <div class="mini-principal">
              <span class="mini-monto destacado">{{ formatearMoneda(calcularMontoDeuda(), getMonedaVenta()) }}</span>
            </div>
            <div *ngIf="mostrarConversionBs()" class="mini-conversion destacado">
              <span class="conversion-simbolo">‚áÑ</span>
              <span class="conversion-monto">{{ getConversionBs(calcularMontoDeuda()) | number:'1.2-2' }}</span>
              <span class="conversion-label">Bs</span>
            </div>
          </div>
        </div>
      </div>

      <form [formGroup]="editarVentaForm" (ngSubmit)="guardarEdicionVenta(modal)">
        <!-- Secci√≥n inngrese monto -->
        <div class="seccion-compacta">
          <!-- Header principal con bot√≥n -->
          <div class="seccion-header">
            <div class="header-content">
              <div class="header-icon-title">
                <i class="bi bi-cash-coin text-primary header-icon"></i>
                <div class="header-text">
                  <h3 class="seccion-titulo">Monto del Abono</h3>
                  <p class="seccion-description">Configura el monto para este abono</p>
                </div>
              </div>
            </div>
          </div>

          <div class="form-grid-compact">
            <!-- Monto abonado - MONEDA DE VENTA -->
            <div class="form-group-compact">
              <label class="form-label-compact">
                <i class="bi bi-currency-dollar"></i>
                Nuevo monto a abonar
              </label>
              <div class="input-group-compact">
                <input type="number" class="form-control form-control-compact" formControlName="montoAbonado"
                  step="0.01" min="0" [max]="getMontoMaximoPermitido()" placeholder="0.00"
                  (input)="onMontoAbonadoChange()">
                <span class="input-suffix">{{ getSimboloMonedaVenta() }}</span>
              </div>
              <!-- Mostrar la conversi√≥n como hint si hay un valor ingresado -->
              <div class="input-hint">
                <span *ngIf="editarVentaForm.get('montoAbonado')?.value">
                  {{ getConversionDisplay() }}
                </span>
                <span *ngIf="!editarVentaForm.get('montoAbonado')?.value">
                  M√°x: {{ getSimboloMonedaVenta() }} {{ getMontoMaximoPermitido() | number:'1.2-2' }} (Deuda pendiente)
                  <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                    ‚áÑ {{getConversionBs(getMontoMaximoPermitido()) | number:'1.2-2'}} Bs
                  </span>
                </span>
              </div>
            </div>

            <!-- Barra de progreso  -->
            <div class="form-group-compact">
              <label class="form-label-compact">
                <i class="bi bi-graph-up"></i>
                Progreso Total
              </label>
              <div class="progreso-compact">
                <div class="progreso-info">
                  <span class="progreso-porcentaje">{{ calcularPorcentajeAbonadoEnModal() }}%</span>
                  <span class="progreso-montos">
                    {{ getSimboloMonedaVenta() }} {{ ((selectedVenta?.montoAbonado || 0) +
                    (editarVentaForm.get('montoAbonado')?.value || 0)) | number:'1.2-2' }} /
                    {{ getSimboloMonedaVenta() }} {{ selectedVenta?.total | number:'1.2-2' }}
                  </span>
                </div>
                <div class="progress-bar-compact">
                  <div class="progress-fill" [style.width.%]="calcularPorcentajeAbonadoEnModal()"></div>
                </div>

                <!-- ‚úÖ NUEVO: Label de deuda restante -->
                <div class="deuda-restante-info">
                  <small class="deuda-label">
                    <i class="bi bi-clock-history"></i>
                    Saldo pendiente:
                    <strong class="deuda-monto">
                      {{ getSimboloMonedaVenta() }} {{ calcularDeudaRestante() | number:'1.2-2' }}
                    </strong>
                    <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                      (‚áÑ {{ getConversionBs(calcularDeudaRestante()) | number:'1.2-2' }} Bs)
                    </span>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de M√©todos de Pago  -->
        <div class="seccion-compacta">
          <!-- Header principal con bot√≥n -->
          <div class="seccion-header">
            <div class="header-content">
              <div class="header-icon-title">
                <i class="bi bi-wallet2 text-primary header-icon"></i>
                <div class="header-text">
                  <h3 class="seccion-titulo">M√©todos de Pago</h3>
                  <p class="seccion-description">Agrega y configura los m√©todos de pago para este abono</p>
                </div>
              </div>
            </div>
            <div class="header-actions">
              <button type="button" class="btn btn-add-method" (click)="agregarMetodoPago()" title="Agregar m√©todo"
                [disabled]="metodosPagoArray.length >= 10">
                <i class="bi bi-plus-circle"></i>
                Agregar M√©todo
                <span *ngIf="metodosPagoArray.length > 0" class="ms-1">
                  ({{metodosPagoArray.length}}/5)
                </span>
              </button>
            </div>
          </div>

          <!-- Contenido de m√©todos de pago -->
          <div class="metodos-pago-section">
            <!-- Contador de m√©todos -->
            <div class="metodos-counter" *ngIf="metodosPagoArray.length > 0">
              <i class="bi bi-list-check text-primary"></i>
              <span>{{ metodosPagoArray.length }} m√©todo{{ metodosPagoArray.length > 1 ? 's' : '' }} configurado{{
                metodosPagoArray.length > 1 ? 's' : '' }}</span>
            </div>

            <div formArrayName="metodosPago" class="metodos-grid" *ngIf="metodosPagoArray.length > 0">
              <div *ngFor="let metodoControl of metodosPagoArray.controls; let i = index" [formGroupName]="i"
                class="metodo-card">

                <!-- Header con n√∫mero y acciones -->
                <div class="metodo-card-header">
                  <div class="metodo-number">
                    <i class="bi bi-123 text-secondary"></i>
                    <span>M√©todo #{{ i + 1 }}</span>
                    <span class="estado-metodo" [ngClass]="{
                            'estado-vacio': metodoEstaVacio(metodoControl),
                            'estado-incompleto': metodoTieneDatosParciales(metodoControl),
                            'estado-completo': metodoEstaCompleto(metodoControl)
                          }">
                      <i class="bi" [class.bi-dash-circle-fill]="metodoEstaVacio(metodoControl)"
                        [class.bi-exclamation-circle-fill]="metodoTieneDatosParciales(metodoControl)"
                        [class.bi-check-circle-fill]="metodoEstaCompleto(metodoControl)"></i>
                      {{
                      metodoEstaVacio(metodoControl) ? 'Vac√≠o' :
                      metodoTieneDatosParciales(metodoControl) ? 'Incompleto' :
                      'Completo'
                      }}
                    </span>
                  </div>
                  <button class="btn btn-remove" (click)="removerMetodoPago(i)" title="Eliminar m√©todo"
                    [disabled]="metodosPagoArray.length === 1">
                    <i class="bi bi-trash text-danger"></i>
                  </button>
                </div>

                <div class="metodo-content">
                  <!-- Selector de tipo de m√©todo-->
                  <div class="campo-principal">
                    <label class="form-label compact-label">
                      <i class="bi bi-credit-card text-primary"></i>
                      Tipo de Pago
                    </label>
                    <select class="form-select modern-select" formControlName="tipo" (change)="onMetodoPagoChange(i)"
                      [ngClass]="{'campo-invalido': metodoControl.get('tipo')?.invalid && metodoControl.get('tipo')?.touched}">
                      <option value="" disabled selected>Elige un m√©todo de pago</option>
                      <option value="efectivo">üíµ Efectivo</option>
                      <option value="debito">üí≥ Tarjeta D√©bito</option>
                      <option value="credito">üîÑ Tarjeta Cr√©dito</option>
                      <option value="pagomovil">üì± Pago M√≥vil</option>
                      <option value="transferencia">üè¶ Transferencia</option>
                      <option value="zelle">üåê Zelle</option>
                    </select>
                    <small *ngIf="metodoControl.get('tipo')?.invalid && metodoControl.get('tipo')?.touched"
                      class="text-danger">
                      <i class="bi bi-exclamation-triangle"></i> Campo requerido
                    </small>
                  </div>

                  <!-- Campos condicionales -->
                  <div class="campos-condicionales" *ngIf="metodoControl.get('tipo')?.value">

                    <!-- Selector de moneda para efectivo (SOLO para tipo efectivo) -->
                    <div *ngIf="metodoControl.get('tipo')?.value === 'efectivo'"
                      class="campo-adicional moneda-selector">
                      <div class="moneda-header">
                        <i class="bi bi-currency-exchange text-success"></i>
                        <span class="moneda-label">Moneda del Efectivo</span>
                      </div>
                      <div class="moneda-buttons-compact">
                        <button type="button" class="moneda-btn-compact"
                          [class.moneda-btn-active]="metodoControl.get('monedaEfectivo')?.value === 'USD'"
                          (click)="seleccionarMonedaEfectivo(i, 'usd')" title="D√≥lar Americano">
                          <span class="moneda-symbol-compact">$</span>
                          <span class="moneda-text-compact">USD</span>
                        </button>

                        <button type="button" class="moneda-btn-compact"
                          [class.moneda-btn-active]="metodoControl.get('monedaEfectivo')?.value === 'EUR'"
                          (click)="seleccionarMonedaEfectivo(i, 'eur')" title="Euro">
                          <span class="moneda-symbol-compact">‚Ç¨</span>
                          <span class="moneda-text-compact">EUR</span>
                        </button>

                        <button type="button" class="moneda-btn-compact"
                          [class.moneda-btn-active]="metodoControl.get('monedaEfectivo')?.value === 'Bs'"
                          (click)="seleccionarMonedaEfectivo(i, 'bs')" title="Bol√≠var">
                          <span class="moneda-symbol-compact">Bs</span>
                          <span class="moneda-text-compact">VES</span>
                        </button>
                      </div>
                      <small class="text-muted" style="font-size: 11px; display: block; margin-top: 3px;">
                        <i class="bi bi-info-circle"></i> Selecciona la moneda del efectivo
                      </small>
                    </div>

                    <!-- Campo Banco -->
                    <div *ngIf="necesitaBanco(metodoControl.get('tipo')?.value)" class="campo-adicional">
                      <label class="form-label compact-label">
                        <i class="bi bi-bank"></i>
                        Banco
                      </label>
                      <ng-select [items]="bancosDisponibles" bindLabel="displayText" bindValue="codigo"
                        formControlName="bancoObject" (change)="onBancoChange($event, i)" [compareWith]="compararBanco"
                        [searchable]="true" [clearable]="true" placeholder="Buscar banco por c√≥digo o nombre..."
                        [class.ng-select-invalid]="metodoControl.get('bancoObject')?.invalid && metodoControl.get('bancoObject')?.touched">
                      </ng-select>
                      <small
                        *ngIf="metodoControl.get('bancoObject')?.invalid && metodoControl.get('bancoObject')?.touched"
                        class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Selecciona un banco
                      </small>
                    </div>

                    <!-- Campo Referencia -->
                    <div *ngIf="necesitaReferencia(metodoControl.get('tipo')?.value)" class="campo-adicional">
                      <label class="form-label compact-label">
                        <i class="bi bi-hash"></i>
                        N¬∞ de Referencia
                      </label>
                      <input type="text" class="form-control modern-input" formControlName="referencia"
                        [placeholder]="getPlaceholderReferencia(metodoControl.get('tipo')?.value)" maxlength="20"
                        [class.campo-invalido]="metodoControl.get('referencia')?.invalid && metodoControl.get('referencia')?.touched" />
                      <small
                        *ngIf="metodoControl.get('referencia')?.invalid && metodoControl.get('referencia')?.touched"
                        class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i> Ingresa el n√∫mero de referencia
                      </small>
                    </div>

                    <!-- Campo Monto -->
                    <div class="campo-monto">
                      <label class="form-label compact-label">
                        <i class="bi bi-cash-stack"></i>
                        Monto a Pagar
                      </label>
                      <input type="number" class="form-control modern-input" formControlName="monto" step="0.01"
                        min="0.01" [max]="getMontoMaximoParaMetodo(i)" placeholder="0.00"
                        (input)="validarMontoMetodoPago(i)"
                        [class.campo-invalido]="metodoControl.get('monto')?.invalid && metodoControl.get('monto')?.touched" />
                      <small *ngIf="metodoControl.get('monto')?.invalid && metodoControl.get('monto')?.touched"
                        class="text-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span *ngIf="metodoControl.get('monto')?.errors?.['required']">Ingresa un monto v√°lido</span>
                        <span *ngIf="metodoControl.get('monto')?.errors?.['min']">El monto debe ser mayor a 0</span>
                        <span *ngIf="metodoControl.get('monto')?.errors?.['max']">El monto excede el m√°ximo
                          permitido</span>
                      </small>
                    </div>
                  </div>
                </div>

                <!-- Footer con informaci√≥n -->
                <div class="metodo-footer" *ngIf="metodoControl.get('tipo')?.value">
                  <div class="footer-info">
                    <span class="maximo-text">
                      <i class="bi bi-graph-up text-info"></i>
                      M√°x. disponible: {{ getMontoMaximoParaMetodo(i) | number:'1.2-2' }} {{ getSimboloParaMetodo(i) }}
                    </span>

                    <!-- Mostrar conversi√≥n clara -->
                    <span *ngIf="metodoControl.get('monto')?.value && metodoControl.get('monto')?.value > 0"
                      class="conversion-text">
                      <i class="bi bi-calculator text-primary"></i>
                      {{ metodoControl.get('monto')?.value | number:'1.2-2' }} {{ getSimboloParaMetodo(i) }}
                      <span *ngIf="mostrarConversionParaMetodo(i)" class="conversion-moneda-venta">
                        = {{ getConversionParaMetodo(i) | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                      </span>
                      <span *ngIf="mostrarConversionBs()" class="bs-conversion">
                        ({{ getConversionBs(metodoControl.get('monto')?.value, getMonedaParaMetodo(i)) | number:'1.2-2'
                        }} Bs)
                      </span>
                    </span>
                  </div>
                </div>

                <!-- Estado vac√≠o -->
                <div class="metodo-empty" *ngIf="!metodoControl.get('tipo')?.value">
                  <i class="bi bi-credit-card-2-front text-muted"></i>
                  <span>Selecciona un tipo de pago para continuar</span>
                </div>
              </div>
            </div>

            <!-- Estado vac√≠o general -->
            <div class="empty-state" *ngIf="metodosPagoArray.length === 0">
              <div class="empty-icon">
                <i class="bi bi-wallet text-muted"></i>
              </div>
              <h5>No hay m√©todos de pago</h5>
              <p>Agrega al menos un m√©todo de pago para continuar con el abono</p>
              <!-- BOT√ìN PARA PRIMER M√âTODO (solo se muestra cuando NO hay m√©todos) -->
              <button type="button" class="btn btn-add-method" (click)="agregarMetodoPago()">
                <i class="bi bi-plus-circle"></i>
                Agregar Primer M√©todo
              </button>
            </div>

            <!-- Resumen de pagos (despu√©s de agregar m√©todos) -->
            <div *ngIf="metodosPagoArray.length > 0" class="resumen-pagos-elegante">
              <div class="resumen-header">
                <div class="resumen-icon">
                  <i class="bi bi-calculator"></i>
                </div>
                <div class="resumen-title">
                  <h6>Resumen de Pagos</h6>
                  <small>Total en {{getMonedaVentaDisplay()}}</small>
                </div>
              </div>

              <div class="resumen-body">
                <div class="resumen-item">
                  <span class="resumen-label">Total m√©todos:</span>
                  <span class="resumen-value total-methods">
                    {{ calcularTotalMetodosPagoEnMonedaVenta() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                  </span>
                </div>

                <div class="resumen-item" [class.has-difference]="!validarPagoCompleto()">
                  <span class="resumen-label">Diferencia:</span>
                  <span class="resumen-value difference">
                    {{ calcularDiferenciaMetodos() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                    <i *ngIf="!validarPagoCompleto()" class="bi bi-exclamation-triangle warning-icon"></i>
                  </span>
                </div>

                <div class="resumen-item total">
                  <span class="resumen-label">Monto a abonar:</span>
                  <span class="resumen-value grand-total">
                    {{ editarVentaForm.get('montoAbonado')?.value || 0 | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                  </span>
                </div>
              </div>

              <div *ngIf="!validarPagoCompleto()" class="resumen-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <span>Los m√©todos de pago no coinciden con el monto a abonar</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de Observaciones (Nueva) -->
        <div class="seccion-compacta"
          *ngIf="selectedVenta?.observaciones || editarVentaForm.get('observaciones')?.value">
          <div class="seccion-header">
            <i class="bi bi-chat-left-text"></i>
            <span class="seccion-titulo">Observaciones del Abono</span>
          </div>

          <div class="form-grid-compact">
            <div class="form-group-compact" style="grid-column: 1 / -1;">
              <label class="form-label-compact">
                <i class="bi bi-pencil"></i>
                Notas adicionales (opcional)
              </label>
              <textarea class="form-control form-control-compact" formControlName="observaciones" rows="3"
                placeholder="Ej: Cliente pagar√° el resto la pr√≥xima semana, se le entreg√≥ recibo, etc."
                maxlength="500"></textarea>
              <div class="input-hint">
                <i class="bi bi-info-circle"></i>
                <span>Informaci√≥n adicional sobre este abono. M√°x. 500 caracteres.</span>
                <span class="float-end text-muted">
                  {{ editarVentaForm.get('observaciones')?.value?.length || 0 }}/500
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer modal -->
        <div class="modal-footer-detalle">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary btn-detalle" (click)="modal.dismiss()">
              <i class="bi bi-x-circle me-2"></i>
              Cancelar
            </button>
            <button type="button" class="btn btn-success btn-detalle"
              [disabled]="editarVentaForm.invalid || !validarPagoCompleto()" (click)="guardarEdicionVenta(modal)">
              <i class="bi bi-check-circle me-2"></i>
              Guardar Abono
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</ng-template>

<!-- Modal de Realizar Pago para contado-pendiente -->
<ng-template #realizarPagoModal let-modal>
  <div class="modal-content">
    <!-- Header simple y claro -->
    <div class="modal-header-compact">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-cash-stack text-success"></i>
        </div>
        <div class="header-text">
          <h5 class="modal-title fw-bold">Realizar Pago</h5>
          <div class="header-subtitle">
            <span class="badge bg-primary">#{{selectedVenta?.numeroControl}}</span>
            <span class="separator">‚Ä¢</span>
            <span class="fw-semibold">{{selectedVenta?.paciente?.nombre}}</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Cerrar"></button>
    </div>

    <div class="modal-body-compact modal-body-scrollable">
      <!-- Resumen MUY simple: Solo lo que se debe pagar -->
      <div class="resumen-simple">
        <div class="deuda-card">
          <div class="deuda-header">
            <i class="bi bi-currency-dollar text-warning"></i>
            <span class="deuda-label">Monto a pagar</span>
          </div>
          <div class="deuda-content">
            <div class="deuda-monto">
              <span class="monto-principal">{{ formatearMoneda(calcularMontoDeuda(), getMonedaVenta()) }}</span>
              <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="monto-conversion">
                ‚âà {{ getConversionBs(calcularMontoDeuda()) | number:'1.2-2' }} Bs
              </span>
            </div>
            <div class="deuda-info">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Pago √∫nico - Total de la deuda pendiente
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario simple -->
      <form [formGroup]="editarVentaForm" (ngSubmit)="guardarPagoCompleto(modal)">
     
        <!-- Secci√≥n de M√©todos de Pago (MANTENIDO pero m√°s simple) -->
        <div class="seccion-compacta">
          <!-- Header principal de la secci√≥n -->
          <div class="seccion-header">
            <div class="header-content">
              <div class="header-icon-title">
                <i class="bi bi-wallet2 text-primary header-icon"></i>
                <div class="header-text">
                  <h3 class="seccion-titulo">M√©todos de Pago</h3>
                  <p class="seccion-description">Seleccione c√≥mo el cliente realizar√° el pago</p>
                </div>
              </div>
            </div>
            <div class="header-actions">
              <button type="button" class="btn btn-add-method" (click)="agregarMetodoPago()" title="Agregar m√©todo"
                [disabled]="metodosPagoArray.length >= 3">
                <i class="bi bi-plus-circle"></i>
                Agregar M√©todo
              </button>
            </div>
          </div>

          <!-- Secci√≥n de M√©todos de Pago Mejorada y Compacta -->
          <div class="metodos-pago-compact">
            
            <!-- Contador de m√©todos y estado -->
            <div class="metodos-info-bar" *ngIf="metodosPagoArray.length > 0">
              <div class="metodos-count">
                <span class="badge bg-primary">{{ metodosPagoArray.length }}</span>
                <span class="metodos-count-text">{{ metodosPagoArray.length === 1 ? 'M√©todo' : 'M√©todos' }} configurado{{ metodosPagoArray.length > 1 ? 's' : '' }}</span>
              </div>
              <div class="metodos-status" [class.status-valid]="validarPagoCompleto()"
                                        [class.status-invalid]="!validarPagoCompleto()">
                <i class="bi" [class.bi-check-circle]="validarPagoCompleto()"
                            [class.bi-exclamation-circle]="!validarPagoCompleto()"></i>
                <span>{{ validarPagoCompleto() ? 'Montos coinciden' : 'Ajustar montos' }}</span>
              </div>
            </div>

            <!-- Grid de m√©todos de pago -->
            <div formArrayName="metodosPago" class="metodos-grid-compact" *ngIf="metodosPagoArray.length > 0">
              <div *ngFor="let metodoControl of metodosPagoArray.controls; let i = index" [formGroupName]="i"
                  class="metodo-card-compact">
                
                <!-- Cabecera compacta -->
                <div class="metodo-card-header-compact">
                  <div class="metodo-header-left">
                    <span class="metodo-indice">#{{ i + 1 }}</span>
                    <div class="metodo-completitud" 
                        [class.completo]="metodoEstaCompleto(metodoControl)"
                        [class.incompleto]="!metodoEstaCompleto(metodoControl)"
                        title="{{ metodoEstaCompleto(metodoControl) ? 'Completo' : 'Incompleto' }}">
                      <i class="bi" [class.bi-check]="metodoEstaCompleto(metodoControl)"
                                [class.bi-dash]="!metodoEstaCompleto(metodoControl)"></i>
                    </div>
                  </div>
                  
                  <div class="metodo-header-right">
                    <button type="button" class="btn btn-sm btn-icon-compact" 
                            (click)="removerMetodoPago(i)"
                            *ngIf="metodosPagoArray.length > 1"
                            title="Eliminar m√©todo">
                      <i class="bi bi-x"></i>
                    </button>
                  </div>
                </div>

                <!-- Cuerpo compacto -->
                <div class="metodo-card-body-compact">
                  
                  <!-- Selector de tipo -->
                  <div class="metodo-tipo-wrapper">
                    <select class="form-select-compact" formControlName="tipo" (change)="onMetodoPagoChange(i)">
                      <option value="" disabled selected>Tipo de pago</option>
                      <option value="efectivo">üíµ Efectivo</option>
                      <option value="debito">üí≥ D√©bito</option>
                      <option value="credito">üîÑ Cr√©dito</option>
                      <option value="pagomovil">üì± Pago M√≥vil</option>
                      <option value="transferencia">üè¶ Transferencia</option>
                      <option value="zelle">üåê Zelle</option>
                    </select>
                  </div>

                  <!-- Campos din√°micos (se muestran solo si hay tipo seleccionado) -->
                  <div *ngIf="metodoControl.get('tipo')?.value" class="metodo-campos-wrapper">
                    
                    <!-- Moneda para efectivo -->
                    <div *ngIf="metodoControl.get('tipo')?.value === 'efectivo'" class="moneda-selector-compact">
                      <div class="moneda-buttons-compact">
                        <button type="button" class="moneda-btn-compact" 
                                [class.active]="metodoControl.get('monedaEfectivo')?.value === 'USD'"
                                (click)="seleccionarMonedaEfectivo(i, 'usd')">
                          <span class="moneda-simbolo">$</span>
                          <span class="moneda-nombre">USD</span>
                        </button>
                        <button type="button" class="moneda-btn-compact"
                                [class.active]="metodoControl.get('monedaEfectivo')?.value === 'EUR'"
                                (click)="seleccionarMonedaEfectivo(i, 'eur')">
                          <span class="moneda-simbolo">‚Ç¨</span>
                          <span class="moneda-nombre">EUR</span>
                        </button>
                        <button type="button" class="moneda-btn-compact"
                                [class.active]="metodoControl.get('monedaEfectivo')?.value === 'Bs'"
                                (click)="seleccionarMonedaEfectivo(i, 'bs')">
                          <span class="moneda-simbolo">Bs</span>
                          <span class="moneda-nombre">VES</span>
                        </button>
                      </div>
                    </div>

                    <!-- Banco (si aplica) -->
                    <div *ngIf="necesitaBanco(metodoControl.get('tipo')?.value)" class="campo-compact">
                      <input type="text" class="form-control-compact" formControlName="bancoCodigo"
                            placeholder="Banco" list="bancos-list">
                      <datalist id="bancos-list">
                        <option *ngFor="let banco of bancosDisponibles" [value]="banco.nombre">
                      </datalist>
                    </div>

                    <!-- Referencia (si aplica) -->
                    <div *ngIf="necesitaReferencia(metodoControl.get('tipo')?.value)" class="campo-compact">
                      <input type="text" class="form-control-compact" formControlName="referencia"
                            [placeholder]="getPlaceholderReferencia(metodoControl.get('tipo')?.value)">
                    </div>

                    <!-- Monto (siempre visible) -->
                    <div class="campo-compact monto-wrapper">
                      <div class="monto-input-compact">
                        <input type="number" class="form-control-compact" formControlName="monto" step="0.01"
                              min="0.01" [max]="getMontoMaximoParaMetodo(i)" placeholder="0.00"
                              (input)="validarMontoMetodoPago(i)">
                        <span class="monto-currency">{{ getSimboloParaMetodo(i) }}</span>
                      </div>
                      <small class="monto-conversion" *ngIf="metodoControl.get('monto')?.value">
                        {{ metodoControl.get('monto')?.value | number:'1.2-2' }} {{ getSimboloParaMetodo(i) }}
                        <span *ngIf="mostrarConversionParaMetodo(i)" class="conversion-venta">
                          ‚âà {{ getConversionParaMetodo(i) | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                        </span>
                      </small>
                    </div>

                  </div>
                </div>
              </div>
            </div>

            <!-- Estado vac√≠o compacto -->
            <div class="empty-compact" *ngIf="metodosPagoArray.length === 0">
              <div class="empty-icon-compact">
                <i class="bi bi-credit-card"></i>
              </div>
              <div class="empty-text-compact">
                <p class="mb-1">No hay m√©todos de pago</p>
                <small class="text-muted">Haz clic en "Agregar M√©todo" para comenzar</small>
              </div>
            </div>

            <!-- Resumen ultra compacto -->
            <div *ngIf="metodosPagoArray.length > 0" class="resumen-compact">
              <div class="resumen-row">
                <span class="resumen-label">Total m√©todos:</span>
                <span class="resumen-value">{{ calcularTotalMetodosPagoEnMonedaVenta() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}</span>
              </div>
              <div class="resumen-row">
                <span class="resumen-label">Deuda total:</span>
                <span class="resumen-value destacado">{{ calcularMontoDeuda() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}</span>
              </div>
              <div class="resumen-row" *ngIf="!validarPagoCompleto()">
                <span class="resumen-label text-warning">Diferencia:</span>
                <span class="resumen-value text-warning">
                  {{ calcularDiferenciaMetodos() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                </span>
              </div>
            </div>

          </div>
        </div>

        <!-- Observaciones Compactas -->
        <div class="observaciones-compact">
          <div class="observaciones-header-compact">
            <div class="observaciones-titulo-compact">
              <i class="bi bi-chat-right-text text-primary me-2"></i>
              <span class="fw-medium">Notas adicionales</span>
              <small class="text-muted ms-2">(opcional)</small>
            </div>
            <div class="observaciones-contador-compact">
              <small class="text-muted">{{ editarVentaForm.get('observaciones')?.value?.length || 0 }}/500</small>
            </div>
          </div>
          
          <div class="observaciones-input-compact">
            <textarea class="form-control form-control-sm observaciones-textarea-compact" 
                      formControlName="observaciones" 
                      rows="1"
                      placeholder="Ej: Recibo entregado, pago en efectivo, contacto adicional..."
                      maxlength="500"
                      (focus)="expandirTextarea($event)"
                      (blur)="contraerTextarea($event)"></textarea>
            
            <div class="observaciones-hints">
              <div class="hints-items">
                <span class="hint-item" (click)="agregarObservacionRapida('Recibo entregado')">
                  <i class="bi bi-receipt"></i> Recibo
                </span>
                <span class="hint-item" (click)="agregarObservacionRapida('Pago en efectivo')">
                  <i class="bi bi-cash"></i> Efectivo
                </span>
                <span class="hint-item" (click)="agregarObservacionRapida('Pago transferencia')">
                  <i class="bi bi-bank"></i> Transferencia
                </span>
                <span class="hint-item" (click)="agregarObservacionRapida('Cliente puntual')">
                  <i class="bi bi-clock"></i> Puntual
                </span>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>

    <!-- Footer simple -->
   <div class="modal-footer-fixed">
      <div class="footer-content">
        <div class="footer-info" *ngIf="metodosPagoArray.length > 0">
          <div class="footer-summary">
            <span class="summary-label">Total a pagar:</span>
            <span class="summary-value">{{ calcularMontoDeuda() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}</span>
          </div>
          <div class="footer-status" [class.status-valid]="validarPagoCompleto()" 
                                     [class.status-invalid]="!validarPagoCompleto()">
            <i class="bi" [class.bi-check-circle]="validarPagoCompleto()"
                       [class.bi-exclamation-circle]="!validarPagoCompleto()"></i>
            <span>{{ validarPagoCompleto() ? 'Listo para registrar' : 'Ajustar montos' }}</span>
          </div>
        </div>
        
        <div class="footer-actions">
          <button type="button" class="btn btn-outline-secondary btn-footer" (click)="modal.dismiss()">
            <i class="bi bi-x-circle me-1"></i>
            Cancelar
          </button>
          <button type="button" class="btn btn-success btn-footer" 
                  [disabled]="editarVentaForm.invalid || !validarPagoCompleto()" 
                  (click)="guardarPagoCompleto(modal)">
            <i class="bi bi-check-circle me-1"></i>
            Registrar Pago
          </button>
        </div>
      </div>
    </div>
  </div>
</ng-template>




<!-- Modal de Recibo -->
<div class="modal fade" id="reciboModal" [class.show]="mostrarModalRecibo"
  [style.display]="mostrarModalRecibo ? 'block' : 'none'" tabindex="-1" [attr.aria-hidden]="!mostrarModalRecibo">
  <div class="modal-dialog modal-xl">
    <div class="modal-content recibo-compacto">
      <!-- Header del Recibo -->
      <div class="modal-header-recibo">
        <div class="header-content">
          <div class="header-icon">
            <i class="bi bi-file-earmark-pdf"></i>
          </div>
          <div class="header-text">
            <h5 class="modal-title">{{ getTituloRecibo() }}</h5>
            <div class="header-subtitle">
              <span class="badge badge-recibo">Recibo {{ datosRecibo?.numeroVenta }}</span>
              <span class="status-badge" [class]="getEstadoBadgeClass()">
                {{ getEstadoTexto() }}
              </span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="cerrarModalRecibo()"
          aria-label="Close"></button>
      </div>

      <!-- Body del Recibo -->
      <div class="modal-body p-3">
        <div class="recibo-container compacto" id="contenidoRecibo">
          <!-- Encabezado compacto -->
          <div class="recibo-header text-center mb-3">
            <h4 class="empresa-nombre mb-1">NEW VISION LENS</h4>
            <div class="empresa-info small text-muted">
              <p class="mb-0">C.C. Candelaria, Local PB-04, Guarenas | Tel: 0212-365-39-42</p>
              <p class="mb-0">RIF: J-123456789 | newvisionlens2020gmail.com</p>
            </div>
            <h5 class="titulo-venta mt-2 mb-0 text-dark">{{ getTituloRecibo() }}</h5>
          </div>

          <!-- Informaci√≥n compacta en una l√≠nea -->
          <div class="info-rapida mb-3">
            <div class="row g-2 small">
              <div class="col-md-3">
                <strong>Recibo:</strong> {{ datosRecibo?.numeroVenta || 'N/A' }}
              </div>
              <div class="col-md-3">
                <strong>Fecha:</strong> {{ datosRecibo?.fecha || 'N/A' }}
              </div>
              <div class="col-md-3">
                <strong>Hora:</strong> {{ datosRecibo?.hora || 'N/A' }}
              </div>
              <div class="col-md-3">
                <strong>Vendedor:</strong> {{ datosRecibo?.vendedor || 'N/A' }}
              </div>
            </div>
          </div>

          <!-- Cliente compacto -->
          <div class="cliente-compacto mb-3 p-2 bg-light rounded small">
            <div class="row g-2">
              <div class="col-md-4">
                <strong>Cliente:</strong> {{ datosRecibo?.cliente?.nombre || 'CLIENTE GENERAL' }}
              </div>
              <div class="col-md-4">
                <strong>C√©dula:</strong> {{ datosRecibo?.cliente?.cedula || 'N/A' }}
              </div>
              <div class="col-md-4">
                <strong>Tel√©fono:</strong> {{ datosRecibo?.cliente?.telefono || 'N/A' }}
              </div>
            </div>
          </div>

          <!-- Productos compactos -->
          <div class="productos-compactos mb-3">
            <h6 class="fw-bold mb-2 text-primary border-bottom pb-1">PRODUCTOS</h6>
            <div class="table-responsive">
              <table class="table table-sm table-bordered mb-1">
                <thead class="table-light">
                  <tr>
                    <th width="5%" class="text-center">#</th>
                    <th width="55%">Descripci√≥n</th>
                    <th width="10%" class="text-center">Cant</th>
                    <th width="15%" class="text-end">P. Unitario</th>
                    <th width="15%" class="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let producto of getProductosSeguros(); let i = index">
                    <td class="text-center">{{ i + 1 }}</td>
                    <td class="small">{{ producto.nombre }}</td>
                    <td class="text-center">{{ producto.cantidad }}</td>
                    <td class="text-end">{{ formatearMoneda(producto.precioUnitarioSinIva) }}</td>
                    <td class="text-end">{{ formatearMoneda(producto.subtotalCalculado) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Secci√≥n de Resumen seg√∫n Tipo de Pago (INTEGRADO) -->
          <div class="resumen-venta mb-3">
            <h6 class="fw-bold mb-2 text-primary border-bottom pb-1">RESUMEN DE VENTA</h6>

            <!-- Contado - CON M√âTODOS DE PAGO INTEGRADOS -->
            <div *ngIf="(datosRecibo?.configuracion?.formaPago || ventaParaRecibo?.formaPago) === 'contado'"
              class="resumen-contado">
              <!-- Forma de pago -->
              <div class="row small mb-3">
                <div class="col-12 text-center">
                  <span class="badge bg-success fs-6">CONTADO</span>
                </div>
              </div>

              <!-- M√©todos de pago para contado -->
              <div class="metodos-pago-integrado mb-3" *ngIf="getMetodosPagoContado().length > 0">
                <h6 class="text-center mb-2 fw-bold text-primary">M√âTODOS DE PAGO</h6>
                <div class="row g-1">
                  <div class="col-12" *ngFor="let metodo of getMetodosPagoContado(); let i = index">
                    <div class="d-flex justify-content-between align-items-center small py-1">
                      <span>
                        <span class="badge bg-primary me-1">{{ formatearTipoPago(metodo.tipo) }}</span>
                        {{ formatearMoneda(metodo.monto_en_moneda_de_venta || metodo.monto, metodo.moneda) }}
                        <span *ngIf="metodo.referencia" class="text-muted ms-1">(Ref: {{ metodo.referencia }})</span>
                        <span *ngIf="metodo.banco" class="text-muted ms-1">- {{ metodo.banco }}</span>
                      </span>
                      <small class="text-muted">#{{ i + 1 }}</small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Total pagado -->
              <div class="row small text-center mt-3">
                <div class="col-12">
                  <strong class="d-block mb-1">TOTAL PAGADO</strong>
                  <div class="fs-5 fw-bold text-success">
                    {{ formatearMoneda(getTotalPagadoSeguro()) }}
                  </div>
                  <small class="text-muted">El pago ha sido realizado en su totalidad</small>
                </div>
              </div>
            </div>

            <!-- Cashea - CON M√âTODOS DE PAGO INTEGRADOS -->
            <div *ngIf="(datosRecibo?.configuracion?.formaPago || ventaParaRecibo?.formaPago) === 'cashea'"
              class="resumen-cashea">
              <!-- Forma de pago -->
              <div class="row small mb-3">
                <div class="col-12 text-center">
                  <span class="badge bg-info fs-6">PLAN CASHEA</span>
                </div>
              </div>

              <!-- Informaci√≥n del plan Cashea -->
              <div class="row small mb-3">
                <div class="col-12 text-center">
                  <div class="cashea-info">
                    <div class="nivel-cashea mb-2">
                      <small class="text-muted">NIVEL</small>
                      <div class="fw-bold text-primary">
                        {{ datosRecibo?.cashea?.nivel ?
                        obtenerNombreNivelCashea(datosRecibo.cashea.nivel) :
                        obtenerNombreNivelCashea(nivelCashea) }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- M√©todos de pago para Cashea -->
              <div class="metodos-pago-integrado mb-3" *ngIf="getMetodosPagoCashea().length > 0">
                <h6 class="text-center mb-2 fw-bold text-primary">M√âTODOS DE PAGO UTILIZADOS</h6>
                <div class="row g-1">
                  <div class="col-12" *ngFor="let metodo of getMetodosPagoCashea()">
                    <div class="d-flex justify-content-between align-items-center small py-1">
                      <span>
                        <span class="badge bg-primary me-1">{{ formatearTipoPago(metodo.tipo) }}</span>
                        {{ formatearMoneda(metodo.monto_en_moneda_de_venta || metodo.monto, metodo.moneda) }}
                        <span *ngIf="metodo.referencia" class="text-muted ms-1">(Ref: {{ metodo.referencia }})</span>
                        <span *ngIf="metodo.banco" class="text-muted ms-1">- {{ metodo.banco }}</span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Desglose de pagos -->
              <div class="row small mb-3">
                <div class="col-12">
                  <div class="pagos-section">
                    <h6 class="text-center mb-3 fw-bold text-primary">DESGLOSE DE PAGOS</h6>

                    <!-- Pago inicial -->
                    <div class="pago-item d-flex justify-content-between align-items-center py-2 border-bottom">
                      <div class="pago-concepto text-center w-50">
                        <i class="bi bi-credit-card text-primary me-1"></i>
                        <strong>Pago Inicial</strong>
                      </div>
                      <div class="pago-monto text-center w-50">
                        <strong>{{ formatearMoneda(datosRecibo?.cashea?.inicial ||
                          ventaParaRecibo.montoInicial) }}</strong>
                      </div>
                    </div>

                    <!-- Cuotas adelantadas -->
                    <div *ngIf="(datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad) > 0"
                      class="pago-item d-flex justify-content-between align-items-center py-2 border-bottom">
                      <div class="pago-concepto text-center w-50">
                        <i class="bi bi-calendar-plus text-success me-1"></i>
                        <strong>{{ datosRecibo?.cashea?.cuotasAdelantadas ||
                          resumenCashea.cantidad }} Cuota{{
                          (datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad) >
                          1 ? 's' : '' }} Adelantada{{ (datosRecibo?.cashea?.cuotasAdelantadas
                          || resumenCashea.cantidad) > 1 ? 's' : '' }}</strong>
                      </div>
                      <div class="pago-monto text-center w-50">
                        <strong>{{ formatearMoneda(datosRecibo?.cashea?.montoAdelantado ||
                          resumenCashea.total) }}</strong>
                      </div>
                    </div>

                    <!-- Total pagado ahora -->
                    <div class="pago-total d-flex justify-content-between align-items-center py-2 mt-2 border-top">
                      <div class="text-center w-50">
                        <strong>TOTAL PAGADO AHORA:</strong>
                      </div>
                      <div class="text-center w-50">
                        <strong class="text-success">
                          {{ formatearMoneda(getTotalPagadoSeguro()) }}
                        </strong>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Calendario de cuotas pendientes -->
              <div class="row small mb-3">
                <div class="col-12">
                  <div class="cuotas-section">
                    <h6 class="text-center mb-3 fw-bold text-primary">FECHAS ESTIMADAS DE PAGO</h6>

                    <div class="cuotas-list">
                      <div *ngFor="let cuota of cuotasCashea; let i = index"
                        class="cuota-item d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div class="cuota-info text-center w-60">
                          <i class="bi bi-calendar-event text-info me-1"></i>
                          <small class="text-muted">Cuota {{ cuota.id }}</small>
                          <div class="fw-bold">{{ cuota.fecha }}</div>
                        </div>
                        <div class="cuota-monto text-center w-40">
                          <div class="fw-bold">{{ formatearMoneda(cuota.monto) }}</div>
                          <small class="badge" [class.badge-pagada]="cuota.pagada"
                            [class.badge-adelantada]="cuota.seleccionada && !cuota.pagada"
                            [class.badge-pendiente]="!cuota.seleccionada && !cuota.pagada">
                            {{ cuota.pagada ? 'Pagada' : cuota.seleccionada ? 'Adelantada' :
                            'Pendiente' }}
                          </small>
                        </div>
                      </div>
                    </div>

                    <!-- Resumen de cuotas -->
                    <div class="resumen-cuotas d-flex justify-content-between align-items-center py-2 mt-2 border-top">
                      <div class="text-center w-50">
                        <small class="text-muted">CUOTAS PENDIENTES</small>
                        <div class="fw-bold text-warning">
                          {{ (datosRecibo?.cashea?.cantidadCuotas || cantidadCuotasCashea) -
                          (datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad)
                          }}
                        </div>
                      </div>
                      <div class="text-center w-50">
                        <small class="text-muted">DEUDA PENDIENTE</small>
                        <div class="fw-bold text-danger">
                          {{ formatearMoneda(datosRecibo?.cashea?.deudaPendiente ||
                          getDeudaPendienteCashea()) }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Abono - Versi√≥n profesional (ya incluye tabla de abonos) -->
            <div *ngIf="(datosRecibo?.configuracion?.formaPago || ventaParaRecibo?.formaPago) === 'abono'"
              class="resumen-abono">
              <!-- Forma de pago -->
              <div class="row small mb-3">
                <div class="col-12 text-center">
                  <span class="badge bg-warning text-dark fs-6">ABONO PARCIAL</span>
                </div>
              </div>

              <!-- Historial de abonos - TABLA COMPLETA (ya incluye m√©todos de pago) -->
              <div class="abonos-realizados mb-3">
                <h6 class="text-center mb-3 fw-bold text-primary">HISTORIAL DE ABONOS</h6>

                <div class="table-responsive">
                  <table class="table table-sm table-bordered mb-3">
                    <thead class="table-light">
                      <tr>
                        <th width="15%" class="text-center"># Abono</th>
                        <th width="25%">Fecha</th>
                        <th width="40%">M√©todos de Pago</th>
                        <th width="20%" class="text-end">Monto</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let abono of getAbonosAgrupados(ventaParaRecibo)">
                        <td class="text-center">
                          <span class="badge bg-secondary">{{ abono.numeroPago }}</span>
                        </td>
                        <td class="small">{{ abono.fechaFormateada }}</td>
                        <td class="small">
                          <div *ngFor="let metodo of abono.metodosDetalle; let last = last" class="mb-1">
                            <i class="bi {{ getIconoMetodoPago(metodo.tipo) }} me-1"></i>
                            {{ formatearTipoPago(metodo.tipo) }}
                            {{ formatearMoneda(metodo.monto, metodo.moneda) }}
                            <span *ngIf="metodo.referencia" class="text-muted">(Ref: {{ metodo.referencia }})</span>
                            <span *ngIf="metodo.banco" class="text-muted">- {{ metodo.banco }}</span>
                          </div>
                        </td>
                        <td class="text-end fw-bold">
                          {{ formatearMoneda(abono.montoAbonado, ventaParaRecibo.moneda) }}
                        </td>
                      </tr>
                    </tbody>
                    <tfoot *ngIf="getAbonosAgrupados(ventaParaRecibo).length > 0">
                      <tr class="table-success">
                        <td colspan="3" class="text-end fw-bold">TOTAL ABONADO:</td>
                        <td class="text-end fw-bold">
                          {{ formatearMoneda(getTotalAbonado(ventaParaRecibo), ventaParaRecibo.moneda) }}
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>

              <!-- Resumen financiero centrado -->
              <div class="row small">
                <div class="col-12">
                  <div class="resumen-financiero text-center">
                    <!-- Total a pagar -->
                    <div class="total-apagar-section mb-3">
                      <div class="total-apagar-label text-muted">TOTAL A PAGAR</div>
                      <div class="total-apagar-monto fs-5 fw-bold text-primary">
                        {{ formatearMoneda(getMontoTotalSeguro()) }}
                      </div>
                    </div>

                    <!-- Deuda pendiente -->
                    <div class="deuda-section mb-3">
                      <div class="deuda-label text-muted">DEUDA PENDIENTE</div>
                      <div class="deuda-monto fs-5 fw-bold text-danger">
                        {{ formatearMoneda(getDeudaPendienteAbono()) }}
                      </div>
                    </div>

                    <!-- Porcentaje pagado -->
                    <div class="progreso-section">
                      <div class="progreso-label text-muted">PORCENTAJE PAGADO</div>
                      <div class="progreso-porcentaje fs-5 fw-bold text-success mb-2">
                        {{ calcularPorcentajeParaRecibo() | number:'1.0-0' }}%
                      </div>
                      <div class="progress mx-auto" style="width: 80%; height: 8px;">
                        <div class="progress-bar bg-success" [style.width.%]="calcularPorcentajeParaRecibo()"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- Cierre de resumen-venta -->

          <!-- Totales compactos (COM√öN PARA TODOS) -->
          <div class="totales-compactos mb-3">
            <div class="row justify-content-end">
              <div class="col-md-6">
                <table class="table table-sm table-bordered">
                  <tr>
                    <td class="fw-bold">Subtotal:</td>
                    <td class="text-end">{{ formatearMoneda(getSubtotalSeguro()) }}</td>
                  </tr>
                  <tr *ngIf="getDescuentoSeguro() > 0">
                    <td class="fw-bold">Descuento:</td>
                    <td class="text-end text-danger">- {{ formatearMoneda(getDescuentoSeguro()) }}</td>
                  </tr>
                  <tr>
                    <td class="fw-bold">IVA:</td>
                    <td class="text-end">{{ formatearMoneda(getIvaSeguro()) }}</td>
                  </tr>

                  <!-- TOTAL A PAGAR -->
                  <tr class="table-info">
                    <td class="fw-bold">Total a pagar:</td>
                    <td class="text-end fw-bold">{{ formatearMoneda(getMontoTotalSeguro()) }}</td>
                  </tr>

                  <!-- ABONO: Mostrar total abonado -->
                  <tr *ngIf="ventaParaRecibo?.formaPago === 'abono'" class="table-warning">
                    <td class="fw-bold">Total abonado:</td>
                    <td class="text-end fw-bold">{{ formatearMoneda(getTotalPagadoSeguro()) }}</td>
                  </tr>
                </table>
              </div>
            </div>
          </div>

          <!-- Observaciones compactas -->
          <div class="observaciones-compactas mb-3" *ngIf="datosRecibo?.observaciones">
            <div class="alert alert-warning py-1 small mb-0">
              <strong>Observaci√≥n:</strong> {{ datosRecibo?.observaciones }}
            </div>
          </div>

          <!-- T√©rminos compactos -->
          <div class="terminos-compactos mt-3 pt-2 border-top">
            <div class="row small text-muted">
              <div class="col-md-8">
                <p class="mb-1">
                  <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                  Pasados 30 d√≠as no nos hacemos responsables de trabajos no retirados
                </p>
              </div>
              <div class="col-md-4 text-end">
                <small>{{ currentYear }} ¬© New Vision Lens 2020</small>
              </div>
            </div>
          </div>

          <!-- Mensaje final -->
          <div class="mensaje-final text-center mt-2 pt-2 border-top">
            <p class="mb-0 small text-primary fw-bold">
              <i class="bi bi-check-circle me-1"></i>
              {{ getMensajeFinal() }}
            </p>
          </div>
        </div> <!-- Cierre de recibo-container -->
      </div> <!-- Cierre de modal-body -->

      <!-- Footer del Modal Recibo -->
      <div class="modal-footer-recibo">
        <div class="footer-actions">
          <div class="footer-section-left">
            <!-- Compartir con todas las opciones incluyendo PDF -->
            <div class="btn-group" ngbDropdown>
              <button type="button" class="btn btn-compartir btn-recibo" ngbDropdownToggle>
                <i class="bi bi-share me-2"></i>
                Compartir
              </button>
              <div class="dropdown-menu" ngbDropdownMenu>
                <!-- Descargar PDF dentro del men√∫ -->
                <button ngbDropdownItem (click)="descargarPDF()">
                  <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                  Descargar PDF
                </button>
                <div class="dropdown-divider"></div>
                <button ngbDropdownItem (click)="compartirWhatsApp()">
                  <i class="bi bi-whatsapp text-success me-2"></i>
                  WhatsApp
                </button>
                <button ngbDropdownItem (click)="copiarEnlace()">
                  <i class="bi bi-link text-info me-2"></i>
                  Copiar Enlace
                </button>
              </div>
            </div>
          </div>

          <div class="footer-section-right">
            <!-- Imprimir -->
            <button type="button" class="btn btn-outline-secondary btn-recibo" (click)="imprimirRecibo()">
              <i class="bi bi-printer me-2"></i>
              Imprimir
            </button>

            <!-- Cerrar -->
            <button type="button" class="btn btn-primary btn-recibo" (click)="cerrarModalRecibo()">
              <i class="bi bi-check me-2"></i>
              Listo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade show" *ngIf="mostrarModalRecibo"></div>


<!-- Modal de Resumen Financiero -->
<div class="modal fade" id="modalResumenFinanciero" tabindex="-1" aria-hidden="true" #modalResumenFinanciero>
  <div class="modal-dialog modal-lg-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0">
      <!-- Header del Modal -->
      <div class="modal-header-moderno">
        <div class="modal-header-content">
          <div class="modal-header-icon">
            <i class="bi bi-graph-up"></i>
          </div>
          <div class="modal-header-text">
            <h4 class="modal-header-title">Resumen Financiero</h4>
            <div class="modal-header-subtitle">
              An√°lisis completo de ventas, abonos y deudas pendientes
            </div>
          </div>
        </div>
        <div class="modal-header-actions">
          <!-- Bot√≥n X para cerrar -->
          <button type="button" class="btn-close-modal" (click)="cerrarModal()" aria-label="Close">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <!-- Body del Modal -->
      <div class="modal-body">
        <!-- Panel de Filtros Compacto (No flotante) -->
        <div class="panel-filtros-compacto mb-4">
          <div class="card border-0 shadow-sm">
            <div class="card-body p-3">
              <div class="d-flex align-items-center justify-content-between">
                <!-- Icono y t√≠tulo -->
                <div class="d-flex align-items-center">
                  <div
                    class="icono-filtro-panel bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                    <i class="bi bi-sliders"></i>
                  </div>
                  <div>
                    <span class="fw-semibold text-primary">Filtros del Resumen</span>
                    <small class="text-muted d-block small">Personaliza el an√°lisis financiero</small>
                  </div>
                </div>

                <!-- Filtros r√°pidos y contador -->
                <div class="d-flex align-items-center">
                  <!-- Contador de filtros activos -->
                  <span class="badge bg-primary rounded-pill me-3" *ngIf="contarFiltrosActivos() > 0">
                    {{ contarFiltrosActivos() }} activo{{ contarFiltrosActivos() > 1 ? 's' : '' }}
                  </span>

                  <!-- Filtros r√°pidos -->
                  <div class="d-flex flex-wrap gap-1 me-3">
                    <button type="button" class="btn btn-sm btn-periodo-rapido"
                      [class.active]="resumenFiltros.periodo === 'hoy'" (click)="aplicarPeriodoResumen('hoy')"
                      title="Hoy">
                      <i class="bi bi-calendar-day"></i>
                      <span class="d-none d-sm-inline ms-1">Hoy</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-periodo-rapido"
                      [class.active]="resumenFiltros.periodo === 'semana'" (click)="aplicarPeriodoResumen('semana')"
                      title="Esta semana">
                      <i class="bi bi-calendar-week"></i>
                      <span class="d-none d-sm-inline ms-1">Semana</span>
                    </button>
                    <button type="button" class="btn btn-sm btn-periodo-rapido"
                      [class.active]="resumenFiltros.periodo === 'mes'" (click)="aplicarPeriodoResumen('mes')"
                      title="Este mes">
                      <i class="bi bi-calendar-month"></i>
                      <span class="d-none d-sm-inline ms-1">Mes</span>
                    </button>
                  </div>

                  <!-- Bot√≥n para mostrar/ocultar filtros avanzados -->
                  <button class="btn btn-sm btn-toggle-avanzado" type="button" (click)="toggleFiltrosAvanzados()"
                    [attr.aria-expanded]="mostrarFiltrosAvanzados" [class.active]="mostrarFiltrosAvanzados">
                    <i class="bi bi-gear me-1"></i>
                    <span>{{ mostrarFiltrosAvanzados ? 'Ocultar' : 'Avanzado' }}</span>
                    <i class="bi bi-chevron-down ms-1 toggle-icon" [class.rotated]="mostrarFiltrosAvanzados"></i>
                  </button>
                </div>
              </div>

              <!-- Filtros avanzados (Mostrar/Ocultar) -->
              <div class="filtros-avanzados-container mt-3" *ngIf="mostrarFiltrosAvanzados">
                <div class="border-top pt-3">
                  <div class="row g-3">
                    <!-- Rango de fechas personalizado -->
                    <div class="col-lg-6">
                      <div class="filtro-item">
                        <label class="form-label small fw-semibold text-primary mb-2">
                          <i class="bi bi-calendar-range me-1"></i>Rango de Fechas
                        </label>
                        <div class="input-group input-group-sm">
                          <span class="input-group-text bg-light">
                            <i class="bi bi-calendar"></i>
                          </span>
                          <input type="date" class="form-control" [(ngModel)]="resumenFiltros.fechaDesde"
                            (change)="actualizarResumen()" placeholder="Desde">
                          <span class="input-group-text bg-light">a</span>
                          <input type="date" class="form-control" [(ngModel)]="resumenFiltros.fechaHasta"
                            (change)="actualizarResumen()" placeholder="Hasta">
                        </div>
                      </div>
                    </div>

                    <!-- A√±o y Mes -->
                    <div class="col-lg-3">
                      <div class="filtro-item">
                        <label class="form-label small fw-semibold text-primary mb-2">
                          <i class="bi bi-calendar me-1"></i>A√±o
                        </label>
                        <select class="form-select form-select-sm" [(ngModel)]="resumenFiltros.anio"
                          (change)="actualizarResumen()">
                          <option value="">Seleccionar a√±o</option>
                          <option *ngFor="let anio of anosDisponibles" [value]="anio">{{ anio }}</option>
                        </select>
                      </div>
                    </div>

                    <div class="col-lg-3">
                      <div class="filtro-item">
                        <label class="form-label small fw-semibold text-primary mb-2">
                          <i class="bi bi-calendar3 me-1"></i>Mes
                        </label>
                        <select class="form-select form-select-sm" [(ngModel)]="resumenFiltros.mes"
                          (change)="actualizarResumen()">
                          <option value="">Todos los meses</option>
                          <option *ngFor="let mes of mesesDisponibles; let i = index" [value]="i+1">
                            {{ mes }}
                          </option>
                        </select>
                      </div>
                    </div>

                    <!-- Asesor -->
                    <div class="col-lg-6">
                      <div class="filtro-item">
                        <label class="form-label small fw-semibold text-primary mb-2">
                          <i class="bi bi-person-badge me-1"></i>Asesor
                        </label>
                        <select class="form-select form-select-sm" [(ngModel)]="resumenFiltros.asesor"
                          (change)="actualizarResumen()">
                          <option value="">Todos los asesores</option>
                          <option *ngFor="let asesor of asesores" [value]="asesor.id">
                            {{ asesor.nombre }}
                          </option>
                        </select>
                      </div>
                    </div>

                    <!-- Forma de Pago -->
                    <div class="col-lg-6">
                      <div class="filtro-item">
                        <label class="form-label small fw-semibold text-primary mb-2">
                          <i class="bi bi-credit-card me-1"></i>Forma de Pago
                        </label>
                        <select class="form-select form-select-sm" [(ngModel)]="resumenFiltros.formaPago"
                          (change)="actualizarResumen()">
                          <option value="">Todas las formas</option>
                          <option value="contado">Contado</option>
                          <option value="contado-pendiente">Contado - Pendiente por Pago</option>
                          <option value="abono">Abono</option>
                          <option value="cashea">Cashea</option>
                          <option value="credito">Cr√©dito</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Bot√≥n para limpiar todos los filtros -->
                  <div class="d-flex justify-content-end mt-3">
                    <button class="btn btn-sm btn-limpiar-filtros" (click)="limpiarTodosLosFiltros()"
                      *ngIf="contarFiltrosActivos() > 0">
                      <i class="bi bi-x-circle me-1"></i>
                      Limpiar todos los filtros
                    </button>
                  </div>
                </div>
              </div>

              <!-- Filtros Activos (chips) -->
              <div class="filtros-activos-chips mt-3" *ngIf="contarFiltrosActivos() > 0">
                <div class="d-flex align-items-center flex-wrap gap-2">
                  <small class="text-muted">
                    <i class="bi bi-funnel me-1"></i>Filtros aplicados:
                  </small>

                  <!-- Filtro de per√≠odo -->
                  <span class="filtro-chip" *ngIf="resumenFiltros.periodo">
                    <i class="bi bi-calendar-range me-1"></i>
                    {{ getPeriodoDisplay() }}
                    <i class="bi bi-x ms-1" (click)="limpiarFiltroPeriodo()"></i>
                  </span>

                  <!-- Filtro de a√±o -->
                  <span class="filtro-chip" *ngIf="resumenFiltros.anio">
                    <i class="bi bi-calendar-year me-1"></i>A√±o {{ resumenFiltros.anio }}
                    <i class="bi bi-x ms-1" (click)="limpiarFiltroAnio()"></i>
                  </span>

                  <!-- Filtro de mes -->
                  <span class="filtro-chip" *ngIf="resumenFiltros.mes">
                    <i class="bi bi-calendar-month me-1"></i>{{ getMesDisplay() }}
                    <i class="bi bi-x ms-1" (click)="limpiarFiltroMes()"></i>
                  </span>

                  <!-- Filtro de asesor -->
                  <span class="filtro-chip" *ngIf="resumenFiltros.asesor">
                    <i class="bi bi-person-badge me-1"></i>{{ getAsesorNombre(resumenFiltros.asesor) }}
                    <i class="bi bi-x ms-1" (click)="limpiarFiltroAsesor()"></i>
                  </span>

                  <!-- Filtro de forma de pago -->
                  <span class="filtro-chip" *ngIf="resumenFiltros.formaPago">
                    <i class="bi bi-credit-card me-1"></i>{{ getFormaPagoDisplay(resumenFiltros.formaPago) }}
                    <i class="bi bi-x ms-1" (click)="limpiarFiltroFormaPago()"></i>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de Montos Detallados -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-primary text-white py-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-currency-dollar me-2"></i>
                  <h5 class="mb-0">Resumen Financiero</h5>
                  <span class="ms-auto badge bg-light text-dark">
                    {{ getFechaRango() }}
                  </span>
                </div>
              </div>
              <div class="card-body">
                <div class="row">
                  <!-- Monto Total General -->
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 border-primary">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="monto-icon bg-primary text-white me-3">
                            <i class="bi bi-cash-stack"></i>
                          </div>
                          <div class="monto-content">
                            <div class="monto-label text-muted">Monto Total General</div>
                            <div class="monto-valor text-primary fw-bold fs-4">
                              {{ getMontoTotalGeneral() }}
                            </div>
                            <div class="monto-subtext small">
                              Valor total de ventas
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Total Abonos Recibidos -->
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 border-success">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="monto-icon bg-success text-white me-3">
                            <i class="bi bi-cash-coin"></i>
                          </div>
                          <div class="monto-content">
                            <div class="monto-label text-muted">Total Abonos Recibidos</div>
                            <div class="monto-valor text-success fw-bold fs-4">
                              {{ getTotalAbonosRecibidos() }}
                            </div>
                            <div class="monto-subtext small">
                              Pagos recibidos a la fecha
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Deuda Pendiente por Cobrar -->
                  <div class="col-md-4 mb-3">
                    <div class="card h-100 border-warning">
                      <div class="card-body">
                        <div class="d-flex align-items-center">
                          <div class="monto-icon bg-warning text-white me-3">
                            <i class="bi bi-clock-history"></i>
                          </div>
                          <div class="monto-content">
                            <div class="monto-label text-muted">Deuda Pendiente por Cobrar</div>
                            <div class="monto-valor text-warning fw-bold fs-4">
                              {{ getDeudaPendienteTotal() }}
                            </div>
                            <div class="monto-subtext small">
                              Monto por recibir
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Desglose de Deuda Pendiente -->
                <div class="row mt-3" *ngIf="getDeudaPendienteTotal() !== '0'">
                  <div class="col-12">
                    <div class="card border-0 bg-light">
                      <div class="card-body">
                        <h6 class="mb-3 text-muted">
                          <i class="bi bi-pie-chart me-2"></i>
                          Desglose de Deuda Pendiente
                        </h6>
                        <div class="row">
                          <!-- Deuda por Cashea -->
                          <div class="col-md-4">
                            <div class="deuda-item">
                              <div class="deuda-header">
                                <span class="deuda-label">
                                  <i class="bi bi-calendar-check text-info me-2"></i>
                                  Por Cashea
                                </span>
                                <span class="deuda-monto text-info">
                                  {{ getDeudaPorCashea() }}
                                </span>
                              </div>
                              <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-info" [style.width.%]="getPorcentajeDeuda('cashea')">
                                </div>
                              </div>
                              <small class="text-muted">
                                {{ getCantidadVentasPorTipo('cashea') }} ventas pendientes
                              </small>
                            </div>
                          </div>

                          <!-- Deuda por Abonos -->
                          <div class="col-md-4">
                            <div class="deuda-item">
                              <div class="deuda-header">
                                <span class="deuda-label">
                                  <i class="bi bi-piggy-bank text-warning me-2"></i>
                                  Por Abonos
                                </span>
                                <span class="deuda-monto text-warning">
                                  {{ getDeudaPorAbonos() }}
                                </span>
                              </div>
                              <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-warning" [style.width.%]="getPorcentajeDeuda('abono')">
                                </div>
                              </div>
                              <small class="text-muted">
                                {{ getCantidadVentasPorTipo('abono') }} ventas pendientes
                              </small>
                            </div>
                          </div>

                          <!-- Deuda por Contado Pendiente -->
                          <div class="col-md-4">
                            <div class="deuda-item">
                              <div class="deuda-header">
                                <span class="deuda-label">
                                  <i class="bi bi-credit-card text-danger me-2"></i>
                                  Por Contado Pendiente
                                </span>
                                <span class="deuda-monto text-danger">
                                  {{ getDeudaPorContadoPendiente() }}
                                </span>
                              </div>
                              <div class="progress mt-2" style="height: 5px;">
                                <div class="progress-bar bg-danger" [style.width.%]="getPorcentajeDeuda('contado')">
                                </div>
                              </div>
                              <small class="text-muted">
                                {{ getCantidadVentasPorTipo('contado') }} ventas pendientes
                              </small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Resumen por Forma de Pago -->
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="card border-0">
                      <div class="card-body">
                        <h6 class="mb-3 text-muted">
                          <i class="bi bi-credit-card-2-front me-2"></i>
                          Resumen por Forma de Pago
                        </h6>
                        <div class="row">
                          <!-- Contado -->
                          <div class="col-md-3 col-6 mb-3">
                            <div class="forma-pago-item text-center">
                              <div class="forma-pago-icon bg-primary text-white">
                                <i class="bi bi-cash"></i>
                              </div>
                              <div class="forma-pago-info mt-2">
                                <div class="forma-pago-label">Contado</div>
                                <div class="forma-pago-monto fw-bold">
                                  {{ getMontoContado() }}
                                </div>
                                <small class="text-muted">
                                  {{ getCantidadVentasPorFormaPago('contado') }} ventas
                                </small>
                              </div>
                            </div>
                          </div>

                          <!-- Abono -->
                          <div class="col-md-3 col-6 mb-3">
                            <div class="forma-pago-item text-center">
                              <div class="forma-pago-icon bg-success text-white">
                                <i class="bi bi-piggy-bank"></i>
                              </div>
                              <div class="forma-pago-info mt-2">
                                <div class="forma-pago-label">Abonos</div>
                                <div class="forma-pago-monto fw-bold">
                                  {{ getMontoAbonos() }}
                                </div>
                                <small class="text-muted">
                                  {{ getCantidadVentasPorFormaPago('abono') }} ventas
                                </small>
                              </div>
                            </div>
                          </div>

                          <!-- Cashea -->
                          <div class="col-md-3 col-6 mb-3">
                            <div class="forma-pago-item text-center">
                              <div class="forma-pago-icon bg-info text-white">
                                <i class="bi bi-calendar-check"></i>
                              </div>
                              <div class="forma-pago-info mt-2">
                                <div class="forma-pago-label">Cashea</div>
                                <div class="forma-pago-monto fw-bold">
                                  {{ getMontoCashea() }}
                                </div>
                                <small class="text-muted">
                                  {{ getCantidadVentasPorFormaPago('cashea') }} ventas
                                </small>
                              </div>
                            </div>
                          </div>

                          <!-- Cr√©dito -->
                          <div class="col-md-3 col-6 mb-3">
                            <div class="forma-pago-item text-center">
                              <div class="forma-pago-icon bg-secondary text-white">
                                <i class="bi bi-credit-card"></i>
                              </div>
                              <div class="forma-pago-info mt-2">
                                <div class="forma-pago-label">Cr√©dito</div>
                                <div class="forma-pago-monto fw-bold">
                                  {{ getMontoCredito() }}
                                </div>
                                <small class="text-muted">
                                  {{ getCantidadVentasPorFormaPago('credito') }} ventas
                                </small>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Secci√≥n de gr√°ficos o an√°lisis adicionales -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-light py-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-bar-chart me-2 text-primary"></i>
                  <h6 class="mb-0 fw-semibold">An√°lisis Detallado</h6>
                </div>
              </div>
              <div class="card-body">

                <!-- Fila 1: Gr√°ficos principales - Dise√±o Moderno -->
                <div class="row mb-4">
                  <!-- Ventas por D√≠a - Moderno -->
                  <div class="col-md-6 mb-4">
                    <div class="card card-chart-moderno border-0 shadow-sm h-100">
                      <div class="card-header-chart d-flex align-items-center justify-content-between py-3 px-4">
                        <div>
                          <h6 class="mb-0 fw-semibold text-primary">
                            <i class="bi bi-bar-chart-line-fill me-2"></i>
                            Ventas por D√≠a
                          </h6>
                          <small class="text-muted" id="ventasDiasRango">
                            {{ getRangoFechasVentas() }}
                          </small>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Ver detalles</a></li>
                            <li><a class="dropdown-item" href="#">Exportar datos</a></li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                          <div>
                            <h3 class="mb-0 fw-bold" id="ventasTotalDias">
                              {{ getTotalVentasPeriodo() | currency:simboloMonedaSistema }}
                            </h3>
                            <small class="text-success">
                              <i class="bi bi-arrow-up-right me-1"></i>
                              <span id="variacionVentas">+12.5%</span> vs. per√≠odo anterior
                            </small>
                          </div>
                          <div class="icono-grafico-grande bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                            <i class="bi bi-calendar-week fs-4"></i>
                          </div>
                        </div>
                        <div class="chart-container-moderno" style="height: 220px;">
                          <canvas id="ventasPorDiaChart"></canvas>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                          <div class="estadistica-rapida">
                            <small class="text-muted">D√≠a m√°s alto:</small>
                            <div class="fw-semibold" id="diaMasAlto">Vie: {{ getMaxVentaDia() |
                              currency:simboloMonedaSistema }}</div>
                          </div>
                          <div class="estadistica-rapida">
                            <small class="text-muted">Promedio diario:</small>
                            <div class="fw-semibold" id="promedioDiario">{{ getPromedioVentas() |
                              currency:simboloMonedaSistema }}</div>
                          </div>
                          <div class="estadistica-rapida">
                            <small class="text-muted">Total d√≠as:</small>
                            <div class="fw-semibold" id="totalDias">{{ getTotalDias() }} d√≠as</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Comparativa Mensual - Moderno -->
                  <div class="col-md-6 mb-4">
                    <div class="card card-chart-moderno border-0 shadow-sm h-100">
                      <div class="card-header-chart d-flex align-items-center justify-content-between py-3 px-4">
                        <div>
                          <h6 class="mb-0 fw-semibold text-success">
                            <i class="bi bi-graph-up-arrow me-2"></i>
                            Comparativa Mensual
                          </h6>
                          <small class="text-muted" id="comparativaRango">
                            {{ getMesActual() }} vs {{ getMesAnterior() }}
                          </small>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-success dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-filter"></i> Filtros
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" (click)="cambiarPeriodoComparativa('mes')">Por mes</a>
                            </li>
                            <li><a class="dropdown-item" href="#" (click)="cambiarPeriodoComparativa('trimestre')">Por
                                trimestre</a></li>
                            <li><a class="dropdown-item" href="#" (click)="cambiarPeriodoComparativa('anio')">Por
                                a√±o</a></li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <div class="row mb-3">
                          <div class="col-6">
                            <div class="indicador-comparativa actual">
                              <small class="text-muted d-block">Mes Actual</small>
                              <h3 class="mb-0 fw-bold text-success">
                                {{ getVentasMesActual() | currency:simboloMonedaSistema }}
                              </h3>
                            </div>
                          </div>
                          <div class="col-6">
                            <div class="indicador-comparativa anterior text-end">
                              <small class="text-muted d-block">Mes Anterior</small>
                              <h3 class="mb-0 fw-bold text-secondary">
                                {{ getVentasMesAnterior() | currency:simboloMonedaSistema }}
                              </h3>
                            </div>
                          </div>
                        </div>
                        <div class="chart-container-moderno" style="height: 220px;">
                          <canvas id="comparativaMensualChart"></canvas>
                        </div>
                        <div class="mt-3 d-flex justify-content-between align-items-center">
                          <div class="variacion-indicador">
                            <div class="d-flex align-items-center">
                              <div class="variacion-icono me-2" [ngClass]="getVariacionClase()">
                                <i class="bi" [class.bi-arrow-up-right]="getVariacion() > 0"
                                  [class.bi-arrow-down-right]="getVariacion() <= 0"></i>
                              </div>
                              <div>
                                <div class="fw-semibold" [ngClass]="getVariacionClase()">
                                  {{ getVariacion() | number:'1.1-1' }}%
                                </div>
                                <small class="text-muted">Variaci√≥n mensual</small>
                              </div>
                            </div>
                          </div>
                          <div class="meta-progreso">
                            <small class="text-muted d-block">Meta mensual</small>
                            <div class="progress" style="height: 6px; width: 120px;">
                              <div class="progress-bar bg-success" [style.width.%]="getPorcentajeMeta()"></div>
                            </div>
                            <small class="text-muted">{{ getPorcentajeMeta() | number:'1.0-0' }}%</small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Fila 2: Gr√°ficos secundarios - Moderno -->
                <div class="row">
                  <!-- Distribuci√≥n por Forma de Pago - Moderno -->
                  <div class="col-md-4 mb-4">
                    <div class="card card-chart-moderno border-0 shadow-sm h-100">
                      <div class="card-header-chart d-flex align-items-center justify-content-between py-3 px-4">
                        <div>
                          <h6 class="mb-0 fw-semibold text-info">
                            <i class="bi bi-pie-chart-fill me-2"></i>
                            Distribuci√≥n de Pagos
                          </h6>
                          <small class="text-muted">Porcentaje por tipo de pago</small>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical"></i>
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Ver detalle</a></li>
                            <li><a class="dropdown-item" href="#">Comparar con per√≠odo anterior</a></li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                          <div>
                            <h3 class="mb-0 fw-bold">{{ getTotalTransacciones() }}</h3>
                            <small class="text-muted">Total transacciones</small>
                          </div>
                          <div class="icono-grafico-pequeno bg-info bg-opacity-10 text-info rounded-circle p-2">
                            <i class="bi bi-credit-card fs-5"></i>
                          </div>
                        </div>
                        <div class="chart-container-moderno-dona" style="height: 180px;">
                          <canvas id="distribucionPagoChart"></canvas>
                        </div>
                        <div class="leyenda-distribucion mt-3">
                          <div class="row g-2">
                            <div class="col-6" *ngFor="let item of getDistribucionPago()">
                              <div class="d-flex align-items-center">
                                <div class="color-leyenda me-2" [style.background-color]="item.color"></div>
                                <div class="flex-grow-1">
                                  <div class="d-flex justify-content-between">
                                    <small class="fw-semibold">{{ item.tipo }}</small>
                                    <small class="text-muted">{{ item.porcentaje }}%</small>
                                  </div>
                                  <div class="fw-bold">{{ item.monto | currency:simboloMonedaSistema }}</div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Tendencia de Deuda - Moderno -->
                  <div class="col-md-4 mb-4">
                    <div class="card card-chart-moderno border-0 shadow-sm h-100">
                      <div class="card-header-chart d-flex align-items-center justify-content-between py-3 px-4">
                        <div>
                          <h6 class="mb-0 fw-semibold text-warning">
                            <i class="bi bi-clock-history me-2"></i>
                            Tendencia de Deuda
                          </h6>
                          <small class="text-muted" id="tendenciaPeriodo">
                            √öltimas 4 semanas
                          </small>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-warning dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-calendar"></i> Per√≠odo
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" (click)="cambiarTendenciaPeriodo('semanas')">Por
                                semanas</a></li>
                            <li><a class="dropdown-item" href="#" (click)="cambiarTendenciaPeriodo('meses')">Por
                                meses</a></li>
                            <li><a class="dropdown-item" href="#" (click)="cambiarTendenciaPeriodo('trimestres')">Por
                                trimestres</a></li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                          <div>
                            <h3 class="mb-0 fw-bold text-warning">
                              {{ getDeudaTotalActual() | currency:simboloMonedaSistema }}
                            </h3>
                            <small class="text-muted">Deuda total actual</small>
                          </div>
                          <div class="variacion-deuda" [ngClass]="getVariacionDeudaClase()">
                            <i class="bi me-1" [class.bi-arrow-up-right]="getVariacionDeuda() > 0"
                              [class.bi-arrow-down-right]="getVariacionDeuda() <= 0"></i>
                            {{ getVariacionDeuda() | number:'1.1-1' }}%
                          </div>
                        </div>
                        <div class="chart-container-moderno" style="height: 180px;">
                          <canvas id="tendenciaDeudaChart"></canvas>
                        </div>
                        <div class="mt-3">
                          <div class="row g-2">
                            <div class="col-4" *ngFor="let tipo of getTiposDeuda()">
                              <div class="tipo-deuda-item text-center">
                                <div class="fw-semibold small">{{ tipo.nombre }}</div>
                                <div class="fw-bold">{{ tipo.monto | currency:simboloMonedaSistema }}</div>
                                <div class="small text-muted">{{ tipo.cantidad }} ventas</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Ventas por Asesor - Moderno -->
                  <div class="col-md-4 mb-4">
                    <div class="card card-chart-moderno border-0 shadow-sm h-100">
                      <div class="card-header-chart d-flex align-items-center justify-content-between py-3 px-4">
                        <div>
                          <h6 class="mb-0 fw-semibold text-purple">
                            <i class="bi bi-person-badge me-2"></i>
                            Desempe√±o por Asesor
                          </h6>
                          <small class="text-muted" id="periodoAsesores">
                            {{ getMesActual() }}
                          </small>
                        </div>
                        <div class="dropdown">
                          <button class="btn btn-sm btn-outline-purple dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-people"></i> {{ getTotalAsesores() }}
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#">Ver ranking completo</a></li>
                            <li><a class="dropdown-item" href="#">Comparar per√≠odos</a></li>
                            <li><a class="dropdown-item" href="#">Exportar reporte</a></li>
                          </ul>
                        </div>
                      </div>
                      <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                          <div>
                            <h3 class="mb-0 fw-bold">{{ getMejorAsesor()?.nombre || 'N/A' }}</h3>
                            <small class="text-muted">Asesor l√≠der</small>
                          </div>
                          <div class="rendimiento-lider bg-purple bg-opacity-10 text-purple rounded p-2">
                            <div class="fw-bold">{{ getMejorAsesor()?.ventas | currency:simboloMonedaSistema }}</div>
                          </div>
                        </div>
                        <div class="chart-container-moderno" style="height: 180px;">
                          <canvas id="ventasPorAsesorChart"></canvas>
                        </div>
                        <div class="ranking-asesores mt-3">
                          <div class="row g-2">
                            <div class="col-12" *ngFor="let asesor of getTopAsesores(3); let i = index">
                              <div class="d-flex align-items-center ranking-item">
                                <div class="ranking-posicion me-2">
                                  <span class="badge" [ngClass]="getRankingBadgeClass(i)">{{ i + 1 }}</span>
                                </div>
                                <div class="flex-grow-1">
                                  <div class="d-flex justify-content-between align-items-center">
                                    <div class="fw-semibold small">{{ asesor.nombre }}</div>
                                    <div class="fw-bold">{{ asesor.ventas | currency:simboloMonedaSistema }}</div>
                                  </div>
                                  <div class="progress mt-1" style="height: 4px;">
                                    <div class="progress-bar bg-purple" [style.width.%]="asesor.porcentaje"></div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer del Modal con ambos botones -->
      <div class="modal-footer d-flex justify-content-between">
        <div>
          <!-- Bot√≥n Generar Informe Excel -->
          <button class="btn btn-excel-moderno" (click)="generarInformeDesdeModal()">
            <i class="bi bi-file-earmark-excel me-2"></i>
            <span>Generar Informe Excel</span>
          </button>

          <!-- Bot√≥n Descargar Resumen PDF -->
          <button type="button" class="btn btn-pdf-moderno ms-2" (click)="descargarResumenPDF()">
            <i class="bi bi-file-earmark-pdf me-2"></i>
            <span>Descargar Resumen PDF</span>
          </button>
        </div>

        <div>
          <!-- Bot√≥n Cerrar -->
          <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
            <i class="bi bi-x-circle me-2"></i>
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>