<div class="card contenedor-generar-venta" style="margin-bottom: 0rem;">
  <!-- Header modernizado del m√≥dulo -->
  <div class="card-header-moderno">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-clock-history"></i>
      </div>
      <div class="header-text">
        <h4 class="header-title">Historial de Ventas</h4>
        <div class="header-subtitle">Consulta y gestiona el historial completo de transacciones</div>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-excel-moderno" (click)="generarInforme()">
        <i class="bi bi-file-earmark-excel"></i>
        <span>Generar Informe</span>
      </button>
    </div>
  </div>

  <div class="card-body">

    <!-- Tarjetas de Resumen -->
    <div class="row mb-4">
      <!-- Total Ventas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon total me-3">
                <i class="bi bi-cart-check"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number">{{ getTotalVentas() }}</div>
                <div class="summary-label">Total Ventas</div>
                <div class="summary-subtext">Per√≠odo actual</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Completadas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon completed me-3">
                <i class="bi bi-check-circle"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-success">{{ getVentasCompletadas() }}</div>
                <div class="summary-label">Completadas</div>
                <div class="summary-subtext">{{ getMontoCompletadas() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Pendientes -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon pending me-3">
                <i class="bi bi-clock-history"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-warning">{{ getVentasPendientes() }}</div>
                <div class="summary-label">Pendientes</div>
                <div class="summary-subtext">{{ getMontoPendientes() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ventas Canceladas -->
      <div class="col-6 col-md-3 mb-3">
        <div class="card summary-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="summary-icon cancelled me-3">
                <i class="bi bi-x-circle"></i>
              </div>
              <div class="summary-content">
                <div class="summary-number text-danger">{{ getVentasCanceladas() }}</div>
                <div class="summary-label">Canceladas</div>
                <div class="summary-subtext">{{ getMontoCanceladas() }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros y b√∫squedas - Dise√±o Mejorado -->
    <div class="card mb-4 border-0 shadow-sm" style="margin-top: -30px;">
      <div class="card-header bg-light py-3">
        <div class="d-flex align-items-center">
          <i class="bi bi-funnel me-2 text-primary"></i>
          <h6 class="mb-0 fw-semibold">Filtros de B√∫squeda</h6>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3 filtros-responsive">

          <!-- Fila 1: Buscador, Estado, Forma de Pago -->
          <div class="col-12 col-md-6">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-search me-1"></i>Buscador General
              </label>
              <div class="input-group-moderno">
                <input type="text" class="form-control-moderno" placeholder="C√©dula, nombre, N¬∞ control..."
                  [(ngModel)]="filtros.busquedaGeneral" (ngModelChange)="onBusquedaInput($event)"
                  (blur)="onBusquedaBlur()" (keydown.enter)="onBusquedaEnter($event)">
                <span class="input-icon">
                  <i class="bi bi-search"></i>
                </span>
              </div>
              <small class="form-text text-muted mt-1">
                üí° Presiona Enter o haz clic fuera del campo para buscar
              </small>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-clipboard-check me-1"></i>Estado de Venta
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.estado" (change)="onFiltroChange()">
                <option value="">Todos los estados</option>
                <option value="completada">Completada</option>
                <option value="pendiente">Pendiente por pago</option>
                <option value="cancelada">Cancelada</option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-credit-card me-1"></i>Forma de Pago
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.formaPago" (change)="onFiltroChange()">
                <option value="">Todas las formas</option>
                <option value="contado">Contado</option>
                <option value="abono">Abono</option>
                <option value="cashea">Cashea</option>
                <option value="credito">Cr√©dito</option>
              </select>
            </div>
          </div>

          <!-- Fila 2: Asesor, Especialista, Rango de Fechas -->
          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-person-badge me-1"></i>Asesor Comercial
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.asesor" (change)="onFiltroChange()">
                <option value="">Todos los asesores ({{ asesores.length }})</option>
                <option *ngFor="let asesor of asesores" [value]="asesor.id">
                  {{ asesor.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-heart-pulse me-1"></i>Especialista M√©dico
              </label>
              <select class="form-select-moderno" [(ngModel)]="filtros.especialista" (change)="onFiltroChange()">
                <option value="">Todos los especialistas ({{ especialistas.length }})</option>
                <option *ngFor="let esp of especialistas" [value]="esp.id">
                  {{ esp.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="col-12 col-md-3">
            <div class="form-group-moderno">
              <label class="form-label fw-semibold text-primary mb-2">
                <i class="bi bi-calendar-range me-1"></i>Rango de Fechas
              </label>
              <div class="date-selector-moderno">
                <button class="btn-datepicker-moderno" type="button" (click)="toggleDatepicker()">
                  <i class="bi bi-calendar3 me-2"></i>
                  <span class="fecha-display">{{ getFechaDisplay() }}</span>
                  <i class="bi bi-chevron-down ms-2"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Fila 3: Acciones -->
          <div class="col-md-3">
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn-limpiar-filtros" type="button" (click)="limpiarFiltros()">
                <i class="bi bi-arrow-counterclockwise me-2"></i>
                Limpiar Filtros
              </button>
            </div>
          </div>

        </div>

        <!-- Filtros Activos -->
        <div class="filtros-activos mt-3" *ngIf="hayFiltrosActivos()">
          <div class="d-flex align-items-center flex-wrap gap-2">
            <span class="filtros-label text-muted small">
              <i class="bi bi-funnel me-1"></i>Filtros aplicados:
            </span>

            <span class="filtro-tag" *ngIf="filtros.busquedaGeneral">
              <i class="bi bi-search me-1"></i>"{{filtros.busquedaGeneral}}"
              <i class="bi bi-x ms-1" (click)="filtros.busquedaGeneral = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.estado">
              <i class="bi bi-clipboard-check me-1"></i>{{ getEstadoDisplay(filtros.estado) }}
              <i class="bi bi-x ms-1" (click)="filtros.estado = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.formaPago">
              <i class="bi bi-credit-card me-1"></i>{{ getFormaPagoDisplay(filtros.formaPago) }}
              <i class="bi bi-x ms-1" (click)="filtros.formaPago = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.asesor">
              <i class="bi bi-person-badge me-1"></i>{{ getAsesorNombre(filtros.asesor) }}
              <i class="bi bi-x ms-1" (click)="filtros.asesor = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.especialista">
              <i class="bi bi-heart-pulse me-1"></i>{{ getEspecialistaNombre(filtros.especialista) }}
              <i class="bi bi-x ms-1" (click)="filtros.especialista = ''; onFiltroChange()"></i>
            </span>

            <span class="filtro-tag" *ngIf="filtros.fechaDesde || filtros.fechaHasta">
              <i class="bi bi-calendar3 me-1"></i>{{ getFechaDisplay() }}
              <i class="bi bi-x ms-1" (click)="limpiarFechas(); onFiltroChange()"></i>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Datepicker Flotante -->
    <div class="modal fade show" [class.d-block]="showDatepicker" tabindex="-1" *ngIf="showDatepicker">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Seleccionar rango de fechas</h5>
            <button type="button" class="btn-close btn-close-white" (click)="closeDatepicker()"
              style="color: white !important;"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <!-- Selector de fecha √∫nica -->
              <div class="col-12">
                <label class="form-label fw-semibold">üìå Fecha √∫nica</label>
                <input type="date" class="form-control" [(ngModel)]="fechaUnica" [max]="maxDate" [min]="minDate"
                  (change)="onFechaUnicaChange()">
                <div class="form-text">Selecciona una fecha espec√≠fica</div>
              </div>

              <div class="col-12 text-center d-flex align-items-center justify-content-center">
                <hr class="my-3">
                <span class="text-muted">O selecciona un rango</span>
              </div>

              <!-- Rango de fechas -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Desde</label>
                <input type="date" class="form-control" [max]="filtros.fechaHasta || maxDate" [min]="minDate"
                  [(ngModel)]="filtros.fechaDesde" (change)="onRangoChange()">
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Hasta</label>
                <input type="date" class="form-control" [min]="filtros.fechaDesde || minDate" [max]="maxDate"
                  [(ngModel)]="filtros.fechaHasta" (change)="onRangoChange()">
              </div>

              <!-- Presets r√°pidos -->
              <div class="col-12">
                <label class="form-label fw-semibold">Rangos predefinidos</label>
                <div class="d-flex flex-wrap gap-2">
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'hoy'"
                    [class.btn-outline-secondary]="presetActivo !== 'hoy'" (click)="setRangoPreset('hoy')">
                    Hoy
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'ayer'"
                    [class.btn-outline-secondary]="presetActivo !== 'ayer'" (click)="setRangoPreset('ayer')">
                    Ayer
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana'"
                    [class.btn-outline-secondary]="presetActivo !== 'semana'" (click)="setRangoPreset('semana')">
                    Esta semana
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana_pasada'"
                    [class.btn-outline-secondary]="presetActivo !== 'semana_pasada'"
                    (click)="setRangoPreset('semana_pasada')">
                    Semana pasada
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes'"
                    [class.btn-outline-secondary]="presetActivo !== 'mes'" (click)="setRangoPreset('mes')">
                    Este mes
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes_pasado'"
                    [class.btn-outline-secondary]="presetActivo !== 'mes_pasado'"
                    (click)="setRangoPreset('mes_pasado')">
                    Mes pasado
                  </button>
                  <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'trimestre'"
                    [class.btn-outline-secondary]="presetActivo !== 'trimestre'" (click)="setRangoPreset('trimestre')">
                    Este trimestre
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="limpiarFechas()">
              <i class="bi bi-x-circle me-1"></i> Limpiar
            </button>
            <button type="button" class="btn btn-primary" (click)="aplicarFechas()">
              <i class="bi bi-check-circle me-1"></i> Aplicar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay para cerrar al hacer click fuera -->
    <div class="modal-backdrop fade show" *ngIf="showDatepicker" (click)="closeDatepicker()"></div>

    <!-- Controles de ordenamiento -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <span class="text-muted">Ordenar por:</span>
        <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="ordenamiento.campo">
          <option value="fecha">Fecha</option>
          <option value="numeroControl">N¬∞ Control</option>
          <option value="montoTotal">Monto Total</option>
          <option value="paciente">Paciente</option>
        </select>
        <button class="btn btn-outline-secondary btn-sm" (click)="cambiarOrden()">
          <i class="bi" [class.bi-arrow-up]="ordenamiento.ascendente"
            [class.bi-arrow-down]="!ordenamiento.ascendente"></i>
        </button>
      </div>

      <div class="text-muted">
        Mostrando {{ventasFiltradas.length}} de {{paginacion.totalItems}} ventas
      </div>
    </div>

    <!-- Lista de ventas - Dise√±o Innovador -->
    <div class="card border-0 shadow-sm">
      <div class="card-body p-0">
        <!-- Mensaje cuando no hay resultados -->
        <div *ngIf="ventasFiltradas.length === 0" class="text-center py-5">
          <div class="empty-state">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h4 class="mt-3 text-muted">No se encontraron ventas</h4>
            <p class="text-muted mb-4">
              <span *ngIf="hayFiltrosActivos()">
                No hay ventas que coincidan con los filtros aplicados.
              </span>
              <span *ngIf="!hayFiltrosActivos()">
                No hay ventas registradas en el historial.
              </span>
            </p>
            <button *ngIf="hayFiltrosActivos()" class="btn btn-primary" (click)="limpiarFiltros()">
              <i class="bi bi-arrow-counterclockwise me-1"></i>
              Limpiar filtros
            </button>
          </div>
        </div>

        <div class="ventas-grid" *ngIf="ventasFiltradas.length > 0">
          <div *ngFor="let venta of ventasFiltradas" class="venta-card">
            <!-- Tarjeta Principal -->
            <div class="venta-header" (click)="toggleDetalleVenta(venta.id)">
              <!-- Avatar y Info Principal -->
              <div class="venta-avatar">
                <div class="avatar-circle" [ngClass]="{
                            'avatar-success': venta.estado === 'completada',
                            'avatar-warning': venta.estado === 'pendiente',
                            'avatar-danger': venta.estado === 'cancelada'
                        }">
                  <i class="bi" [class.bi-check-lg]="venta.estado === 'completada'"
                    [class.bi-clock]="venta.estado === 'pendiente'" [class.bi-x-lg]="venta.estado === 'cancelada'"></i>
                </div>
              </div>

              <!-- Informaci√≥n Central -->
              <div class="venta-info">
                <div class="venta-title">
                  <h6 class="mb-1 fw-bold text-dark">
                    {{venta.paciente.nombre}}
                    <span class="estatus-pago-text" [ngClass]="getEstatusPagoClase(venta)">
                      ({{getEstatusPago(venta)}})
                    </span>
                  </h6>
                  <div class="venta-meta">
                    <span class="meta-item">
                      <i class="bi bi-person-badge text-muted"></i>
                      CI. {{venta.paciente.cedula}}
                    </span>
                    <span class="meta-divider">‚Ä¢</span>
                    <span class="meta-item">
                      <i class="bi bi-calendar3 text-muted"></i>
                      {{venta.fecha | date:'dd/MM/yyyy'}}
                    </span>
                    <span class="meta-divider">‚Ä¢</span>
                    <span class="meta-item">
                      <i class="bi bi-clock text-muted"></i>
                      {{venta.fecha | date:'HH:mm'}}
                    </span>
                  </div>
                </div>

                <!-- Informaci√≥n Adicional -->
                <div class="venta-details">
                  <div class="detail-item">
                    <small class="text-muted">Control</small>
                    <strong class="text-primary">#{{venta.numeroControl}}</strong>
                  </div>
                  <div class="detail-item">
                    <small class="text-muted">Asesor</small>
                    <span class="text-dark">{{venta.asesor.nombre}}</span>
                  </div>
                  <div class="detail-item">
                    <small class="text-muted">Forma Pago</small>
                    <span class="text-capitalize badge forma-pago-badge" [ngClass]="{
                                    'forma-contado': venta.formaPago === 'contado',
                                    'forma-cashea': venta.formaPago === 'cashea',
                                    'forma-abono': venta.formaPago === 'abono'
                                }">
                      {{venta.formaPago}}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Lado Derecho - Estado y Monto -->
              <div class="venta-sidebar">
                <!-- Estado -->
                <div class="estado-badge" [ngClass]="{
                            'estado-completada': venta.estado === 'completada',
                            'estado-pendiente': venta.estado === 'pendiente',
                            'estado-cancelada': venta.estado === 'cancelada'
                        }">
                  <div class="estado-dot"></div>
                  <span class="estado-text">{{venta.estado | titlecase}}</span>
                </div>

                <!-- Monto -->
                <div class="monto-display">
                  <div class="monto-amount text-primary fw-bold">
                    {{ getMontoParaMostrar(venta, venta.montoTotal) }}
                  </div>
                  <div class="monto-label text-muted small">Total</div>
                </div>

                <!-- √çcono Expandir -->
                <div class="expand-icon">
                  <i class="bi" [class.bi-chevron-down]="!venta.mostrarDetalle"
                    [class.bi-chevron-up]="venta.mostrarDetalle"></i>
                </div>
              </div>
            </div>

            <!-- Panel Expandible - Dise√±o Moderno -->
            <div *ngIf="venta.mostrarDetalle" class="venta-expandible">
              <div class="expandible-content">
                <div class="resumen-rapido">
                  <div class="resumen-item">
                    <i class="bi bi-cart-check text-primary"></i>
                    <div>
                      <small class="text-muted">Productos</small>
                      <div class="fw-semibold">{{venta.productos?.length || 0}} items</div>
                    </div>
                  </div>
                  <div class="resumen-item">
                    <i class="bi bi-currency-dollar text-success"></i>
                    <div>
                      <small class="text-muted">Subtotal</small>
                      <div class="fw-semibold">{{ getMontoParaMostrar(venta, venta.subtotal) }}</div>
                    </div>
                  </div>
                  <div class="resumen-item">
                    <i class="bi bi-percent text-warning"></i>
                    <div>
                      <small class="text-muted">Descuento</small>
                      <div class="fw-semibold">{{venta.descuento || 0}}%</div>
                    </div>
                  </div>
                  <div class="resumen-item">
                    <i class="bi bi-cash-coin text-info"></i>
                    <div>
                      <small class="text-muted">Pagado</small>
                      <div class="fw-semibold">{{ getMontoParaMostrar(venta, getTotalPagadoVenta(venta)) }}</div>
                    </div>
                  </div>

                  <div class="resumen-item" *ngIf="getDeudaPendiente(venta) > 0">
                    <i class="bi bi-clock-history text-danger"></i>
                    <div>
                      <small class="text-muted">Deuda Pendiente</small>
                      <div class="fw-semibold text-danger">
                        {{ getMontoParaMostrar(venta, getDeudaPendiente(venta)) }}
                        <small *ngIf="venta.formaPago === 'cashea'" class="text-muted d-block">
                          {{ venta.cantidadCuotas - venta.cuotasAdelantadas.length }} cuota pendiente
                        </small>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n Media: Detalles Espec√≠ficos -->
                <!-- <div class="detalles-grid">
                  <div class="detalle-seccion">
                    <h6 class="seccion-titulo">
                      <i class="bi bi-credit-card me-2"></i>
                      M√©todos de Pago
                    </h6>
                    <div class="metodos-pago">
                      <div *ngFor="let metodo of venta.metodosPago" class="metodo-item-detallado">
                       <div class="metodo-header">
                          <div class="metodo-icono" [ngClass]="'metodo-' + metodo.tipo">
                              <i class="bi" [class.bi-cash]="metodo.tipo === 'efectivo'"
                                  [class.bi-credit-card]="metodo.tipo === 'debito' || metodo.tipo === 'credito'"
                                  [class.bi-phone]="metodo.tipo === 'pagomovil'"
                                  [class.bi-bank]="metodo.tipo === 'transferencia'"
                                  [class.bi-currency-dollar]="metodo.tipo === 'zelle'"></i>
                          </div>
                          <div class="metodo-info">
                              <span class="metodo-tipo text-capitalize fw-semibold">{{getTipoPagoDisplay(metodo.tipo)}}</span>
                              <span class="metodo-monto">
                                  {{ getMontoDisplayMetodoPago(metodo, venta) }}
                              </span>
                          </div>
                      </div>

                        <div class="metodo-detalles">
                          <div class="detalle-linea-combinada" *ngIf="getEquivalenteDisplay(metodo, venta)">
                            <div class="detalle-item-combinado">
                              <i class="bi bi-arrow-left-right text-muted"></i>
                              <span class="detalle-texto">{{ getEquivalenteDisplay(metodo, venta) }}</span>
                            </div>
                            <div class="detalle-item-combinado">
                              <i class="bi bi-graph-up text-muted"></i>
                              <span class="detalle-texto">{{ getEquivalenteDisplay(metodo, venta) }}</span>
                            </div>
                          </div>

                          <div class="detalle-linea-combinada" *ngIf="metodo.referencia || getBancoDisplay(metodo)">
                            <div class="detalle-item-combinado" *ngIf="metodo.referencia">
                              <i class="bi bi-receipt text-muted"></i>
                              <span class="detalle-texto">
                                Ref: <strong>{{metodo.referencia}}</strong>
                              </span>
                            </div>

                            <div class="detalle-item-combinado" *ngIf="getBancoDisplay(metodo) && 
                              (metodo.tipo === 'pagomovil' || metodo.tipo === 'transferencia')">
                              <i class="bi bi-building text-muted"></i>
                              <span class="detalle-texto">
                                Banco: <strong>{{ getBancoDisplay(metodo) }}</strong>
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="detalle-seccion">
                    <h6 class="seccion-titulo">
                      <i class="bi bi-info-circle me-2"></i>
                      Informaci√≥n Adicional
                    </h6>
                    <div class="info-adicional-grid">

                      <div class="info-fila">
                        <div class="info-item destacado">
                          <div class="info-icono">
                            <i class="bi bi-person-badge"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Especialista</span>
                            <span class="info-value" [ngClass]="{'text-muted': !venta.especialista?.nombre}">
                              {{venta.especialista?.nombre || 'No asignado'}}
                              <span *ngIf="venta.especialista?.tipo" class="info-subtext">
                                - {{venta.especialista.tipo}}
                              </span>
                            </span>
                          </div>
                        </div>

                        <div class="info-item">
                          <div class="info-icono">
                            <i class="bi bi-person-gear"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Tipo Cliente</span>
                            <span class="info-value">
                              {{venta.paciente?.tipoPersona || 'Natural' | titlecase}}
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="info-fila">
                        <div class="info-item">
                          <div class="info-icono">
                            <i class="bi bi-box-seam"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Productos</span>
                            <span class="info-value">
                              {{venta.productos?.length || 0}}
                              <small class="text-muted d-block" *ngIf="venta.productos?.length === 1">
                                {{venta.productos[0]?.nombre}}
                              </small>
                              <small class="text-muted d-block" *ngIf="venta.productos?.length > 1">
                                {{venta.productos[0]?.nombre}} +{{venta.productos.length - 1}} m√°s
                              </small>
                            </span>
                          </div>
                        </div>

                        <div class="info-item" *ngIf="venta.formaPago === 'abono' || venta.formaPago === 'cashea'">
                          <div class="info-icono">
                            <i class="bi" [class.bi-piggy-bank]="venta.formaPago === 'abono'"
                              [class.bi-calendar-check]="venta.formaPago === 'cashea'"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label" *ngIf="venta.formaPago === 'abono'">Plan Abonos</span>
                            <span class="info-label" *ngIf="venta.formaPago === 'cashea'">Plan Cashea</span>
                            <span class="info-value">
                              <span *ngIf="venta.formaPago === 'abono'">
                                Abonado: {{getMontoParaMostrar(venta, venta.montoAbonado)}}
                                <small class="text-muted d-block">
                                  Pendiente: {{getMontoParaMostrar(venta, getDeudaPendiente(venta))}}
                                </small>
                              </span>
                              <span *ngIf="venta.formaPago === 'cashea'">
                                {{venta.cuotasAdelantadas?.length || 0}}/{{venta.cantidadCuotas}} cuotas
                                <small class="text-muted d-block">
                                  Nivel: {{venta.nivelCashea}} ‚Ä¢ Cuota: {{getMontoParaMostrar(venta,
                                  venta.montoPorCuota)}}
                                </small>
                              </span>
                            </span>
                          </div>
                        </div>
                      </div>

                      <div class="info-fila" *ngIf="venta.observaciones">
                        <div class="info-item observaciones" style="grid-column: 1 / -1;">
                          <div class="info-icono">
                            <i class="bi bi-chat-left-text"></i>
                          </div>
                          <div class="info-contenido">
                            <span class="info-label">Observaciones</span>
                            <span class="info-value observacion-texto">{{venta.observaciones}}</span>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>-->

                <!-- Secci√≥n Inferior: Acciones -->
                <div class="acciones-venta">
                  <div class="acciones-left">
                    <span class="text-muted small">
                      <i class="bi bi-clock-history me-1"></i>
                      Creado el {{venta.fecha | date:'dd/MM/yyyy'}}
                    </span>
                  </div>
                  <div class="acciones-right">
                    <button *ngIf="mostrarBotonEditar(venta)" class="btn btn-outline-primary btn-sm accion-btn"
                      (click)="editarVenta(venta)">
                      <i class="bi-cash-coin"></i>
                      <span>Abonar</span>
                    </button>

                    <button class="btn btn-outline-primary btn-sm accion-btn" (click)="verDetalleCompleto(venta)">
                      <i class="bi bi-eye"></i>
                      <span>Detalles</span>
                    </button>

                    <button class="btn btn-outline-primary btn-sm accion-btn" (click)="verRecibo(venta)">
                      <i class="bi bi-receipt"></i>
                      <span>Ver recibo</span>
                    </button>
                    <button *ngIf="venta.estado !== 'cancelada'" class="btn btn-outline-danger btn-sm accion-btn"
                      (click)="cancelarVenta(venta)">
                      <i class="bi bi-x-circle"></i>
                      <span>Cancelar</span>
                    </button>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n Estilo Bancario -->
    <div class="card mt-4">
      <div class="card-body">
        <div class="row align-items-center">
          <!-- Informaci√≥n de resultados -->
          <div class="col-md-4">
            <div class="d-flex align-items-center gap-3">
              <span class="text-muted small">
                Mostrando <strong>{{ ventasFiltradas.length }}</strong> de
                <strong>{{ paginacion.totalItems }}</strong> registros
              </span>

              <div class="vr"></div>

              <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="paginacion.itemsPorPagina"
                (change)="cambiarItemsPorPagina()">
                <option *ngFor="let opcion of paginacion.itemsPorPaginaOpciones" [value]="opcion">
                  {{ opcion }} por p√°gina
                </option>
              </select>
            </div>
          </div>

          <!-- Controles de paginaci√≥n centrados -->
          <div class="col-md-4">
            <div class="d-flex justify-content-center align-items-center gap-1">
              <!-- Navegaci√≥n r√°pida -->
              <button class="btn btn-sm btn-outline-secondary" (click)="primeraPagina()"
                [disabled]="paginacion.paginaActual === 1" title="Primera p√°gina">
                <i class="bi bi-chevron-double-left"></i>
              </button>

              <button class="btn btn-sm btn-outline-secondary" (click)="paginaAnterior()"
                [disabled]="paginacion.paginaActual === 1" title="P√°gina anterior">
                <i class="bi bi-chevron-left"></i>
              </button>

              <!-- N√∫meros de p√°gina -->
              <div class="btn-group mx-2" role="group">
                <button *ngFor="let pagina of paginacion.rangoPaginas" class="btn btn-sm"
                  [class.btn-primary]="pagina === paginacion.paginaActual"
                  [class.btn-outline-secondary]="pagina !== paginacion.paginaActual && pagina !== -1"
                  [class.btn-light]="pagina === -1" (click)="pagina !== -1 && irAPagina(pagina)"
                  [disabled]="pagina === -1">
                  {{ pagina === -1 ? '...' : pagina }}
                </button>
              </div>

              <button class="btn btn-sm btn-outline-secondary" (click)="paginaSiguiente()"
                [disabled]="paginacion.paginaActual === paginacion.totalPaginas" title="P√°gina siguiente">
                <i class="bi bi-chevron-right"></i>
              </button>

              <button class="btn btn-sm btn-outline-secondary" (click)="ultimaPagina()"
                [disabled]="paginacion.paginaActual === paginacion.totalPaginas" title="√öltima p√°gina">
                <i class="bi bi-chevron-double-right"></i>
              </button>
            </div>
          </div>

          <!-- Informaci√≥n de p√°gina -->
          <div class="col-md-4 text-end">
            <div class="d-flex align-items-center justify-content-end gap-3">
              <span class="text-muted small">
                P√°gina <strong>{{ paginacion.paginaActual }}</strong> de
                <strong>{{ paginacion.totalPaginas }}</strong>
              </span>

              <div class="vr"></div>

              <!-- Salto r√°pido a p√°gina -->
              <div class="input-group input-group-sm" style="width: 120px;">
                <input type="number" class="form-control" #paginaInput [min]="1" [max]="paginacion.totalPaginas"
                  placeholder="Ir a...">
                <button class="btn btn-outline-secondary" type="button" (click)="irAPagina(paginaInput.valueAsNumber)"
                  [disabled]="!paginaInput.value || paginaInput.valueAsNumber < 1 || paginaInput.valueAsNumber > paginacion.totalPaginas">
                  <i class="bi bi-arrow-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Paginaci√≥n M√≥vil (solo se muestra en pantallas peque√±as) -->
    <div class="d-lg-none mt-3">
      <div class="card">
        <div class="card-body py-2">
          <div class="row align-items-center">
            <div class="col-4">
              <button
                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                (click)="paginaAnterior()" [disabled]="paginacion.paginaActual === 1">
                <i class="bi bi-chevron-left"></i>
                <span>Ant</span>
              </button>
            </div>
            <div class="col-4 text-center">
              <span class="text-muted small">
                {{ paginacion.paginaActual }}/{{ paginacion.totalPaginas }}
              </span>
            </div>
            <div class="col-4">
              <button
                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                (click)="paginaSiguiente()" [disabled]="paginacion.paginaActual === paginacion.totalPaginas">
                <span>Sig</span>
                <i class="bi bi-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal de Confirmaci√≥n para Cancelar Venta -->
<ng-template #cancelarVentaModal let-modal>
  <div class="modal-header bg-primary text-white">
    <h5 class="modal-title">
      <i class="bi bi-exclamation-triangle me-2"></i>
      Confirmar Cancelaci√≥n
    </h5>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()"></button>
  </div>

  <div class="modal-body">
    <!-- Cambiamos alert-warning por alert-info con fondo azul claro -->
    <div class="alert alert-info" role="alert">
      <h6 class="alert-heading fw-bold">¬øEst√° seguro de que desea cancelar esta venta?</h6>
      <p class="mb-0 mt-2">
        <strong>Venta {{ formatNumeroVenta(selectedVenta?.id) }}</strong><br>
        <span *ngIf="selectedVenta?.paciente?.nombre">Paciente: {{ selectedVenta.paciente.nombre }}</span><br>
        <span *ngIf="selectedVenta?.montoTotal">Monto: {{ selectedVenta.montoTotal | currency }}</span>
      </p>
    </div>

    <div class="form-group mt-3">
      <label for="motivoCancelacion" class="form-label">
        <strong>Motivo de cancelaci√≥n:</strong>
      </label>
      <textarea id="motivoCancelacion" class="form-control" rows="3"
        placeholder="Ingrese el motivo de la cancelaci√≥n..." [(ngModel)]="motivoCancelacion" maxlength="500">
      </textarea>
      <small class="text-muted">{{ motivoCancelacion?.length || 0 }}/500 caracteres</small>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.dismiss()">
      <i class="bi bi-x-circle me-1"></i> Cancelar
    </button>
    <button type="button" class="btn btn-danger" (click)="confirmarCancelacion(modal)">
      <i class="bi bi-check-circle me-1"></i> Confirmar Cancelaci√≥n
    </button>
  </div>
</ng-template>


<!-- Modal de Detalle Completo de Venta - Dise√±o Simplificado -->
<ng-template #detalleVentaModal let-modal>
  <!-- Header con gradiente -->
  <div class="modal-header-detalle">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-file-earmark-text"></i>
      </div>
      <div class="header-text">
        <h5 class="modal-title">Detalle de Venta</h5>
        <div class="header-subtitle">
          <span class="badge badge-primary">#{{selectedVenta?.numeroControl}}</span>
          <span class="separator">‚Ä¢</span>
          <span class="fecha">{{selectedVenta?.fecha | date:'dd/MM/yyyy'}}</span>
        </div>
      </div>
    </div>
    <button type="button" class="btn-close btn-close-white" (click)="modal.dismiss()" aria-label="Cerrar"></button>
  </div>

  <div class="modal-body-detalle">
    <!-- Tarjeta de Informaci√≥n Principal -->
    <div class="info-card principal">
      <div class="card-header-detalle">
        <i class="bi bi-person-circle"></i>
        <span>Informaci√≥n del Paciente</span>
      </div>
      <div class="card-body-detalle">
        <div class="info-grid-2cols">
          <!-- Fila 1 -->
          <div class="info-row">
            <div class="info-item-detalle">
              <label>üë§ Paciente</label>
              <div class="value">{{selectedVenta?.paciente?.nombre}}</div>
            </div>
            <div class="info-item-detalle">
              <label>üÜî C√©dula</label>
              <div class="value">{{selectedVenta?.paciente?.cedula || 'No especificada'}}</div>
            </div>
          </div>

          <!-- Fila 2 -->
          <div class="info-row">
            <div class="info-item-detalle">
              <label>üìß Email</label>
              <div class="value">{{selectedVenta?.paciente?.email || 'No especificado'}}</div>
            </div>
            <div class="info-item-detalle">
              <label>üìû Tel√©fono</label>
              <div class="value">{{selectedVenta?.paciente?.telefono || 'No especificado'}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Personal Asignado -->
    <div class="info-card personal">
      <div class="card-header-detalle">
        <i class="bi bi-people"></i>
        <span>Personal Asignado</span>
      </div>
      <div class="card-body-detalle">
        <div class="personal-grid">
          <div class="info-item-detalle">
            <label>üë®‚Äçüíº Asesor</label>
            <div class="value">{{selectedVenta?.asesorNombre}}</div>
          </div>
          <div class="info-item-detalle">
            <label>üë®‚Äç‚öïÔ∏è Especialista</label>
            <div class="value">{{selectedVenta?.especialista?.nombre}}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Formulaci√≥n Cl√≠nica (si existe) -->
    <div class="info-card formulacion" *ngIf="selectedVenta?.historiaMedica?.formulacion">
      <div class="card-header-detalle">
        <i class="bi bi-eyeglasses"></i>
        <span>Formulaci√≥n Cl√≠nica</span>
      </div>
      <div class="card-body-detalle">
        <div class="formulacion-grid">
          <!-- Ojo Derecho -->
          <div class="ojo-card">
            <div class="ojo-header ojo-derecho">
              <i class="bi bi-eye"></i>
              <span>Ojo Derecho (OD)</span>
            </div>
            <div class="ojo-params">
              <div class="param">
                <span class="param-label">Esfera (Esf)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.esf || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Cilindro (Cil)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.cil || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Eje</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.eje || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Add</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.add || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Altura</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.alt || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">DP</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.od?.dp || '‚Äî'}}</span>
              </div>
            </div>
          </div>

          <!-- Ojo Izquierdo -->
          <div class="ojo-card">
            <div class="ojo-header ojo-izquierdo">
              <i class="bi bi-eye"></i>
              <span>Ojo Izquierdo (OI)</span>
            </div>
            <div class="ojo-params">
              <div class="param">
                <span class="param-label">Esfera (Esf)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.esf || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Cilindro (Cil)</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.cil || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Eje</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.eje || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Add</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.add || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">Altura</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.alt || '‚Äî'}}</span>
              </div>
              <div class="param">
                <span class="param-label">DP</span>
                <span class="param-value">{{selectedVenta?.historiaMedica?.formulacion?.oi?.dp || '‚Äî'}}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Recomendaciones -->
        <div class="recomendaciones" *ngIf="selectedVenta?.historiaMedica?.recomendaciones">
          <div class="recomendaciones-header">
            <i class="bi bi-stars"></i>
            <span>Recomendaciones</span>
          </div>
          <div class="recomendaciones-grid">
            <div class="recomendacion-item">
              <span class="rec-label">Montura</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.montura || '‚Äî'}}</span>
            </div>
            <div class="recomendacion-item">
              <span class="rec-label">Material</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.material || '‚Äî'}}</span>
            </div>
            <div class="recomendacion-item">
              <span class="rec-label">Cristal</span>
              <span class="rec-value">{{selectedVenta?.historiaMedica?.recomendaciones?.cristal || '‚Äî'}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Productos -->
    <div class="info-card productos">
      <div class="card-header-detalle">
        <i class="bi bi-cart"></i>
        <span>Productos y Servicios</span>
      </div>
      <div class="card-body-detalle">
        <div class="productos-list">
          <div *ngFor="let producto of selectedVenta?.productos" class="producto-item">
            <div class="producto-info">
              <div class="producto-nombre">{{producto.nombre}}</div>
              <div class="producto-codigo">C√≥digo: {{producto.codigo}}</div>
              <div class="producto-detalles">
                <span class="cantidad">{{producto.cantidad}} und</span>
                <span class="precio">{{producto.precio | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar' ? 'USD' :
                  'BS'}}</span>
                <span *ngIf="producto.aplicaIva" class="iva-badge">+IVA</span>
              </div>
            </div>
            <div class="producto-totales">
              <div class="subtotal">{{producto.subtotal | number:'1.2-2'}}</div>
              <div class="total">{{producto.total | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar' ? 'USD' :
                'BS'}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Configuraci√≥n de Pago -->
    <div class="info-card pago">
      <div class="card-header-detalle">
        <i class="bi bi-credit-card"></i>
        <span>Configuraci√≥n de Pago</span>
      </div>
      <div class="card-body-detalle">
        <div class="pago-grid-compact">

          <!-- Fila 1: Informaci√≥n B√°sica -->
          <div class="pago-row">
            <div class="pago-item-compact">
              <label>Forma de Pago</label>
              <div class="value highlight">{{getFormaPagoDisplay(selectedVenta?.formaPago)}}</div>
            </div>
            <div class="pago-item-compact">
              <label>Moneda</label>
              <div class="value">{{getMonedaDisplay(selectedVenta?.moneda)}}</div>
            </div>
            <div class="pago-item-compact" *ngIf="selectedVenta?.descuento > 0">
              <label>Descuento</label>
              <div class="value discount">{{selectedVenta?.descuento || 0}}%</div>
            </div>
          </div>

          <!-- Informaci√≥n espec√≠fica por tipo de pago -->

          <!-- Cashea: Dise√±o compacto -->
          <div *ngIf="selectedVenta?.formaPago === 'cashea'" class="pago-especifico">
            <div class="pago-row">
              <div class="pago-item-compact">
                <label><i class="bi bi-graph-up"></i> Nivel</label>
                <div class="value small">{{selectedVenta?.nivelCashea}}</div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-cash-coin"></i> Inicial</label>
                <div class="value small">
                  {{selectedVenta?.montoInicial | number:'1.2-2'}} {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-calendar-week"></i> Cuotas</label>
                <div class="value small">
                  {{selectedVenta?.cantidadCuotas}}x {{selectedVenta?.montoPorCuota | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact" *ngIf="selectedVenta?.cuotasAdelantadas?.length > 0">
                <label><i class="bi bi-lightning"></i> Adelantadas</label>
                <div class="value small info">
                  {{selectedVenta?.cuotasAdelantadas?.length}} ({{getTotalCuotasAdelantadas() | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}})
                </div>
              </div>
            </div>
          </div>

          <!-- Abono: Dise√±o compacto en l√≠nea -->
          <div *ngIf="selectedVenta?.formaPago === 'abono'" class="pago-especifico">
            <div class="pago-row">
              <div class="pago-item-compact">
                <label><i class="bi bi-check-circle"></i> Abonado</label>
                <div class="value small success">
                  {{selectedVenta?.montoAbonado | number:'1.2-2'}} {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-clock"></i> Pendiente</label>
                <div class="value small warning">
                  {{(selectedVenta?.total - selectedVenta?.montoAbonado) | number:'1.2-2'}}
                  {{getMonedaDisplay(selectedVenta?.moneda)}}
                </div>
              </div>
              <div class="pago-item-compact">
                <label><i class="bi bi-percent"></i> Progreso</label>
                <div class="value small">{{getPorcentajeAbonado()}}%</div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Tarjeta de M√©todos de Pago -->
    <div class="info-card metodos-pago-detalle" *ngIf="selectedVenta?.metodosPago?.length">
      <div class="card-header-detalle">
        <i class="bi bi-wallet2"></i>
        <span>M√©todos de Pago</span>
      </div>
      <div class="card-body-detalle">
        <div class="metodos-grid">
          <div *ngFor="let metodo of selectedVenta?.metodosPago" class="metodo-item-detalle">
            <div class="metodo-icono">
              <i class="bi" [class.bi-cash]="metodo.tipo === 'efectivo'"
                [class.bi-credit-card]="metodo.tipo === 'debito' || metodo.tipo === 'credito'"
                [class.bi-phone]="metodo.tipo === 'pagomovil'" [class.bi-bank]="metodo.tipo === 'transferencia'"
                [class.bi-currency-dollar]="metodo.tipo === 'zelle'"></i>
            </div>
            <div class="metodo-info-detalle">
              <div class="metodo-tipo">{{ getTipoPagoDisplay(metodo.tipo) }}</div>

              <!-- DISPLAY CORREGIDO DE MONTOS -->
              <div class="montos-linea">
                <!-- Pago en BOLIVARES - SOLO MONTO EN BS ALINEADO -->
                <div *ngIf="metodo.moneda_id === 'bolivar'" class="monto-simple text-success">
                  {{ metodo.monto | number:'1.2-2' }} Bs.
                </div>

                <!-- Pago en D√ìLARES -->
                <div *ngIf="metodo.moneda_id === 'dolar'" class="monto-simple text-success">
                  {{ metodo.monto | number:'1.2-2' }} USD
                </div>

                <!-- Pago en EUROS -->
                <div *ngIf="metodo.moneda_id === 'euro'" class="monto-simple text-success">
                  {{ metodo.monto | number:'1.2-2' }} EUR
                </div>
              </div>

              <!-- INFORMACI√ìN ADICIONAL CORREGIDA -->
              <div class="metodo-detalles-adicionales">
                <!-- Referencia - mostrar siempre que exista -->
                <div class="detalle-adicional" *ngIf="metodo.referencia">
                  <i class="bi bi-receipt"></i>
                  <span>Ref: {{metodo.referencia}}</span>
                </div>

                <!-- Banco - mostrar siempre que exista -->
                <div class="detalle-adicional" *ngIf="metodo.bancoNombre">
                  <i class="bi bi-building"></i>
                  <span>Banco: {{metodo.bancoNombre}} {{metodo.bancoCodigo ? '(' + metodo.bancoCodigo + ')' :
                    ''}}</span>
                </div>

                <!-- Tasa de cambio y equivalente - solo para pagos en bol√≠vares, al final -->
                <div *ngIf="metodo.moneda_id === 'bolivar' && metodo.monto_en_moneda_de_venta"
                  class="detalle-adicional">
                  <i class="bi bi-arrow-left-right"></i>
                  <span>
                    {{ getSimboloMonedaVenta() }}{{ metodo.monto_en_moneda_de_venta | number:'1.2-2' }}
                    (Tasa: 1 {{ getMonedaVentaDisplay() }} = {{ getTasaBolivar() | number:'1.2-2' }} Bs)
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tarjeta de Resumen Financiero -->
    <div class="info-card resumen">
      <div class="card-header-detalle">
        <i class="bi bi-calculator"></i>
        <span>Resumen Financiero</span>
      </div>
      <div class="card-body-detalle">
        <div class="resumen-grid">
          <div class="resumen-item">
            <span class="resumen-label">Subtotal</span>
            <span class="resumen-value">{{selectedVenta?.subtotal | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar'
              ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item" *ngIf="selectedVenta?.totalIva">
            <span class="resumen-label">IVA Total</span>
            <span class="resumen-value">{{selectedVenta?.totalIva | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar'
              ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item" *ngIf="selectedVenta?.totalDescuento">
            <span class="resumen-label">Descuento</span>
            <span class="resumen-value">-{{selectedVenta?.totalDescuento | number:'1.2-2'}} {{selectedVenta?.moneda ===
              'dolar' ? 'USD' : 'BS'}}</span>
          </div>
          <div class="resumen-item total">
            <span class="resumen-label">Total</span>
            <span class="resumen-value">{{selectedVenta?.total | number:'1.2-2'}} {{selectedVenta?.moneda === 'dolar' ?
              'USD' : 'BS'}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Observaciones -->
    <div class="info-card observaciones" *ngIf="selectedVenta?.observaciones">
      <div class="card-header-detalle">
        <i class="bi bi-chat-left-text"></i>
        <span>Observaciones</span>
      </div>
      <div class="card-body-detalle">
        <p class="observaciones-text">{{selectedVenta?.observaciones}}</p>
      </div>
    </div>
  </div>

  <!-- Footer del Modal -->
  <div class="modal-footer-detalle">
    <div class="footer-actions">
      <button type="button" class="btn btn-secondary btn-detalle" (click)="modal.dismiss()">
        <i class="bi bi-x-circle me-2"></i>
        Cerrar
      </button>
    </div>
  </div>
</ng-template>


<!-- Modal de Edici√≥n de Venta con Abono - MONEDA DE VENTA FIJA -->
<ng-template #editarVentaModal let-modal>
  <div class="modal-content">
    <!-- Header compacto -->
    <div class="modal-header-compact">
      <div class="header-content">
        <div class="header-icon">
          <i class="bi bi-pencil-square"></i>
        </div>
        <div class="header-text">
          <h5 class="modal-title">Realizar Abono</h5>
          <div class="header-subtitle">
            <span class="badge">#{{selectedVenta?.numeroControl}}</span>
            <span class="separator">‚Ä¢</span>
            <span>{{selectedVenta?.paciente?.nombre}}</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close" (click)="modal.dismiss()" aria-label="Cerrar"></button>
    </div>

    <div class="modal-body-compact">
      <!-- Resumen r√°pido -->
      <div class="resumen-rapido">
        <div class="resumen-item">
          <div class="resumen-icon">
            <i class="bi bi-cash"></i>
          </div>
          <div class="resumen-content">
            <small>Total Venta</small>
            <div class="resumen-valor">
              {{ getSimboloMonedaVenta() }} {{ selectedVenta?.total | number:'1.2-2' }}
              <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                ‚áÑ {{getConversionBs(selectedVenta?.total) | number:'1.2-2'}} Bs
              </span>
            </div>
          </div>
        </div>
        <div class="resumen-item">
          <div class="resumen-icon">
            <i class="bi bi-wallet2"></i>
          </div>
          <div class="resumen-content">
            <small>Abonado</small>
            <div class="resumen-valor">
              {{ getSimboloMonedaVenta() }} {{ selectedVenta?.montoAbonado | number:'1.2-2' }}
              <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                ‚áÑ {{getConversionBs(selectedVenta?.montoAbonado) | number:'1.2-2'}} Bs
              </span>
            </div>
          </div>
        </div>
        <div class="resumen-item">
          <div class="resumen-icon">
            <i class="bi bi-clock"></i>
          </div>
          <div class="resumen-content">
            <small>Pendiente</small>
            <div class="resumen-valor">
              {{ getSimboloMonedaVenta() }} {{ calcularMontoDeuda() | number:'1.2-2' }}
              <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                ‚áÑ {{getConversionBs(calcularMontoDeuda()) | number:'1.2-2'}} Bs
              </span>
            </div>
          </div>
        </div>
      </div>

      <form [formGroup]="editarVentaForm" (ngSubmit)="guardarEdicionVenta(modal)">
        <!-- Secci√≥n principal compacta - CON MONEDA DE VENTA -->
        <div class="seccion-compacta">
          <div class="seccion-header">
            <i class="bi bi-cash-coin"></i>
            <span class="seccion-titulo">Monto del Abono</span>
          </div>

          <div class="form-grid-compact">
            <!-- Monto abonado - MONEDA DE VENTA -->
            <div class="form-group-compact">
              <label class="form-label-compact">
                <i class="bi bi-currency-dollar"></i>
                Nuevo monto a abonar
              </label>
              <div class="input-group-compact">
                <input type="number" class="form-control form-control-compact" formControlName="montoAbonado"
                  step="0.01" min="0" [max]="getMontoMaximoPermitido()" placeholder="0.00"
                  (input)="onMontoAbonadoChange()">
                <span class="input-suffix">{{ getSimboloMonedaVenta() }}</span>
              </div>
              <div class="input-hint">
                M√°x: {{ getSimboloMonedaVenta() }} {{ getMontoMaximoPermitido() | number:'1.2-2' }} (Deuda pendiente)

                <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                  ‚áÑ {{getConversionBs(getMontoMaximoPermitido()) | number:'1.2-2'}} Bs
                </span>
              </div>
            </div>

            <!-- Barra de progreso  -->
            <div class="form-group-compact">
              <label class="form-label-compact">
                <i class="bi bi-graph-up"></i>
                Progreso Total
              </label>
              <div class="progreso-compact">
                <div class="progreso-info">
                  <span class="progreso-porcentaje">{{ calcularPorcentajeAbonado() }}%</span>
                  <span class="progreso-montos">
                    {{ getSimboloMonedaVenta() }} {{ ((selectedVenta?.montoAbonado || 0) +
                    (editarVentaForm.get('montoAbonado')?.value || 0)) | number:'1.2-2' }} /
                    {{ getSimboloMonedaVenta() }} {{ selectedVenta?.total | number:'1.2-2' }}
                  </span>
                </div>
                <div class="progress-bar-compact">
                  <div class="progress-fill" [style.width.%]="calcularPorcentajeAbonado()"></div>
                </div>

                <!-- ‚úÖ NUEVO: Label de deuda restante -->
                <div class="deuda-restante-info">
                  <small class="deuda-label">
                    <i class="bi bi-clock-history"></i>
                    Saldo pendiente:
                    <strong class="deuda-monto">
                      {{ getSimboloMonedaVenta() }} {{ calcularDeudaRestante() | number:'1.2-2' }}
                    </strong>
                    <span *ngIf="mostrarConversionBs() && getMonedaVenta() !== 'bolivar'" class="conversion-bs">
                      (‚áÑ {{ getConversionBs(calcularDeudaRestante()) | number:'1.2-2' }} Bs)
                    </span>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- M√©todos de pago -->
        <div class="seccion-compacta">
          <div class="seccion-header with-action">
            <div class="header-content">
              <i class="bi bi-wallet2"></i>
              <span class="seccion-titulo">M√©todos de Pago</span>
            </div>
            <button type="button" class="btn btn-action-compact" (click)="agregarMetodoPago()"
              [disabled]="metodosPagoArray.length >= 3">
              <i class="bi bi-plus-lg"></i>
              Agregar M√©todo
            </button>
          </div>

          <div formArrayName="metodosPago" class="metodos-grid-compact">
            <div *ngFor="let metodo of metodosPagoArray.controls; let i = index" [formGroupName]="i"
              class="metodo-item-compact">

              <div class="metodo-header-compact">
                <div class="metodo-tipo-container">
                  <label class="metodo-label">
                    <i class="bi bi-credit-card"></i>
                    Tipo de pago
                  </label>
                  <select class="form-select form-select-compact metodo-select" formControlName="tipo"
                    (change)="onMetodoPagoChange(i)">
                    <option value="" disabled selected>Seleccionar m√©todo...</option>
                    <option value="efectivo">üíµ Efectivo</option>
                    <option value="debito">üí≥ D√©bito</option>
                    <option value="credito">üîÑ Cr√©dito</option>
                    <option value="transferencia">üè¶ Transferencia</option>
                    <option value="pagomovil">üì± Pago M√≥vil</option>
                    <option value="zelle">üåê Zelle</option>
                  </select>
                </div>

                <div class="metodo-monto-container">
                  <label class="metodo-label">
                    <i class="bi bi-cash-coin"></i>
                    Monto
                  </label>
                  <div class="metodo-monto-compact">
                    <input type="number" class="form-control form-control-compact metodo-input" formControlName="monto"
                      step="0.01" min="0" [max]="getMontoMaximoParaMetodo(i)" placeholder="0.00"
                      (input)="validarMontoMetodoPago(i)">
                    <span class="monto-suffix">{{ getSimboloParaMetodo(i) }}</span>
                  </div>

                  <!-- Mostrar informaci√≥n de conversi√≥n -->
                  <div class="conversion-hint">
                    <!-- Mostrar conversi√≥n a moneda de venta si es diferente -->
                    <small *ngIf="mostrarConversionParaMetodo(i) && metodo.get('monto')?.value > 0" class="text-info">
                      ‚âà {{ getConversionParaMetodo(i) | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                    </small>

                    <!-- Mostrar conversi√≥n a BS si la moneda de venta no es bol√≠var -->
                    <small *ngIf="mostrarConversionBs() && metodo.get('monto')?.value > 0" class="text-warning">
                      ‚áÑ {{ getConversionBs(metodo.get('monto')?.value) | number:'1.2-2' }} Bs
                    </small>

                    <!-- Mostrar monto m√°ximo -->
                    <small *ngIf="getMontoMaximoParaMetodo(i) > 0" class="text-muted d-block mt-1">
                      M√°x: {{ getMontoMaximoParaMetodo(i) | number:'1.2-2' }} {{ getSimboloParaMetodo(i) }}
                    </small>
                  </div>
                </div>

                <div class="metodo-actions">
                  <button type="button" class="btn btn-icon-compact btn-remove" (click)="removerMetodoPago(i)"
                    [disabled]="metodosPagoArray.length === 1" title="Eliminar m√©todo de pago">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>

              <!-- Indicador de moneda seg√∫n tipo -->
              <div class="metodo-currency-indicator" *ngIf="metodo.get('tipo')?.value">
                <span class="currency-badge" [ngClass]="{
    'currency-usd': getSimboloParaMetodo(i) === '$',
    'currency-eur': getSimboloParaMetodo(i) === '‚Ç¨', 
    'currency-bs': getSimboloParaMetodo(i) === 'Bs.'
  }">
                  <strong>{{ getSimboloParaMetodo(i) }}</strong> -
                  <span *ngIf="getSimboloParaMetodo(i) === '$'">D√≥lares Americanos</span>
                  <span *ngIf="getSimboloParaMetodo(i) === '‚Ç¨'">Euros</span>
                  <span *ngIf="getSimboloParaMetodo(i) === 'Bs. '">Bol√≠vares</span>
                </span>
              </div>
            </div>
          </div>

          <!-- Selector de moneda para efectivo - SOLO PARA EFECTIVO -->
          <div *ngIf="hayMetodoEfectivoSeleccionado()" class="moneda-selector-container">
            <div class="moneda-selector-header">
              <i class="bi bi-currency-exchange"></i>
              <span>Moneda para Pagos en Efectivo</span>
            </div>
            <div class="moneda-selector-buttons">
              <button type="button" class="moneda-btn" [class.moneda-active]="monedaEfectivo === 'USD'"
                (click)="monedaEfectivo = 'USD'">
                <span class="moneda-symbol">$</span>
                <span class="moneda-info">
                  <strong>USD</strong>
                  <small>D√≥lar Americano</small>
                </span>
              </button>

              <button type="button" class="moneda-btn" [class.moneda-active]="monedaEfectivo === 'EUR'"
                (click)="monedaEfectivo = 'EUR'">
                <span class="moneda-symbol">‚Ç¨</span>
                <span class="moneda-info">
                  <strong>EUR</strong>
                  <small>Euro</small>
                </span>
              </button>

            </div>
          </div>

          <!-- Resumen de m√©todos EN MONEDA DE VENTA -->
          <div *ngIf="metodosPagoArray.length > 0" class="resumen-metodos-compact">
            <div class="resumen-header">
              <i class="bi bi-calculator"></i>
              <span>Resumen de Pagos </span>
            </div>
            <div class="resumen-linea">
              <span class="resumen-label">Total m√©todos:</span>
              <strong class="resumen-valor">
                {{ calcularTotalMetodosPagoEnMonedaVenta() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
              </strong>
            </div>
            <div class="resumen-linea" [class.resumen-warning]="!validarPagoCompleto()">
              <span class="resumen-label">Diferencia:</span>
              <strong class="resumen-valor">
                {{ calcularDiferenciaMetodos() | number:'1.2-2' }} {{ getSimboloMonedaVenta() }}
                <i *ngIf="!validarPagoCompleto()" class="bi bi-exclamation-triangle warning-icon"></i>
              </strong>
            </div>
          </div>
        </div>

        <!-- Footer modal -->
        <div class="modal-footer-detalle">
          <div class="footer-actions">
            <button type="button" class="btn btn-secondary btn-detalle" (click)="modal.dismiss()">
              <i class="bi bi-x-circle me-2"></i>
              Cancelar
            </button>
            <button type="button" class="btn btn-success btn-detalle"
              [disabled]="editarVentaForm.invalid || !validarPagoCompleto()">
              <i class="bi bi-check-circle me-2"></i>
              Guardar Cambios
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</ng-template>