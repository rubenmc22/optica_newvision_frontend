<div class="card contenedor-generar-venta" style="margin-bottom: 0rem;">
    <!-- Header del m√≥dulo -->
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
        <h4 class="mb-0"> Historial de Ventas </h4>
        <div class="ms-auto">
            <button class="btn btn-light btn-sm" (click)="generarInforme()">
                <i class="bi bi-file-earmark-excel"></i> Generar Informe
            </button>
        </div>
    </div>



    <div class="card-body">
        <!-- Filtros y b√∫squedas -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 filtros-responsive">
                    <!-- Fila 1: Buscador, Asesor, Especialista -->
                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">üîç Buscador</label>
                        <input type="text" class="form-control"
                            placeholder="C√©dula, nombre del paciente o N¬∞ de control..."
                            [(ngModel)]="filtros.busquedaGeneral" (input)="onFiltroChange()">
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">üë®‚Äçüíº Asesor</label>
                        <select class="form-select" [(ngModel)]="filtros.asesor" (change)="onFiltroChange()">
                            <option value="">Todos</option>
                            <option *ngFor="let asesor of asesores" [value]="asesor.id">{{asesor.nombre}}</option>
                        </select>
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">üë®‚Äç‚öïÔ∏è Especialista</label>
                        <select class="form-select" [(ngModel)]="filtros.especialista" (change)="onFiltroChange()">
                            <option value="">Todos</option>
                            <option *ngFor="let esp of especialistas" [value]="esp.id">{{esp.nombre}}</option>
                        </select>
                    </div>

                    <!-- Fila 2: Status, Rango de Fechas, Limpiar -->
                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">üìä Status</label>
                        <select class="form-select" [(ngModel)]="filtros.estado" (change)="onFiltroChange()">
                            <option value="">Todos</option>
                            <option value="completada">‚úÖ Completada</option>
                            <option value="cancelada">‚ùå Cancelada</option>
                        </select>
                    </div>

                    <!-- Selector de Rango de Fechas y Bot√≥n Limpiar juntos -->
                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold">üìÖ Rango de fechas</label>
                        <div class="input-group">
                            <button class="btn btn-outline-primary" type="button" (click)="toggleDatepicker()">
                                <i class="bi bi-calendar-range me-1"></i>
                                <span class="fecha-display">{{ getFechaDisplay() }}</span>
                            </button>
                        </div>
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label fw-semibold d-block text-center text-md-start"></label>
                        <div class="d-flex justify-content-center justify-content-md-end" style="margin-top: 20px;">
                            <button class="btn btn-outline-warning" type="button" (click)="limpiarFiltros()"
                                title="Restablecer todos los filtros">
                                <i class="bi bi-arrow-counterclockwise me-1"></i> Limpiar filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Datepicker Flotante -->
        <div class="modal fade show" [class.d-block]="showDatepicker" tabindex="-1" *ngIf="showDatepicker">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Seleccionar rango de fechas</h5>
                        <button type="button" class="btn-close" (click)="closeDatepicker()"
                            style="color: white !important;"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <!-- Selector de fecha √∫nica -->
                            <div class="col-12">
                                <label class="form-label fw-semibold">üìå Fecha √∫nica</label>
                                <input type="date" class="form-control" [(ngModel)]="fechaUnica" [max]="maxDate"
                                    [min]="minDate" (change)="onFechaUnicaChange()">
                                <div class="form-text">Selecciona una fecha espec√≠fica</div>
                            </div>

                            <div class="col-12 text-center d-flex align-items-center justify-content-center">
                                <hr class="my-3">
                                <span class="text-muted">O selecciona un rango</span>
                            </div>

                            <!-- Rango de fechas -->
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Desde</label>
                                <input type="date" class="form-control" [max]="filtros.fechaHasta || maxDate"
                                    [min]="minDate" [(ngModel)]="filtros.fechaDesde" (change)="onRangoChange()">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label fw-semibold">Hasta</label>
                                <input type="date" class="form-control" [min]="filtros.fechaDesde || minDate"
                                    [max]="maxDate" [(ngModel)]="filtros.fechaHasta" (change)="onRangoChange()">
                            </div>

                            <!-- Presets r√°pidos -->
                            <div class="col-12">
                                <label class="form-label fw-semibold">Rangos predefinidos</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'hoy'"
                                        [class.btn-outline-secondary]="presetActivo !== 'hoy'"
                                        (click)="setRangoPreset('hoy')">
                                        Hoy
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'ayer'"
                                        [class.btn-outline-secondary]="presetActivo !== 'ayer'"
                                        (click)="setRangoPreset('ayer')">
                                        Ayer
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana'"
                                        [class.btn-outline-secondary]="presetActivo !== 'semana'"
                                        (click)="setRangoPreset('semana')">
                                        Esta semana
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'semana_pasada'"
                                        [class.btn-outline-secondary]="presetActivo !== 'semana_pasada'"
                                        (click)="setRangoPreset('semana_pasada')">
                                        Semana pasada
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes'"
                                        [class.btn-outline-secondary]="presetActivo !== 'mes'"
                                        (click)="setRangoPreset('mes')">
                                        Este mes
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'mes_pasado'"
                                        [class.btn-outline-secondary]="presetActivo !== 'mes_pasado'"
                                        (click)="setRangoPreset('mes_pasado')">
                                        Mes pasado
                                    </button>
                                    <button class="btn btn-sm" [class.btn-primary]="presetActivo === 'trimestre'"
                                        [class.btn-outline-secondary]="presetActivo !== 'trimestre'"
                                        (click)="setRangoPreset('trimestre')">
                                        Este trimestre
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="limpiarFechas()">
                            <i class="bi bi-x-circle me-1"></i> Limpiar
                        </button>
                        <button type="button" class="btn btn-primary" (click)="aplicarFechas()">
                            <i class="bi bi-check-circle me-1"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay para cerrar al hacer click fuera -->
        <div class="modal-backdrop fade show" *ngIf="showDatepicker" (click)="closeDatepicker()"></div>

        <!-- Controles de ordenamiento -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <span class="text-muted">Ordenar por:</span>
                <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="ordenamiento.campo">
                    <option value="fecha">Fecha</option>
                    <option value="numeroControl">N¬∞ Control</option>
                    <option value="montoTotal">Monto Total</option>
                    <option value="paciente">Paciente</option>
                </select>
                <button class="btn btn-outline-secondary btn-sm" (click)="cambiarOrden()">
                    <i class="bi" [class.bi-arrow-up]="ordenamiento.ascendente"
                        [class.bi-arrow-down]="!ordenamiento.ascendente"></i>
                </button>
            </div>

            <div class="text-muted">
                Mostrando {{ventasFiltradas.length}} de {{totalVentas}} ventas
            </div>
        </div>

        <!-- Lista de ventas -->
        <div class="card">
            <div class="card-body p-0">
                <div class="list-group list-group-flush">
                    <div *ngFor="let venta of ventasFiltradas" class="list-group-item">
                        <!-- Encabezado de la venta - Versi√≥n Mejorada -->
                        <div class="d-flex justify-content-between align-items-center cursor-pointer p-3 border-bottom"
                            (click)="toggleDetalleVenta(venta.id)">
                            <div class="d-flex align-items-center gap-3">
                                <!-- N√∫mero de Control con mejor dise√±o -->
                                <div class="bg-primary text-white rounded p-2 text-center" style="min-width: 80px;">
                                    <div class="small">Control</div>
                                    <strong class="fs-6">#{{venta.numeroControl}}</strong>
                                </div>

                                <!-- Informaci√≥n del paciente -->
                                <div class="flex-grow-1">
                                    <!-- Nombre y c√©dula en l√≠nea con icono -->
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <i class="bi bi-person-circle text-muted"></i>
                                        <h6 class="mb-0 fw-semibold text-dark">
                                            {{venta.paciente.nombre}} - CI. {{venta.paciente.cedula}}
                                        </h6>
                                    </div>

                                    <!-- Fecha y hora con mejor formato -->
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="bi bi-calendar3 text-muted small"></i>
                                        <small class="text-muted">
                                            {{venta.fecha | date:'dd/MM/yyyy'}} a las {{venta.fecha | date:'HH:mm'}}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Estado y monto alineados a la derecha -->
                            <div class="d-flex align-items-center gap-3">
                                <!-- Badge de estado mejorado -->
                                <span class="badge px-3 py-2" [ngClass]="{
                                    'bg-success': venta.estado === 'completada',
                                    'bg-warning text-dark': venta.estado === 'pendiente',
                                    'bg-danger': venta.estado === 'cancelada'
                                }">
                                    <i class="bi" [class.bi-check-circle]="venta.estado === 'completada'"
                                        [class.bi-clock]="venta.estado === 'pendiente'"
                                        [class.bi-x-circle]="venta.estado === 'cancelada'" class="me-1"></i>
                                    {{venta.estado | titlecase}}
                                </span>

                                <!-- Monto con mejor formato -->
                                <div class="text-end">
                                    <strong class="text-primary fs-6">{{venta.montoTotal |
                                        currency:'USD':'symbol':'1.2-2'}}</strong>
                                    <div class="text-muted small">Total</div>
                                </div>

                                <!-- √çcono de expandir/contraer -->
                                <i class="bi fs-5 text-muted" [class.bi-chevron-down]="!venta.mostrarDetalle"
                                    [class.bi-chevron-up]="venta.mostrarDetalle"></i>
                            </div>
                        </div>
                        <!-- Detalle expandible -->
                        <div *ngIf="venta.mostrarDetalle" class="mt-3 pt-3 border-top">
                            <div class="row">
                                <!-- Informaci√≥n general -->
                                <div class="col-md-6">
                                    <h6>Informaci√≥n de la Venta</h6>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Asesor:</strong></td>
                                            <td>{{venta.asesor.nombre}}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Especialista:</strong></td>
                                            <td>{{venta.especialista?.nombre || 'N/A'}}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Servicios:</strong></td>
                                            <td>
                                                <span *ngFor="let servicio of venta.servicios"
                                                    class="badge bg-light text-dark me-1">
                                                    {{servicio.nombre}}
                                                </span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <!-- M√©todos de pago -->
                                <div class="col-md-6">
                                    <h6>M√©todos de Pago</h6>
                                    <div *ngFor="let metodo of venta.metodosPago" class="mb-1">
                                        <small>
                                            {{metodo.tipo | titlecase}}:
                                            <strong>{{metodo.monto | currency}}</strong>
                                            <span *ngIf="metodo.conversionBs" class="text-muted">
                                                ({{metodo.conversionBs | number:'1.2-2'}} Bs)
                                            </span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="d-flex justify-content-end gap-2 mt-3">
                                <button class="btn btn-outline-primary btn-sm" (click)="verRecibo(venta)">
                                    <i class="bi bi-receipt"></i> Ver Recibo
                                </button>
                                <button *ngIf="venta.estado !== 'cancelada'" class="btn btn-outline-danger btn-sm"
                                    (click)="cancelarVenta(venta)">
                                    <i class="bi bi-x-circle"></i> Cancelar Venta
                                </button>
                                <button class="btn btn-outline-info btn-sm" (click)="verDetalleCompleto(venta)">
                                    <i class="bi bi-eye"></i> Ver Detalle Completo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paginaci√≥n Moderna -->
        <div class="d-flex justify-content-between align-items-center mt-4 p-3 bg-light rounded-3">
            <!-- Informaci√≥n de resultados -->
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted">
                    <strong>{{ ventasFiltradas.length }}</strong> resultados
                </span>
                <div class="vr"></div>
                <span class="text-muted">
                    P√°gina <strong>{{ paginaActual }}</strong> de <strong>{{ totalPaginas }}</strong>
                </span>
            </div>

            <!-- Controles de paginaci√≥n centrados -->
            <div class="d-flex align-items-center gap-2">
                <!-- Bot√≥n Anterior -->
                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"
                    (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1"
                    [class.btn-outline-secondary]="paginaActual === 1">
                    <i class="bi bi-chevron-left"></i>
                    <span class="d-none d-sm-inline">Anterior</span>
                </button>

                <!-- Selector de p√°gina r√°pida -->
                <div class="input-group input-group-sm" style="width: 120px;">
                    <span class="input-group-text bg-white">P√°g.</span>
                    <select class="form-select" [(ngModel)]="paginaActual" (change)="cambiarPagina(paginaActual)">
                        <option *ngFor="let pagina of getRangoPaginas()" [value]="pagina">
                            {{ pagina }}
                        </option>
                    </select>
                </div>

                <!-- Bot√≥n Siguiente -->
                <button class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1"
                    (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas"
                    [class.btn-outline-secondary]="paginaActual === totalPaginas">
                    <span class="d-none d-sm-inline">Siguiente</span>
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>

            <!-- Controles adicionales a la derecha -->
            <div class="d-flex align-items-center gap-3">
                <!-- Selector de items por p√°gina -->
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Mostrar:</span>
                    <select class="form-select form-select-sm" style="width: 80px;" [(ngModel)]="itemsPorPagina"
                        (change)="cambiarItemsPorPagina()">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Paginaci√≥n M√≥vil (solo se muestra en pantallas peque√±as) -->
        <div class="d-lg-none mt-3">
            <div class="card">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-4">
                            <button
                                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                                (click)="cambiarPagina(paginaActual - 1)" [disabled]="paginaActual === 1">
                                <i class="bi bi-chevron-left"></i>
                                <span>Ant</span>
                            </button>
                        </div>
                        <div class="col-4 text-center">
                            <span class="text-muted small">
                                {{ paginaActual }}/{{ totalPaginas }}
                            </span>
                        </div>
                        <div class="col-4">
                            <button
                                class="btn btn-outline-primary btn-sm w-100 d-flex align-items-center justify-content-center gap-1"
                                (click)="cambiarPagina(paginaActual + 1)" [disabled]="paginaActual === totalPaginas">
                                <span>Sig</span>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>