<div class="container-fluid p-3">
    <!-- Header del módulo -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Historial de Ventas</h2>
        <button class="btn btn-success" (click)="generarInforme()">
            <i class="bi bi-file-earmark-excel"></i> Generar Informe
        </button>
    </div>

    <!-- Filtros y búsquedas -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <!-- Fila 1 de filtros -->
                <div class="col-md-3">
                    <label class="form-label">N° Control</label>
                    <input type="text" class="form-control" placeholder="Buscar por número..." 
                           [(ngModel)]="filtros.numeroControl">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Paciente</label>
                    <input type="text" class="form-control" placeholder="Buscar paciente..." 
                           [(ngModel)]="filtros.paciente">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Asesor</label>
                    <select class="form-select" [(ngModel)]="filtros.asesor">
                        <option value="">Todos los asesores</option>
                        <option *ngFor="let asesor of asesores" [value]="asesor.id">{{asesor.nombre}}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Especialista</label>
                    <select class="form-select" [(ngModel)]="filtros.especialista">
                        <option value="">Todos los especialistas</option>
                        <option *ngFor="let esp of especialistas" [value]="esp.id">{{esp.nombre}}</option>
                    </select>
                </div>

                <!-- Fila 2 de filtros -->
                <div class="col-md-3">
                    <label class="form-label">Fecha desde</label>
                    <input type="date" class="form-control" [(ngModel)]="filtros.fechaDesde">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha hasta</label>
                    <input type="date" class="form-control" [(ngModel)]="filtros.fechaHasta">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select class="form-select" [(ngModel)]="filtros.estado">
                        <option value="">Todos los estados</option>
                        <option value="completada">Completada</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Monto mínimo</label>
                    <input type="number" class="form-control" placeholder="Monto mínimo..." 
                           [(ngModel)]="filtros.montoMinimo">
                </div>

                <!-- Botones de acción filtros -->
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" (click)="aplicarFiltros()">
                            <i class="bi bi-funnel"></i> Aplicar Filtros
                        </button>
                        <button class="btn btn-outline-secondary" (click)="limpiarFiltros()">
                            <i class="bi bi-arrow-clockwise"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Controles de ordenamiento -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
            <span class="text-muted">Ordenar por:</span>
            <select class="form-select form-select-sm" style="width: auto;" [(ngModel)]="ordenamiento.campo">
                <option value="fecha">Fecha</option>
                <option value="numeroControl">N° Control</option>
                <option value="montoTotal">Monto Total</option>
                <option value="paciente">Paciente</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm" (click)="cambiarOrden()">
                <i class="bi" [class.bi-arrow-up]="ordenamiento.ascendente" 
                   [class.bi-arrow-down]="!ordenamiento.ascendente"></i>
            </button>
        </div>
        
        <div class="text-muted">
            Mostrando {{ventasFiltradas.length}} de {{totalVentas}} ventas
        </div>
    </div>

    <!-- Lista de ventas -->
    <div class="card">
        <div class="card-body p-0">
            <div class="list-group list-group-flush">
                <div *ngFor="let venta of ventasFiltradas" class="list-group-item">
                    <!-- Encabezado de la venta -->
                    <div class="d-flex justify-content-between align-items-center cursor-pointer"
                         (click)="toggleDetalleVenta(venta.id)">
                        <div class="d-flex align-items-center gap-3">
                            <div class="bg-light rounded p-2 text-center">
                                <div class="small text-muted">N° Control</div>
                                <strong>#{{venta.numeroControl}}</strong>
                            </div>
                            <div>
                                <h6 class="mb-1">{{venta.paciente.nombre}}</h6>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> {{venta.fecha | date:'dd/MM/yyyy HH:mm'}}
                                </small>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge" [ngClass]="{
                                'bg-success': venta.estado === 'completada',
                                'bg-warning': venta.estado === 'pendiente',
                                'bg-danger': venta.estado === 'cancelada'
                            }">
                                {{venta.estado | titlecase}}
                            </span>
                            <strong class="text-primary">{{venta.montoTotal | currency}}</strong>
                            <i class="bi" [class.bi-chevron-down]="!venta.mostrarDetalle" 
                               [class.bi-chevron-up]="venta.mostrarDetalle"></i>
                        </div>
                    </div>

                    <!-- Detalle expandible -->
                    <div *ngIf="venta.mostrarDetalle" class="mt-3 pt-3 border-top">
                        <div class="row">
                            <!-- Información general -->
                            <div class="col-md-6">
                                <h6>Información de la Venta</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Asesor:</strong></td>
                                        <td>{{venta.asesor.nombre}}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Especialista:</strong></td>
                                        <td>{{venta.especialista?.nombre || 'N/A'}}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Servicios:</strong></td>
                                        <td>
                                            <span *ngFor="let servicio of venta.servicios" class="badge bg-light text-dark me-1">
                                                {{servicio.nombre}}
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Métodos de pago -->
                            <div class="col-md-6">
                                <h6>Métodos de Pago</h6>
                                <div *ngFor="let metodo of venta.metodosPago" class="mb-1">
                                    <small>
                                        {{metodo.tipo | titlecase}}: 
                                        <strong>{{metodo.monto | currency}}</strong>
                                        <span *ngIf="metodo.conversionBs" class="text-muted">
                                            ({{metodo.conversionBs | number:'1.2-2'}} Bs)
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Acciones -->
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <button class="btn btn-outline-primary btn-sm" (click)="verRecibo(venta)">
                                <i class="bi bi-receipt"></i> Ver Recibo
                            </button>
                            <button *ngIf="venta.estado !== 'cancelada'" 
                                    class="btn btn-outline-danger btn-sm" 
                                    (click)="cancelarVenta(venta)">
                                <i class="bi bi-x-circle"></i> Cancelar Venta
                            </button>
                            <button class="btn btn-outline-info btn-sm" (click)="verDetalleCompleto(venta)">
                                <i class="bi bi-eye"></i> Ver Detalle Completo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Paginación -->
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
            Página {{paginaActual}} de {{totalPaginas}}
        </div>
        <nav>
            <ul class="pagination">
                <li class="page-item" [class.disabled]="paginaActual === 1">
                    <a class="page-link" (click)="cambiarPagina(paginaActual - 1)">Anterior</a>
                </li>
                <li *ngFor="let pagina of getRangoPaginas()" 
                    class="page-item" 
                    [class.active]="pagina === paginaActual">
                    <a class="page-link" (click)="cambiarPagina(pagina)">{{pagina}}</a>
                </li>
                <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                    <a class="page-link" (click)="cambiarPagina(paginaActual + 1)">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
</div>