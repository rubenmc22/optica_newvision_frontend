<div class="card contenedor-generar-venta-moderno">
    <!-- Encabezado modernizado -->
    <div class="card-header-moderno">
        <div class="header-content">
            <div class="header-icon">
                <i class="bi bi-cart-plus"></i>
            </div>
            <div class="header-text">
                <h4 class="header-title">Generar Venta</h4>
                <div class="header-subtitle">Complete la informaci√≥n del paciente y agregue productos</div>
            </div>
        </div>
    </div>

    <!-- Cuerpo -->
    <div class="card-body-moderno">
        <!-- Barra de informaci√≥n contextual -->
        <div class="context-bar">
            <div class="context-info">
                <i class="bi bi-info-circle"></i>
                <span class="context-text">
                    Selecciona un paciente si aplica y agrega productos para continuar la venta.
                </span>
            </div>

            <!-- Switch paciente modernizado -->
            <div class="patient-toggle">
                <div class="toggle-content">
                    <i class="bi bi-person-circle"></i>
                    <span class="toggle-label">Paciente</span>
                    <span class="toggle-badge" [ngClass]="requierePaciente ? 'badge-included' : 'badge-excluded'">
                        {{ requierePaciente ? 'Incluido' : 'No incluido' }}
                    </span>
                </div>
                <label class="modern-switch">
                    <input type="checkbox" [(ngModel)]="requierePaciente">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Mensaje informativo cuando el switch est√° activado -->
            <div *ngIf="requierePaciente" class="info-message-toggle" @fadeInOut>
                <div class="info-content">
                    <i class="bi bi-info-circle"></i>
                    <div class="info-text">
                        <strong>Orden de trabajo autom√°tica:</strong>
                        <span>Si la historia m√©dica contiene f√≥rmula √≥ptica, se generar√° una orden de trabajo para el laboratorio.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paneles principales -->
        <div class="paneles-container">
            <!-- üßë Panel Paciente y Contexto Cl√≠nico -->
            <section class="panel-moderno panel-paciente" *ngIf="requierePaciente">
                <div class="panel-header">
                    <i class="bi bi-person-vcard"></i>
                    <span>Informaci√≥n del Paciente</span>
                </div>
                <div class="panel-body">
                    <!-- Buscador de paciente -->
                    <div class="buscador-moderno">
                        <label class="form-label-moderno">
                            <i class="bi bi-search"></i>
                            Buscar paciente
                        </label>
                        <ng-select #selectorPaciente id="selectorPaciente" [items]="pacientesFiltradosPorSede"
                            bindLabel="informacionPersonal.nombreCompleto" [selectOnTab]="true" [clearable]="true"
                            [searchable]="true" [(ngModel)]="pacienteSeleccionado"
                            (search)="actualizarFiltroTexto($event)" (change)="onPacienteSeleccionado($event)"
                            [searchFn]="filtrarPorNombreOCedula" placeholder="Buscar por nombre o c√©dula..."
                            class="modern-ng-select">

                            <ng-template ng-option-tmp let-item="item">
                                <div class="paciente-option">
                                    <strong>{{ item.informacionPersonal.nombreCompleto }}</strong>
                                    <small class="text-muted">‚Äî {{ item.informacionPersonal.cedula }}</small>
                                </div>
                            </ng-template>

                            <ng-template ng-notfound-tmp>
                                <div class="not-found-message">
                                    <i class="bi bi-exclamation-circle"></i>
                                    No se encontraron pacientes con ese nombre o c√©dula
                                </div>
                            </ng-template>
                        </ng-select>
                    </div>

                    <!-- Selector de historia m√©dica -->
                    <div *ngIf="pacienteSeleccionado && historiasMedicas.length > 0" class="selector-historia-moderno">
                        <label class="form-label-moderno">
                            <i class="bi bi-clipboard-pulse"></i>
                            Seleccionar historia m√©dica
                        </label>
                        <ng-select [items]="historiasMedicas" bindLabel="fechaFormateada" bindValue="key"
                            [searchable]="false" [clearable]="false" [(ngModel)]="historiaSeleccionadaId"
                            (change)="onHistoriaSeleccionada($event)" placeholder="Selecciona una historia m√©dica..."
                            class="modern-ng-select">

                            <ng-template ng-label-tmp let-item="item">
                                <div class="historia-label">
                                    <span class="historia-fecha">{{item.fechaFormateada}}</span>
                                    <span *ngIf="item.esReciente" class="badge bg-info ms-2">M√ÅS RECIENTE</span>
                                </div>
                            </ng-template>

                            <ng-template ng-option-tmp let-item="item">
                                <div class="historia-option">
                                    <div class="historia-header">
                                        <strong>{{item.nHistoria}}</strong>
                                        <small class="text-muted"> {{item.fechaFormateada}}</small>
                                        <span *ngIf="item.esReciente" class="badge bg-info ms-2">M√ÅS RECIENTE</span>
                                    </div>
                                    <div class="historia-detalle">
                                        <div class="row">
                                            <div class="col-6">
                                                <small class="text-muted">
                                                    <i class="bi bi-person-badge"></i>
                                                    {{item.profesionalNombre || 'Sin profesional'}}
                                                </small>
                                            </div>
                                            <div class="col-6 text-end">
                                                <small class="text-muted">
                                                    <i class="bi bi-emoji-sunglasses"></i> {{item.motivo}}
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ng-template>
                        </ng-select>
                        <small class="form-text text-muted">
                            Por defecto se selecciona la historia m√°s reciente. Puedes cambiar si es necesario.
                        </small>
                    </div>

                    <!-- En la secci√≥n de formulaci√≥n cl√≠nica -->
                    <div *ngIf="historiaMedica && tieneFormulaCompletaTemplate(historiaMedica)"
                        class="formulacion-section">
                        <div class="section-header">
                            <h5>Formulaci√≥n Cl√≠nica</h5>
                            <i class="bi bi-eyeglasses"></i>
                            <span *ngIf="!tieneFormulaCompletaTemplate(historiaMedica)" class="badge bg-warning ms-2">
                                <i class="bi bi-exclamation-triangle"></i> Sin f√≥rmula
                            </span>
                        </div>

                        <div class="formulacion-grid">
                            <!-- Ojo Derecho -->
                            <div class="ojo-card">
                                <div class="ojo-header ojo-derecho">
                                    <i class="bi bi-eye-fill"></i>
                                    <span>Ojo Derecho (OD)</span>
                                </div>
                                <div class="ojo-params">
                                    <div class="param">
                                        <span class="param-label">Esfera (ESF)</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.esf_od || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Cilindro (CIL)</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.cil_od || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Eje</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.eje_od || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ADD</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.add_od || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ALT</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.alt_od || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">DP</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.dp_od || '--' }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ojo Izquierdo -->
                            <div class="ojo-card">
                                <div class="ojo-header ojo-izquierdo">
                                    <i class="bi bi-eye-fill"></i>
                                    <span>Ojo Izquierdo (OI)</span>
                                </div>
                                <div class="ojo-params">
                                    <div class="param">
                                        <span class="param-label">Esfera (ESF)</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.esf_oi || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Cilindro (CIL)</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.cil_oi || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Eje</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.eje_oi || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ADD</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.add_oi || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ALT</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.alt_oi || '--' }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">DP</span>
                                        <span class="param-value">{{
                                            historiaMedica?.examenOcular?.refraccionFinal?.dp_oi || '--' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recomendaciones -->
                        <div *ngIf="historiaMedica?.recomendaciones?.length > 0" class="recomendaciones-section">
                            <div class="section-header">
                                <h5>Recomendaciones</h5>
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="recomendaciones-grid">
                                <div class="recomendacion-item">
                                    <span class="rec-label">Montura</span>
                                    <span class="rec-value">{{ historiaMedica.recomendaciones[0]?.montura || '--'
                                        }}</span>
                                </div>
                                <div class="recomendacion-item">
                                    <span class="rec-label">Material</span>
                                    <span class="rec-value">{{ getMaterialesRecomendados() }}</span>
                                </div>
                                <div class="recomendacion-item">
                                    <span class="rec-label">Cristal</span>
                                    <span class="rec-value">{{ historiaMedica.recomendaciones[0]?.cristal?.label || '--'
                                        }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- üõí Panel Carrito de Productos -->
            <section class="panel-moderno panel-productos">
                <div class="panel-header">
                    <i class="bi bi-cart"></i>
                    <span>Carrito de Productos</span>
                </div>
                <div class="panel-body">
                    <!-- Buscador de productos -->
                    <div class="buscador-productos">
                        <div class="buscador-main">
                            <label class="form-label-moderno">
                                <i class="bi bi-search"></i>
                                Buscar producto
                            </label>
                            <ng-select #productoSelect id="selectorProducto" [items]="productosFiltradosPorSede"
                                bindLabel="nombre" bindValue="id" [searchable]="true" [clearable]="true"
                                [selectOnTab]="true" [(ngModel)]="productoSeleccionado"
                                (change)="onProductoSeleccionadoChange($event)"
                                [searchFn]="filtrarProductoPorNombreOCodigo" placeholder="Buscar por nombre o c√≥digo..."
                                class="modern-ng-select">

                                <ng-template ng-option-tmp let-item="item">
                                    <div class="producto-option">
                                        <strong>{{ item.nombre }}</strong>
                                        <small class="text-muted">‚Äî {{ item.codigo }}</small>
                                        <small class="stock-badge" [class.low-stock]="item.stock < 5">
                                            Stock: {{ item.stock }}
                                        </small>
                                    </div>
                                </ng-template>

                                <ng-template ng-notfound-tmp>
                                    <div class="not-found-message">
                                        <i class="bi bi-exclamation-circle"></i>
                                        No se encontraron productos con ese nombre o c√≥digo
                                    </div>
                                </ng-template>
                            </ng-select>
                        </div>
                    </div>

                    <!-- Tabla de productos mejorada -->
                    <div *ngIf="venta.productos.length > 0" class="productos-table-container">
                        <div class="section-header">
                            <i class="bi bi-cart-check"></i>
                            <h5>Productos en el Carrito</h5>
                            <span class="badge bg-primary">{{ venta.productos.length }} producto{{
                                venta.productos.length > 1 ? 's' : '' }}</span>
                        </div>

                        <div class="table-scroll-container">
                            <table class="table-moderna">
                                <thead>
                                    <tr>
                                        <th class="text-center">Producto</th>
                                        <th class="text-center">Precio Unit.</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-center">Subtotal</th>
                                        <!-- QUITAMOS la columna de IVA -->
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let p of productosConDetalle; trackBy: trackByProducto"
                                        class="producto-row">

                                        <!-- Columna Producto -->
                                        <td class="producto-info">
                                            <div class="producto-details">
                                                <span class="producto-nombre">{{ p.nombre }}</span>
                                                <small class="producto-codigo text-muted">{{ p.codigo }}</small>
                                            </div>
                                        </td>

                                        <!-- Columna Precio -->
                                        <td class="text-center precio">
                                            <span class="precio-unitario">
                                                <!-- Mostrar precio SIN IVA -->
                                                {{ formatearMoneda(getPrecioParaMostrar(p)) }}
                                            </span>
                                            <!-- Referencia en Bs si no es bol√≠var -->
                                            <small *ngIf="!esMonedaBolivar(monedaSistema)" class="text-muted d-block">
                                                {{ formatearMoneda(getPrecioEnBs(p), 'bolivar') }}
                                            </small>
                                        </td>

                                        <!-- Columna Cantidad -->
                                        <td class="text-center cantidad-cell">
                                            <div class="cantidad-control">
                                                <div class="input-group input-group-sm">
                                                    <input type="number" [ngModel]="p.cantidad ?? 1"
                                                        (ngModelChange)="onCantidadChange(p, $event)" min="1"
                                                        max="{{ p.stock }}" class="form-control cantidad-input"
                                                        [class.border-warning]="(p.cantidad ?? 1) > p.stock" />
                                                </div>
                                                <small class="stock-info"
                                                    [class.text-danger]="(p.cantidad ?? 1) > p.stock"
                                                    [class.text-muted]="(p.cantidad ?? 1) <= p.stock">
                                                    {{ p.stock }} disponible{{ p.stock > 1 ? 's' : '' }}
                                                </small>
                                            </div>
                                        </td>

                                        <!-- Columna Subtotal -->
                                        <td class="text-center subtotal">
                                            <!-- Mostrar subtotal SIN IVA -->
                                            {{ formatearMoneda(p.subtotal) }}
                                        </td>

                                        <!-- Columna Acciones -->
                                        <td class="text-center acciones">
                                            <button class="btn-eliminar" (click)="eliminarProducto(p.id)"
                                                title="Eliminar del carrito">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Resumen y bot√≥n de generar venta -->
                    <div *ngIf="venta.productos.length > 0" @fadeInOut class="resumen-venta">
                        <div class="resumen-content">
                            <div class="monto-total">
                                <i class="bi bi-receipt"></i>
                                <span class="resumen-label">Monto total (sin IVA):</span>
                                <span class="monto-valor">
                                    {{ formatearMoneda(totalProductos) }}
                                </span>
                            </div>
                            <button class="btn-generar-venta" (click)="abrirModalResumen()"
                                [disabled]="!puedeGenerarVentaDesdeCarrito()" [title]="getMensajeTooltipBotonGenerar()">
                                <i class="bi bi-check-lg"></i>
                                Generar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal resumen de venta -->
<div class="modal fade" id="resumenVentaModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
    data-bs-keyboard="false" (shown.bs.modal)="onModalShown()">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Header modernizado -->
            <div class="modal-header-detalle">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="bi bi-receipt-cutoff"></i>
                    </div>
                    <div class="header-text">
                        <h5 class="modal-title">Resumen de Venta</h5>
                        <div class="header-subtitle">
                            <span class="badge">Confirmaci√≥n Final</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body-detalle">
                <!-- üëì Formulaci√≥n cl√≠nica resumida - Modernizada -->
                <div class="info-card formulacion" *ngIf="requierePaciente">
                    <div class="card-header-detalle">
                        <i class="bi bi-eyeglasses"></i>
                        <span>Formulaci√≥n Cl√≠nica</span>
                    </div>
                    <div class="card-body-detalle">
                        <ng-container *ngIf="historiaMedica?.examenOcular?.refraccionFinal; else sinFormulacion">
                            <div class="formulacion-grid">
                                <!-- Ojo Derecho -->
                                <div class="ojo-card">
                                    <div class="ojo-header ojo-derecho">
                                        <i class="bi bi-eye-fill"></i>
                                        <span>Ojo Derecho (OD)</span>
                                    </div>
                                    <div class="ojo-params">
                                        <div class="param">
                                            <span class="param-label">Esfera (ESF)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.esf_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Cilindro (CIL)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.cil_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Eje</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.eje_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ADD</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.add_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ALT</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.alt_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">DP</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.dp_od }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ojo Izquierdo -->
                                <div class="ojo-card">
                                    <div class="ojo-header ojo-izquierdo">
                                        <i class="bi bi-eye-fill"></i>
                                        <span>Ojo Izquierdo (OI)</span>
                                    </div>
                                    <div class="ojo-params">
                                        <div class="param">
                                            <span class="param-label">Esfera (ESF)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.esf_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Cilindro (CIL)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.cil_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Eje</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.eje_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ADD</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.add_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ALT</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.alt_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">DP</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.dp_oi }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recomendaciones -->
                            <div class="recomendaciones-section">
                                <div class="section-header">
                                    <h5>Recomendaciones</h5>
                                    <i class="bi bi-clipboard-check"></i>
                                </div>
                                <div class="recomendaciones-grid">
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Montura</span>
                                        <span class="rec-value">{{ historiaMedica.recomendaciones[0].montura }}</span>
                                    </div>
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Material</span>
                                        <span class="rec-value">{{ materialesRecomendados }}</span>
                                    </div>
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Cristal</span>
                                        <span class="rec-value">{{ historiaMedica.recomendaciones[0].cristal.label
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <ng-template #sinFormulacion>
                            <div class="alert d-flex align-items-center mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <span>No hay formulaci√≥n registrada para este paciente.</span>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- üë§ Informaci√≥n del Cliente (solo cuando no hay paciente) -->
                <div *ngIf="mostrarClienteSinPaciente" class="info-card cliente-sin-paciente">
                    <div class="card-header-detalle">
                        <i class="bi bi-person-badge"></i>
                        <span>Informaci√≥n del Cliente</span>
                    </div>

                    <div class="card-body-detalle">
                        <div class="cliente-form">
                            <!-- Switch Tipo de Persona - Moderno -->
                            <div class="tipo-persona-section">
                                <label class="section-label">Tipo de Persona</label>
                                <div class="switch-container modern">
                                    <div class="switch-options">
                                        <div class="switch-option"
                                            [class.active]="clienteSinPaciente.tipoPersona === 'natural'"
                                            (click)="clienteSinPaciente.tipoPersona = 'natural'; onTipoPersonaChange()">
                                            <i class="bi bi-person"></i>
                                            <span>Persona Natural</span>
                                        </div>
                                        <div class="switch-option"
                                            [class.active]="clienteSinPaciente.tipoPersona === 'juridica'"
                                            (click)="clienteSinPaciente.tipoPersona = 'juridica'; onTipoPersonaChange()">
                                            <i class="bi bi-building"></i>
                                            <span>Persona Jur√≠dica</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos del formulario optimizados -->
                            <div class="cliente-fields">
                                <div class="form-grid">
                                    <!-- Fila 1: C√©dula/RIF con validaci√≥n -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-card-text"></i>
                                            {{ clienteSinPaciente.tipoPersona === 'natural' ? 'C√©dula' : 'RIF' }}
                                        </label>
                                        <div class="input-with-action">
                                            <input type="text" class="form-control modern-input"
                                                style="margin-bottom: -10px !important;"
                                                [(ngModel)]="clienteSinPaciente.cedula"
                                                [placeholder]="clienteSinPaciente.tipoPersona === 'natural' ? 'Ingrese la c√©dula' : 'Ingrese el RIF'"
                                                (blur)="onCedulaBlur()" (input)="onCedulaChange()"
                                                (focus)="onCampoEditadoManualmente()" [disabled]="validandoCliente"
                                                data-cedula-input>

                                            <!-- Bot√≥n de validaci√≥n compacto y con estados -->
                                            <button class="{{ getClaseBotonValidar() }}"
                                                (click)="forzarValidacionCliente()"
                                                [disabled]="validandoCliente || !clienteSinPaciente.cedula || !validarCedula(clienteSinPaciente.cedula, clienteSinPaciente.tipoPersona)"
                                                [title]="getTooltipBotonValidar()" type="button">
                                                <i class="bi"
                                                    [class.bi-search]="!validandoCliente && !clienteEncontrado && !validacionIntentada"
                                                    [class.bi-check-lg]="clienteEncontrado && !validandoCliente"
                                                    [class.bi-hourglass]="validandoCliente"
                                                    [class.bi-exclamation-circle]="validacionIntentada && !clienteEncontrado && !validandoCliente"></i>
                                            </button>
                                        </div>

                                        <div class="error-message"
                                            *ngIf="!getEstadoCampoCedula().valido && clienteSinPaciente.cedula">
                                            <i class="bi bi-exclamation-circle"></i>
                                            {{ getEstadoCampoCedula().mensaje }}
                                        </div>
                                    </div>
                                    <!-- Fila 1: Nombre/Raz√≥n Social -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-person"></i>
                                            {{ clienteSinPaciente.tipoPersona === 'natural' ? 'Nombre Completo' : 'Raz√≥n Social' }}
                                        </label>
                                        <input type="text" class="form-control modern-input"
                                            style="margin-bottom: -10px !important;"
                                            [(ngModel)]="clienteSinPaciente.nombreCompleto"
                                            [placeholder]="clienteSinPaciente.tipoPersona === 'natural' ? 'Ingrese nombre completo' : 'Ingrese raz√≥n social'"
                                            (blur)="onNombreChange()"
                                            (input)="onNombreChange(); onCampoEditadoManualmente()"
                                            [class.campo-autocompletado]="clienteEncontrado" data-nombre-input>
                                        <div class="error-message"
                                            *ngIf="!getEstadoCampoNombre().valido && clienteSinPaciente.nombreCompleto">
                                            <i class="bi bi-exclamation-circle"></i>
                                            {{ getEstadoCampoNombre().mensaje }}
                                        </div>
                                    </div>

                                    <!-- Fila 2: Tel√©fono -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-telephone"></i>
                                            Tel√©fono
                                        </label>
                                        <input type="tel" class="form-control modern-input"
                                            style="margin-bottom: -10px !important;"
                                            [(ngModel)]="clienteSinPaciente.telefono"
                                            placeholder="Ej: 4121234567 (Ven) o +57 3123456789"
                                            (blur)="onTelefonoBlur()"
                                            (input)="onTelefonoChange(); onCampoEditadoManualmente()"
                                            [class.campo-autocompletado]="clienteEncontrado" data-telefono-input>
                                        <small class="form-text text-muted">
                                            Para Venezuela: ingrese el n√∫mero (4121234567). Otros pa√≠ses: incluya el
                                            c√≥digo (+57 3123456789)
                                        </small>
                                        <div class="error-message"
                                            *ngIf="!getEstadoCampoTelefono().valido && clienteSinPaciente.telefono">
                                            <i class="bi bi-exclamation-circle"></i>
                                            {{ getEstadoCampoTelefono().mensaje }}
                                        </div>
                                    </div>

                                    <!-- Fila 2: Email -->
                                    <div class="form-group">
                                        <label class="form-label">
                                            <i class="bi bi-envelope"></i>
                                            Email
                                        </label>
                                        <input type="email" class="form-control modern-input"
                                            style="margin-bottom: -10px !important;"
                                            [(ngModel)]="clienteSinPaciente.email" placeholder="ejemplo@correo.com"
                                            (blur)="onEmailChange()"
                                            (input)="onEmailChange(); onCampoEditadoManualmente()"
                                            [class.campo-autocompletado]="clienteEncontrado" data-email-input>
                                        <div class="error-message"
                                            *ngIf="!getEstadoCampoEmail().valido && clienteSinPaciente.email">
                                            <i class="bi bi-exclamation-circle"></i>
                                            {{ getEstadoCampoEmail().mensaje }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Informaci√≥n adicional sobre validaci√≥n -->
                            <div class="info-validacion" *ngIf="clienteSinPaciente.cedula && validacionIntentada">
                                <div class="alert alert-info" [ngClass]="{
                                    'alert-success': clienteEncontrado,
                                    'alert-warning': !clienteEncontrado && !validandoCliente,
                                    'alert-info': validandoCliente
                                }">
                                    <div class="d-flex align-items-center">
                                        <i class="bi" [class.bi-check-circle-fill]="clienteEncontrado"
                                            [class.bi-exclamation-circle-fill]="!clienteEncontrado && !validandoCliente"
                                            [class.bi-hourglass-split]="validandoCliente" class="me-2"></i>
                                        <div>
                                            <strong>
                                                {{ clienteEncontrado ? 'Cliente Verificado' :
                                                validandoCliente ? 'Validando...' : 'Cliente No Encontrado' }}
                                            </strong>
                                            <div class="small">
                                                {{ clienteEncontrado ?
                                                'Los datos fueron autocompletados desde nuestra base de datos' :
                                                validandoCliente ?
                                                'Buscando informaci√≥n del cliente...' :
                                                'Complete los datos manualmente. El cliente ser√° registrado al generar la venta.' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üí≥ Configuraci√≥n de venta - Modernizada -->
                <div class="info-card pago">
                    <div class="card-header-detalle">
                        <i class="bi bi-credit-card"></i>
                        <span>Configuraci√≥n de Venta</span>
                    </div>
                    <div class="card-body-detalle">
                        <!-- Forma de Pago y Descuento -->
                        <div class="config-grid">
                            <div class="config-item">
                                <label class="form-label">Forma de pago</label>
                                <select class="form-select modern-select" [(ngModel)]="venta.formaPago"
                                    (ngModelChange)="onFormaPagoChange($event)">
                                    <option value="contado">Contado</option>
                                    <option value="abono">Abono parcial</option>
                                    <option value="cashea">Cashea</option>
                                </select>
                            </div>

                            <div class="config-item">
                                <label class="form-label">Descuento (%)</label>
                                <div class="input-with-hint">
                                    <input type="number" class="form-control modern-input" [(ngModel)]="venta.descuento"
                                        min="0" max="100" (ngModelChange)="onDescuentoChange()"
                                        style="margin-bottom: 0rem !important; height: 50px !important;" />
                                    <small class="hint-text">
                                        <i class="bi bi-lightbulb"></i> Afecta el <strong>Monto total</strong>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Cashea - Modernizado -->
                        <div *ngIf="venta.formaPago === 'cashea'" class="cashea-section">
                            <div class="cashea-config">
                                <div class="config-item">
                                    <label class="form-label">Nivel Cashea</label>
                                    <select class="form-select modern-select" [(ngModel)]="nivelCashea"
                                        (change)="asignarInicialPorNivel()">
                                        <option value="nivel1">Nivel 1 (60%)</option>
                                        <option value="nivel2">Nivel 2 (50%)</option>
                                        <option value="nivel3">Nivel 3 (40%)</option>
                                        <option value="nivel4">Nivel 4 (40%)</option>
                                        <option value="nivel5">Nivel 5 (40%)</option>
                                        <option value="nivel6">Nivel 6 (40%)</option>
                                    </select>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Cuotas</label>
                                    <select class="form-select modern-select" [(ngModel)]="cantidadCuotasCashea"
                                        (change)="generarCuotasCashea()"
                                        [disabled]="!nivelPermiteCuotasExtendidas(nivelCashea)">
                                        <option [value]="3">3 cuotas</option>
                                        <option [value]="6" [disabled]="!nivelPermiteCuotasExtendidas(nivelCashea)">6
                                            cuotas</option>
                                    </select>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Inicial</label>
                                    <div class="input-with-validation">
                                        <input type="text" class="form-control modern-input"
                                            [placeholder]="formatearMoneda(calcularInicialCasheaPorNivel(montoTotal, nivelCashea), venta.moneda)"
                                            [(ngModel)]="valorInicialTemporal" (blur)="formatearInicialCashea()"
                                            (input)="onMontoInicialChange()" (keypress)="validarEntrada($event)"
                                            (keydown.escape)="limpiarCampoInicial()" />
                                        <small class="validation-text">
                                            M√≠nimo: {{ formatearMoneda(calcularInicialCasheaPorNivel(montoTotal,
                                            nivelCashea), venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'"> {{
                                                obtenerEquivalenteBs(calcularInicialCasheaPorNivel(montoTotal,
                                                nivelCashea)) | number:'1.2-2' }} Bs</span>
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- Cuotas Cashea - Modernizado -->
                            <div class="cuotas-section">
                                <label class="section-label">
                                    <i class="bi bi-calendar-check"></i>
                                    Fechas de pago
                                </label>
                                <small class="section-subtitle">Fechas aproximadas. Valida en la aplicaci√≥n de
                                    Cashea.</small>

                                <div class="cuotas-grid">
                                    <ng-container *ngFor="let cuota of cuotasCashea; let i = index">
                                        <div class="cuota-card" [ngClass]="{
                                            'cuota-pagada': cuota.pagada,
                                            'cuota-seleccionada': cuota.seleccionada && !cuota.pagada,
                                            'cuota-pendiente': !cuota.seleccionada && !cuota.pagada,
                                            'cuota-deshabilitada': !cuota.habilitada
                                        }" (click)="cuota.habilitada && toggleCuotaSeleccionada(i)">
                                            <div class="cuota-header">
                                                <span class="cuota-numero">Cuota {{ cuota.id }}</span>
                                                <span class="cuota-estado" [ngClass]="{
                                                    'estado-pagada': cuota.pagada,
                                                    'estado-seleccionada': cuota.seleccionada && !cuota.pagada,
                                                    'estado-pendiente': !cuota.seleccionada && !cuota.pagada
                                                }">
                                                    {{ cuota.pagada ? 'Pagada' : cuota.seleccionada ? 'Seleccionada' :
                                                    'Pendiente' }}
                                                </span>
                                            </div>
                                            <div class="cuota-body">
                                                <div class="cuota-fecha">{{ cuota.fecha }}</div>
                                                <div class="cuota-monto">{{ formatearMoneda(cuota.monto, venta.moneda)
                                                    }}</div>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Resumen Cashea - Mensaje claro -->
                                <div class="resumen-cashea" [ngClass]="{ 
                                    'resumen-invalido': !casheaBalanceValido,
                                    'resumen-completo': esPagoCompletoCashea 
                                }">
                                    <div class="resumen-content">
                                        <span class="resumen-text">
                                            {{ mensajeResumenCashea }}
                                        </span>
                                        <span class="resumen-monto">
                                            {{ formatearMoneda(resumenCashea.total, venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'">(~{{
                                                formatearMoneda(resumenCashea.totalBs, 'bolivar') }})</span>
                                            <i *ngIf="!casheaBalanceValido"
                                                class="bi bi-exclamation-triangle text-warning ms-1"></i>
                                            <i *ngIf="esPagoCompletoCashea"
                                                class="bi bi-check-circle text-success ms-1"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Abono parcial - Modernizado -->
                        <div *ngIf="venta.formaPago === 'abono'" class="abono-section">
                            <div class="abono-config">
                                <div class="config-item">
                                    <label class="form-label">Monto abonado</label>
                                    <div class="abono-input-group">
                                        <input type="text" class="form-control modern-input"
                                            [placeholder]="'Monto en ' + obtenerSimboloMoneda(venta.moneda)"
                                            [(ngModel)]="valorTemporal" (blur)="formatearMonto()"
                                            (keypress)="validarEntrada($event)" />

                                        <div class="progress-container">
                                            <div class="progress-label">
                                                <span>{{ porcentajeAbonadoDelTotal }}% del total cubierto</span>
                                                <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                    {{ formatearMoneda(obtenerEquivalenteBs(venta.montoAbonado ?? 0),
                                                    'bolivar') }}
                                                </span>
                                            </div>
                                            <div class="progress modern-progress">
                                                <div class="progress-bar" role="progressbar"
                                                    [style.width.%]="porcentajeAbonadoDelTotal"
                                                    [ngClass]="{'progress-complete': porcentajeAbonadoDelTotal === 100, 'progress-partial': porcentajeAbonadoDelTotal < 100 }">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Total adeudado</label>
                                    <div class="adeudado-display">
                                        <span class="adeudado-monto">
                                            {{ formatearMoneda(montoTotal - (venta.montoAbonado ?? 0), venta.moneda) }}
                                        </span>
                                        <small *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                            {{ formatearMoneda(obtenerEquivalenteBs(montoTotal - (venta.montoAbonado
                                            ?? 0)), 'bolivar') }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="metodos-pago-section">
                            <div class="section-header">
                                <div class="section-label-container">
                                    <label class="section-label">
                                        <i class="bi bi-wallet2"></i>
                                        M√©todos de pago
                                    </label>
                                    <small class="section-description">Agrega y configura los m√©todos de pago para esta
                                        venta</small>
                                </div>
                                <div class="section-actions">
                                    <!-- BOT√ìN DIN√ÅMICO -->
                                    <button class="btn btn-add-method" (click)="agregarMetodo()" title="Agregar m√©todo"
                                        *ngIf="venta.metodosDePago.length > 0">
                                        <i class="bi bi-plus-circle"></i>
                                        Agregar M√©todo
                                    </button>
                                </div>
                            </div>

                            <!-- Selector de moneda para efectivo -->
                            <div *ngIf="hayMetodoEfectivoSeleccionado()" class="moneda-selector-container">
                                <div class="moneda-selector-header">
                                    <i class="bi bi-currency-exchange"></i>
                                    <span>Moneda para Pagos en Efectivo</span>
                                </div>
                                <div class="moneda-selector-buttons">
                                    <button type="button" class="moneda-btn"
                                        [class.moneda-active]="monedaEfectivo === 'USD'"
                                        (click)="cambiarMonedaEfectivo('USD')">
                                        <span class="moneda-symbol">$</span>
                                        <span class="moneda-info">
                                            <strong>USD</strong>
                                            <small>D√≥lar Americano</small>
                                        </span>
                                    </button>

                                    <button type="button" class="moneda-btn"
                                        [class.moneda-active]="monedaEfectivo === 'EUR'"
                                        (click)="cambiarMonedaEfectivo('EUR')">
                                        <span class="moneda-symbol">‚Ç¨</span>
                                        <span class="moneda-info">
                                            <strong>EUR</strong>
                                            <small>Euro</small>
                                        </span>
                                    </button>

                                    <button type="button" class="moneda-btn"
                                        [class.moneda-active]="monedaEfectivo === 'VES'"
                                        (click)="cambiarMonedaEfectivo('VES')">
                                        <span class="moneda-symbol">Bs</span>
                                        <span class="moneda-info">
                                            <strong>VES</strong>
                                            <small>Bol√≠var</small>
                                        </span>
                                    </button>
                                </div>
                                <div class="moneda-hint">
                                    <i class="bi bi-info-circle"></i>
                                    <span>Esta selecci√≥n aplica a todos los pagos en efectivo</span>
                                </div>
                            </div>

                            <!-- Contador de m√©todos -->
                            <div class="metodos-counter" *ngIf="venta.metodosDePago.length > 0">
                                <i class="bi bi-list-check"></i>
                                <span>{{ venta.metodosDePago.length }} m√©todo{{ venta.metodosDePago.length > 1 ? 's' :
                                    '' }} configurado{{ venta.metodosDePago.length > 1 ? 's' : '' }}</span>
                            </div>

                            <div class="metodos-grid" *ngIf="venta.metodosDePago.length > 0">
                                <div *ngFor="let metodo of venta.metodosDePago; let i = index" class="metodo-card">
                                    <!-- Header con n√∫mero y acciones -->
                                    <div class="metodo-card-header">
                                        <div class="metodo-number">
                                            <i class="bi bi-123"></i>
                                            <span>M√©todo #{{ i + 1 }}</span>
                                            <!-- Indicador de estado -->
                                            <span class="estado-metodo"
                                                [ngClass]="{'estado-completo': metodoCompleto(metodo), 'estado-incompleto': !metodoCompleto(metodo) }">
                                                <i class="bi" [class.bi-check-circle-fill]="metodoCompleto(metodo)"
                                                    [class.bi-exclamation-circle-fill]="!metodoCompleto(metodo)"></i>
                                                {{ metodoCompleto(metodo) ? 'Completo' : 'Incompleto' }}
                                            </span>
                                        </div>
                                        <button class="btn btn-remove" (click)="eliminarMetodo(i)"
                                            title="Eliminar m√©todo">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>

                                    <div class="metodo-content">
                                        <!-- Selector de tipo de m√©todo -->
                                        <div class="campo-principal">
                                            <label class="form-label compact-label">
                                                <i class="bi bi-credit-card"></i>
                                                Tipo de Pago
                                            </label>
                                            <select class="form-select modern-select" [(ngModel)]="metodo.tipo"
                                                (change)="onTipoMetodoChange(i)"
                                                [ngClass]="{'campo-invalido': !metodo.tipo}">
                                                <option value="" disabled selected>Elige un m√©todo de pago</option>
                                                <option value="efectivo">üíµ Efectivo</option>
                                                <option value="debito">üí≥ Tarjeta D√©bito</option>
                                                <option value="credito">üîÑ Tarjeta Cr√©dito</option>
                                                <option value="pagomovil">üì± Pago M√≥vil</option>
                                                <option value="transferencia">üè¶ Transferencia</option>
                                                <option value="zelle">üåê Zelle</option>
                                            </select>
                                            <small *ngIf="!metodo.tipo" class="text-danger">
                                                <i class="bi bi-exclamation-triangle"></i> Campo requerido
                                            </small>
                                        </div>

                                        <!-- Campos condicionales -->
                                        <div class="campos-condicionales" *ngIf="metodo.tipo">
                                            <!-- Banco -->
                                            <div *ngIf="necesitaBanco(metodo.tipo)" class="campo-adicional">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-bank"></i>
                                                    Banco
                                                </label>
                                                <ng-select [items]="bancosDisponibles" bindLabel="nombre"
                                                    [(ngModel)]="metodo.bancoObject"
                                                    (ngModelChange)="onBancoChange($event, i)"
                                                    [compareWith]="compararBanco" [searchable]="true" [clearable]="true"
                                                    placeholder="Buscar banco por c√≥digo o nombre..."
                                                    [ngClass]="{'campo-invalido': necesitaBanco(metodo.tipo) && !metodo.bancoObject}">

                                                    <ng-template ng-label-tmp let-item="item">
                                                        <span *ngIf="item">{{ item?.codigo }} - {{ item?.nombre
                                                            }}</span>
                                                        <span *ngIf="!item">Seleccionar banco...</span>
                                                    </ng-template>

                                                    <ng-template ng-option-tmp let-item="item">
                                                        <div class="banco-option" *ngIf="item">
                                                            <div class="banco-codigo">{{ item.codigo }}</div>
                                                            <div class="banco-nombre">{{ item.nombre }}</div>
                                                        </div>
                                                    </ng-template>

                                                    <ng-template ng-notfound-tmp>
                                                        <div class="not-found-message">
                                                            <i class="bi bi-search"></i>
                                                            No se encontraron bancos con ese criterio
                                                        </div>
                                                    </ng-template>
                                                </ng-select>
                                                <small *ngIf="necesitaBanco(metodo.tipo) && !metodo.bancoObject"
                                                    class="text-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Selecciona un banco
                                                </small>
                                            </div>

                                            <!-- Referencia -->
                                            <div *ngIf="necesitaReferencia(metodo.tipo)" class="campo-adicional">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-hash"></i>
                                                    N¬∞ de Referencia
                                                </label>
                                                <input type="text" class="form-control modern-input"
                                                    [(ngModel)]="metodo.referencia" placeholder="Ej: 123456789"
                                                    maxlength="20"
                                                    [ngClass]="{'campo-invalido': necesitaReferencia(metodo.tipo) && (!metodo.referencia || metodo.referencia.trim() === '')}" />
                                                <small
                                                    *ngIf="necesitaReferencia(metodo.tipo) && (!metodo.referencia || metodo.referencia.trim() === '')"
                                                    class="text-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Ingresa el n√∫mero de
                                                    referencia
                                                </small>
                                            </div>

                                            <!-- Monto -->
                                            <div class="campo-monto">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-cash-stack"></i>
                                                    Monto a Pagar
                                                </label>
                                                <input type="text" class="form-control modern-input"
                                                    [placeholder]="getPlaceholderMonto(metodo.tipo)"
                                                    [(ngModel)]="metodo.valorTemporal" (blur)="formatearMontoMetodo(i)"
                                                    (keypress)="validarEntrada($event)" [disabled]="!metodo.tipo"
                                                    [ngClass]="{'campo-invalido': !metodo.monto || metodo.monto <= 0}" />
                                                <small *ngIf="!metodo.monto || metodo.monto <= 0" class="text-danger">
                                                    <i class="bi bi-exclamation-triangle"></i> Ingresa un monto v√°lido
                                                </small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer con informaci√≥n -->
                                    <div class="metodo-footer" *ngIf="metodo.tipo">
                                        <div class="footer-info">
                                            <span class="maximo-text">
                                                <i class="bi bi-graph-up"></i>
                                                M√°x. disponible: {{ formatearMoneda(getMontoRestanteParaMetodo(i),
                                                getMonedaParaMetodo(metodo.tipo)) }}
                                            </span>

                                            <!-- Mostrar conversi√≥n clara -->
                                            <span *ngIf="metodo.monto && metodo.monto > 0" class="conversion-text">
                                                <i class="bi"></i>
                                                {{ formatearMoneda(metodo.monto, getMonedaParaMetodo(metodo.tipo)) }}
                                                = {{ getInfoConversionMetodo(metodo) }}
                                                <span *ngIf="getMonedaParaMetodo(metodo.tipo) !== 'bolivar'"
                                                    class="bs-conversion">
                                                    ({{ formatearMoneda(calcularConversionBs(metodo.monto, metodo.tipo),
                                                    'bolivar') }})
                                                </span>
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Estado vac√≠o -->
                                    <div class="metodo-empty" *ngIf="!metodo.tipo">
                                        <i class="bi bi-credit-card-2-front"></i>
                                        <span>Selecciona un tipo de pago para continuar</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Estado vac√≠o general -->
                            <div class="empty-state" *ngIf="venta.metodosDePago.length === 0">
                                <div class="empty-icon">
                                    <i class="bi bi-wallet"></i>
                                </div>
                                <h5>No hay m√©todos de pago</h5>
                                <p>Agrega al menos un m√©todo de pago para continuar con la venta</p>
                                <!-- BOT√ìN PARA PRIMER M√âTODO -->
                                <button class="btn btn-add-method" (click)="agregarMetodo()">
                                    <i class="bi bi-plus-circle"></i>
                                    Agregar Primer M√©todo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- üßæ Totales - Modernizado -->
                <div class="info-card resumen">
                    <div class="card-header-detalle">
                        <i class="bi bi-graph-up"></i>
                        <span>Resumen Financiero</span>
                    </div>
                    <div class="card-body-detalle">
                        <!-- Totales principales -->
                        <div class="resumen-grid">
                            <!-- Subtotal -->
                            <div class="resumen-item">
                                <span class="resumen-label">
                                    <i class="bi bi-cart me-1"></i>
                                    Subtotal (sin IVA)
                                </span>
                                <span class="resumen-value">{{ formatearMoneda(subtotalSinIva, venta.moneda) }}</span>
                            </div>
                            
                            <!-- Descuento (solo si existe) -->
                            <div *ngIf="tieneDescuento" class="resumen-item">
                                <span class="resumen-label">
                                    <i class="bi bi-tag me-1"></i>
                                    Descuento ({{ venta.descuento }}%)
                                </span>
                                <span class="resumen-value descuento">
                                    -{{ formatearMoneda(descuentoAplicado, venta.moneda) }}
                                </span>
                            </div>
                            
                            <!-- Subtotal con descuento (solo si hay descuento) -->
                            <div *ngIf="tieneDescuento" class="resumen-item subtotal-con-descuento">
                                <span class="resumen-label">
                                    <i class="bi bi-calculator me-1"></i>
                                    Subtotal con descuento
                                </span>
                                <span class="resumen-value">
                                    {{ formatearMoneda(subtotalConDescuento, venta.moneda) }}
                                </span>
                            </div>
                            
                            <!-- IVA -->
                            <div class="resumen-item iva">
                                <span class="resumen-label">
                                    <i class="bi bi-percent me-1"></i>
                                    IVA ({{ ivaPorcentaje }}%)
                                </span>
                                <span class="resumen-value">
                                    {{ formatearMoneda(ivaCalculado, venta.moneda) }}
                                </span>
                            </div>
                            
                            <!-- Separador visual (solo si hay descuento) -->
                            <div *ngIf="tieneDescuento" class="resumen-separator">
                                <i class="bi bi-arrow-down"></i>
                            </div>
                            
                            <!-- Total a pagar -->
                            <div class="resumen-item total-pagar">
                                <span class="resumen-label">
                                    <i class="bi bi-cash-stack me-1"></i>
                                    Total a pagar
                                </span>
                                <span class="resumen-value total-amount">
                                    {{ formatearMoneda(totalPagar, venta.moneda) }}
                                </span>
                            </div>
                            
                            <!-- Mini resumen (si hay descuento) -->
                            <div *ngIf="tieneDescuento" class="resumen-info">
                                <small>
                                    <i class="bi bi-info-circle me-1"></i>
                                    Incluye {{ venta.descuento }}% de descuento
                                </small>
                            </div>
                        </div>

                        <!-- Detalles de forma de pago -->
                        <div class="forma-pago-detalle">
                            <h6 class="detalle-title">
                                <i class="bi bi-credit-card-2-front"></i>
                                Detalles de pago
                            </h6>

                            <!-- Contado -->
                            <div *ngIf="venta.formaPago === 'contado'" class="detalle-contado">
                                <div class="detalle-item">
                                    <span class="detalle-label">Forma de pago:</span>
                                    <span class="detalle-value">{{ venta.formaPago | titlecase }}</span>
                                </div>
                                <div class="detalle-item">
                                    <span class="detalle-label">Monto total:</span>
                                    <span class="detalle-value">
                                        {{ formatearMoneda(redondearDosDecimales(montoTotal), venta.moneda) }}
                                        <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                             {{
                                            formatearMoneda(redondearDosDecimales(obtenerEquivalenteBs(montoTotal)),
                                            'bolivar') }}
                                        </span>
                                    </span>
                                </div>
                            </div>

                            <!-- Cashea -->
                            <div *ngIf="venta.formaPago === 'cashea'" class="detalle-cashea">
                                <div class="detalle-grid">
                                    <div class="detalle-item">
                                        <span class="detalle-label">Forma de pago:</span>
                                        <span class="detalle-value">{{ venta.formaPago | titlecase }}</span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Nivel Cashea:</span>
                                        <span class="detalle-value">{{ obtenerNombreNivelCashea(nivelCashea) }}</span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Inicial:</span>
                                        <span class="detalle-value">
                                            {{ formatearMoneda(redondearDosDecimales(venta.montoInicial), venta.moneda)
                                            }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                 {{
                                                formatearMoneda(redondearDosDecimales(obtenerEquivalenteBs(venta.montoInicial)),
                                                'bolivar') }}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Cuotas:</span>
                                        <span class="detalle-value">
                                            {{ cantidadCuotas }} de {{
                                            formatearMoneda(redondearDosDecimales(montoPrimeraCuota), venta.moneda) }}
                                        </span>
                                    </div>
                                    <div *ngIf="resumenCashea.cantidad > 0" class="detalle-item">
                                        <span class="detalle-label">Adelanto:</span>
                                        <span class="detalle-value">
                                            {{ formatearMoneda(resumenCashea.total, venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                 {{ formatearMoneda(resumenCashea.totalBs, 'bolivar') }}
                                            </span>
                                            <small class="detail-text">({{ resumenCashea.cantidad }} cuota{{
                                                resumenCashea.cantidad > 1 ? 's' : '' }})</small>
                                        </span>
                                    </div>

                                    <!-- Versi√≥n compacta del total pagado -->
                                    <div class="detalle-item total-pagado-item">
                                        <span class="detalle-label">Total a pagar ahora:</span>
                                        <span class="detalle-value total-pagado-value">
                                            <strong>{{ formatearMoneda(totalPagadoCashea, venta.moneda) }}</strong>
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                 {{ formatearMoneda(totalPagadoCasheaBs, 'bolivar') }}
                                            </span>
                                            <small class="detail-text">
                                                (Inicial {{ formatearMoneda(redondearDosDecimales(venta.montoInicial),
                                                venta.moneda) }}
                                                + {{ resumenCashea.cantidad }} cuota{{ resumenCashea.cantidad > 1 ? 's'
                                                : '' }}
                                                {{ formatearMoneda(resumenCashea.total, venta.moneda) }})
                                            </small>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Abono parcial -->
                            <div *ngIf="venta.formaPago === 'abono'" class="detalle-abono">
                                <div class="detalle-grid">
                                    <div class="detalle-item">
                                        <span class="detalle-label">Monto abonado:</span>
                                        <span class="detalle-value">
                                            {{ formatearMoneda(redondearDosDecimales(venta.montoAbonado ?? 0),
                                            venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                 {{
                                                formatearMoneda(redondearDosDecimales(obtenerEquivalenteBs(venta.montoAbonado
                                                ?? 0)), 'bolivar') }}
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Total adeudado:</span>
                                        <span class="detalle-value">
                                            {{ formatearMoneda(redondearDosDecimales(montoTotal - (venta.montoAbonado ??
                                            0)), venta.moneda) }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de m√©todos de pago -->
                        <div class="metodos-resumen">
                            <h6 class="detalle-title">
                                <i class="bi bi-wallet2"></i>
                                M√©todos de pago aplicados
                            </h6>
                            
                            <div class="metodos-list">
                                <div *ngFor="let metodo of venta.metodosDePago" 
                                    class="metodo-resumen-item"
                                    [class.con-datos]="metodo.referencia || metodo.banco"
                                    [class.pago-movil]="metodo.tipo === 'pago_movil' || metodo.tipo === 'pagomovil'"
                                    [class.transferencia]="metodo.tipo === 'transferencia'">
                                    
                                    <div class="metodo-info">
                                        <!-- Tipo de m√©todo de pago -->
                                        <span class="metodo-tipo">
                                            {{ metodo.tipo | titlecase }}
                                        </span>
                                        
                                        <!-- Contenedor para referencia y banco (solo visible si existen) -->
                                        <div *ngIf="metodo.referencia || metodo.banco" class="metodo-datos-container">
                                            
                                            <!-- Mostrar referencia si existe -->
                                            <span *ngIf="metodo.referencia" class="metodo-referencia">
                                                <span class="referencia-label">Ref:</span>
                                                <span class="referencia-value">{{ metodo.referencia }}</span>
                                            </span>
                                            
                                            <!-- Mostrar banco si existe -->
                                            <span *ngIf="metodo.banco" class="metodo-banco">
                                                <span class="banco-label">Banco:</span>
                                                <span class="banco-value">{{ metodo.banco }}</span>
                                            </span>
                                            
                                        </div>
                                    </div>
                                    
                                    <!-- Monto y conversi√≥n -->
                                    <span class="metodo-monto">
                                        <span class="monto-principal">
                                            {{ formatearMoneda(redondear(metodo.monto ?? 0), getMonedaParaMetodo(metodo.tipo)) }}
                                        </span>
                                        
                                        <span *ngIf="getMonedaParaMetodo(metodo.tipo) !== 'bolivar'" class="conversion-text">
                                            <span class="conversion-value">
                                                {{ formatearMoneda(redondear(calcularConversionBs(metodo.monto ?? 0, metodo.tipo)), 'bolivar') }}
                                            </span>
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selecci√≥n de Asesor - Switch en header, selector a la derecha -->
                <div class="info-card asesor asesor-container">
                    <div class="card-header-detalle">
                        <i class="bi bi-person-gear"></i>
                        <span>Asesor de Venta</span>
                        <div class="header-toggle">
                            <label class="toggle-label">Cambiar asesor</label>
                            <div class="toggle-switch modern compact">
                                <label class="switch">
                                    <input type="checkbox" [(ngModel)]="mostrarSelectorAsesor">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body-detalle">
                        <div class="asesor-layout-horizontal">
                            <!-- Secci√≥n izquierda: Informaci√≥n del asesor actual -->
                            <div class="asesor-info-section">
                                <div class="asesor-current-compact">
                                    <div class="asesor-avatar">
                                        <i class="bi bi-person-circle"></i>
                                    </div>
                                    <div class="asesor-details-compact">
                                        <h4 class="asesor-name">{{ getNombreAsesorSeleccionado() }}</h4>
                                        <p class="asesor-role">{{ getCargoAsesorSeleccionado() }}</p>
                                        <span class="asesor-badge">Asesor actual</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Secci√≥n derecha: Selector compacto -->
                            <div *ngIf="mostrarSelectorAsesor" class="asesor-selector-section">
                                <div class="selector-container">
                                    <select class="form-select asesor-select-normal" [(ngModel)]="asesorSeleccionado"
                                        (change)="onAsesorChange()">
                                        <option value="" disabled selected>Seleccionar asesor...</option>
                                        <option *ngFor="let empleado of empleadosDisponibles" [value]="empleado.id">
                                            {{ empleado.nombre }}
                                        </option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="bi bi-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer modernizado -->
            <div class="modal-footer-detalle">
                <div class="footer-actions">
                    <button type="button" class="btn btn-secondary btn-detalle" data-bs-dismiss="modal"
                        [disabled]="generandoVenta">
                        <i class="bi bi-x-circle me-2"></i>
                        {{ generandoVenta ? 'Cancelando...' : 'Cancelar' }}
                    </button>
                    <button type="button" class="btn btn-success btn-detalle" (click)="generarVenta()"
                        [disabled]="!puedeGenerarVenta || generandoVenta" [title]="mensajeEstadoBoton">
                        <i class="bi" [class.bi-check-circle]="!generandoVenta"
                            [class.bi-hourglass-split]="generandoVenta" class="me-2"></i>
                        {{ generandoVenta ? 'Procesando...' : 'Confirmar y Generar Venta' }}
                        <span *ngIf="!puedeGenerarVenta && !generandoVenta" class="ms-1">({{ mensajeEstadoBoton
                            }})</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Recibo -->
<div class="modal fade" id="reciboModal" [class.show]="mostrarModalRecibo"
    [style.display]="mostrarModalRecibo ? 'block' : 'none'" tabindex="-1" [attr.aria-hidden]="!mostrarModalRecibo">
    <div class="modal-dialog modal-xl">
        <div class="modal-content recibo-compacto">
            <!-- Header del Recibo -->
            <div class="modal-header-recibo">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="bi bi-file-earmark-pdf"></i>
                    </div>
                    <div class="header-text">
                        <h5 class="modal-title">{{ getTituloRecibo() }}</h5>
                        <div class="header-subtitle">
                            <span class="badge badge-recibo">Recibo {{ informacionVenta?.numeroVenta }}</span>
                            <span class="status-badge" [class]="getEstadoBadgeClass()">
                                {{ getEstadoTexto() }}
                            </span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" (click)="cerrarModalRecibo()"
                    aria-label="Close"></button>
            </div>

            <!-- Body del Recibo -->
            <div class="modal-body p-3">
                <div class="recibo-container compacto" id="contenidoRecibo">
                    <!-- Encabezado compacto -->
                    <div class="recibo-header text-center mb-3">
                        <!-- Nombre de la sede desde la informaci√≥n de sede -->
                        <h4 class="empresa-nombre mb-1">{{ datosRecibo?.sede?.nombre || '' }}</h4>

                        <!-- Informaci√≥n de contacto din√°mica -->
                        <div class="empresa-info small text-muted">
                            <!-- Direcci√≥n desde sedeInfo -->
                            <p class="mb-0">{{ datosRecibo?.sede?.direccion || '' }}</p>

                            <!-- Tel√©fono y RIF desde sedeInfo -->
                            <p class="mb-0">
                                Tel: {{ datosRecibo?.sede?.telefono || '' }} |
                                RIF: {{ datosRecibo?.sede?.rif || '' }}
                            </p>

                            <!-- Email desde sedeInfo -->
                            <p class="mb-0">Email: {{ datosRecibo?.sede?.email || '' }}</p>
                        </div>

                        <h5 class="titulo-venta mt-2 mb-0 text-dark">{{ getTituloRecibo() }}</h5>
                    </div>

                    <!-- Informaci√≥n -->
                    <div class="info-rapida mb-3">
                        <div class="row g-2 small">
                            <div class="col-md-3">
                                <strong>Recibo:</strong> {{ datosRecibo?.numeroVenta || 'N/A' }}
                            </div>
                            <div class="col-md-3">
                                <strong>Fecha:</strong> {{ datosRecibo?.fecha || 'N/A' }}
                            </div>
                            <div class="col-md-3">
                                <strong>Hora:</strong> {{ datosRecibo?.hora || 'N/A' }}
                            </div>
                            <div class="col-md-3">
                                <strong>Vendedor:</strong> {{ datosRecibo?.vendedor || 'N/A' }}
                            </div>
                        </div>
                    </div>

                    <!-- Cliente compacto -->
                    <div class="cliente-compacto mb-3 p-2 bg-light rounded small">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <!-- Cambiar "Cliente:" por "Paciente:" o "Cliente:" -->
                                <strong>
                                    {{ datosRecibo?.cliente?.esPaciente ? 'Paciente:' : 'Cliente:' }}
                                </strong> 
                                {{ datosRecibo?.cliente?.nombre || (datosRecibo?.cliente?.esPaciente ? 'PACIENTE' : 'CLIENTE GENERAL') }}
                            </div>
                            <div class="col-md-4">
                                <strong>C√©dula:</strong> {{ datosRecibo?.cliente?.cedula || 'N/A' }}
                            </div>
                            <div class="col-md-4">
                                <strong>Tel√©fono:</strong> {{ datosRecibo?.cliente?.telefono || 'N/A' }}
                            </div>
                        </div>
                    </div>

                    <!-- Productos compactos -->
                    <div class="productos-compactos mb-3">
                        <h6 class="fw-bold mb-2 text-primary border-bottom pb-1">PRODUCTOS</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="45%" class="text-center">Producto</th>
                                        <th width="15%" class="text-center">Precio Unit.</th>
                                        <th width="10%" class="text-center">Cant.</th>
                                        <th width="15%" class="text-center">SubTotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Solo mostrar datosRecibo.productos -->
                                    <tr *ngFor="let producto of datosRecibo?.productos; let i = index">
                                        <td class="text-center">{{ i + 1 }}</td>
                                        <td>
                                            <div class="fw-bold small">{{ producto.nombre }}</div>
                                            <div class="text-muted extra-small">{{ producto.codigo || 'N/A' }}</div>
                                        </td>
                                        <td class="text-end">
                                            {{ formatearMoneda(producto.precioUnitario, producto.moneda || datosRecibo?.configuracion?.moneda) }}
                                        </td>
                                        <td class="text-center">
                                            {{ producto.cantidad || 1 }}
                                        </td>
                                        <td class="text-end">
                                            {{ formatearMoneda(producto.subtotal, producto.moneda || datosRecibo?.configuracion?.moneda) }}
                                        </td>
                                    </tr>
                                    
                                    <!-- Mensaje si no hay productos -->
                                    <tr *ngIf="!datosRecibo?.productos || datosRecibo.productos.length === 0">
                                        <td colspan="5" class="text-center text-muted py-3">
                                            <i class="bi bi-exclamation-triangle me-2"></i>
                                            No hay productos para mostrar
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- M√©todos de pago compactos -->
                    <div class="metodos-compactos mb-3" *ngIf="getMetodosPagoSeguros().length > 0">
                        <h6 class="fw-bold mb-2 text-primary border-bottom pb-1">PAGOS</h6>
                        <div class="row g-1">
                            <div class="col-12" *ngFor="let metodo of getMetodosPagoSeguros()">
                                <!-- Quita la clase "small" que est√° causando el problema -->
                                <div class="d-flex justify-content-between align-items-center py-1">
                                    <span class="metodo-pago-info">
                                        <span class="badge bg-primary me-1">{{ formatearTipoPago(metodo.tipo) }}</span>
                                        <!-- Pasar la moneda espec√≠fica del m√©todo -->
                                        <span class="monto-text">{{ formatearMoneda(metodo.monto, metodo.moneda)
                                            }}</span>
                                        <span *ngIf="metodo.referencia" class="text-muted ms-1 referencia-text">(Ref: {{
                                            metodo.referencia }})</span>
                                        <span *ngIf="metodo.banco" class="text-muted ms-1 banco-text">- {{ metodo.banco
                                            }}</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Resumen seg√∫n Tipo de Pago REAL -->
                    <div class="resumen-venta mb-3">
                        <h6 class="fw-bold mb-2 text-primary border-bottom pb-1">RESUMEN DE VENTA</h6>

                        <!-- Contado -->
                        <div *ngIf="(datosRecibo?.configuracion?.formaPago || venta.formaPago) === 'contado'"
                            class="resumen-contado">
                            <div class="row small">
                                <div class="col-6">
                                    <strong>Forma de pago:</strong><br>
                                    <span class="badge bg-success">CONTADO</span>
                                </div>
                                <div class="col-6 text-end">
                                    <strong>Monto total:</strong><br>
                                    {{ formatearMoneda(datosRecibo?.totales?.total, datosRecibo?.configuracion?.moneda) }}
                                </div>
                            </div>
                        </div>

                        <!-- Cashea - Versi√≥n mejorada con fechas -->
                        <div *ngIf="(datosRecibo?.configuracion?.formaPago || venta.formaPago) === 'cashea'"
                            class="resumen-cashea">
                            <!-- Forma de pago -->
                            <div class="row small mb-3">
                                <div class="col-12 text-center">
                                    <span class="badge bg-info fs-6">PLAN CASHEA</span>
                                </div>
                            </div>

                            <!-- Informaci√≥n del plan Cashea -->
                            <div class="row small mb-3">
                                <div class="col-12 text-center">
                                    <div class="cashea-info">
                                        <div class="nivel-cashea mb-2">
                                            <small class="text-muted">NIVEL</small>
                                            <div class="fw-bold text-primary">
                                                {{ datosRecibo?.cashea?.nivel ?
                                                obtenerNombreNivelCashea(datosRecibo.cashea.nivel) :
                                                obtenerNombreNivelCashea(nivelCashea) }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Desglose de pagos -->
                            <div class="row small mb-3">
                                <div class="col-12">
                                    <div class="pagos-section">
                                        <h6 class="text-center mb-3 fw-bold text-primary">DESGLOSE DE PAGOS</h6>

                                        <!-- Pago inicial -->
                                        <div
                                            class="pago-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="pago-concepto text-center w-50">
                                                <i class="bi bi-credit-card text-primary me-1"></i>
                                                <strong>Pago Inicial</strong>
                                            </div>
                                            <div class="pago-monto text-center w-50">
                                                <strong>{{ formatearMoneda(datosRecibo?.cashea?.inicial ||
                                                    venta.montoInicial) }}</strong>
                                            </div>
                                        </div>

                                        <!-- Cuotas adelantadas -->
                                        <div *ngIf="(datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad) > 0"
                                            class="pago-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                            <div class="pago-concepto text-center w-50">
                                                <i class="bi bi-calendar-plus text-success me-1"></i>
                                                <strong>{{ datosRecibo?.cashea?.cuotasAdelantadas ||
                                                    resumenCashea.cantidad }} Cuota{{
                                                    (datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad) >
                                                    1 ? 's' : '' }} Adelantada{{ (datosRecibo?.cashea?.cuotasAdelantadas
                                                    || resumenCashea.cantidad) > 1 ? 's' : '' }}</strong>
                                            </div>
                                            <div class="pago-monto text-center w-50">
                                                <strong>{{ formatearMoneda(datosRecibo?.cashea?.montoAdelantado ||
                                                    resumenCashea.total) }}</strong>
                                            </div>
                                        </div>

                                        <!-- Total pagado ahora -->
                                        <div
                                            class="pago-total d-flex justify-content-between align-items-center py-2 mt-2 border-top">
                                            <div class="text-center w-50">
                                                <strong>TOTAL PAGADO AHORA:</strong>
                                            </div>
                                            <div class="text-center w-50">
                                                <strong class="text-success">
                                                    {{ formatearMoneda(getTotalPagadoSeguro()) }}
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendario de cuotas pendientes -->
                            <div class="row small mb-3">
                                <div class="col-12">
                                    <div class="cuotas-section">
                                        <h6 class="text-center mb-3 fw-bold text-primary">FECHAS ESTIMADAS DE PAGO</h6>

                                        <div class="cuotas-list">
                                            <div *ngFor="let cuota of cuotasCashea; let i = index"
                                                class="cuota-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <div class="cuota-info text-center w-60">
                                                    <i class="bi bi-calendar-event text-info me-1"></i>
                                                    <small class="text-muted">Cuota {{ cuota.id }}</small>
                                                    <div class="fw-bold">{{ cuota.fecha }}</div>
                                                </div>
                                                <div class="cuota-monto text-center w-40">
                                                    <div class="fw-bold">{{ formatearMoneda(cuota.monto) }}</div>
                                                    <small class="badge" [class.badge-pagada]="cuota.pagada"
                                                        [class.badge-adelantada]="cuota.seleccionada && !cuota.pagada"
                                                        [class.badge-pendiente]="!cuota.seleccionada && !cuota.pagada">
                                                        {{ cuota.pagada ? 'Pagada' : cuota.seleccionada ? 'Adelantada' :
                                                        'Pendiente' }}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Resumen de cuotas -->
                                        <div
                                            class="resumen-cuotas d-flex justify-content-between align-items-center py-2 mt-2 border-top">
                                            <div class="text-center w-50">
                                                <small class="text-muted">CUOTAS PENDIENTES</small>
                                                <div class="fw-bold text-warning">
                                                    {{ (datosRecibo?.cashea?.cantidadCuotas || cantidadCuotasCashea) -
                                                    (datosRecibo?.cashea?.cuotasAdelantadas || resumenCashea.cantidad)
                                                    }}
                                                </div>
                                            </div>
                                            <div class="text-center w-50">
                                                <small class="text-muted">DEUDA PENDIENTE</small>
                                                <div class="fw-bold text-danger">
                                                    {{ formatearMoneda(datosRecibo?.cashea?.deudaPendiente ||
                                                    getDeudaPendienteCashea()) }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Abono - Versi√≥n profesional sin celdas -->
                        <div *ngIf="(datosRecibo?.configuracion?.formaPago || venta.formaPago) === 'abono'"
                            class="resumen-abono">
                            <!-- Forma de pago -->
                            <div class="row small mb-3">
                                <div class="col-12 text-center">
                                    <span class="badge bg-warning text-dark fs-6">ABONO PARCIAL</span>
                                </div>
                            </div>

                            <!-- Abonos realizados - Dise√±o profesional -->
                            <div class="row small mb-3">
                                <div class="col-12">
                                    <div class="abonos-section">
                                        <h6 class="text-center mb-3 fw-bold text-primary">ABONOS REALIZADOS</h6>

                                        <div class="abonos-list">
                                            <div
                                                class="abono-item d-flex justify-content-between align-items-center py-2 border-bottom">
                                                <div class="abono-fecha text-center w-50">
                                                    <i class="bi bi-calendar-check text-primary me-1"></i>
                                                    <strong>{{ datosRecibo?.fecha }}</strong>
                                                </div>
                                                <div class="abono-monto text-center w-50">
                                                    <i class="bi bi-cash-coin text-success me-1"></i>
                                                    <strong>{{ formatearMoneda(datosRecibo?.abono?.montoAbonado ||
                                                        venta.montoAbonado) }}</strong>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Total abonado -->
                                        <div
                                            class="total-abonado d-flex justify-content-between align-items-center py-2 mt-2 border-top">
                                            <div class="text-center w-50">
                                                <strong>TOTAL ABONADO:</strong>
                                            </div>
                                            <div class="text-center w-50">
                                                <strong class="text-success">
                                                    {{ formatearMoneda(datosRecibo?.abono?.montoAbonado ||
                                                    venta.montoAbonado) }}
                                                </strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Resumen financiero centrado -->
                            <div class="row small">
                                <div class="col-12">
                                    <div class="resumen-financiero text-center">
                                        <div class="deuda-section mb-3">
                                            <div class="deuda-label text-muted">DEUDA PENDIENTE</div>
                                            <div class="deuda-monto fs-5 fw-bold text-danger">
                                                {{ formatearMoneda(datosRecibo?.abono?.deudaPendiente ||
                                                getDeudaPendienteAbono()) }}
                                            </div>
                                        </div>

                                        <div class="progreso-section">
                                            <div class="progreso-label text-muted">PORCENTAJE PAGADO</div>
                                            <div class="progreso-porcentaje fs-5 fw-bold text-success mb-2">
                                                {{ (datosRecibo?.abono?.porcentajePagado || porcentajeAbonadoDelTotal) |
                                                number:'1.0-0' }}%
                                            </div>
                                            <div class="progress mx-auto" style="width: 80%; height: 8px;">
                                                <div class="progress-bar bg-success"
                                                    [style.width.%]="datosRecibo?.abono?.porcentajePagado || porcentajeAbonadoDelTotal">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Totales compactos -->
                    <div class="totales-compactos mb-3">
                        <div class="row justify-content-end">
                            <div class="col-md-6">
                                <table class="table table-sm table-bordered">
                                    <!-- Subtotal - usar datosRecibo.totales.subtotal -->
                                    <tr>
                                        <td class="fw-bold">Subtotal (sin IVA):</td>
                                        <td class="text-end">{{ formatearMoneda(datosRecibo?.totales?.subtotal, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    
                                    <!-- Descuento - solo si existe -->
                                    <tr *ngIf="datosRecibo?.totales?.descuento > 0">
                                        <td class="fw-bold">Descuento ({{ datosRecibo?.configuracion?.descuento }}%):</td>
                                        <td class="text-end text-danger">- {{ formatearMoneda(datosRecibo?.totales?.descuento, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    
                                    <!-- Subtotal con descuento - solo si hay descuento -->
                                    <tr *ngIf="datosRecibo?.totales?.descuento > 0">
                                        <td class="fw-bold">Subtotal con descuento:</td>
                                        <td class="text-end">{{ formatearMoneda(datosRecibo?.totales?.subtotal - datosRecibo?.totales?.descuento, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    
                                    <!-- IVA -->
                                    <tr>
                                        <td class="fw-bold">IVA ({{ datosRecibo?.configuracion?.impuesto || ivaPorcentaje }}%):</td>
                                        <td class="text-end">{{ formatearMoneda(datosRecibo?.totales?.iva, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    
                                    <!-- Mostrar seg√∫n forma de pago -->
                                    <tr *ngIf="datosRecibo?.configuracion?.formaPago === 'contado'" class="table-success">
                                        <td class="fw-bold">Total pagado:</td>
                                        <td class="text-end fw-bold">{{ formatearMoneda(datosRecibo?.totales?.totalPagado, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>

                                    <tr *ngIf="datosRecibo?.configuracion?.formaPago === 'cashea'" class="table-info">
                                        <td class="fw-bold">Total a pagar:</td>
                                        <td class="text-end fw-bold">{{ formatearMoneda(datosRecibo?.totales?.total, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    <tr *ngIf="datosRecibo?.configuracion?.formaPago === 'cashea'" class="table-warning">
                                        <td class="fw-bold">Total pagado ahora:</td>
                                        <td class="text-end fw-bold">{{ formatearMoneda(datosRecibo?.totales?.totalPagado, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>

                                    <tr *ngIf="datosRecibo?.configuracion?.formaPago === 'abono'" class="table-info">
                                        <td class="fw-bold">Total a pagar:</td>
                                        <td class="text-end fw-bold">{{ formatearMoneda(datosRecibo?.totales?.total, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                    <tr *ngIf="datosRecibo?.configuracion?.formaPago === 'abono'" class="table-warning">
                                        <td class="fw-bold">Total abonado:</td>
                                        <td class="text-end fw-bold">{{ formatearMoneda(datosRecibo?.totales?.totalPagado, datosRecibo?.configuracion?.moneda) }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones compactas -->
                    <div class="observaciones-compactas mb-3" *ngIf="datosRecibo?.observaciones">
                        <div class="alert alert-warning py-1 small mb-0">
                            <strong>Observaci√≥n:</strong> {{ datosRecibo?.observaciones }}
                        </div>
                    </div>

                    <!-- T√©rminos compactos -->
                    <div class="terminos-compactos mt-3 pt-2 border-top">
                        <div class="row small text-muted">
                            <div class="col-md-8">
                                <p class="mb-1">
                                    <i class="bi bi-exclamation-triangle text-warning me-1"></i>
                                    Pasados 30 d√≠as no nos hacemos responsables de trabajos no retirados
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <small>{{ currentYear }} ¬© New Vision Lens 2020</small>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje final -->
                    <div class="mensaje-final text-center mt-2 pt-2 border-top">
                        <p class="mb-0 small text-primary fw-bold">
                            <i class="bi bi-check-circle me-1"></i>
                            {{ getMensajeFinal() }}
                        </p>
                    </div>
                </div>
            </div>

            <!-- Footer del Modal Recibo -->
            <div class="modal-footer-recibo">
                <div class="footer-actions">
                    <div class="footer-section-left">
                        <!-- Compartir con todas las opciones incluyendo PDF -->
                        <div class="btn-group" ngbDropdown>
                            <button type="button" class="btn btn-compartir btn-recibo" ngbDropdownToggle>
                                <i class="bi bi-share me-2"></i>
                                Compartir
                            </button>
                            <div class="dropdown-menu" ngbDropdownMenu>
                                <!-- Descargar PDF dentro del men√∫ -->
                                <!-- <button ngbDropdownItem (click)="descargarPDF()">
                                    <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                    Descargar PDF
                                </button> -->
                                <div class="dropdown-divider"></div>
                                <button ngbDropdownItem (click)="compartirWhatsApp()">
                                    <i class="bi bi-whatsapp text-success me-2"></i>
                                    WhatsApp
                                </button>
                                <!-- <button ngbDropdownItem (click)="compartirEmail()">
                                    <i class="bi bi-envelope text-primary me-2"></i>
                                    Email
                                </button>-->
                                <button ngbDropdownItem (click)="copiarEnlace()">
                                    <i class="bi bi-link text-info me-2"></i>
                                    Copiar Enlace
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="footer-section-right">
                        <!-- Imprimir -->
                        <button type="button" class="btn btn-outline-secondary btn-recibo" (click)="imprimirRecibo()">
                            <i class="bi bi-printer me-2"></i>
                            Imprimir
                        </button>

                        <!-- Cerrar -->
                        <button type="button" class="btn btn-primary btn-recibo" (click)="cerrarModalRecibo()">
                            <i class="bi bi-check me-2"></i>
                            Listo
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade show" *ngIf="mostrarModalRecibo"></div>