<div class="card contenedor-generar-venta-moderno">
    <!-- Encabezado modernizado -->
    <div class="card-header-moderno">
        <div class="header-content">
            <div class="header-icon">
                <i class="bi bi-cart-plus"></i>
            </div>
            <div class="header-text">
                <h4 class="header-title">Generar Venta</h4>
                <div class="header-subtitle">Complete la informaci√≥n del paciente y agregue productos</div>
            </div>
        </div>
    </div>

    <!-- Cuerpo -->
    <div class="card-body-moderno">
        <!-- Barra de informaci√≥n contextual -->
        <div class="context-bar">
            <div class="context-info">
                <i class="bi bi-info-circle"></i>
                <span class="context-text">
                    Selecciona un paciente si aplica y agrega productos para continuar la venta.
                </span>
            </div>

            <!-- Switch paciente modernizado -->
            <div class="patient-toggle">
                <div class="toggle-content">
                    <i class="bi bi-person-circle"></i>
                    <span class="toggle-label">Paciente</span>
                    <span class="toggle-badge" [ngClass]="requierePaciente ? 'badge-included' : 'badge-excluded'">
                        {{ requierePaciente ? 'Incluido' : 'No incluido' }}
                    </span>
                </div>
                <label class="modern-switch">
                    <input type="checkbox" [(ngModel)]="requierePaciente">
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Paneles principales -->
        <div class="paneles-container">
            <!-- üßë Panel Paciente y Contexto Cl√≠nico -->
            <section class="panel-moderno panel-paciente" *ngIf="requierePaciente">
                <div class="panel-header">
                    <i class="bi bi-person-vcard"></i>
                    <span>Informaci√≥n del Paciente</span>
                </div>
                <div class="panel-body">
                    <!-- Buscador de paciente -->
                    <div class="buscador-moderno">
                        <label class="form-label-moderno">
                            <i class="bi bi-search"></i>
                            Buscar paciente
                        </label>
                        <ng-select id="selectorPaciente" [items]="pacientesFiltradosPorSede"
                            bindLabel="informacionPersonal.nombreCompleto" [selectOnTab]="true" [clearable]="true"
                            [searchable]="true" [(ngModel)]="pacienteSeleccionado"
                            (search)="actualizarFiltroTexto($event)" (change)="onPacienteSeleccionado($event)"
                            [searchFn]="filtrarPorNombreOCedula" placeholder="Buscar por nombre o c√©dula..."
                            class="modern-ng-select">

                            <ng-template ng-option-tmp let-item="item">
                                <div class="paciente-option">
                                    <strong>{{ item.informacionPersonal.nombreCompleto }}</strong>
                                    <small class="text-muted">‚Äî {{ item.informacionPersonal.cedula }}</small>
                                </div>
                            </ng-template>

                            <ng-template ng-notfound-tmp>
                                <div class="not-found-message">
                                    <i class="bi bi-exclamation-circle"></i>
                                    No se encontraron pacientes con ese nombre o c√©dula
                                </div>
                            </ng-template>
                        </ng-select>
                    </div>

                    <!-- Formulaci√≥n cl√≠nica -->
                    <div *ngIf="historiaMedica" class="formulacion-section">
                        <div class="section-header">
                            <h5>Formulaci√≥n Cl√≠nica</h5>
                            <i class="bi bi-eyeglasses"></i>
                        </div>

                        <div class="formulacion-grid">
                            <!-- Ojo Derecho -->
                            <div class="ojo-card">
                                <div class="ojo-header ojo-derecho">
                                    <i class="bi bi-eye-fill"></i>
                                    <span>Ojo Derecho (OD)</span>
                                </div>
                                <div class="ojo-params">
                                    <div class="param">
                                        <span class="param-label">Esfera (ESF)</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.esf_od
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Cilindro (CIL)</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.cil_od
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Eje</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.eje_od
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ADD</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.add_od
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ALT</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.alt_od
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">DP</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.dp_od
                                            }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ojo Izquierdo -->
                            <div class="ojo-card">
                                <div class="ojo-header ojo-izquierdo">
                                    <i class="bi bi-eye-fill"></i>
                                    <span>Ojo Izquierdo (OI)</span>
                                </div>
                                <div class="ojo-params">
                                    <div class="param">
                                        <span class="param-label">Esfera (ESF)</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.esf_oi
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Cilindro (CIL)</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.cil_oi
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">Eje</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.eje_oi
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ADD</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.add_oi
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">ALT</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.alt_oi
                                            }}</span>
                                    </div>
                                    <div class="param">
                                        <span class="param-label">DP</span>
                                        <span class="param-value">{{ historiaMedica.examenOcular.refraccionFinal.dp_oi
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recomendaciones -->
                        <div class="recomendaciones-section">
                            <div class="section-header">
                                <h5>Recomendaciones</h5>
                                <i class="bi bi-clipboard-check"></i>
                            </div>
                            <div class="recomendaciones-grid">
                                <div class="recomendacion-item">
                                    <span class="rec-label">Montura</span>
                                    <span class="rec-value">{{ historiaMedica.recomendaciones[0].montura }}</span>
                                </div>
                                <div class="recomendacion-item">
                                    <span class="rec-label">Material</span>
                                    <span class="rec-value">{{ materialesRecomendados }}</span>
                                </div>
                                <div class="recomendacion-item">
                                    <span class="rec-label">Cristal</span>
                                    <span class="rec-value">{{ historiaMedica.recomendaciones[0].cristal.label }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- üõí Panel Carrito de Productos -->
            <section class="panel-moderno panel-productos">
                <div class="panel-header">
                    <i class="bi bi-cart"></i>
                    <span>Carrito de Productos</span>
                </div>
                <div class="panel-body">
                    <!-- Buscador de productos -->
                    <div class="buscador-productos">
                        <div class="buscador-main">
                            <label class="form-label-moderno">
                                <i class="bi bi-search"></i>
                                Buscar producto
                            </label>
                            <ng-select id="selectorProducto" [items]="productosFiltradosPorSede" bindLabel="nombre"
                                [searchable]="true" [clearable]="true" [selectOnTab]="true"
                                [(ngModel)]="productoSeleccionado" (change)="agregarProductoAlCarrito($event)"
                                [searchFn]="filtrarProductoPorNombreOCodigo" placeholder="Buscar por nombre o c√≥digo..."
                                class="modern-ng-select">
                                <ng-template ng-option-tmp let-item="item">
                                    <div class="producto-option">
                                        <strong>{{ item.nombre }}</strong>
                                        <small class="text-muted">‚Äî {{ item.codigo }}</small>
                                    </div>
                                </ng-template>
                                <ng-template ng-notfound-tmp>
                                    <div class="not-found-message">
                                        <i class="bi bi-exclamation-circle"></i>
                                        No se encontraron productos con ese nombre o c√≥digo
                                    </div>
                                </ng-template>
                            </ng-select>
                        </div>
                    </div>

                    <!-- Tabla de productos mejorada -->
                    <div *ngIf="venta.productos.length > 0" class="productos-table-container">
                        <div class="section-header">
                            <i class="bi bi-cart-check"></i>
                            <h5>Productos en el Carrito</h5>
                            <span class="badge bg-primary">{{ venta.productos.length }} producto{{
                                venta.productos.length > 1 ? 's' : '' }}</span>
                        </div>

                        <div class="table-scroll-container">
                            <table class="table-moderna">
                                <thead>
                                    <tr>
                                        <th class="text-center">Producto</th>
                                        <th class="text-center">Precio Unit.</th>
                                        <th class="text-center">Cant.</th>
                                        <th class="text-center">Subtotal</th>
                                        <th class="text-center">
                                            IVA <span class="text-muted">(16%)</span>
                                        </th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let p of productosConDetalle; trackBy: trackByProducto"
                                        class="producto-row">

                                        <!-- Columna Producto -->
                                        <td class="producto-info">
                                            <div class="producto-details">
                                                <span class="producto-nombre">{{ p.nombre }}</span>
                                                <small class="producto-codigo text-muted">{{ p.codigo }}</small>
                                            </div>
                                        </td>

                                        <!-- Columna Precio -->
                                        <td class="text-center precio">
                                            <span class="precio-unitario">
                                                {{ getPrecioParaMostrar(p) | number:'1.2-2' }} {{
                                                getSimboloMonedaActual() }}
                                            </span>
                                            <!-- Referencia en Bs si no es bol√≠var -->
                                            <small *ngIf="!esMonedaBolivar(monedaSistema)" class="text-muted d-block">
                                                Bs {{ getPrecioEnBs(p) | number:'1.2-2' }}
                                            </small>
                                        </td>

                                        <!-- Columna Cantidad -->
                                        <td class="text-center cantidad-cell">
                                            <div class="cantidad-control">
                                                <div class="input-group input-group-sm">
                                                    <input type="number" [ngModel]="p.cantidad ?? 1"
                                                        (ngModelChange)="onCantidadChange(p, $event)" min="1"
                                                        max="{{ p.stock }}" class="form-control cantidad-input"
                                                        [class.border-warning]="(p.cantidad ?? 1) > p.stock" />
                                                </div>
                                                <small class="stock-info"
                                                    [class.text-danger]="(p.cantidad ?? 1) > p.stock"
                                                    [class.text-muted]="(p.cantidad ?? 1) <= p.stock">
                                                    {{ p.stock }} disponible{{ p.stock > 1 ? 's' : '' }}
                                                </small>
                                            </div>
                                        </td>

                                        <!-- Columna Subtotal -->
                                        <td class="text-center subtotal">
                                            {{ p.subtotal | number:'1.2-2' }} {{ getSimboloMonedaActual() }}
                                        </td>


                                        <!-- Columna IVA -->
                                        <td class="text-center iva">
                                            <ng-container *ngIf="p.iva && p.iva > 0; else sinIva">
                                                <span class="iva-monto">
                                                    {{ p.iva | number:'1.2-2' }} {{ getSimboloMonedaActual() }}
                                                </span>
                                            </ng-container>
                                            <ng-template #sinIva>
                                                <span class="sin-iva text-muted">‚Äî</span>
                                            </ng-template>
                                        </td>

                                        <!-- Columna Total -->
                                        <td class="text-center total">
                                            <strong class="total-monto">
                                                {{ p.total | number:'1.2-2' }} {{ getSimboloMonedaActual() }}
                                            </strong>
                                        </td>

                                        <!-- Columna Acciones -->
                                        <td class="text-center acciones">
                                            <button class="btn-eliminar" (click)="eliminarProducto(p.id)"
                                                title="Eliminar del carrito">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Resumen y bot√≥n de generar venta -->
                    <div *ngIf="venta.productos.length > 0" @fadeInOut class="resumen-venta">
                        <div class="resumen-content">
                            <div class="monto-total">
                                <i class="bi bi-receipt"></i>
                                <span class="resumen-label">Monto total:</span>
                                <span class="monto-valor">
                                    {{ totalProductos | number:'1.2-2' }} {{ getSimboloMonedaActual() }}
                                </span>
                            </div>
                            <button class="btn-generar-venta" (click)="abrirModalResumen()">
                                <i class="bi bi-check-lg"></i>
                                Generar Venta
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>

<!-- Modal resumen de  venta -->
<div class="modal fade" id="resumenVentaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Header modernizado -->
            <div class="modal-header-detalle">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="bi bi-receipt-cutoff"></i>
                    </div>
                    <div class="header-text">
                        <h5 class="modal-title">Resumen de Venta</h5>
                        <div class="header-subtitle">
                            <span class="badge">Confirmaci√≥n Final</span>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body-detalle">
                <!-- üëì Formulaci√≥n cl√≠nica resumida - Modernizada -->
                <div class="info-card formulacion">
                    <div class="card-header-detalle">
                        <i class="bi bi-eyeglasses"></i>
                        <span>Formulaci√≥n Cl√≠nica</span>
                    </div>
                    <div class="card-body-detalle">
                        <ng-container *ngIf="historiaMedica?.examenOcular?.refraccionFinal; else sinFormulacion">
                            <div class="formulacion-grid">
                                <!-- Ojo Derecho -->
                                <div class="ojo-card">
                                    <div class="ojo-header ojo-derecho">
                                        <i class="bi bi-eye-fill"></i>
                                        <span>Ojo Derecho (OD)</span>
                                    </div>
                                    <div class="ojo-params">
                                        <div class="param">
                                            <span class="param-label">Esfera (ESF)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.esf_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Cilindro (CIL)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.cil_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Eje</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.eje_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ADD</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.add_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ALT</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.alt_od }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">DP</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.dp_od }}</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ojo Izquierdo -->
                                <div class="ojo-card">
                                    <div class="ojo-header ojo-izquierdo">
                                        <i class="bi bi-eye-fill"></i>
                                        <span>Ojo Izquierdo (OI)</span>
                                    </div>
                                    <div class="ojo-params">
                                        <div class="param">
                                            <span class="param-label">Esfera (ESF)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.esf_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Cilindro (CIL)</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.cil_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">Eje</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.eje_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ADD</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.add_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">ALT</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.alt_oi }}</span>
                                        </div>
                                        <div class="param">
                                            <span class="param-label">DP</span>
                                            <span class="param-value">{{
                                                historiaMedica.examenOcular.refraccionFinal.dp_oi }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recomendaciones -->
                            <div class="recomendaciones-section">
                                <div class="section-header">
                                    <h5>Recomendaciones</h5>
                                    <i class="bi bi-clipboard-check"></i>
                                </div>
                                <div class="recomendaciones-grid">
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Montura</span>
                                        <span class="rec-value">{{ historiaMedica.recomendaciones[0].montura }}</span>
                                    </div>
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Material</span>
                                        <span class="rec-value">{{ materialesRecomendados }}</span>
                                    </div>
                                    <div class="recomendacion-item">
                                        <span class="rec-label">Cristal</span>
                                        <span class="rec-value">{{ historiaMedica.recomendaciones[0].cristal.label
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <ng-template #sinFormulacion>
                            <div class="alert d-flex align-items-center mb-0">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <span>No hay formulaci√≥n registrada para este paciente.</span>
                            </div>
                        </ng-template>
                    </div>
                </div>

                <!-- üí≥ Configuraci√≥n de venta - Modernizada -->
                <div class="info-card pago">
                    <div class="card-header-detalle">
                        <i class="bi bi-credit-card"></i>
                        <span>Configuraci√≥n de Venta</span>
                    </div>
                    <div class="card-body-detalle">
                        <!-- Forma de Pago y Descuento -->
                        <div class="config-grid">
                            <div class="config-item">
                                <label class="form-label">Forma de pago</label>
                                <select class="form-select modern-select" [(ngModel)]="venta.formaPago"
                                    (ngModelChange)="onFormaPagoChange($event)">
                                    <option value="contado">Contado</option>
                                    <option value="abono">Abono parcial</option>
                                    <option value="cashea">Cashea</option>
                                </select>
                            </div>

                            <div class="config-item">
                                <label class="form-label">Descuento (%)</label>
                                <div class="input-with-hint">
                                    <input type="number" class="form-control modern-input" [(ngModel)]="venta.descuento"
                                        min="0" max="100" (ngModelChange)="onDescuentoChange()"
                                        style="margin-bottom: 0rem !important; height: 50px !important;" />
                                    <small class="hint-text">
                                        <i class="bi bi-lightbulb"></i> Afecta el <strong>Monto total</strong>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Cashea - Modernizado -->
                        <div *ngIf="venta.formaPago === 'cashea'" class="cashea-section">
                            <div class="cashea-config">
                                <div class="config-item">
                                    <label class="form-label">Nivel Cashea</label>
                                    <select class="form-select modern-select" [(ngModel)]="nivelCashea"
                                        (change)="asignarInicialPorNivel()">
                                        <option value="nivel1">Nivel 1 (60%)</option>
                                        <option value="nivel2">Nivel 2 (50%)</option>
                                        <option value="nivel3">Nivel 3 (40%)</option>
                                        <option value="nivel4">Nivel 4 (40%)</option>
                                        <option value="nivel5">Nivel 5 (40%)</option>
                                        <option value="nivel6">Nivel 6 (40%)</option>
                                    </select>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Cuotas</label>
                                    <select class="form-select modern-select" [(ngModel)]="cantidadCuotasCashea"
                                        (change)="generarCuotasCashea()"
                                        [disabled]="!nivelPermiteCuotasExtendidas(nivelCashea)">
                                        <option [value]="3">3 cuotas</option>
                                        <option [value]="6" [disabled]="!nivelPermiteCuotasExtendidas(nivelCashea)">6
                                            cuotas</option>
                                    </select>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Inicial</label>
                                    <div class="input-with-validation">
                                        <input type="text" class="form-control modern-input"
                                            [placeholder]="'Monto en ' + obtenerSimboloMoneda(venta.moneda)"
                                            [(ngModel)]="valorInicialTemporal" (blur)="formatearInicialCashea()"
                                            (keypress)="validarEntrada($event)" />
                                        <small class="validation-text">
                                            M√≠nimo: {{ calcularInicialCasheaPorNivel(montoTotal, nivelCashea) |
                                            number:'1.2-2' }} {{ obtenerSimboloMoneda(venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'">‚áÑ {{
                                                obtenerEquivalenteBs(calcularInicialCasheaPorNivel(montoTotal,
                                                nivelCashea)) | number:'1.2-2' }} Bs</span>
                                        </small>
                                    </div>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Monto por cuota</label>
                                    <div class="readonly-field">
                                        {{ redondearDosDecimales(montoPrimeraCuota) }} {{
                                        obtenerSimboloMoneda(venta.moneda) }}
                                    </div>
                                </div>
                            </div>

                            <!-- Cuotas Cashea - Modernizado -->
                            <div class="cuotas-section">
                                <label class="section-label">
                                    <i class="bi bi-calendar-check"></i>
                                    Fechas de pago
                                </label>
                                <small class="section-subtitle">Fechas aproximadas. Valida en la aplicaci√≥n de
                                    Cashea.</small>

                                <div class="cuotas-grid">
                                    <ng-container *ngFor="let cuota of cuotasCashea; let i = index">
                                        <div class="cuota-card" [ngClass]="{
                                            'cuota-pagada': cuota.pagada,
                                            'cuota-seleccionada': cuota.seleccionada && !cuota.pagada,
                                            'cuota-pendiente': !cuota.seleccionada && !cuota.pagada,
                                            'cuota-deshabilitada': !cuota.habilitada
                                        }" (click)="cuota.habilitada && toggleCuotaSeleccionada(i)">
                                            <div class="cuota-header">
                                                <span class="cuota-numero">Cuota {{ cuota.id }}</span>
                                                <span class="cuota-estado" [ngClass]="{
                                                    'estado-pagada': cuota.pagada,
                                                    'estado-seleccionada': cuota.seleccionada && !cuota.pagada,
                                                    'estado-pendiente': !cuota.seleccionada && !cuota.pagada
                                                }">
                                                    {{ cuota.pagada ? 'Pagada' : cuota.seleccionada ? 'Seleccionada' :
                                                    'Pendiente' }}
                                                </span>
                                            </div>
                                            <div class="cuota-body">
                                                <div class="cuota-fecha">{{ cuota.fecha }}</div>
                                                <div class="cuota-monto">{{ cuota.monto | number:'1.2-2' }} {{
                                                    obtenerSimboloMoneda(venta.moneda) }}</div>
                                            </div>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Resumen Cashea - Mensaje claro -->
                                <div class="resumen-cashea" [ngClass]="{ 
                                    'resumen-invalido': !casheaBalanceValido,
                                    'resumen-completo': esPagoCompletoCashea 
                                }">
                                    <div class="resumen-content">
                                        <span class="resumen-text">
                                            {{ mensajeResumenCashea }}
                                        </span>
                                        <span class="resumen-monto">
                                            {{ resumenCashea.total | number:'1.2-2' }} {{
                                            obtenerSimboloMoneda(venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'">(~{{ resumenCashea.totalBs |
                                                number:'1.2-2' }} Bs)</span>
                                            <i *ngIf="!casheaBalanceValido"
                                                class="bi bi-exclamation-triangle text-warning ms-1"></i>
                                            <i *ngIf="esPagoCompletoCashea"
                                                class="bi bi-check-circle text-success ms-1"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Abono parcial - Modernizado -->
                        <div *ngIf="venta.formaPago === 'abono'" class="abono-section">
                            <div class="abono-config">
                                <div class="config-item">
                                    <label class="form-label">Monto abonado</label>
                                    <div class="abono-input-group">
                                        <input type="text" class="form-control modern-input"
                                            [placeholder]="'Monto en ' + obtenerSimboloMoneda(venta.moneda)"
                                            [(ngModel)]="valorTemporal" (blur)="formatearMonto()"
                                            (keypress)="validarEntrada($event)" />

                                        <div class="progress-container">
                                            <div class="progress-label">
                                                <span>{{ porcentajeAbonadoDelTotal }}% del total cubierto</span>
                                                <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                    ‚áÑ {{ obtenerEquivalenteBs(venta.montoAbonado ?? 0) | number:'1.2-2'
                                                    }} Bs
                                                </span>
                                            </div>
                                            <div class="progress modern-progress">
                                                <div class="progress-bar" role="progressbar"
                                                    [style.width.%]="porcentajeAbonadoDelTotal" [ngClass]="{
                                                    'progress-complete': porcentajeAbonadoDelTotal === 100,
                                                    'progress-partial': porcentajeAbonadoDelTotal < 100
                                                }"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="config-item">
                                    <label class="form-label">Total adeudado</label>
                                    <div class="adeudado-display">
                                        <span class="adeudado-monto">
                                            {{ montoTotal - (venta.montoAbonado ?? 0) | number:'1.2-2' }} {{
                                            obtenerSimboloMoneda(venta.moneda) }}
                                        </span>
                                        <small *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                            ‚áÑ {{ obtenerEquivalenteBs(montoTotal - (venta.montoAbonado ?? 0)) |
                                            number:'1.2-2' }} Bs
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="metodos-pago-section">
                            <div class="section-header">
                                <div class="section-label-container">
                                    <label class="section-label">
                                        <i class="bi bi-wallet2"></i>
                                        M√©todos de pago
                                    </label>
                                    <small class="section-description">Agrega y configura los m√©todos de pago para esta
                                        venta</small>
                                </div>
                                <div class="section-actions">
                                    <!-- BOT√ìN DIN√ÅMICO -->
                                    <button class="btn btn-add-method" (click)="agregarMetodo()" title="Agregar m√©todo"
                                        *ngIf="venta.metodosDePago.length > 0">
                                        <i class="bi bi-plus-circle"></i>
                                        Agregar M√©todo
                                    </button>
                                </div>
                            </div>

                            <!-- Selector de moneda para efectivo -->
                            <div *ngIf="hayMetodoEfectivoSeleccionado()" class="moneda-selector-container">
                                <div class="moneda-selector-header">
                                    <i class="bi bi-currency-exchange"></i>
                                    <span>Moneda para Pagos en Efectivo</span>
                                </div>
                                <div class="moneda-selector-buttons">
                                    <button type="button" class="moneda-btn"
                                        [class.moneda-active]="monedaEfectivo === 'USD'"
                                        (click)="cambiarMonedaEfectivo('USD')">
                                        <span class="moneda-symbol">$</span>
                                        <span class="moneda-info">
                                            <strong>USD</strong>
                                            <small>D√≥lar Americano</small>
                                        </span>
                                    </button>

                                    <button type="button" class="moneda-btn"
                                        [class.moneda-active]="monedaEfectivo === 'EUR'"
                                        (click)="cambiarMonedaEfectivo('EUR')">
                                        <span class="moneda-symbol">‚Ç¨</span>
                                        <span class="moneda-info">
                                            <strong>EUR</strong>
                                            <small>Euro</small>
                                        </span>
                                    </button>
                                </div>
                                <div class="moneda-hint">
                                    <i class="bi bi-info-circle"></i>
                                    <span>Esta selecci√≥n aplica a todos los pagos en efectivo</span>
                                </div>
                            </div>

                            <!-- Contador de m√©todos -->
                            <div class="metodos-counter" *ngIf="venta.metodosDePago.length > 0">
                                <i class="bi bi-list-check"></i>
                                <span>{{ venta.metodosDePago.length }} m√©todo{{ venta.metodosDePago.length > 1 ? 's' :
                                    '' }} configurado{{ venta.metodosDePago.length > 1 ? 's' : '' }}</span>
                            </div>

                            <div class="metodos-grid" *ngIf="venta.metodosDePago.length > 0">
                                <div *ngFor="let metodo of venta.metodosDePago; let i = index" class="metodo-card">
                                    <!-- Header con n√∫mero y acciones -->
                                    <div class="metodo-card-header">
                                        <div class="metodo-number">
                                            <i class="bi bi-123"></i>
                                            <span>M√©todo #{{ i + 1 }}</span>
                                        </div>
                                        <button class="btn btn-remove" (click)="eliminarMetodo(i)"
                                            title="Eliminar m√©todo">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>

                                    <div class="metodo-content">
                                        <!-- Selector de tipo de m√©todo -->
                                        <div class="campo-principal">
                                            <label class="form-label compact-label">
                                                <i class="bi bi-credit-card"></i>
                                                Tipo de Pago
                                            </label>
                                            <select class="form-select modern-select" [(ngModel)]="metodo.tipo"
                                                (change)="onTipoMetodoChange(i)">
                                                <option value="" disabled selected>Elige un m√©todo de pago</option>
                                                <option value="efectivo">üíµ Efectivo</option>
                                                <option value="debito">üí≥ Tarjeta D√©bito</option>
                                                <option value="credito">üîÑ Tarjeta Cr√©dito</option>
                                                <option value="pagomovil">üì± Pago M√≥vil</option>
                                                <option value="transferencia">üè¶ Transferencia</option>
                                                <option value="zelle">üåê Zelle</option>
                                            </select>
                                        </div>

                                        <!-- Campos condicionales -->
                                        <div class="campos-condicionales" *ngIf="metodo.tipo">
                                            <!-- Banco -->
                                            <div *ngIf="necesitaBanco(metodo.tipo)" class="campo-adicional">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-bank"></i>
                                                    Banco
                                                </label>
                                                <ng-select [items]="bancosDisponibles" bindLabel="nombre"
                                                    [(ngModel)]="metodo.bancoObject"
                                                    (ngModelChange)="onBancoChange($event, i)"
                                                    [compareWith]="compararBanco" [searchable]="true" [clearable]="true"
                                                    placeholder="Buscar banco por c√≥digo o nombre...">

                                                    <ng-template ng-label-tmp let-item="item">
                                                        <span *ngIf="item">{{ item?.codigo }} - {{ item?.nombre
                                                            }}</span>
                                                        <span *ngIf="!item">Seleccionar banco...</span>
                                                    </ng-template>

                                                    <ng-template ng-option-tmp let-item="item">
                                                        <div class="banco-option" *ngIf="item">
                                                            <div class="banco-codigo">{{ item.codigo }}</div>
                                                            <div class="banco-nombre">{{ item.nombre }}</div>
                                                        </div>
                                                    </ng-template>

                                                    <ng-template ng-notfound-tmp>
                                                        <div class="not-found-message">
                                                            <i class="bi bi-search"></i>
                                                            No se encontraron bancos con ese criterio
                                                        </div>
                                                    </ng-template>
                                                </ng-select>
                                            </div>

                                            <!-- Referencia -->
                                            <div *ngIf="necesitaReferencia(metodo.tipo)" class="campo-adicional">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-hash"></i>
                                                    N¬∞ de Referencia
                                                </label>
                                                <input type="text" class="form-control modern-input"
                                                    [(ngModel)]="metodo.referencia" placeholder="Ej: 123456789"
                                                    maxlength="20" />
                                            </div>

                                            <!-- Monto -->
                                            <div class="campo-monto">
                                                <label class="form-label compact-label">
                                                    <i class="bi bi-cash-stack"></i>
                                                    Monto a Pagar
                                                </label>
                                                <input type="text" class="form-control modern-input"
                                                    [placeholder]="getPlaceholderMonto(metodo.tipo)"
                                                    [(ngModel)]="metodo.valorTemporal" (blur)="formatearMontoMetodo(i)"
                                                    (keypress)="validarEntrada($event)" [disabled]="!metodo.tipo" />
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Footer con informaci√≥n -->
                                    <div class="metodo-footer" *ngIf="metodo.tipo">
                                        <div class="footer-info">
                                            <span class="maximo-text">
                                                <i class="bi bi-graph-up"></i>
                                                M√°x. disponible: {{ getMontoRestanteParaMetodo(i) | number:'1.2-2' }} {{
                                                getSimboloMonedaActual() }}
                                                <span *ngIf="getMonedaParaMetodo(metodo.tipo) === 'bolivar'"
                                                    class="conversion-text">
                                                    ({{ getMontoRestanteParaMetodoEnBs(i) | number:'1.2-2' }} Bs)
                                                </span>
                                            </span>

                                            <span
                                                *ngIf="mostrarConversionBs(metodo.tipo) && metodo.monto && metodo.monto > 0"
                                                class="conversion-text">
                                                <i class="bi bi-arrow-left-right"></i>
                                                Equivale a {{ calcularConversionBs(metodo.monto, metodo.tipo) |
                                                number:'1.2-2' }} Bs
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Estado vac√≠o -->
                                    <div class="metodo-empty" *ngIf="!metodo.tipo">
                                        <i class="bi bi-credit-card-2-front"></i>
                                        <span>Selecciona un tipo de pago para continuar</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Estado vac√≠o general -->
                            <div class="empty-state" *ngIf="venta.metodosDePago.length === 0">
                                <div class="empty-icon">
                                    <i class="bi bi-wallet"></i>
                                </div>
                                <h5>No hay m√©todos de pago</h5>
                                <p>Agrega al menos un m√©todo de pago para continuar con la venta</p>
                                <!-- BOT√ìN PARA PRIMER M√âTODO -->
                                <button class="btn btn-add-method" (click)="agregarMetodo()">
                                    <i class="bi bi-plus-circle"></i>
                                    Agregar Primer M√©todo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üßæ Totales - Modernizado -->
                <div class="info-card resumen">
                    <div class="card-header-detalle">
                        <i class="bi bi-graph-up"></i>
                        <span>Resumen Financiero</span>
                    </div>
                    <div class="card-body-detalle">
                        <!-- Totales principales -->
                        <div class="resumen-grid">
                            <div class="resumen-item">
                                <span class="resumen-label">Subtotal (productos)</span>
                                <span class="resumen-value">{{ totalProductos | number:'1.2-2' }} {{
                                    obtenerSimboloMoneda(venta.moneda) }}</span>
                            </div>
                            <div class="resumen-item">
                                <span class="resumen-label">Descuento</span>
                                <span class="resumen-value descuento">
                                    {{ truncarDosDecimales(venta.descuento ? (totalProductos * (venta.descuento / 100))
                                    : 0) }} {{ obtenerSimboloMoneda(venta.moneda) }}
                                </span>
                            </div>
                            <div class="resumen-item total">
                                <span class="resumen-label">Monto total</span>
                                <span class="total-amount">
                                    {{ redondearDosDecimales(montoTotal) | number:'1.2-2' }} {{
                                    obtenerSimboloMoneda(venta.moneda) }}
                                    <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                        ‚áÑ {{ redondearDosDecimales(obtenerEquivalenteBs(montoTotal)) | number:'1.2-2' }}
                                        Bs
                                    </span>
                                </span>
                            </div>
                        </div>

                        <!-- Detalles de forma de pago -->
                        <div class="forma-pago-detalle">
                            <h6 class="detalle-title">
                                <i class="bi bi-credit-card-2-front"></i>
                                Detalles de pago
                            </h6>

                            <!-- Contado -->
                            <div *ngIf="venta.formaPago === 'contado'" class="detalle-contado">
                                <div class="detalle-item">
                                    <span class="detalle-label">Forma de pago:</span>
                                    <span class="detalle-value">{{ venta.formaPago | titlecase }}</span>
                                </div>
                                <div class="detalle-item">
                                    <span class="detalle-label">Monto total:</span>
                                    <span class="detalle-value">
                                        {{ redondearDosDecimales(montoTotal) | number:'1.2-2' }} {{
                                        obtenerSimboloMoneda(venta.moneda) }}
                                        <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                            ‚áÑ {{ redondearDosDecimales(obtenerEquivalenteBs(montoTotal)) |
                                            number:'1.2-2' }} Bs
                                        </span>
                                    </span>
                                </div>
                            </div>

                            <!-- Cashea -->
                            <div *ngIf="venta.formaPago === 'cashea'" class="detalle-cashea">
                                <div class="detalle-grid">
                                    <div class="detalle-item">
                                        <span class="detalle-label">Forma de pago:</span>
                                        <span class="detalle-value">{{ venta.formaPago | titlecase }}</span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Nivel Cashea:</span>
                                        <span class="detalle-value">{{ obtenerNombreNivelCashea(nivelCashea) }}</span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Inicial:</span>
                                        <span class="detalle-value">
                                            {{ redondearDosDecimales(venta.montoInicial) | number:'1.2-2' }} {{
                                            obtenerSimboloMoneda(venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                ‚áÑ {{ redondearDosDecimales(obtenerEquivalenteBs(venta.montoInicial)) |
                                                number:'1.2-2' }} Bs
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Cuotas:</span>
                                        <span class="detalle-value">
                                            {{ cantidadCuotas }} de {{ redondearDosDecimales(montoPrimeraCuota) |
                                            number:'1.2-2' }} {{ obtenerSimboloMoneda(venta.moneda) }}
                                        </span>
                                    </div>
                                    <div *ngIf="resumenCashea.cantidad > 0" class="detalle-item">
                                        <span class="detalle-label">Adelanto:</span>
                                        <span class="detalle-value">
                                            {{ resumenCashea.total | number:'1.2-2' }} {{
                                            obtenerSimboloMoneda(venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                ‚áÑ {{ resumenCashea.totalBs | number:'1.2-2' }} Bs
                                            </span>
                                            <small class="detail-text">({{ resumenCashea.cantidad }} cuota{{
                                                resumenCashea.cantidad > 1 ? 's' : '' }})</small>
                                        </span>
                                    </div>

                                    <!-- Versi√≥n compacta del total pagado -->
                                    <div class="detalle-item total-pagado-item">
                                        <span class="detalle-label">Total a pagar ahora:</span>
                                        <span class="detalle-value total-pagado-value">
                                            <strong>{{ totalPagadoCashea | number:'1.2-2' }} {{
                                                obtenerSimboloMoneda(venta.moneda) }}</strong>
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                ‚áÑ {{ totalPagadoCasheaBs | number:'1.2-2' }} Bs
                                            </span>
                                            <small class="detail-text">
                                                (Inicial {{ redondearDosDecimales(venta.montoInicial) | number:'1.2-2'
                                                }}
                                                + {{ resumenCashea.cantidad }} cuota{{ resumenCashea.cantidad > 1 ? 's'
                                                : '' }}
                                                {{ resumenCashea.total | number:'1.2-2' }})
                                            </small>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Abono parcial -->
                            <div *ngIf="venta.formaPago === 'abono'" class="detalle-abono">
                                <div class="detalle-grid">
                                    <div class="detalle-item">
                                        <span class="detalle-label">Monto abonado:</span>
                                        <span class="detalle-value">
                                            {{ redondearDosDecimales(venta.montoAbonado ?? 0) | number:'1.2-2' }} {{
                                            obtenerSimboloMoneda(venta.moneda) }}
                                            <span *ngIf="venta.moneda !== 'bolivar'" class="conversion-text">
                                                ‚áÑ {{ redondearDosDecimales(obtenerEquivalenteBs(venta.montoAbonado ??
                                                0)) | number:'1.2-2' }} Bs
                                            </span>
                                        </span>
                                    </div>
                                    <div class="detalle-item">
                                        <span class="detalle-label">Total adeudado:</span>
                                        <span class="detalle-value">
                                            {{ redondearDosDecimales(montoTotal - (venta.montoAbonado ?? 0)) |
                                            number:'1.2-2' }} {{ obtenerSimboloMoneda(venta.moneda) }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Resumen de m√©todos de pago -->
                        <div class="metodos-resumen">
                            <h6 class="detalle-title">
                                <i class="bi bi-wallet2"></i>
                                M√©todos de pago aplicados
                            </h6>
                            <div class="metodos-list">
                                <div *ngFor="let metodo of venta.metodosDePago" class="metodo-resumen-item">
                                    <div class="metodo-info">
                                        <span class="metodo-tipo">{{ metodo.tipo | titlecase }}</span>

                                        <!-- Mostrar referencia si existe -->
                                        <span *ngIf="metodo.referencia" class="metodo-referencia">
                                            Ref: {{ metodo.referencia }}
                                        </span>

                                        <!-- Mostrar banco si existe -->
                                        <span *ngIf="metodo.banco" class="metodo-banco">
                                            Banco: {{ metodo.banco }}
                                        </span>
                                    </div>

                                    <span class="metodo-monto">
                                        {{ redondear(metodo.monto ?? 0) | number:'1.2-2' }} {{
                                        obtenerSimboloMoneda(getMonedaParaMetodo(metodo.tipo)) }}

                                        <span *ngIf="getMonedaParaMetodo(metodo.tipo) !== 'bolivar'"
                                            class="conversion-text">
                                            ‚áÑ {{ redondear(calcularConversionBs(metodo.monto ?? 0, metodo.tipo)) |
                                            number:'1.2-2' }} Bs
                                        </span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer modernizado -->
            <div class="modal-footer-detalle">
                <div class="footer-actions">
                    <button type="button" class="btn btn-secondary btn-detalle" data-bs-dismiss="modal"
                        [disabled]="generandoVenta">
                        <i class="bi bi-x-circle me-2"></i>
                        {{ generandoVenta ? 'Cancelando...' : 'Cancelar' }}
                    </button>
                    <button type="button" class="btn btn-success btn-detalle" (click)="generarVenta()"
                        [disabled]="!puedeGenerarVenta || generandoVenta" [title]="mensajeEstadoBoton">
                        <i class="bi" [class.bi-check-circle]="!generandoVenta"
                            [class.bi-hourglass-split]="generandoVenta" class="me-2"></i>
                        {{ generandoVenta ? 'Procesando...' : 'Confirmar y Generar Venta' }}
                        <span *ngIf="!puedeGenerarVenta && !generandoVenta" class="ms-1">({{ mensajeEstadoBoton
                            }})</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Modal para mostrar el recibo - XL -->
<div class="modal fade" id="reciboModal" [class.show]="mostrarModalRecibo"
    [style.display]="mostrarModalRecibo ? 'block' : 'none'" [class.d-block]="mostrarModalRecibo" tabindex="-1"
    aria-labelledby="reciboModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">

    <div class="modal-dialog modal-dialog-centered modal-xl-custom">
        <div class="modal-content">

            <div class="modal-header-recibo">
                <div class="header-content">
                    <div class="header-icon">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="header-text">
                        <h4 class="header-title">¬°Venta Generada Exitosamente!</h4>
                        <div class="header-subtitle">Recibo digital de la transacci√≥n completada</div>
                    </div>
                </div>

                <!-- Bot√≥n cerrar - CORREGIDO: Ahora est√° alineado correctamente -->
                <button type="button" class="btn-close-custom" (click)="cerrarModalRecibo()" title="Cerrar recibo">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="modal-body p-0">
                <!-- Informaci√≥n de la venta - Mejorada -->
                <div class="venta-info-card">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">
                                <i class="bi bi-receipt me-1"></i>
                                N¬∞ de Venta
                            </div>
                            <div class="info-value">{{ informacionVenta?.numeroVenta }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <i class="bi bi-calendar me-1"></i>
                                Fecha
                            </div>
                            <div class="info-value">{{ informacionVenta?.fecha }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <i class="bi bi-clock me-1"></i>
                                Hora
                            </div>
                            <div class="info-value">{{ informacionVenta?.hora }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">
                                <i class="bi bi-check-circle me-1"></i>
                                Estado
                            </div>
                            <div class="info-value">
                                <span class="status-badge status-completed">{{ informacionVenta?.estado }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contenedor del recibo -->
                    <div class="p-3">
                        <!-- Loading mientras carga el recibo -->
                        <div *ngIf="generandoRecibo" class="text-center py-5">
                            <div class="spinner-border text-success mb-3" role="status">
                                <span class="visually-hidden">Generando recibo...</span>
                            </div>
                            <h5 class="text-success">Generando comprobante de pago...</h5>
                            <p class="text-muted">Estamos preparando tu recibo digital</p>
                        </div>

                        <!-- Iframe para mostrar el PDF -->
                        <div *ngIf="urlRecibo && !generandoRecibo" class="recibo-container">
                            <iframe [src]="urlRecibo | safeUrl" width="100%" [style.height]="getAlturaIframe()"
                                frameborder="0" class="recibo-iframe w-100">
                                Tu navegador no soporta la visualizaci√≥n de PDFs.
                                <a [href]="urlRecibo" target="_blank">Descargar recibo</a>
                            </iframe>
                        </div>

                        <!-- Mensaje de error -->
                        <div *ngIf="errorGeneracion" class="alert alert-danger text-center">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            {{ errorGeneracion }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer con acciones mejorado -->
            <div class="modal-footer-recibo">
                <div class="footer-actions">
                    <!-- Bot√≥n Cerrar a la izquierda -->
                    <button type="button" class="btn btn-outline-secondary btn-detalle" (click)="cerrarModalRecibo()">
                        <i class="bi bi-x-circle me-2"></i>
                        Cerrar
                    </button>

                    <!-- Grupo de acciones a la derecha -->
                    <div class="action-buttons" *ngIf="urlRecibo && !generandoRecibo">
                        <!-- Compartir -->
                        <button type="button" class="btn btn-primary btn-detalle btn-action"
                            (click)="compartirReciboSimple()">
                            <i class="bi bi-share me-2"></i>
                            Compartir/Descargar
                        </button>

                        <!-- Imprimir -->
                        <button type="button" class="btn btn-primary btn-detalle btn-action" (click)="imprimirRecibo()">
                            <i class="bi bi-printer me-2"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Backdrop del modal -->
<div class="modal-backdrop fade show" *ngIf="mostrarModalRecibo"></div>