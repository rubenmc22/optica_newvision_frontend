<div class="gestion-ordenes-container">
  <!-- Header -->
  <div class="ordenes-header">
    <div class="header-content">
      <div class="header-title">
        <i class="bi bi-clipboard-check"></i>
        <h1>Gestión de Órdenes de Trabajo</h1>
      </div>
      <div class="header-actions">
        <div class="search-container">
          <input type="text" class="form-control search-input" placeholder="Buscar orden, cliente o producto..."
            [(ngModel)]="filtroBusqueda" (input)="aplicarFiltros()">
          <i class="bi bi-search search-icon"></i>
        </div>

        <div class="filtros-container">
          <select class="form-select filtro-select" [(ngModel)]="filtroEstado" (change)="aplicarFiltros()">
            <option value="">Todos los estados</option>
            <option value="en_tienda">En Tienda</option>
            <option value="proceso_laboratorio">En Laboratorio</option>
            <option value="listo_laboratorio">Listo en Laboratorio</option>
            <option value="pendiente_retiro">Pendiente por Retirar</option>
            <option value="entregado">Entregado</option>
          </select>

          <button class="btn btn-refresh" [attr.data-tooltip]="'Recargar'" (click)="recargarOrdenes()">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Estadísticas rápidas -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="stat-icon" style="background: #e3f2fd;">
          <i class="bi bi-shop" style="color: #1976d2;"></i>
        </div>
        <div class="stat-info">
          <span class="stat-count">{{ estadisticas.enTienda }}</span>
          <span class="stat-label">En Tienda</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fff3e0;">
          <i class="bi bi-gear" style="color: #f57c00;"></i>
        </div>
        <div class="stat-info">
          <span class="stat-count">{{ estadisticas.enProceso }}</span>
          <span class="stat-label">En Proceso</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #e8f5e9;">
          <i class="bi bi-check-circle" style="color: #388e3c;"></i>
        </div>
        <div class="stat-info">
          <span class="stat-count">{{ estadisticas.listoLaboratorio }}</span>
          <span class="stat-label">Listo en Lab</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fff8e1;">
          <i class="bi bi-clock-history" style="color: #ffa000;"></i>
        </div>
        <div class="stat-info">
          <span class="stat-count">{{ estadisticas.pendienteRetiro }}</span>
          <span class="stat-label">Pendiente Retiro</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #f3e5f5;">
          <i class="bi bi-box-seam" style="color: #7b1fa2;"></i>
        </div>
        <div class="stat-info">
          <span class="stat-count">{{ estadisticas.total }}</span>
          <span class="stat-label">Total Órdenes</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista Kanban -->
  <div class="kanban-container" cdkDropListGroup>
    <!-- Columna: En Tienda -->
    <div class="kanban-column" cdkDropList [cdkDropListData]="ordenesEnTienda"
      (cdkDropListDropped)="drop($event, 'en_tienda')">
      <div class="column-header" style="border-color: #1976d2;">
        <div class="column-title">
          <span class="column-badge" style="background: #1976d2;">{{ ordenesEnTienda.length }}</span>
          <h3><i class="bi bi-shop"></i> En Tienda</h3>
          <div class="column-actions" *ngIf="ordenesEnTienda.length > 0">
            <button class="btn-move-all" (click)="moverTodos(ordenesEnTienda, 'en_tienda', 'proceso_laboratorio')"
              [attr.data-tooltip]="'Mover todos a Laboratorio'">
              <i class="bi bi-arrow-right-circle"></i>
            </button>
          </div>
        </div>
        <small>Órdenes recibidas</small>
      </div>

      <div class="ordenes-list" *ngIf="ordenesEnTienda.length > 0; else emptyTienda"
        [class.limited-view]="ordenesEnTienda.length > maxOrdenesPorColumna">
        <div class="orden-card" *ngFor="let orden of (ordenesEnTienda | slice:0:maxOrdenesPorColumna)" cdkDrag
          [cdkDragData]="orden" (click)="verDetalleOrden(orden)">
          <div class="orden-card-header">
            <span class="orden-fecha">
              {{ orden.fechaCreacion | date:'dd/MM' }}
            </span>
          </div>

          <div class="orden-cliente">
            <i class="bi bi-person"></i>
            <span class="cliente-nombre">{{ truncarTexto(orden.clienteNombre,
              18)
              }}</span>
          </div>

          <div class="orden-producto">
            <i class="bi bi-eyeglasses"></i>
            <span>{{ truncarTexto(orden.productoNombre, 22) }}</span>
          </div>

          <div class="orden-meta">
            <div class="meta-item">
              <i class="bi bi-calendar"></i>
              <small>Entrega: {{ orden.fechaEntregaEstimada | date:'dd/MM' }}</small>
            </div>
            <div class="meta-item" *ngIf="orden.diasRestantes !== undefined">
              <i class="bi bi-clock"></i>
              <small [ngClass]="{'text-danger': orden.diasRestantes < 3}">
                {{ orden.diasRestantes }}d
              </small>
            </div>
          </div>

          <div class="orden-actions">
            <button class="btn-action" (click)="cambiarEstado(orden, 'proceso_laboratorio'); $event.stopPropagation()"
              [attr.data-tooltip]="'Mover a Laboratorio'">
              <i class="bi bi-arrow-right"></i>
            </button>
          </div>
        </div>

        <div class="more-orders-indicator" *ngIf="ordenesEnTienda.length > maxOrdenesPorColumna">
          <span class="badge bg-secondary">
            +{{ ordenesEnTienda.length - maxOrdenesPorColumna }}
          </span>
          <button class="btn-view-all" (click)="verTodasOrdenes('en_tienda')">
            Ver todas
          </button>
        </div>
      </div>

      <ng-template #emptyTienda>
        <div class="empty-column">
          <i class="bi bi-inbox"></i>
          <p>No hay órdenes</p>
        </div>
      </ng-template>
    </div>

    <!-- Columna: En Laboratorio -->
    <div class="kanban-column" cdkDropList [cdkDropListData]="ordenesEnProceso"
      (cdkDropListDropped)="drop($event, 'proceso_laboratorio')">
      <div class="column-header" style="border-color: #f57c00;">
        <div class="column-title">
          <span class="column-badge" style="background: #f57c00;">{{ ordenesEnProceso.length }}</span>
          <h3><i class="bi bi-gear"></i> En Laboratorio</h3>
          <div class="column-actions" *ngIf="ordenesEnProceso.length > 0">
            <button class="btn-move-all"
              (click)="moverTodos(ordenesEnProceso, 'proceso_laboratorio', 'listo_laboratorio')"
              [attr.data-tooltip]="'Marcar todos como listos'">
              <i class="bi bi-check-circle"></i>
            </button>
          </div>
        </div>
        <small>En proceso</small>
      </div>

      <div class="ordenes-list" *ngIf="ordenesEnProceso.length > 0; else emptyProceso"
        [class.limited-view]="ordenesEnProceso.length > maxOrdenesPorColumna">
        <div class="orden-card" *ngFor="let orden of (ordenesEnProceso | slice:0:maxOrdenesPorColumna)" cdkDrag
          [cdkDragData]="orden" (click)="verDetalleOrden(orden)">
          <div class="orden-progreso" *ngIf="orden.progreso > 0">
            <div class="progreso-bar">
              <div class="progreso-fill" [style.width.%]="orden.progreso || 0"></div>
            </div>
            <small>{{ orden.progreso || 0 }}%</small>
          </div>

          <div class="orden-cliente">
            <i class="bi bi-person"></i>
            <span class="cliente-nombre">{{ truncarTexto(orden.clienteNombre,
              18)
              }}</span>
          </div>

          <div class="orden-producto">
            <i class="bi bi-eyeglasses"></i>
            <span>{{ truncarTexto(orden.productoNombre, 22) }}</span>
          </div>

          <div class="orden-meta">
            <div class="meta-item">
              <i class="bi bi-person-badge"></i>
              <small>
                {{ truncarTexto(orden.tecnicoAsignado || 'Sin asignar', 12) }}
              </small>
            </div>
          </div>

          <div class="orden-actions">
            <button class="btn-action" (click)="actualizarProgreso(orden); $event.stopPropagation()"
              [attr.data-tooltip]="'Actualizar progreso'">
              <i class="bi bi-percent"></i>
            </button>
            <button class="btn-action" (click)="cambiarEstado(orden, 'listo_laboratorio'); $event.stopPropagation()"
              [attr.data-tooltip]="'Marcar como listo'">
              <i class="bi bi-check-circle"></i>
            </button>
          </div>
        </div>

        <div class="more-orders-indicator" *ngIf="ordenesEnProceso.length > maxOrdenesPorColumna">
          <span class="badge bg-secondary">
            +{{ ordenesEnProceso.length - maxOrdenesPorColumna }}
          </span>
          <button class="btn-view-all" (click)="verTodasOrdenes('proceso_laboratorio')">
            Ver todas
          </button>
        </div>
      </div>

      <ng-template #emptyProceso>
        <div class="empty-column">
          <i class="bi bi-gear"></i>
          <p>No hay órdenes</p>
        </div>
      </ng-template>
    </div>

    <!-- Para "Listo en Laboratorio" - más compacto -->
    <div class="kanban-column" cdkDropList [cdkDropListData]="ordenesListasLaboratorio"
      (cdkDropListDropped)="drop($event, 'listo_laboratorio')">
      <div class="column-header" style="border-color: #388e3c;">
        <div class="column-title">
          <span class="column-badge" style="background: #388e3c;">{{ ordenesListasLaboratorio.length }}</span>
          <h3><i class="bi bi-check-circle"></i> Listo</h3>
          <div class="column-actions" *ngIf="ordenesListasLaboratorio.length > 0">
            <button class="btn-move-all"
              (click)="moverTodos(ordenesListasLaboratorio, 'listo_laboratorio', 'pendiente_retiro')"
              [attr.data-tooltip]="'Enviar todos a tienda'">
              <i class="bi bi-truck"></i>
            </button>
          </div>
        </div>
        <small>Terminadas</small>
      </div>

      <div class="ordenes-list" *ngIf="ordenesListasLaboratorio.length > 0; else emptyListo"
        [class.limited-view]="ordenesListasLaboratorio.length > maxOrdenesPorColumna">
        <div class="orden-card" *ngFor="let orden of (ordenesListasLaboratorio | slice:0:maxOrdenesPorColumna)" cdkDrag
          [cdkDragData]="orden" (click)="verDetalleOrden(orden)">
          <div class="orden-card-header">
            <span class="badge-success">
              <i class="bi bi-check-lg"></i>
            </span>
            <span class="orden-fecha">
              {{ orden.fechaTerminacion | date:'dd/MM' }}
            </span>
          </div>

          <div class="orden-cliente">
            <i class="bi bi-person"></i>
            <span class="cliente-nombre">{{ truncarTexto(orden.clienteNombre,
              18)
              }}</span>
          </div>

          <div class="orden-producto">
            <i class="bi bi-eyeglasses"></i>
            <span>{{ truncarTexto(orden.productoNombre, 22) }}</span>
          </div>

          <div class="orden-meta">
            <div class="meta-item">
              <i class="bi bi-person-badge"></i>
              <small>
                {{ truncarTexto(orden.tecnicoAsignado, 12) }}
              </small>
            </div>
          </div>

          <div class="orden-actions">
            <button class="btn-action" (click)="cambiarEstado(orden, 'pendiente_retiro'); $event.stopPropagation()"
              [attr.data-tooltip]="'Enviar a tienda'">
              <i class="bi bi-truck"></i>
            </button>
          </div>
        </div>

        <div class="more-orders-indicator" *ngIf="ordenesListasLaboratorio.length > maxOrdenesPorColumna">
          <span class="badge bg-secondary">
            +{{ ordenesListasLaboratorio.length - maxOrdenesPorColumna }}
          </span>
          <button class="btn-view-all" (click)="verTodasOrdenes('listo_laboratorio')">
            Ver todas
          </button>
        </div>
      </div>

      <ng-template #emptyListo>
        <div class="empty-column">
          <i class="bi bi-check-circle"></i>
          <p>No hay órdenes</p>
        </div>
      </ng-template>
    </div>

    <!-- Para "Pendiente por Retirar" - más compacto -->
    <div class="kanban-column" cdkDropList [cdkDropListData]="ordenesPendienteRetiro"
      (cdkDropListDropped)="drop($event, 'pendiente_retiro')">
      <div class="column-header" style="border-color: #ffa000;">
        <div class="column-title">
          <span class="column-badge" style="background: #ffa000;">{{ ordenesPendienteRetiro.length }}</span>
          <h3><i class="bi bi-clock-history"></i> Pendiente</h3>
          <div class="column-actions" *ngIf="ordenesPendienteRetiro.length > 0">
            <button class="btn-move-all" (click)="moverTodos(ordenesPendienteRetiro, 'pendiente_retiro', 'entregado')"
              [attr.data-tooltip]="'Marcar todos como entregados'">
              <i class="bi bi-box-seam"></i>
            </button>
          </div>
        </div>
        <small>Listas para entregar</small>
      </div>

      <div class="ordenes-list" *ngIf="ordenesPendienteRetiro.length > 0; else emptyPendiente"
        [class.limited-view]="ordenesPendienteRetiro.length > maxOrdenesPorColumna">
        <div class="orden-card alert-card" *ngFor="let orden of (ordenesPendienteRetiro | slice:0:maxOrdenesPorColumna)"
          cdkDrag [cdkDragData]="orden" (click)="verDetalleOrden(orden)">
          <div class="orden-card-header">
            <span class="badge-warning">
              <i class="bi bi-exclamation-triangle"></i>
            </span>
            <span class="orden-fecha">
              {{ orden.fechaRecepcionTienda | date:'dd/MM' }}
            </span>
          </div>

          <div class="orden-cliente">
            <i class="bi bi-person"></i>
            <span class="cliente-nombre">{{ truncarTexto(orden.clienteNombre,
              18)
              }}</span>
          </div>

          <div class="orden-producto">
            <i class="bi bi-eyeglasses"></i>
            <span>{{ truncarTexto(orden.productoNombre, 22) }}</span>
          </div>

          <div class="orden-alerta" *ngIf="orden.diasEnEspera > 7">
            <i class="bi bi-bell"></i>
            <small class="text-danger">{{ orden.diasEnEspera }}d</small>
          </div>

          <div class="orden-meta">
            <div class="meta-item">
              <i class="bi bi-telephone"></i>
              <small>
                {{ truncarTexto(orden.clienteTelefono, 10) }}
              </small>
            </div>
          </div>

          <div class="orden-actions">
            <button class="btn-action btn-success" (click)="cambiarEstado(orden, 'entregado'); $event.stopPropagation()"
              [attr.data-tooltip]="'Marcar como entregado'">
              <i class="bi bi-box-seam"></i>
            </button>
            <button class="btn-action" (click)="notificarCliente(orden); $event.stopPropagation()"
              [attr.data-tooltip]="'Notificar al cliente'">
              <i class="bi bi-chat-dots"></i>
            </button>
          </div>
        </div>

        <div class="more-orders-indicator" *ngIf="ordenesPendienteRetiro.length > maxOrdenesPorColumna">
          <span class="badge bg-secondary">
            +{{ ordenesPendienteRetiro.length - maxOrdenesPorColumna }}
          </span>
          <button class="btn-view-all" (click)="verTodasOrdenes('pendiente_retiro')">
            Ver todas
          </button>
        </div>
      </div>

      <ng-template #emptyPendiente>
        <div class="empty-column">
          <i class="bi bi-clock-history"></i>
          <p>No hay órdenes</p>
        </div>
      </ng-template>
    </div>
  </div>

  <!-- Historial de Entregas (Acordeón) -->
  <div class="archivo-container">
    <!-- Encabezado plegable -->
    <div class="archivo-header" (click)="mostrarArchivo = !mostrarArchivo">
      <h3>
        <i class="bi bi-archive"></i>
        Historial de Entregas
        <span class="badge bg-purple">{{ordenesEntregadas.length + ordenesArchivadas.length}}</span>
        <i class="bi bi-chevron-down toggle-icon" [class.rotated]="mostrarArchivo"></i>
      </h3>
      <div class="archivo-actions">
        <button class="btn btn-sm btn-outline-purple" (click)="abrirModalArchivo(); $event.stopPropagation()"
          [attr.data-tooltip]="'Ver todas las órdenes archivadas'">
          <i class="bi bi-box-archive"></i> Ver Archivadas ({{ordenesArchivadas.length}})
        </button>
        <button class="btn btn-sm btn-outline-secondary" (click)="configurarDiasAutoArchivo(); $event.stopPropagation()"
          [attr.data-tooltip]="'Configurar días para auto-archivado'">
          <i class="bi bi-gear"></i> Config. Auto-Archivo
        </button>
      </div>
    </div>

    <!-- Contenido plegable -->
    <div class="archivo-content" *ngIf="mostrarArchivo">
      <!-- Pestañas para Entregados Recientes vs Archivados -->
      <div class="archivo-tabs">
        <div class="tab-buttons">
          <button class="tab-button" [class.active]="tabActiva === 'entregados'" (click)="tabActiva = 'entregados'">
            <i class="bi bi-box-seam"></i>
            Entregados Recientes
            <span class="badge">{{ordenesEntregadas.length}}</span>
          </button>
        </div>

        <!-- Contenido de entregados recientes -->
        <div class="tab-content" *ngIf="tabActiva === 'entregados'">
          <div class="recent-deliveries">
            <!-- Miniaturas de órdenes entregadas recientemente -->
            <div class="delivery-minicard" *ngFor="let orden of ordenesEntregadas.slice(0, 4)"
              (click)="verDetalleOrden(orden)">
              <div class="minicard-header">
                <small>{{orden.codigo}}</small>
                <span class="days-ago">{{calcularDiasDesde(orden.fechaEntrega)}} días</span>
              </div>
              <div class="minicard-body">
                <div class="minicard-cliente">
                  {{truncarTexto(orden.clienteNombre, 15)}}</div>
                <div class="minicard-producto">
                  {{truncarTexto(orden.productoNombre, 20)}}</div>
              </div>
              <div class="minicard-actions">
                <button class="btn-icon" (click)="archivarOrden(orden, false); $event.stopPropagation()"
                  [attr.data-tooltip]="'Archivar orden'">
                  <i class="bi bi-archive"></i>
                </button>
                <button class="btn-icon" (click)="generarFactura(orden); $event.stopPropagation()"
                  [attr.data-tooltip]="'Generar factura'">
                  <i class="bi bi-receipt"></i>
                </button>
              </div>
            </div>

            <!-- Ver todas -->
            <div class="view-all-container" *ngIf="ordenesEntregadas.length > 4">
              <button class="btn-view-all" (click)="verTodasOrdenes('entregado')">
                Ver todas las {{ordenesEntregadas.length}} entregas
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra inferior -->
  <div class="ordenes-footer">
    <div class="footer-info">
      <span class="text-muted">
        <i class="bi bi-info-circle"></i>
        Arrastra las tarjetas para cambiar su estado • Haz clic para ver detalles
      </span>
    </div>
    <div class="footer-actions">
      <button class="btn btn-secondary" (click)="exportarReporte()" [attr.data-tooltip]="'Exportar reporte a Excel'">
        <i class="bi bi-file-earmark-excel"></i> Exportar
      </button>
      <button class="btn btn-primary" (click)="generarReporte()" [attr.data-tooltip]="'Generar e imprimir reporte PDF'">
        <i class="bi bi-printer"></i> Imprimir Reporte
      </button>
    </div>
  </div>
</div>

<!-- Modal Detalle Orden -->
<div class="modal-backdrop" *ngIf="mostrarModalDetalle" (click)="cerrarModalDetalle()"></div>
<div class="modal-detalle-orden" *ngIf="mostrarModalDetalle">
  <div class="modal-header">
    <div class="header-left">
      <h2>
        <i class="bi bi-clipboard-data"></i>
        Orden #{{ ordenSeleccionada?.ordenId || ordenSeleccionada?.codigo }}
      </h2>
      <div class="orden-status">
        <span class="badge" [ngClass]="getEstadoClass(ordenSeleccionada?.estado)">
          {{ getEstadoTexto(ordenSeleccionada?.estado) }}
        </span>
        <span class="text-muted">
          <i class="bi bi-calendar"></i>
          {{ ordenSeleccionada?.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}
        </span>
      </div>
    </div>

    <div class="header-right">
      <button class="btn-close-modal" (click)="cerrarModalDetalle()" aria-label="Cerrar">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
  </div>

  <div class="modal-body">
    <!-- Grid de 2 columnas -->
    <div class="detalle-grid">

      <!-- COLUMNA IZQUIERDA -->
      <div class="detalle-columna">

        <!-- Información del Cliente -->
        <div class="info-card">
          <div class="info-header">
            <i class="bi bi-person-circle"></i>
            <h4>Información del Cliente</h4>
          </div>
          <div class="info-content compact">
            <!-- Línea 1: Nombre y Cédula combinados -->
            <div class="info-row">
              <span class="info-label">Paciente:</span>
              <div class="info-value">
                <div class="cliente-principal">
                  <strong>{{ ordenSeleccionada?.cliente?.informacion?.nombreCompleto ||
                    ordenSeleccionada?.clienteNombre ||
                    'Nombre no especificado' }}</strong>
                  <span *ngIf="ordenSeleccionada?.cliente?.informacion?.cedula || ordenSeleccionada?.clienteCedula"
                    class="cliente-cedula">
                    • C.I. {{ ordenSeleccionada?.cliente?.informacion?.cedula || ordenSeleccionada?.clienteCedula }}
                  </span>
                </div>
                <div *ngIf="!(ordenSeleccionada?.cliente?.informacion?.cedula || ordenSeleccionada?.clienteCedula)"
                  class="text-muted small-text">
                  Sin cédula registrada
                </div>
              </div>
            </div>

            <!-- Línea 2: Contacto unificado -->
            <div class="info-row">
              <span class="info-label">Contacto:</span>
              <div class="info-value contacto-unificado">
                <!-- Teléfono -->
                <a *ngIf="ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono"
                  href="tel:{{ ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono }}"
                  class="contacto-link">
                  <i class="bi bi-telephone"></i>
                  {{ ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono }}
                </a>
                <span *ngIf="!(ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono)"
                  class="text-muted">
                  <i class="bi bi-telephone"></i> Sin teléfono
                </span>

                <!-- Separador si hay ambos -->
                <span *ngIf="(ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono) && 
                     ordenSeleccionada?.cliente?.informacion?.email" class="separador-contacto">|</span>

                <!-- Email -->
                <a *ngIf="ordenSeleccionada?.cliente?.informacion?.email"
                  href="mailto:{{ ordenSeleccionada?.cliente?.informacion?.email }}" class="contacto-link">
                  <i class="bi bi-envelope"></i>
                  {{ ordenSeleccionada?.cliente?.informacion?.email }}
                </a>
                <span *ngIf="!ordenSeleccionada?.cliente?.informacion?.email && 
                     (ordenSeleccionada?.cliente?.informacion?.telefono || ordenSeleccionada?.clienteTelefono)"
                  class="text-muted">
                  <i class="bi bi-envelope"></i> Sin email
                </span>
              </div>
            </div>

            <!-- Línea 3: Información adicional si existe -->
            <div class="info-row" *ngIf="ordenSeleccionada?.cliente?.informacion?.tipoPersona">
              <span class="info-label">Tipo:</span>
              <span class="info-value">
                <span class="badge-tipo" [ngClass]="{'tipo-natural': ordenSeleccionada?.cliente?.informacion?.tipoPersona === 'natural',
                          'tipo-juridico': ordenSeleccionada?.cliente?.informacion?.tipoPersona === 'juridico'}">
                  {{ ordenSeleccionada?.cliente?.informacion?.tipoPersona === 'natural' ? 'Persona Natural' :
                  ordenSeleccionada?.cliente?.informacion?.tipoPersona === 'juridico' ? 'Persona Jurídica' :
                  ordenSeleccionada?.cliente?.informacion?.tipoPersona }}
                </span>
              </span>
            </div>
          </div>
        </div>

        <!-- Formulación -->
        <div class="info-card" *ngIf="ordenSeleccionada?.formulacion">
          <div class="info-header">
            <i class="bi bi-eyeglasses"></i>
            <h4>Formulación</h4>
          </div>
          <div class="info-content compact formulacion-compact">
            <div class="formulacion-row">
              <div class="formulacion-col ojo-col">
                <div class="ojo-label">OD</div>
                <div class="formulacion-valor">{{ ordenSeleccionada?.formulacion?.esferaOD || '--' }}</div>
                <div class="formulacion-extra" *ngIf="ordenSeleccionada?.formulacion?.cilindroOD">
                  <small>{{ ordenSeleccionada?.formulacion?.cilindroOD }} x {{ ordenSeleccionada?.formulacion?.ejeOD
                    }}°</small>
                </div>
              </div>

              <div class="formulacion-col ojo-col">
                <div class="ojo-label">OI</div>
                <div class="formulacion-valor">{{ ordenSeleccionada?.formulacion?.esferaOI || '--' }}</div>
                <div class="formulacion-extra" *ngIf="ordenSeleccionada?.formulacion?.cilindroOI">
                  <small>{{ ordenSeleccionada?.formulacion?.cilindroOI }} x {{ ordenSeleccionada?.formulacion?.ejeOI
                    }}°</small>
                </div>
              </div>

              <div class="formulacion-col add-col" *ngIf="ordenSeleccionada?.formulacion?.adicion">
                <div class="ojo-label">Add</div>
                <div class="formulacion-valor">{{ ordenSeleccionada?.formulacion?.adicion }}</div>
              </div>
            </div>

            <!-- Información adicional si existe -->
            <div class="formulacion-extra-info" *ngIf="ordenSeleccionada?.formulacion?.observaciones">
              <small>
                <i class="bi bi-info-circle"></i>
                {{ ordenSeleccionada?.formulacion?.observaciones }}
              </small>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="info-card">
          <div class="info-header">
            <i class="bi bi-chat-left-text"></i>
            <h4>Observaciones</h4>
          </div>
          <div class="info-content compact">
            <div *ngIf="ordenSeleccionada?.observaciones; else sinObservaciones" class="observaciones-content">
              {{ ordenSeleccionada?.observaciones }}
            </div>
            <ng-template #sinObservaciones>
              <div class="text-center">
                <i class="bi bi-chat-left"></i>
                <span class="text-muted">Sin observaciones</span>
              </div>
            </ng-template>
          </div>
        </div>

      </div>

      <!-- COLUMNA DERECHA -->
      <div class="detalle-columna">

        <!-- Productos -->
        <div class="info-card">
          <div class="info-header">
            <i class="bi bi-box-seam"></i>
            <h4>Productos ({{ ordenSeleccionada?.productos?.length || 1 }})</h4>
          </div>
          <div class="info-content compact productos-list">
            <!-- Si tiene estructura de productos del API -->
            <div class="producto-item"
              *ngFor="let producto of ordenSeleccionada?.productos; trackBy: trackByProductoId">
              <div class="producto-header">
                <strong>{{ producto?.datos?.nombre || 'Producto sin nombre' }}</strong>
                <span class="badge">{{ producto?.cantidad || 1 }} unidad{{ (producto?.cantidad || 1) > 1 ? 'es' : ''
                  }}</span>
              </div>
              <div class="producto-details">
                <small>
                  <span class="text-muted">Marca:</span> {{ producto?.datos?.marca || 'N/A' }}
                  <span class="separator">•</span>
                  <span class="text-muted">Código:</span> {{ producto?.datos?.codigo || 'N/A' }}
                </small>
              </div>
              <div class="producto-meta">
                <small class="text-muted">
                  {{ producto?.datos?.modelo || producto?.datos?.categoria || '' }}
                  <span *ngIf="producto?.datos?.material"> • {{ producto?.datos?.material }}</span>
                </small>
              </div>
            </div>

            <!-- Si tiene la estructura antigua (solo un producto) -->
            <div class="producto-item" *ngIf="!ordenSeleccionada?.productos && ordenSeleccionada?.productoNombre">
              <div class="producto-header">
                <strong>{{ ordenSeleccionada?.productoNombre }}</strong>
                <span class="badge">1 unidad</span>
              </div>
              <div class="producto-details">
                <small>
                  <span class="text-muted">Código:</span> {{ ordenSeleccionada?.codigo || 'N/A' }}
                </small>
              </div>
            </div>

            <!-- Si no hay productos -->
            <div class="text-center" *ngIf="!ordenSeleccionada?.productos && !ordenSeleccionada?.productoNombre">
              <i class="bi bi-box"></i>
              <span class="text-muted">Sin productos registrados</span>
            </div>
          </div>
        </div>

        <!-- Personal Asignado -->
        <div class="info-card">
          <div class="info-header">
            <i class="bi bi-person-badge"></i>
            <h4>Personal Asignado</h4>
          </div>
          <div class="info-content compact">
            <div class="info-row" *ngIf="ordenSeleccionada?.especialista">
              <span class="info-label">Especialista:</span>
              <div class="info-value">
                <div>{{ ordenSeleccionada?.especialista?.nombre || 'No especificado' }}</div>
                <small class="text-muted">{{ ordenSeleccionada?.especialista?.cargo || 'Optometrista' }}</small>
              </div>
            </div>
            <div class="info-row" *ngIf="ordenSeleccionada?.asesor">
              <span class="info-label">Asesor:</span>
              <div class="info-value">
                <div>{{ ordenSeleccionada?.asesor?.nombre || 'No especificado' }}</div>
                <small class="text-muted" *ngIf="ordenSeleccionada?.asesor?.cedula">C.I. {{
                  ordenSeleccionada?.asesor?.cedula }}</small>
              </div>
            </div>

            <!-- Si no hay personal asignado -->
            <div class="text-center"
              *ngIf="!ordenSeleccionada?.especialista && !ordenSeleccionada?.asesor && !ordenSeleccionada?.tecnicoAsignado">
              <i class="bi bi-person-x"></i>
              <span class="text-muted">Sin personal asignado</span>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Acciones según estado -->
    <div class="modal-actions" *ngIf="ordenSeleccionada">
      <div class="actions-left">
        <div class="venta-id" *ngIf="ordenSeleccionada?.ventaId"
          title="ID de Venta Relacionada - Haga clic para ver detalles">
          <i class="bi bi-receipt"></i>
          <span>{{ ordenSeleccionada?.ventaId }}</span>
          <small *ngIf="ordenSeleccionada?.clienteNombre" class="venta-cliente">
            • {{ ordenSeleccionada?.clienteNombre }}
          </small>
        </div>
      </div>
      <div class="actions-right">
        <button *ngIf="ordenSeleccionada.estado === 'en_tienda'" class="btn btn-primary"
          (click)="cambiarEstado(ordenSeleccionada, 'proceso_laboratorio'); cerrarModalDetalle()">
          <i class="bi bi-arrow-right"></i> Mover a Laboratorio
        </button>
        <button *ngIf="ordenSeleccionada.estado === 'proceso_laboratorio'" class="btn btn-success"
          (click)="cambiarEstado(ordenSeleccionada, 'listo_laboratorio'); cerrarModalDetalle()">
          <i class="bi bi-check-circle"></i> Marcar como Listo
        </button>
        <button *ngIf="ordenSeleccionada.estado === 'listo_laboratorio'" class="btn btn-warning"
          (click)="cambiarEstado(ordenSeleccionada, 'pendiente_retiro'); cerrarModalDetalle()">
          <i class="bi bi-truck"></i> Enviar a Tienda
        </button>
        <button *ngIf="ordenSeleccionada.estado === 'pendiente_retiro'" class="btn btn-success"
          (click)="cambiarEstado(ordenSeleccionada, 'entregado'); cerrarModalDetalle()">
          <i class="bi bi-box-seam"></i> Marcar como Entregado
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Archivadas -->
<div class="modal-backdrop" *ngIf="mostrarModalArchivo" (click)="mostrarModalArchivo = false"></div>
<div class="modal-archivadas" *ngIf="mostrarModalArchivo">
  <div class="modal-header">
    <h2>
      <i class="bi bi-archive"></i>
      Órdenes Archivadas
      <span class="badge bg-white text-purple ms-2">{{ordenesArchivadas.length}}</span>
    </h2>
    <button class="btn-close-modal" (click)="mostrarModalArchivo = false">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="modal-body">
    <div class="search-archivo">
      <input type="text" [(ngModel)]="filtroArchivo" (input)="filtrarArchivadas()" placeholder="Buscar en archivadas..."
        class="form-control">
    </div>

    <div class="archivadas-grid" *ngIf="ordenesFiltradasArchivadas.length > 0; else emptyArchivo">
      <div class="archivada-card" *ngFor="let orden of ordenesFiltradasArchivadas">
        <div class="archivada-header">
          <div class="archivada-codigo">
            <strong>{{orden.codigo}}</strong>
          </div>
          <span class="archivada-fecha">
            Archivada: {{orden.fechaArchivado | date:'dd/MM/yy'}}
          </span>
        </div>

        <div class="archivada-info">
          <div class="info-row">
            <i class="bi bi-person"></i>
            <span>{{orden.clienteNombre}}</span>
          </div>
          <div class="info-row">
            <i class="bi bi-eyeglasses"></i>
            <span>{{orden.productoNombre}}</span>
          </div>
          <div class="info-row">
            <i class="bi bi-calendar-check"></i>
            <span>Entregada: {{orden.fechaEntrega | date:'dd/MM/yy'}}</span>
          </div>
        </div>

        <div class="archivada-meta">
          <div class="meta-item">
            <i class="bi bi-clock-history"></i>
            <small>Tiempo total: {{calcularDiasDuracion(orden)}} días</small>
          </div>
          <div class="meta-item">
            <i class="bi bi-info-circle"></i>
            <small>{{orden.motivoArchivo || 'Sin motivo'}}</small>
          </div>
        </div>

        <div class="archivada-actions">
          <button class="btn btn-sm btn-outline-success" (click)="restaurarOrden(orden)">
            <i class="bi bi-arrow-counterclockwise"></i> Restaurar
          </button>
          <button class="btn btn-sm btn-outline-primary" (click)="generarFactura(orden)">
            <i class="bi bi-receipt"></i> Factura
          </button>
        </div>
      </div>
    </div>

    <ng-template #emptyArchivo>
      <div class="empty-state">
        <i class="bi bi-archive" style="font-size: 48px; color: #e2e8f0;"></i>
        <h4>No hay órdenes archivadas</h4>
        <p class="text-muted">Las órdenes se archivan automáticamente después de {{diasParaAutoArchivo}} días de
          entrega.</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Modal para ver todas las órdenes -->
<div class="modal-backdrop" *ngIf="mostrarModalOrdenes" (click)="cerrarModalOrdenes()"></div>
<div class="modal-ordenes" *ngIf="mostrarModalOrdenes">
  <div class="modal-header">
    <h2>
      <i class="bi bi-list-ul"></i>
      {{tituloModalOrdenes}}
      <span class="badge bg-primary ms-2">{{ordenesModalFiltradas.length}}</span>
    </h2>
    <button class="btn-close-modal" (click)="cerrarModalOrdenes()">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>

  <div class="modal-body">
    <!-- Barra de búsqueda y filtros -->
    <div class="modal-search-container">
      <div class="search-box">
        <input type="text" class="form-control search-input" placeholder="Buscar orden, cliente, producto o venta..."
          [(ngModel)]="filtroModal" (input)="filtrarOrdenesModal()">
        <i class="bi bi-search search-icon"></i>
        <button class="btn-clear-search" *ngIf="filtroModal" (click)="limpiarFiltroModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Filtros adicionales -->
      <div class="filtros-rapidos">
        <!-- Ordenamiento -->
        <select class="form-select sort-select" [(ngModel)]="ordenModal" (change)="ordenarOrdenesModal()">
          <option value="fechaCreacion_desc">Más recientes primero</option>
          <option value="fechaCreacion_asc">Más antiguos primero</option>
          <option value="diasRestantes_asc">Próximas a vencer</option>
          <option value="clienteNombre_asc">Cliente A-Z</option>
          <option value="clienteNombre_desc">Cliente Z-A</option>
        </select>
      </div>
    </div>

    <!-- Contador de resultados -->
    <div class="resultados-info" *ngIf="filtroModal || filtroPrioridadModal">
      <small class="text-muted">
        Mostrando {{ordenesModalFiltradas.length}} de {{ordenesModal.length}} órdenes
        <span *ngIf="filtroModal">• Buscando: "{{filtroModal}}"</span>
      </small>
    </div>

    <!-- Lista de órdenes filtradas -->
    <div class="ordenes-modal-list" *ngIf="ordenesModalFiltradas.length > 0; else sinResultados">
      <div class="orden-modal-card" *ngFor="let orden of ordenesModalPagina" (click)="verDetalleOrden(orden)">
        <div class="orden-modal-header">
          <div class="orden-info">
            <strong>{{orden.codigo}}</strong>
            <!-- Indicador de coincidencia en búsqueda -->
            <span class="search-match-indicator" *ngIf="tieneCoincidencia(orden)">
              <i class="bi bi-search"></i>
            </span>
          </div>
          <span class="orden-estado">
            {{getEstadoTexto(orden.estado)}}
          </span>
        </div>

        <div class="orden-modal-body">
          <div class="orden-cliente-modal">
            <i class="bi bi-person"></i>
            <span [innerHTML]="resaltarTexto(orden.clienteNombre, filtroModal)"></span>
          </div>
          <div class="orden-producto-modal">
            <i class="bi bi-eyeglasses"></i>
            <span [innerHTML]="resaltarTexto(orden.productoNombre, filtroModal)"></span>
          </div>
          <div class="orden-meta-modal">
            <div class="meta-item">
              <i class="bi bi-calendar"></i>
              <small>Creación: {{orden.fechaCreacion | date:'dd/MM/yy'}}</small>
            </div>
            <div class="meta-item" *ngIf="orden.fechaEntregaEstimada">
              <i class="bi bi-clock"></i>
              <small [ngClass]="{'text-danger': orden.diasRestantes < 3}">
                Entrega: {{orden.fechaEntregaEstimada | date:'dd/MM/yy'}}
                <span *ngIf="orden.diasRestantes !== undefined">({{orden.diasRestantes}}d)</span>
              </small>
            </div>
          </div>
        </div>

        <div class="orden-modal-actions">
          <button class="btn-action" (click)="verDetalleOrden(orden); $event.stopPropagation()" title="Ver detalles">
            <i class="bi bi-eye"></i>
          </button>
          <button class="btn-action"
            *ngIf="estadoModalActual !== 'entregado' && estadoModalActual !== 'pendiente_retiro'"
            (click)="cambiarEstado(orden, getNextEstado(estadoModalActual)); $event.stopPropagation()"
            title="Avanzar estado">
            <i class="bi bi-arrow-right"></i>
          </button>
          <button class="btn-action btn-success" *ngIf="estadoModalActual === 'pendiente_retiro'"
            (click)="cambiarEstado(orden, 'entregado'); $event.stopPropagation()" title="Marcar como entregado">
            <i class="bi bi-check-lg"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <ng-template #sinResultados>
      <div class="no-results">
        <i class="bi bi-search"></i>
        <h4>No se encontraron órdenes</h4>
        <p *ngIf="filtroModal || filtroPrioridadModal">
          No hay órdenes que coincidan con tu búsqueda.
          <a href="javascript:void(0)" (click)="limpiarFiltroModal()" class="text-primary">
            Limpiar filtros
          </a>
        </p>
        <p *ngIf="!filtroModal && !filtroPrioridadModal">No hay órdenes en este estado.</p>
      </div>
    </ng-template>

    <!-- Paginación si hay muchas órdenes -->
    <div class="modal-pagination" *ngIf="ordenesModalFiltradas.length > 20">
      <div class="pagination-info">
        Mostrando {{inicioPaginacion + 1}} - {{finPaginacion}} de {{ordenesModalFiltradas.length}}
      </div>
      <div class="pagination-controls">
        <button class="btn-pagination" [disabled]="paginaActual === 0" (click)="paginaAnterior()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <span class="pagina-info">Página {{paginaActual + 1}} de {{totalPaginas}}</span>
        <button class="btn-pagination" [disabled]="paginaActual === totalPaginas - 1" (click)="paginaSiguiente()">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>
</div>