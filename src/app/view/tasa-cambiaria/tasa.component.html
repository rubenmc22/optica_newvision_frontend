<div class="container mt-4">
  <h2 class="text-center mb-4">ğŸ’° Tasa de Cambio</h2>

  <div class="row">
    <div *ngFor="let tasa of tasas" class="col-md-6">
      <div class="card p-4 shadow-lg position-relative">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <h5 class="fw-bold me-2">
              {{ metodoTasa[tasa.id] === 'manual' ? '(' + tasa.simbolo + ')' + ' ' + tasa.nombre  :  tasa.nombre + ' Oficial BCV' }}
            </h5>

            <small *ngIf="metodoTasa[tasa.id] === 'manual'" class="text-muted ms-0 fst-italic" style="margin-top: -6px; font-size: 14px;">(Tasa Manual)</small>
            <button *ngIf="metodoTasa[tasa.id] === 'bcv' && !autoActualizar[tasa.id]"
              class="btn p-1 border-0 bg-transparent" (click)="actualizarBCV(tasa.id)">
              <i class="bi bi-arrow-repeat text-success"></i>
            </button>
          </div>
        </div>

        <p class="fs-3 text-success">
          {{ metodoTasa[tasa.id] === 'bcv' ? tasa.valor : tasaManual[tasa.id] || 0 | number:'1.2-2' }} {{ tasa.simbolo
          }}
        </p>

        <!-- âœ… Muestra referencia BCV solo cuando la tasa es manual -->
        <div *ngIf="metodoTasa[tasa.id] === 'manual'" class="text-muted small fst-italic">
          <span class="d-block">Tasa oficial BCV: {{ tasa.valor | number:'1.2-2' }} {{ tasa.simbolo }}</span>
        </div>

        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            Ãšltima actualizaciÃ³n: {{ metodoTasa[tasa.id] === 'manual' ? fechaActualizacionManual[tasa.id] :
            tasa.updated_at | date:'dd/MM/yyyy HH:mm' }}
          </small>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" [(ngModel)]="autoActualizar[tasa.id]"
              (change)="verificarAutoActualizar(tasa.id)">
            <label class="form-check-label">Auto</label>
          </div>
        </div>

        <!-- BotÃ³n de configuraciÃ³n -->
        <button class="btn btn-light position-absolute top-0 end-0 mt-2 me-2" (click)="toggleMenu(tasa.id)">â‹®</button>

        <!-- MenÃº de configuraciÃ³n adaptado -->
        <div *ngIf="menuAbierto === tasa.id" class="position-absolute menu top-0 end-0 mt-5 me-2 shadow bg-white p-2 rounded"
          (clickOutside)="cerrarMenu()">
          <button *ngIf="metodoTasa[tasa.id] !== 'manual'" class="btn btn-sm btn-primary w-100 mb-1"
            (click)="abrirPopover(tasa.id)">Ingresar Tasa Manual</button>
          <button class="btn btn-sm btn-secondary w-100 mb-1" (click)="verHistorial(tasa.id)">Ver historial</button>
          <button *ngIf="metodoTasa[tasa.id] === 'manual'" class="btn btn-sm btn-success w-100"
            (click)="actualizarBCV(tasa.id)">Actualizar a Tasa BCV</button>
        </div>

        <!-- âœ… Modal flotante mejorado -->
        <div *ngIf="popoverActivo === tasa.id" class="popover-custom">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Modificar Tasa</strong>
            <button class="btn btn-sm p-0 border-0 bg-transparent text-danger" (click)="cerrarPopover()">âŒ</button>
          </div>
          <input type="number" class="form-control form-control-sm text-center mb-2 no-spinner"
            [(ngModel)]="nuevaTasaManual" step="0.01">
          <button class="btn btn-sm btn-primary w-100" (click)="guardarTasaManual(tasa.id)">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>


       <!-- Modal historial tasas -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="historialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="historialLabel">ğŸ“ˆ Historial de Tasa de {{ simboloSeleccionado }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>ğŸ§ Actualizado por</th>
              <th>â± Fecha y hora</th>
              <th>ğŸ’µ Valor</th>
              <th>ğŸ” Tipo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialTasaSeleccionada">
              <td>{{ item.usuario }}</td>
              <td>{{ item.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
              <td><strong class="text-success">{{ item.valor | number:'1.2-2' }} {{ simboloSeleccionado }}</strong></td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-secondary': item.metodo === 'manual',
                  'bg-info text-dark': item.metodo === 'bcv'
                }">{{ item.metodo === 'manual' ? 'Manual' : 'BCV' }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
