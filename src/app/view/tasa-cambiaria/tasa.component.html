<div class="container mt-4">
  <h2 class="text-center mb-4">üí∞ Tasa de Cambio</h2>

  <div class="row">
    <div *ngFor="let tasa of tasas" class="col-md-6">
      <div class="card p-4 shadow-lg position-relative">
        <div class="d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center">
            <h5 class="fw-bold me-2">
              {{ metodoTasa[tasa.id] === 'manual' ? '(' + tasa.simbolo + ')' + ' ' + tasa.nombre  :  tasa.nombre + ' Oficial BCV' }}
            </h5>

            <small *ngIf="metodoTasa[tasa.id] === 'manual'" class="text-muted ms-0 fst-italic" style="margin-top: -6px; font-size: 14px;">(Tasa Manual)</small>
            <button *ngIf="metodoTasa[tasa.id] === 'bcv' && !autoActualizar[tasa.id]"
              class="btn p-1 border-0 bg-transparent" (click)="actualizarBCV(tasa.id)">
              <i class="bi bi-arrow-repeat text-success"></i>
            </button>
          </div>
        </div>

        <p class="fs-3 text-success">
          {{ metodoTasa[tasa.id] === 'bcv' ? tasa.valor : tasaManual[tasa.id] || 0 | number:'1.2-2' }} {{ tasa.simbolo
          }}
        </p>

        <!-- ‚úÖ Muestra referencia BCV solo cuando la tasa es manual -->
        <div *ngIf="metodoTasa[tasa.id] === 'manual'" class="text-muted small fst-italic">
          <span class="d-block">Tasa oficial BCV: {{ tasa.valor | number:'1.2-2' }} {{ tasa.simbolo }}</span>
        </div>

        <div class="d-flex justify-content-between align-items-center">
          <small class="text-muted">
            √öltima actualizaci√≥n: {{ metodoTasa[tasa.id] === 'manual' ? fechaActualizacionManual[tasa.id] :
            tasa.updated_at | date:'dd/MM/yyyy HH:mm' }}
          </small>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" [(ngModel)]="autoActualizar[tasa.id]"
              (change)="verificarAutoActualizar(tasa.id)">
            <label class="form-check-label">Auto</label>
          </div>
        </div>

        <!-- Bot√≥n de configuraci√≥n -->
        <button class="btn btn-light position-absolute top-0 end-0 mt-2 me-2" (click)="toggleMenu(tasa.id)">‚ãÆ</button>

        <!-- Men√∫ de configuraci√≥n adaptado -->
        <div *ngIf="menuAbierto === tasa.id" class="position-absolute menu top-0 end-0 mt-5 me-2 shadow bg-white p-2 rounded"
          (clickOutside)="cerrarMenu()">
          <button *ngIf="metodoTasa[tasa.id] !== 'manual'" class="btn btn-sm btn-primary w-100 mb-1"
            (click)="abrirPopover(tasa.id)">Ingresar Tasa Manual</button>
          <button class="btn btn-sm btn-secondary w-100 mb-1" (click)="verHistorial(tasa.id)">Ver historial</button>
          <button *ngIf="metodoTasa[tasa.id] === 'manual'" class="btn btn-sm btn-success w-100"
            (click)="actualizarBCV(tasa.id)">Actualizar a Tasa BCV</button>
        </div>

        <!-- ‚úÖ Modal flotante mejorado -->
        <div *ngIf="popoverActivo === tasa.id" class="popover-custom">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Modificar Tasa</strong>
            <button class="btn btn-sm p-0 border-0 bg-transparent text-danger" (click)="cerrarPopover()">‚ùå</button>
          </div>
          <input type="number" class="form-control form-control-sm text-center mb-2 no-spinner"
            [(ngModel)]="nuevaTasaManual" step="0.01">
          <button class="btn btn-sm btn-primary w-100" (click)="guardarTasaManual(tasa.id)">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>