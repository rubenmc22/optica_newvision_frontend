<div class="container mt-4">
  <div class="card shadow-lg card-primary">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
      <h4 class="mb-0">üí∞ Tasa de Cambio</h4>
      <div class="ms-auto">
        <button class="btn btn-light btn-sm" (click)="actualizarYRecargarTasasDesdeBCV()"> <i
            class="bi bi-cloud-arrow-down-fill me-2"></i> Actualizar desde BCV

        </button>
      </div>

    </div><br>



    <div class="card-body row">
      <div *ngFor="let tasa of tasas" class="col-md-6">
        <div class="card p-4 shadow-lg position-relative">
          <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <h5 class="fw-bold me-2">
                {{ metodoTasa[tasa.id] === 'manual' ? '(' + tasa.simbolo + ')' + ' ' + tasa.nombre : tasa.nombre + '
                Oficial BCV' }}
              </h5>

              <small *ngIf="metodoTasa[tasa.id] === 'manual'" class="text-muted ms-0 fst-italic"
                style="margin-top: -6px; font-size: 14px;">(Tasa Manual)</small>
              <button *ngIf="metodoTasa[tasa.id] === 'bcv' && !autoActualizar[tasa.id]"
                class="btn p-1 border-0 bg-transparent" (click)="actualizarTasaDesdeBCV(tasa.id)">

              </button>
            </div>
          </div>

          <p class="fs-3 text-success">
            <ng-container *ngIf="!loadingBCV[tasa.id]; else cargandoBCV">
              {{ metodoTasa[tasa.id] === 'bcv' ? tasa.valor : tasaManual[tasa.id] || 0 }} {{ tasa.simbolo
              }}
            </ng-container>
            <ng-template #cargandoBCV>
              ‚è≥ Actualizando...
            </ng-template>
          </p>


          <!-- ‚úÖ Muestra referencia BCV solo cuando la tasa es manual -->
          <div class="text-muted small fst-italic">
            <span class="d-block">Tasa oficial BCV: {{ valorBCV[tasa.id] || 0 }} {{ tasa.simbolo
              }}</span>

          </div>

          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">
              √öltima actualizaci√≥n: {{ metodoTasa[tasa.id] === 'manual' ? fechaActualizacionManual[tasa.id] :
              tasa.updated_at | date:'dd/MM/yyyy HH:mm' }}
            </small>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" [(ngModel)]="autoActualizar[tasa.id]"
                (change)="activarRastreoBCVConSincronizacion(tasa.id)">
              <label class="form-check-label">Auto</label>
            </div>
          </div>
        </div>
        <!-- Bot√≥n de configuraci√≥n -->
        <button class="btn btn-sm position-absolute top-0 end-0 mt-2 me-2"
          (click)="abrirMenu($event, tasa.id)">‚ò∞</button>


        <!-- Men√∫ de configuraci√≥n adaptado -->
        <div *ngIf="menuAbierto === tasa.id"
          class="position-absolute menu top-0 end-0 mt-5 me-2 shadow bg-white p-2 rounded"
          (clickOutside)="cerrarMenu()">
          <button *ngIf="metodoTasa[tasa.id] !== 'manual'" class="btn btn-sm btn-primary w-100 mb-1"
            (click)="abrirPopover(tasa.id)">Ingresar Tasa Manual</button>
          <button class="btn btn-sm btn-secondary w-100 mb-1" (click)="verHistorial(tasa.id)">Ver historial</button>
          <button *ngIf="metodoTasa[tasa.id] === 'manual'" class="btn btn-sm btn-success w-100"
            (click)="actualizarTasaDesdeBCV(tasa.id)">Actualizar a Tasa BCV</button>
        </div>

        <!-- ‚úÖ Modal flotante mejorado -->
        <div *ngIf="popoverActivo === tasa.id" class="popover-custom">
          <div class="d-flex justify-content-between align-items-center">
            <strong>Modificar Tasa</strong>
            <button class="btn btn-sm p-0 border-0 bg-transparent text-danger" (click)="cerrarPopover()">‚ùå</button>
          </div>
          <input type="number" class="form-control form-control-sm text-center mb-2 no-spinner"
            [(ngModel)]="nuevaTasaManual" step="0.01">
          <button class="btn btn-sm btn-primary w-100" (click)="guardarTasaManual(tasa.id)">Guardar</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Modal historial tasas -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="historialLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="historialLabel">üìà Historial de Tasa de {{ simboloSeleccionado }}</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              <th>üßç Actualizado por</th>
              <th>‚è± Fecha y hora</th>
              <th>üíµ Valor</th>
              <th>üîÅ Tipo</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of historialTasaSeleccionada">
              <td>{{ item.usuario }}</td>
              <td>{{ item.fecha | date:'dd/MM/yyyy HH:mm' }}</td>
              <td><strong class="text-success">{{ item.valor | number:'1.2-2' }} {{ simboloSeleccionado }}</strong></td>
              <td>
                <span class="badge" [ngClass]="{
                  'bg-secondary': item.metodo === 'manual',
                  'bg-info text-dark': item.metodo === 'bcv'
                }">{{ item.metodo === 'manual' ? 'Manual' : 'BCV' }}</span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>