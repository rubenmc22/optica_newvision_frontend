<div class="container-fluid historia-medica-container">
  <!-- Header con información del paciente -->
  <div class="row paciente-header sticky-top bg-light py-3 shadow-sm">
    <div class="col-md-8">
      <h2>
        <button class="btn btn-outline-secondary me-3" (click)="cerrarHistorias()">
          <i class="bi bi-arrow-left"></i>
        </button>
        Historias Clínicas: {{paciente?.nombreCompleto || 'Cargando...'}}
      </h2>
      <div class="paciente-info">
        <span class="badge bg-primary me-2">Cédula: {{paciente?.cedula}}</span>
        <span class="badge bg-info me-2">Edad: {{calcularEdad(paciente?.fechaNacimiento)}}</span>
        <span class="badge bg-secondary">Última visita: {{ultimaHistoriaFecha | date}}</span>
      </div>
    </div>
    <div class="col-md-4 text-end">
      <button class="btn btn-success" (click)="nuevaHistoria()">
        <i class="bi bi-plus-lg"></i> Nueva Historia
      </button>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="row mt-4">
    <!-- Panel lateral con lista de historias -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Listado de Historias</h5>
        </div>
        <div class="card-body p-0">
          <div *ngIf="cargando" class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <div *ngIf="!cargando && historias.length === 0" class="alert alert-info m-3">
            No hay historias clínicas registradas.
          </div>

          <div class="list-group list-group-flush">
            <a *ngFor="let historia of historias" 
               [id]="'historia-' + historia.id"
               class="list-group-item list-group-item-action historia-card"
               [class.active]="historiaSeleccionada?.id === historia.id"
               (click)="verHistoriaDetalle(historia)">
              <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">{{historia.motivoConsulta || 'Consulta médica'}}</h6>
                <small>{{historia.fecha | date:'shortDate'}}</small>
              </div>
              <p class="mb-1 text-truncate">{{historia.diagnostico || 'Sin diagnóstico registrado'}}</p>
              <small class="text-muted">Dr. {{historia.medico || 'Médico no especificado'}}</small>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel principal con detalle de historia -->
    <div class="col-md-8">
      <div *ngIf="historiaSeleccionada" class="card shadow-sm">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">Detalle de Historia Clínica</h5>
        </div>
        <div class="card-body">
          <div class="historia-header mb-4">
            <h4>{{historiaSeleccionada.motivoConsulta || 'Consulta médica'}}</h4>
            <div class="d-flex justify-content-between align-items-center">
              <span class="badge bg-secondary">
                {{historiaSeleccionada.fecha | date:'fullDate'}}
              </span>
              <span class="text-muted">
                <i class="bi bi-person-badge"></i> Dr. {{historiaSeleccionada.medico}}
              </span>
            </div>
          </div>

          <div class="historia-content">
            <!-- Sección de Diagnóstico -->
            <div class="mb-4">
              <h5 class="section-title">
                <i class="bi bi-clipboard2-pulse me-2"></i>Diagnóstico
              </h5>
              <div class="diagnostico-box p-3 bg-light rounded">
                {{historiaSeleccionada.diagnostico || 'No especificado'}}
              </div>
            </div>

            <!-- Sección de Tratamiento -->
            <div class="mb-4">
              <h5 class="section-title">
                <i class="bi bi-capsule me-2"></i>Tratamiento
              </h5>
              <div class="tratamiento-box p-3 bg-light rounded">
                <pre>{{historiaSeleccionada.tratamiento || 'No se indicó tratamiento'}}</pre>
              </div>
            </div>

            <!-- Sección de Notas -->
            <div *ngIf="historiaSeleccionada.notas" class="mb-4">
              <h5 class="section-title">
                <i class="bi bi-journal-text me-2"></i>Notas Adicionales
              </h5>
              <div class="notas-box p-3 bg-light rounded">
                {{historiaSeleccionada.notas}}
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer text-end">
          <button class="btn btn-outline-primary me-2">
            <i class="bi bi-printer"></i> Imprimir
          </button>
          <button class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Editar
          </button>
        </div>
      </div>

      <div *ngIf="!historiaSeleccionada && !cargando" class="alert alert-info">
        Seleccione una historia clínica para ver los detalles
      </div>
    </div>
  </div>
</div>