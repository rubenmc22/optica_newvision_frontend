<div class="container-fluid py-4">
  <!-- Encabezado -->
  <div class="card shadow-lg containerPrincipal">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
      <h4 class="mb-0">üë®‚Äç‚öïÔ∏è Historias m√©dicas</h4>
      <div class="ms-auto">
        <button class="btn btn-light btn-sm" (click)="nuevaHistoria()">
          ‚ûï Agregar Historia Nueva
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Selector de paciente -->
      <div class="w-100 mb-3">
        <label for="selectorPaciente" class="form-label">üë§ Buscar y seleccionar paciente</label>
        <ng-select [items]="pacientesFiltrados" bindLabel="nombreCompleto" bindValue="id"
          [(ngModel)]="pacienteIdSeleccionado" (change)="seleccionarPacientePorId(pacienteIdSeleccionado)"
          [searchable]="true" [clearable]="true" placeholder="Buscar por nombre o c√©dula..."
          [searchFn]="filtrarPaciente">
          <ng-template ng-option-tmp let-item="item">
            {{ item.nombreCompleto }} ‚Äî {{ item.cedula }}
          </ng-template>
        </ng-select>
      </div>

      <!-- Mensaje si el paciente no tiene historial -->
      <div *ngIf="mostrarSinHistorial" class="alert alert-info">
        Este paciente no posee historial m√©dico registrado.
      </div>

      <!-- Panel principal -->
      <div class="row g-2 mt-0" *ngIf="mostrarElementos">
        <!-- Listado de historias -->
        <div class="col-md-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
              style="padding: 10px 20px;">
              <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Historiales</h5>
            </div>

            <!-- Scroll SOLO si hay suficiente contenido -->
            <div class="card-body px-0" style="max-height: 460px; overflow-y: auto;">
              <div class="list-group list-group-flush">
                <button *ngFor="let historia of historial"
                  class="list-group-item list-group-item-action position-relative"
                  [class.active]="historiaSeleccionada?.id === historia.id" (click)="verDetalle(historia)">

                  <!-- üß† Encabezado superior: motivo + fecha -->
                  <div class="d-flex justify-content-between mb-1">
                    <strong>{{ historia.motivo }}</strong>
                    <span class="">{{ historia.fecha }}</span>
                  </div>

                  <!-- üë• Pie inferior: m√©dico + n¬∞ historia -->
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">üë®‚Äç‚öïÔ∏è {{ historia.medico }}</small>
                    <span class="badge bg-info">#{{ historia.n_historia || '00012345' }}</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Detalle de historia cl√≠nica -->
        <div class="col-md-9 details">
          <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
            style="padding: 10px 20px;">
            <!-- T√≠tulo a la izquierda -->
            <h5 class="mb-0">
              <i class="bi bi-eye-fill me-2"></i> Detalle del Examen
            </h5>

            <!-- Fecha y M√©dico en bloque alineado al margen derecho -->
            <div class="ms-auto">
              <div class="text-start">
                <strong style="color: var(--details-color); font-size: 15px;">N¬∞ de historia:</strong>
                <span class="fw-semibold" style="color: white; font-size: 15px;">
                  {{ historiaSeleccionada.n_historia || '00012345' }}
                </span>
              </div>
              <div class="mb-0 text-start">
                <strong style="color: var(--details-color); font-size: 15px;">Fecha:</strong>
                <span class="fw-semibold" style="color: white; font-size: 15px;">
                  {{ historiaSeleccionada.fecha }}
                </span>
              </div>
            </div>
          </div>

          <div class="card-body" id="detalleExamen" style="height: 500px; overflow-y: auto;  background-color: white;">
            <div class="row mb-4">
              <!-- Datos del paciente -->
              <div class="col-md-8">
                <h6 class="text-primary">üìå Datos del Paciente</h6>
                <div class="row">
                  <div class="col-md-4 mb-0">
                    <strong>Nombre:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.nombreCompleto }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>C√©dula:</strong><br>
                    <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.cedula }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Tel√©fono:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.telefono }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Edad:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ calcularEdad(pacienteSeleccionado?.fechaNacimiento) }} a√±os
                    </p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Ocupaci√≥n:</strong><br>
                    <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.ocupacion }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Motivo:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ historiaSeleccionada.motivo }}</p>
                  </div>
                  <div class="col-md-8 mb-0">
                    <strong>Direcci√≥n:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.direccion }}</p>
                  </div>
                </div>
              </div>

              <!-- M√©dico tratante -->
              <div class="col-md-4 d-flex align-items-start ">
                <div>
                  <h6 class="text-primary">üë®‚Äç‚öïÔ∏è M√©dico tratante</h6>
                  <strong style="font-size: 15px;">Nombre:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ historiaSeleccionada.medico }}</p>
                </div>
              </div>
            </div>

            <!-- Historia Cl√≠nica del paciente -->
            <div class="mb-4">
              <h6 class="text-primary">üß¨ Historia Cl√≠nica</h6>
              <!-- Condiciones cl√≠nicas booleanas -->
              <div class="row gy-2 mb-3">
                <div class="col-md-3">
                  <strong>Usuario de lentes:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.usuarioLentes ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Cristal actual:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.tipoCristalActual || 'No especificado' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>√öltima graduaci√≥n:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.ultimaGraduacion || 'No disponible' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Fotofobia:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.fotofobia ? 'S√≠' : 'No' }}</p>
                </div>
              </div>

              <!-- Antecedentes personales visualizados como badges -->
              <div class="row gy-2 mb-3">
                <div class="col-md-3">
                  <strong class="d-block mb-1">Alergias a:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.alergicoA || 'No especificado' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Cirug√≠a ocular previa:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.cirugiaOcular ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-3">
                  <strong class="d-block mb-1">Tipo de cirug√≠a ocular:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.cirugiaOcularDescripcion || 'No especificada'
                    }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Traumatismo ocular:</strong>
                  <p class="bg-light rounded p-2">{{ historiaSeleccionada.traumatismoOcular ? 'S√≠' : 'No' }}</p>
                </div>
              </div>

              <!-- Condiciones adicionales -->
              <div class="row gy-2 mb-3">
                <div class="col-md-4">
                  <strong>Uso de dispositivos electr√≥nicos:</strong>
                  <p class="bg-light rounded p-2">
                    {{ historiaSeleccionada.usaDispositivosElectronicos ? 'S√≠' : 'No' }}
                    <span *ngIf="historiaSeleccionada.tiempoUsoEstimado"> ‚Äî {{ historiaSeleccionada.tiempoUsoEstimado
                      }}</span>
                  </p>
                </div>
                <div class="col-md-4">
                  <strong class="d-block mb-1">Antecedentes personales:</strong>
                  <div *ngIf="historiaSeleccionada.antecedentesPersonales?.length > 0"
                    class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let antecedente of historiaSeleccionada.antecedentesPersonales"
                      class="badge bg-success text-white p-2">
                      {{ antecedente }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.antecedentesPersonales?.length">
                    <span class="badge bg-secondary p-2">No reportados</span>
                  </div>
                </div>

                <div class="col-md-4">
                  <strong class="d-block mb-1">Antecedentes familiares:</strong>
                  <div *ngIf="historiaSeleccionada.antecedentesFamiliares?.length > 0"
                    class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let antecedente of historiaSeleccionada.antecedentesFamiliares"
                      class="badge bg-info text-dark p-2">
                      {{ antecedente }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.antecedentesFamiliares?.length">
                    <span class="badge bg-secondary p-2">No reportados</span>
                  </div>
                </div>
              </div>

              <!-- Listados din√°micos -->
              <div class="row gy-2">
                <div class="col-md-4">
                  <strong class="d-block mb-1">Patolog√≠as generales:</strong>
                  <div *ngIf="historiaSeleccionada.patologias?.length > 0" class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let patologia of historiaSeleccionada.patologias" class="badge bg-secondary p-2">
                      {{ patologia }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.patologias?.length">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>
                <div class="col-md-4">
                  <strong class="d-block mb-1">Patolog√≠a ocular:</strong>
                  <div *ngIf="historiaSeleccionada.patologiaOcular?.length > 0" class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let pat of historiaSeleccionada.patologiaOcular"
                      class="badge bg-warning text-dark p-2">
                      {{ pat }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.patologiaOcular?.length">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-0">
              <div class="col-md-6">
                <h6 class="text-primary">üìê Lensometr√≠a</h6>
                <table class="table table-sm table-bordered text-center align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Ojo</th>
                      <th>ESF</th>
                      <th>CIL</th>
                      <th>EJE</th>
                      <th>ADD</th>
                      <th colspan="2">AV Lejos</th>
                      <th colspan="2">AV Cerca</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>OD</td>
                      <td>{{ historiaSeleccionada.len_esf_od }}</td>
                      <td>{{ historiaSeleccionada.len_cil_od }}</td>
                      <td>{{ historiaSeleccionada.len_eje_od }}</td>
                      <td>{{ historiaSeleccionada.len_add_od }}</td>
                      <td>{{ historiaSeleccionada.len_av_lejos_od || '10 OD'}}</td>
                      <td rowspan="2" class="align-middle">{{ historiaSeleccionada.len_av_lejos_bi || '20 BI'}}</td>
                      <td>{{ historiaSeleccionada.len_av_cerca_od || '10 OD'}}</td>
                      <td rowspan="2" class="align-middle">{{ historiaSeleccionada.len_av_cerca_bi || '20 BI' }}</td>
                    </tr>
                    <tr>
                      <td>OI</td>
                      <td>{{ historiaSeleccionada.len_esf_oi }}</td>
                      <td>{{ historiaSeleccionada.len_cil_oi }}</td>
                      <td>{{ historiaSeleccionada.len_eje_oi }}</td>
                      <td>{{ historiaSeleccionada.len_add_oi }}</td>
                      <td>{{ historiaSeleccionada.len_av_lejos_oi || '30 OI'}}</td>
                      <td>{{ historiaSeleccionada.len_av_cerca_oi || '30 OI'}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <!-- AVSC: ocupa 8 columnas -->
              <div class="col-md-6">
                <h6 class="text-primary">üìê AVSC - AVAE - OTROS</h6>
                <table class="table table-sm table-bordered mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="text-align: center;">Ojo</th>
                      <th style="text-align: center;" colspan="2">AVSC</th>
                      <th style="text-align: center;">AVAE</th>
                      <th style="text-align: center;" colspan="2">OTROS:</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="text-align: center;">OD</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_od || '20 BI' }}</td>
                      <td rowspan="2" class="align-middle" style="text-align: center;">{{ historiaSeleccionada.avsc_bi
                        || '20 BI'}}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avae_od || '20 BI' }}</td>
                      <td style="text-align: center;" colspan="2">{{ historiaSeleccionada.otros_od || '20 BI' }}</td>
                    </tr>
                    <tr>
                      <td style="text-align: center;">OI</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_oi || '20 BI'}}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avae_oi || '20 BI'}}</td>
                      <td style="text-align: center;" colspan="2">{{ historiaSeleccionada.otros_oi || '20 BI'}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="row align-items-start">
              <!-- Hora: ocupa 4 columnas -->
              <div class="col-md-4 mb-4">
                <div class="d-flex align-items-center">
                  <h6 class="text-primary mb-0 me-2">üïí Hora de evaluaci√≥n:</h6>
                  <span class="fw-semibold">{{ historiaSeleccionada.horaEvaluacion || 'No registrada' }}</span>
                </div>
              </div><br>
            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <!-- Refracci√≥n  -->
                <div class="mb-4">
                  <h6 class="text-primary">üìê Refracci√≥n</h6>
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th style="text-align: center;" colspan="2">AVCCL</th>
                        <th style="text-align: center;" colspan="2">AVCCC</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="text-align: center;">OD</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_add_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avccl_od || '20 BI' }}</td>
                        <td rowspan="2" class="align-middle">{{ historiaSeleccionada.ref_avccl_bi || '20 BI'}}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avccc_od || '20 BI' }}</td>
                        <td rowspan="2" class="align-middle">{{ historiaSeleccionada.ref_avccc_bi || '20 BI'}}</td>
                      </tr>
                      <tr>
                        <td style="text-align: center;">OI</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_add_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avccl_oi || '20 BI' }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avccc_oi || '20 BI' }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <!-- Refracci√≥n Final -->
                <div class="mb-4">
                  <h6 class="text-primary">üìê Refracci√≥n Final segun tipo de Lente</h6>
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th style="text-align: center;">ALT</th>
                        <th style="text-align: center;">DP</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="text-align: center;">OD</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_esf_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_cil_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_eje_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_add_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_alt_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_dp_od }}</td>
                      </tr>
                      <tr>
                        <td style="text-align: center;">OI</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_esf_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_cil_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_eje_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_add_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_alt_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_dp_oi }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Diagn√≥stico y tratamiento -->
            <div class="row mb-1">
              <div class="col-md-6 mb-1">
                <h6 class="text-primary">üìù Diagn√≥stico</h6>
                <p class="bg-light rounded p-2">{{ historiaSeleccionada.diagnostico }}</p>
              </div>
              <div class="col-md-6 mb-1">
                <h6 class="text-primary">üíä Tratamiento</h6>
                <p class="bg-light rounded p-2">{{ historiaSeleccionada.tratamiento }}</p>
              </div>
            </div>

            <!-- Asesor√≠a -->
            <div class="mb-2">
              <h6 class="text-primary">üßë‚Äçüíº Recomendaciones</h6>
              <div class="row">
                <div class="col-md-3 mb-0">
                  <strong>Tipo de cristal:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.cristal }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Material:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.material }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Montura sugerida:</strong><br>
                  <p class="ms-0 bg-light rounded p-2"> {{ historiaSeleccionada.montura }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Cristal sugerido:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.cristalSugerido }} </p>
                </div>
                <div class="col-md-12 mb-0">
                  <strong>Observaciones:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.observaciones }}</p>
                </div>
              </div>
            </div>

            <!-- Nota de conformidad -->
            <div class="mt-4 pt-0">
              <div class="alert alert-warning" style="background: var(--degradado-pastel) !important; border: none;">
                <h6 class="fw-bold">‚úçÔ∏è DECLARACI√ìN DE CONFORMIDAD</h6>
                <p class="mb-0">{{ notaConformidad }}</p>
              </div>
            </div>

            <!-- Firmas -->
            <div class="mt-4 pt-3 border-top mb-4">
              <div class="row justify-content-between text-center">
                <!-- Firma del paciente -->
                <div class="col-md-5">
                  <p class="mb-1"><strong>Firma del Paciente</strong></p>
                  <div class="border rounded p-3 bg-light" style="height: 100px;">
                    <!-- espacio para firma manuscrita -->
                  </div>
                  <p class="mt-2 mb-0 text-muted">Nombre: {{ pacienteSeleccionado?.nombreCompleto }}</p>
                  <p class="mb-0 text-muted">C.I: {{ pacienteSeleccionado?.cedula }}</p>
                </div>
                <!-- Firma del m√©dico -->
                <div class="col-md-5">
                  <p class="mb-1"><strong>Firma del M√©dico Tratante</strong></p>
                  <div class="border rounded p-3 bg-light" style="height: 100px;">
                    <!-- espacio para firma manuscrita -->
                  </div>
                  <p class="mt-2 mb-0 text-muted">Nombre: {{ historiaSeleccionada.medico }}</p>
                  <p class="mb-0 text-muted">C.I: {{ pacienteSeleccionado?.cedula || 'No disponible' }}</p>
                </div>
              </div>
            </div>
            <div class="col-md-12 pt-4" style="text-align: center;">
              <p class="mb-1"><strong>Asesor Responsable</strong></p>
              
              <p class="mt-2 mb-0 text-muted">Nombre: {{ historiaSeleccionada.asesor || 'Nombre del asesor' }}</p>
              <p class="mb-0 text-muted">C√©dula: {{ historiaSeleccionada.cedula || 'Cedula' }}</p>
            </div>
        

        </div>

        <div class="card-footer text-end">
          <button class="btn btn-outline-secondary me-2">
            <i class="bi bi-printer"></i> Imprimir
          </button>
          <button class="btn btn-primary">
            <i class="bi bi-pencil-square"></i> Editar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
</div>


<<!-- Modal para agregar/editar historia -->
<div class="modal fade" id="historiaModal" tabindex="-1" aria-labelledby="historiaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      
      <!-- Card Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="historiaModalLabel">
          {{ modoEdicion ? '‚úèÔ∏è Editar Historia M√©dica' : 'üë®‚Äç‚öïÔ∏è Nueva Historia M√©dica' }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      
      <!-- Card Body -->
      <div class="modal-body">
        <form [formGroup]="historiaForm" (ngSubmit)="guardarHistoria()">
          
          <!-- Secci√≥n Paciente -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">üë§ Datos del Paciente</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Paciente</label>
                  <ng-select [items]="pacientesFiltrados" 
                            bindLabel="nombreCompleto"
                            formControlName="pacienteId"
                            [searchable]="true"
                            placeholder="Buscar paciente...">
                  </ng-select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">M√©dico Tratante</label>
                  <input type="text" class="form-control" formControlName="medico">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Motivo de Consulta</label>
                  <input type="text" class="form-control" formControlName="motivo">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Fecha</label>
                  <input type="date" class="form-control" formControlName="fecha">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Hora</label>
                  <input type="time" class="form-control" formControlName="horaEvaluacion">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n Antecedentes -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">üìã Antecedentes</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-check-label">Usuario de lentes</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="usuarioLentes">
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Tipo de cristal actual</label>
                  <input type="text" class="form-control" formControlName="tipoCristalActual">
                </div>
                <div class="col-md-3">
                  <label class="form-label">√öltima graduaci√≥n</label>
                  <input type="text" class="form-control" formControlName="ultimaGraduacion">
                </div>
                <div class="col-md-3">
                  <label class="form-check-label">Fotofobia</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" formControlName="fotofobia">
                  </div>
                </div>
                
                <!-- M√°s campos de antecedentes -->
                <div class="col-md-6">
                  <label class="form-label">Antecedentes personales</label>
                  <ng-select [items]="opcionesAntecedentes"
                            formControlName="antecedentesPersonales"
                            [multiple]="true"
                            placeholder="Seleccione...">
                  </ng-select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Antecedentes familiares</label>
                  <ng-select [items]="opcionesAntecedentes"
                            formControlName="antecedentesFamiliares"
                            [multiple]="true"
                            placeholder="Seleccione...">
                  </ng-select>
                </div>
                
                <!-- Campos adicionales -->
                <div class="col-md-4">
                  <label class="form-label">Al√©rgico a</label>
                  <input type="text" class="form-control" formControlName="alergicoA">
                </div>
                <div class="col-md-4">
                  <label class="form-label">Cirug√≠a ocular previa</label>
                  <select class="form-select" formControlName="cirugiaOcular">
                    <option value="">Seleccione</option>
                    <option value="true">S√≠</option>
                    <option value="false">No</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Tipo de cirug√≠a</label>
                  <input type="text" class="form-control" formControlName="cirugiaOcularDescripcion">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n Examen Ocular -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">üëÅÔ∏è Examen Ocular</h6>
            </div>
            <div class="card-body">
              
              <!-- Lensometr√≠a -->
              <h6 class="text-primary mb-3">üìê Lensometr√≠a</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Ojo</th>
                      <th>ESF</th>
                      <th>CIL</th>
                      <th>EJE</th>
                      <th>ADD</th>
                      <th>AV Lejos</th>
                      <th>AV Cerca</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>OD</td>
                      <td><input type="text" class="form-control" formControlName="len_esf_od"></td>
                      <td><input type="text" class="form-control" formControlName="len_cil_od"></td>
                      <td><input type="text" class="form-control" formControlName="len_eje_od"></td>
                      <td><input type="text" class="form-control" formControlName="len_add_od"></td>
                      <td><input type="text" class="form-control" formControlName="len_av_lejos_od"></td>
                      <td><input type="text" class="form-control" formControlName="len_av_cerca_od"></td>
                    </tr>
                    <tr>
                      <td>OI</td>
                      <td><input type="text" class="form-control" formControlName="len_esf_oi"></td>
                      <td><input type="text" class="form-control" formControlName="len_cil_oi"></td>
                      <td><input type="text" class="form-control" formControlName="len_eje_oi"></td>
                      <td><input type="text" class="form-control" formControlName="len_add_oi"></td>
                      <td><input type="text" class="form-control" formControlName="len_av_lejos_oi"></td>
                      <td><input type="text" class="form-control" formControlName="len_av_cerca_oi"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Refracci√≥n -->
              <h6 class="text-primary mb-3 mt-4">üîç Refracci√≥n</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Ojo</th>
                      <th>ESF</th>
                      <th>CIL</th>
                      <th>EJE</th>
                      <th>ADD</th>
                      <th>AVCCL</th>
                      <th>AVCCC</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>OD</td>
                      <td><input type="text" class="form-control" formControlName="ref_esf_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_cil_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_eje_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_add_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_avccl_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_avccc_od"></td>
                    </tr>
                    <tr>
                      <td>OI</td>
                      <td><input type="text" class="form-control" formControlName="ref_esf_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_cil_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_eje_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_add_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_avccl_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_avccc_oi"></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Refracci√≥n Final -->
              <h6 class="text-primary mb-3 mt-4">üéØ Refracci√≥n Final</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Ojo</th>
                      <th>ESF</th>
                      <th>CIL</th>
                      <th>EJE</th>
                      <th>ADD</th>
                      <th>ALT</th>
                      <th>DP</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>OD</td>
                      <td><input type="text" class="form-control" formControlName="ref_final_esf_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_cil_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_eje_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_add_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_alt_od"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_dp_od"></td>
                    </tr>
                    <tr>
                      <td>OI</td>
                      <td><input type="text" class="form-control" formControlName="ref_final_esf_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_cil_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_eje_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_add_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_alt_oi"></td>
                      <td><input type="text" class="form-control" formControlName="ref_final_dp_oi"></td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- AVSC - AVAE - OTROS -->
              <h6 class="text-primary mb-3 mt-4">üëÄ AVSC - AVAE - OTROS</h6>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Ojo</th>
                      <th>AVSC</th>
                      <th>AVAE</th>
                      <th>OTROS</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>OD</td>
                      <td><input type="text" class="form-control" formControlName="avsc_od"></td>
                      <td><input type="text" class="form-control" formControlName="avae_od"></td>
                      <td><input type="text" class="form-control" formControlName="otros_od"></td>
                    </tr>
                    <tr>
                      <td>OI</td>
                      <td><input type="text" class="form-control" formControlName="avsc_oi"></td>
                      <td><input type="text" class="form-control" formControlName="avae_oi"></td>
                      <td><input type="text" class="form-control" formControlName="otros_oi"></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n Diagn√≥stico y Tratamiento -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">üíä Diagn√≥stico y Tratamiento</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Diagn√≥stico</label>
                  <textarea class="form-control" rows="3" formControlName="diagnostico"></textarea>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tratamiento</label>
                  <textarea class="form-control" rows="3" formControlName="tratamiento"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n Recomendaciones -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">üßë‚Äçüíº Recomendaciones</h6>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Tipo de cristal</label>
                  <select class="form-select" formControlName="cristal">
                    <option value="">Seleccionar</option>
                    <option value="Monofocal">Monofocal</option>
                    <option value="Bifocal">Bifocal</option>
                    <option value="Progresivo">Progresivo</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Material</label>
                  <select class="form-select" formControlName="material">
                    <option value="">Seleccionar</option>
                    <option value="CR-39">CR-39</option>
                    <option value="Policarbonato">Policarbonato</option>
                    <option value="Trivex">Trivex</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Montura sugerida</label>
                  <input type="text" class="form-control" formControlName="montura">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Cristal sugerido</label>
                  <input type="text" class="form-control" formControlName="cristalSugerido">
                </div>
                <div class="col-md-6">
                  <label class="form-label">N¬∞ de historia</label>
                  <input type="text" class="form-control" formControlName="n_historia">
                </div>
                <div class="col-md-12">
                  <label class="form-label">Observaciones</label>
                  <textarea class="form-control" rows="2" formControlName="observaciones"></textarea>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Secci√≥n Nota de Conformidad -->
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-light">
              <h6 class="mb-0">‚úçÔ∏è Nota de Conformidad</h6>
            </div>
            <div class="card-body">
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="conformeCheck" formControlName="conforme">
                <label class="form-check-label" for="conformeCheck">
                  {{ notaConformidad }}
                </label>
              </div>
              <div class="mb-3">
                <label class="form-label">Asesor responsable</label>
                <input type="text" class="form-control" formControlName="asesor">
              </div>
            </div>
          </div>
          
          <!-- Card Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="historiaForm.invalid">
              <i class="bi bi-save"></i> {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>