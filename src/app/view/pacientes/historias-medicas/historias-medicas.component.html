<div class="container-fluid py-4">
  <!-- Encabezado -->
  <div class="card shadow-lg containerPrincipal">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
      <h4 class="mb-0">üë®‚Äç‚öïÔ∏è Historias m√©dicas</h4>
      <div class="ms-auto">
        <button class="btn btn-light btn-sm" (click)="nuevaHistoria()">
          ‚ûï Agregar Historia Nueva
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Selector de paciente -->
      <div class="w-100 mb-3">
        <label for="selectorPaciente" class="form-label">üë§ Buscar y seleccionar paciente</label>
        <ng-select [items]="pacientesFiltrados" bindLabel="nombreCompleto" bindValue="id"
          [(ngModel)]="pacienteIdSeleccionado" (change)="seleccionarPacientePorId(pacienteIdSeleccionado)"
          [searchable]="true" [clearable]="true" placeholder="Buscar por nombre o c√©dula..."
          [searchFn]="filtrarPaciente">
          <ng-template ng-option-tmp let-item="item">
            {{ item.nombreCompleto }} ‚Äî {{ item.cedula }}
          </ng-template>
        </ng-select>
      </div>

      <!-- Mensaje si el paciente no tiene historial -->
      <div *ngIf="mostrarSinHistorial" class="alert alert-info">
        Este paciente no posee historial m√©dico registrado.
      </div>

      <!-- Panel principal -->
      <div class="row g-2 mt-0" *ngIf="mostrarElementos">
        <!-- Listado de historias -->
        <div class="col-md-3">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
              style="padding: 10px 20px;">
              <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Historiales</h5>
            </div>

            <!-- Scroll SOLO si hay suficiente contenido -->
            <div class="card-body px-0" style="max-height: 460px; overflow-y: auto;">
              <div class="list-group list-group-flush">
                <button *ngFor="let historia of historial"
                  class="list-group-item list-group-item-action position-relative"
                  [class.active]="historiaSeleccionada?.id === historia.id" (click)="verDetalle(historia)">

                  <!-- üß† Encabezado superior: motivo + fecha -->
                  <div class="d-flex justify-content-between mb-1">
                    <strong>{{ historia.motivo }}</strong>
                    <span class="">{{ historia.fecha }}</span>
                  </div>

                  <!-- üë• Pie inferior: m√©dico + n¬∞ historia -->
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">üë®‚Äç‚öïÔ∏è {{ historia.medico }}</small>
                    <span class="badge bg-info">#{{ historia.n_historia || '00012345' }}</span>
                  </div>

                </button>
              </div>
            </div>


          </div>
        </div>




        <!-- Detalle de historia cl√≠nica -->
        <div class="col-md-9 details">
          <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
            style="padding: 10px 20px;">

            <!-- T√≠tulo a la izquierda -->
            <h5 class="mb-0">
              <i class="bi bi-eye-fill me-2"></i> Detalle del Examen
            </h5>

            <!-- Fecha y M√©dico en bloque alineado al margen derecho -->
            <div class="ms-auto">
              <div class="text-start">
                <strong style="color: var(--details-color); font-size: 15px;">N¬∞ de historia:</strong>
                <span class="fw-semibold" style="color: white; font-size: 15px;">
                  {{ historiaSeleccionada.n_historia || '00012345' }}
                </span>
              </div>
              <div class="mb-0 text-start">
                <strong style="color: var(--details-color); font-size: 15px;">Fecha:</strong>
                <span class="fw-semibold" style="color: white; font-size: 15px;">
                  {{ historiaSeleccionada.fecha }}
                </span>
              </div>
            </div>
          </div>

          <div class="card-body" style=" " style="height: 500px; overflow-y: auto;  background-color: white;">
            <div class="row mb-4">
              <!-- Datos del paciente -->
              <div class="col-md-8">
                <h6 class="text-primary">üìå Datos del Paciente</h6>
                <div class="row">
                  <div class="col-md-4 mb-0">
                    <strong>Nombre:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.nombreCompleto }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>C√©dula:</strong><br>
                    <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.cedula }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Tel√©fono:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.telefono }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Edad:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ calcularEdad(pacienteSeleccionado?.fechaNacimiento) }} a√±os
                    </p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Ocupaci√≥n:</strong><br>
                    <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.ocupacion }}</p>
                  </div>
                  <div class="col-md-4 mb-0">
                    <strong>Motivo:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ historiaSeleccionada.motivo }}</p>
                  </div>
                  <div class="col-md-6 mb-0">
                    <strong>Direcci√≥n:</strong><br>
                    <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.direccion }}</p>
                  </div>
                </div>
              </div>

              <!-- M√©dico tratante -->
              <div class="col-md-4 d-flex align-items-start ">
                <div>
                  <h6 class="text-primary">üë®‚Äç‚öïÔ∏è M√©dico tratante</h6>
                  <strong style="font-size: 15px;">Nombre:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ historiaSeleccionada.medico }}</p>
                </div>
              </div>
            </div>

            <!-- Historia Cl√≠nica del paciente -->
            <div class="mb-4">
              <h6 class="text-primary">üß¨ Historia Cl√≠nica</h6>

              <!-- Condiciones cl√≠nicas booleanas -->
              <div class="row gy-0">
                <div class="col-md-4 mb-0">
                  <strong>Usuario de lentes:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.usuarioLentes ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>Cristal actual:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.tipoCristalActual || 'No especificado' }}
                  </p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>√öltima graduaci√≥n:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.ultimaGraduacion || 'No disponible' }}
                  </p>
                </div>
              </div>
              <div class="mb-0 row  gy-1">
                <div class="col-md-4">
                  <strong>Fotofobia:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.fotofobia ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-4">
                  <strong>Alergias:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.alergico ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-4">
                  <strong>Traumatismo ocular:</strong>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.traumatismoOcular ? 'S√≠' : 'No' }}</p>
                </div>

              </div>
              <!-- Dispositivos electr√≥nicos -->
              <div class="mb-0 row gy-2">
                <div class="col-md-4">
                  <strong>Cirug√≠a ocular:</strong>
                  <p class="ms-0">{{ historiaSeleccionada.cirugiaOcular ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-4">
                  <strong>Dispositivos electr√≥nicos:</strong>
                  <p class="ms-1 bg-light rounded p-2">
                    {{ historiaSeleccionada.usaDispositivosElectronicos ? 'S√≠' : 'No' }}
                    <span *ngIf="historiaSeleccionada.tiempoUsoEstimado"> ‚Äî {{ historiaSeleccionada.tiempoUsoEstimado
                      }}</span>
                  </p>
                </div>
              </div>

              <div class="row">
                <!-- Patolog√≠as generales -->
                <div class="mb-2 col-md-4">
                  <strong class="d-block mb-1">Patolog√≠as detectadas:</strong>
                  <div *ngIf="historiaSeleccionada.patologias?.length > 0" class="d-flex flex-wrap gap-2">
                    <span *ngFor="let patologia of historiaSeleccionada.patologias" class="badge bg-secondary p-2">
                      {{ patologia }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.patologias?.length">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>

                <!-- Antecedentes familiares -->
                <div class="mb-2 col-md-4">
                  <strong class="d-block mb-1">Antecedentes familiares:</strong>
                  <div *ngIf="historiaSeleccionada.antecedentesFamiliares?.length > 0" class="d-flex flex-wrap gap-2">
                    <span *ngFor="let antecedente of historiaSeleccionada.antecedentesFamiliares"
                      class="badge bg-info text-dark p-2">
                      {{ antecedente }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.antecedentesFamiliares?.length">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>
                <!-- Patolog√≠as oculares -->
                <div class="mb-2 col-md-4">
                  <strong class="d-block mb-1">Patolog√≠a ocular:</strong>
                  <div *ngIf="historiaSeleccionada.patologiaOcular?.length > 0" class="d-flex flex-wrap gap-2">
                    <span *ngFor="let pat of historiaSeleccionada.patologiaOcular"
                      class="badge bg-warning text-dark p-2">
                      {{ pat }}
                    </span>
                  </div>
                  <div *ngIf="!historiaSeleccionada.patologiaOcular?.length">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>
              </div>

            </div>

            <!-- Lensonmetria -->
            <div class="row mb-0">
              <div class="col-md-6">
                <h6 class="text-primary">üìê Lensometria</h6>
                <table class="table table-sm table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th style="text-align: center;">Ojo</th>
                      <th style="text-align: center;">ESF</th>
                      <th style="text-align: center;">CIL</th>
                      <th style="text-align: center;">EJE</th>
                      <th style="text-align: center;">ADD</th>
                      <th style="text-align: center;">AV</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="text-align: center;">OD</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_add_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.len_av_od }}</td>

                    </tr>
                    <tr>
                      <td style="text-align: center;">OI</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.ref_add_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.len_av__oi }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- AVSC: ocupa 8 columnas -->
              <div class="col-md-6">
                <h6 class="text-primary">üìê AVSC</h6>
                <table class="table table-sm table-bordered mb-0">
                  <thead class="table-light">
                    <tr>
                      <th style="text-align: center;">Ojo</th>
                      <th style="text-align: center;">OD</th>
                      <th style="text-align: center;">OI</th>
                      <th style="text-align: center;">CERCA</th>
                      <th style="text-align: center;">AVAE</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="text-align: center;">OD</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_od_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_oi_od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_cerca__od }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_avcc_od }}</td>
                    </tr>
                    <tr>
                      <td style="text-align: center;">OI</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_od_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_oi_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_cerca_oi }}</td>
                      <td style="text-align: center;">{{ historiaSeleccionada.avsc_avcc_oi }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="row align-items-start">
              <!-- Hora: ocupa 4 columnas -->
              <div class="col-md-4 mb-4">
                <div class="d-flex align-items-center">
                  <h6 class="text-primary mb-0 me-2">üïí Hora de evaluaci√≥n:</h6>
                  <span class="fw-semibold">{{ historiaSeleccionada.horaEvaluacion || 'No registrada' }}</span>
                </div>
              </div><br>

            </div>

            <div class="row mb-2">
              <div class="col-md-6">
                <!-- Refracci√≥n  -->
                <div class="mb-4">
                  <h6 class="text-primary">üìê Refracci√≥n</h6>
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th style="text-align: center;">AVCC</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="text-align: center;">OD</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_add_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avcc_od }}</td>
                      </tr>
                      <tr>
                        <td style="text-align: center;">OI</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_esf_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_cil_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_eje_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_add_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_avcc_oi }}</td>

                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <!-- Refracci√≥n Final -->
                <div class="mb-4">
                  <h6 class="text-primary">üìê Refracci√≥n Final segun tipo de Lente</h6>
                  <table class="table table-sm table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th style="text-align: center;">ALT</th>
                        <th style="text-align: center;">DP</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="text-align: center;">OD</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_esf_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_cil_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_eje_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_add_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_alt_od }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_dp_od }}</td>
                      </tr>
                      <tr>
                        <td style="text-align: center;">OI</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_esf_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_cil_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_eje_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_add_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_alt_oi }}</td>
                        <td style="text-align: center;">{{ historiaSeleccionada.ref_final_dp_oi }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

              </div>
            </div>

            <!-- Diagn√≥stico y tratamiento -->
            <div class="row mb-1">
              <div class="col-md-6 mb-1">
                <h6 class="text-primary">üìù Diagn√≥stico</h6>
                <p class="bg-light rounded p-2">{{ historiaSeleccionada.diagnostico }}</p>
              </div>
              <div class="col-md-6 mb-1">
                <h6 class="text-primary">üíä Tratamiento</h6>
                <p class="bg-light rounded p-2">{{ historiaSeleccionada.tratamiento }}</p>
              </div>
            </div>

            <!-- Asesor√≠a -->
            <div class="mb-3">
              <h6 class="text-primary">üßë‚Äçüíº Recomendaciones</h6>
              <div class="row">
                <div class="col-md-4 mb-0">
                  <strong>Tipo de cristal:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.cristal }}</p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>Material:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.material }}</p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>Montura sugerida:</strong><br>
                  <p class="ms-0 bg-light rounded p-2"> {{ historiaSeleccionada.montura }}</p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>Cristal sugerido:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.cristalSugerido }} </p>
                </div>
                <div class="col-md-4 mb-0">
                  <strong>Observaciones:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">{{ historiaSeleccionada.observaciones }}</p>
                </div>
              </div>
            </div>
          </div>

          <div class="card-footer text-end">
            <button class="btn btn-outline-secondary me-2">
              <i class="bi bi-printer"></i> Imprimir
            </button>
            <button class="btn btn-primary">
              <i class="bi bi-pencil-square"></i> Editar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>