<div class="container-fluid py-4">
  <!-- Encabezado -->
  <div class="card shadow-lg containerPrincipal">
    <div class="card-header bg-primary text-white d-flex align-items-center justify-content-between">
      <h4 class="mb-0">üë®‚Äç‚öïÔ∏è Historias m√©dicas</h4>
      <div class="ms-auto">
        <button class="btn btn-light btn-sm" (click)="iniciarFlujoHistoria()">
          ‚ûï Agregar Historia Nueva
        </button>
      </div>
    </div>
    <div class="card-body">
      <!-- Selector de paciente -->
      <div class="row mb-3">
        <div class="col-md-4">
          <label for="filtroSede" class="form-label">üìç Filtrar por sede</label>
          <select id="filtroSede" class="form-select" [(ngModel)]="sedeFiltro">
            <option [value]="sedeActiva">Solo {{ sedeActiva | titlecase }}</option>
            <option value="otra">Otra sede</option>
            <option value="todas">Todas las sedes</option>
          </select>
        </div>
        <div class="col-md-8">
          <label for="selectorPaciente" class="form-label">üë§ Buscar y seleccionar paciente</label>
          <ng-select [items]="pacientesFiltrados" bindLabel="nombreCompleto" bindValue="id"
            [(ngModel)]="pacienteIdSeleccionado" (ngModelChange)="seleccionarPacientePorId($event)" [searchable]="true"
            [clearable]="true" placeholder="Buscar por nombre o c√©dula..." [searchFn]="filtrarPaciente">
            <ng-template ng-option-tmp let-item="item">
              {{ item.nombreCompleto }} ‚Äî {{ item.cedula }}
            </ng-template>
          </ng-select>

        </div>
      </div>
    </div>

    <!-- Mensaje si el paciente no tiene historial -->
    <div *ngIf="mostrarSinHistorial" class="alert alert-info">
      Este paciente no posee historial m√©dico registrado.
    </div>

    <!-- Panel principal -->
    <div class="row g-2 mt-0" *ngIf="mostrarElementos">
      <!-- Listado de historias -->
      <div class="col-md-3">
        <div class="card shadow-sm h-100">
          <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
            style="padding: 10px 20px;">
            <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Historiales</h5>
          </div>

          <!-- Scroll SOLO si hay suficiente contenido -->
          <div class="card-body px-0" style="max-height: 460px; overflow-y: auto;">
            <div class="list-group list-group-flush">
              <button *ngFor="let historia of historial"
                class="list-group-item list-group-item-action position-relative"
                [class.active]="historiaSeleccionada?.id === historia.id" (click)="verDetalle(historia)">

                <!-- üß† Encabezado superior: motivo + fecha -->
                <div class="d-flex justify-content-between mb-1">
                  <strong>{{ historia.datosConsulta.motivo }}</strong>
                  <span class="">{{ historia.fecha }}</span>
                </div>

                <!-- üë• Pie inferior: m√©dico + n¬∞ historia -->
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <small class="text-muted">üë®‚Äç‚öïÔ∏è {{ historia.datosConsulta.medico }}</small>
                  <span class="badge bg-info">#{{ historia.nHistoria || '00012345' }}</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalle de historia cl√≠nica -->
      <div class="col-md-9 details">
        <div class="card-header bg-white border-bottom d-flex justify-content-between align-items-center"
          style="padding: 10px 20px;">
          <!-- T√≠tulo a la izquierda -->
          <h5 class="mb-0">
            <i class="bi bi-eye-fill me-2"></i> Detalle del Examen
          </h5>

          <!-- Fecha y M√©dico en bloque alineado al margen derecho -->
          <div class="ms-auto">
            <div class="text-start">
              <strong style="color: var(--details-color); font-size: 15px;">N¬∞ de historia:</strong>
              <span class="fw-semibold" style="color: white; font-size: 15px;">
                {{ historiaSeleccionada?.nHistoria || '00012345' }}
              </span>
            </div>
            <div class="mb-0 text-start">
              <strong style="color: var(--details-color); font-size: 15px;">Fecha:</strong>
              <span class="fw-semibold" style="color: white; font-size: 15px;">
                {{ historiaSeleccionada?.fecha }}
              </span>
            </div>
          </div>
        </div>

        <div class="card-body" id="detalleExamen" style="height: 500px; overflow-y: auto;  background-color: white;">
          <div class="row mb-4">
            <!-- Datos del paciente -->
            <div class="col-md-12">
              <h6 class="text-primary">üìå Datos del Paciente</h6>
              <div class="row">
                <div class="col-md-3 mb-0">
                  <strong>Nombre:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.informacionPersonal?.nombreCompleto }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>C√©dula:</strong><br>
                  <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.informacionPersonal?.cedula }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Tel√©fono:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.informacionPersonal?.telefono }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Edad:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ calcularEdad(pacienteSeleccionado?.informacionPersonal?.fechaNacimiento) }} a√±os
                  </p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Ocupaci√≥n:</strong><br>
                  <p class="ms-0  bg-light rounded p-2"> {{ pacienteSeleccionado?.informacionPersonal?.ocupacion }}</p>
                </div>
                <div class="col-md-3 mb-0">
                  <strong>Motivo:</strong><br>
                  <p class="ms-0 bg-light rounded p-2">
                    {{ historiaSeleccionada?.datosConsulta?.motivo || 'No especificado' }}
                  </p>
                </div>
                <div class="col-md-6 mb-0">
                  <strong>Direcci√≥n:</strong><br>
                  <p class="ms-0  bg-light rounded p-2">{{ pacienteSeleccionado?.informacionPersonal?.direccion }}</p>
                </div>
              </div>
            </div>

            <!-- Historia Cl√≠nica del paciente -->
            <div class="mb-4">
              <h6 class="text-primary">üß¨ Historia Cl√≠nica</h6>
              <!-- Condiciones cl√≠nicas booleanas -->
              <div class="row gy-2 mb-1">
                <div class="col-md-3">
                  <strong>Usuario de lentes:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.usuarioLentes ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Cristal actual:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.tipoCristalActual || 'No especificado' }}
                  </p>
                </div>
                <div class="col-md-3">
                  <strong>√öltima graduaci√≥n:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.ultimaGraduacion || 'No especificado' }}
                  </p>
                </div>
                <div class="col-md-3">
                  <strong>Fotofobia:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.fotofobia ? 'S√≠' : 'No' }}</p>
                </div>
              </div>

              <!-- Antecedentes personales visualizados como badges -->
              <div class="row gy-2 mb-1">
                <div class="col-md-3">
                  <strong class="d-block mb-1">Alergias a:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.alergicoA || 'No especificado' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Cirug√≠a ocular previa:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.cirugiaOcular ? 'S√≠' : 'No' }}</p>
                </div>
                <div class="col-md-3">
                  <strong class="d-block mb-1">Tipo de cirug√≠a ocular:</strong>
                  <p class="bg-light rounded p-2">
                    {{ pacienteSeleccionado?.historiaClinica?.cirugiaOcularDescripcion || 'No especificada' }}</p>
                </div>
                <div class="col-md-3">
                  <strong>Traumatismo ocular:</strong>
                  <p class="bg-light rounded p-2">{{ pacienteSeleccionado?.historiaClinica?.traumatismoOcular ? 'S√≠' : 'No' }}</p>
                </div>
              </div>

              <!-- Condiciones adicionales -->
              <div class="row gy-2 mb-1">
                <div class="col-md-4">
                  <strong>Uso de dispositivos electr√≥nicos:</strong>
                  <p class="bg-light rounded p-2">
                    {{ pacienteSeleccionado?.historiaClinica?.usaDispositivosElectronicos ? 'S√≠' : 'No' }}
                    <span *ngIf="pacienteSeleccionado?.historiaClinica?.tiempoUsoEstimado"> ‚Äî {{
                      pacienteSeleccionado?.historiaClinica?.tiempoUsoEstimado }}</span>
                  </p>
                </div>
                <div class="col-md-4">
                  <strong class="d-block mb-1">Antecedentes personales:</strong>
                  <div *ngIf="(pacienteSeleccionado?.historiaClinica?.antecedentesPersonales ?? []).length > 0"
                    class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let antecedente of pacienteSeleccionado?.historiaClinica?.antecedentesPersonales ?? []"
                      class="badge bg-success text-white p-2">
                      {{ antecedente }}
                    </span>
                  </div>
                  <div *ngIf="!(pacienteSeleccionado?.historiaClinica?.antecedentesPersonales?.length)">
                    <span class="badge bg-secondary p-2">No reportados</span>
                  </div>
                </div>

                <div class="col-md-4">
                  <strong class="d-block mb-1">Antecedentes familiares:</strong>
                  <div *ngIf="(pacienteSeleccionado?.historiaClinica?.antecedentesFamiliares ?? []).length > 0"
                    class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let antecedente of pacienteSeleccionado?.historiaClinica?.antecedentesFamiliares ?? []"
                      class="badge bg-info text-dark p-2">
                      {{ antecedente }}
                    </span>
                  </div>
                  <div *ngIf="!(pacienteSeleccionado?.historiaClinica?.antecedentesFamiliares?.length)">
                    <span class="badge bg-secondary p-2">No reportados</span>
                  </div>
                </div>
              </div>

              <!-- Listados din√°micos -->
              <div class="row gy-2 mb-2">
                <!-- Patolog√≠as generales -->
                <div class="col-md-4">
                  <strong class="d-block mb-1">Patolog√≠as generales:</strong>
                  <div *ngIf="(pacienteSeleccionado?.historiaClinica?.patologias ?? []).length > 0" class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let patologia of pacienteSeleccionado?.historiaClinica?.patologias ?? []"
                      class="badge bg-secondary p-2">
                      {{ patologia }}
                    </span>
                  </div>
                  <div *ngIf="!(pacienteSeleccionado?.historiaClinica?.patologias?.length)">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>

                <!-- Patolog√≠a ocular -->
                <div class="col-md-5">
                  <strong class="d-block mb-1">Patolog√≠a ocular:</strong>
                  <div *ngIf="(pacienteSeleccionado?.historiaClinica?.patologiaOcular ?? []).length > 0"
                    class="d-flex flex-wrap gap-2 mt-2">
                    <span *ngFor="let pat of pacienteSeleccionado?.historiaClinica?.patologiaOcular ?? []"
                      class="badge bg-warning text-dark p-2">
                      {{ pat }}
                    </span>
                  </div>
                  <div *ngIf="!(pacienteSeleccionado?.historiaClinica?.patologiaOcular?.length)">
                    <span class="badge bg-secondary p-2">No</span>
                  </div>
                </div>
              </div>

              <div class="row mb-0 pt-2 mt-2">
                <div class="col-md-6">
                  <h6 class="text-primary">üìê Lensometr√≠a</h6>
                  <table class="table table-sm table-bordered text-center align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Ojo</th>
                        <th>ESF</th>
                        <th>CIL</th>
                        <th>EJE</th>
                        <th>ADD</th>
                        <th colspan="2">AV Lejos</th>
                        <th colspan="2">AV Cerca</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>OD</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.esf_od }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.cil_od }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.eje_od }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.add_od }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.av_lejos_od || '10 OD'}}</td>
                        <td rowspan="2" class="align-middle">{{
                          historiaSeleccionada?.examenOcular?.lensometria?.av_lejos_bi || '20 BI'}}
                        </td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.av_cerca_od || '10 OD'}}</td>
                        <td rowspan="2" class="align-middle">{{
                          historiaSeleccionada?.examenOcular?.lensometria?.av_cerca_bi || '20 BI' }}
                        </td>
                      </tr>
                      <tr>
                        <td>OI</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.esf_oi }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.cil_oi }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.eje_oi }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.add_oi }}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.av_lejos_oi || '30 OI'}}</td>
                        <td>{{ historiaSeleccionada?.examenOcular?.lensometria?.av_cerca_oi || '30 OI'}}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <!-- AVSC: ocupa 8 columnas -->
                <div class="col-md-6">
                  <h6 class="text-primary">üìê AVSC - AVAE - OTROS</h6>
                  <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;" colspan="2">AVSC</th>
                        <th style="text-align: center;">AVAE</th>
                        <th style="text-align: center;" colspan="2">OTROS:</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td style="text-align: center;">OD</td>
                        <td style="text-align: center;">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.avsc_od || '20 BI' }}</td>
                        <td rowspan="2" class="align-middle" style="text-align: center;">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.avsc_bi
                          || '20 BI'}}</td>
                        <td style="text-align: center;">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.avae_od || '20 BI' }}</td>
                        <td style="text-align: center;" colspan="2">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.otros_od || '20 BI' }}
                        </td>
                      </tr>
                      <tr>
                        <td style="text-align: center;">OI</td>
                        <td style="text-align: center;">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.avsc_oi || '20 BI'}}</td>
                        <td style="text-align: center;">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.avae_oi || '20 BI'}}</td>
                        <td style="text-align: center;" colspan="2">{{
                          historiaSeleccionada?.examenOcular?.avsc_avae_otros?.otros_oi || '20 BI'}}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="row align-items-start">
                <!-- Hora: ocupa 4 columnas -->
                <div class="col-md-4 mb-4">
                  <div class="d-flex align-items-center">
                    <h6 class="text-primary mb-0 me-2">üïí Hora de evaluaci√≥n:</h6>
                    <span class="fw-semibold">{{ historiaSeleccionada?.horaEvaluacion || 'No registrada' }}</span>
                  </div>
                </div><br>
              </div>

              <div class="row mb-2">
                <div class="col-md-6">
                  <!-- Refracci√≥n  -->
                  <div class="mb-4">
                    <h6 class="text-primary">üìê Refracci√≥n</h6>
                    <table class="table table-sm table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th style="text-align: center;">Ojo</th>
                          <th style="text-align: center;">ESF</th>
                          <th style="text-align: center;">CIL</th>
                          <th style="text-align: center;">EJE</th>
                          <th style="text-align: center;">ADD</th>
                          <th style="text-align: center;" colspan="2">AVCCL</th>
                          <th style="text-align: center;" colspan="2">AVCCC</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td style="text-align: center;">OD</td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.esf_od }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.cil_od }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.eje_od }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.add_od }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.avccl_od
                            || '20 BI' }}</td>
                          <td rowspan="2" class="align-middle">{{
                            historiaSeleccionada?.examenOcular?.refraccion?.avccl_bi || '20 BI'}}</td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.avccc_od
                            || '20 BI' }}</td>
                          <td rowspan="2" class="align-middle">{{
                            historiaSeleccionada?.examenOcular?.refraccion?.avccc_bi || '20 BI'}}</td>
                        </tr>
                        <tr>
                          <td style="text-align: center;">OI</td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.esf_oi }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.cil_oi }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.eje_oi }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.add_oi }}
                          </td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.avccl_oi
                            || '20 BI' }}</td>
                          <td style="text-align: center;">{{ historiaSeleccionada?.examenOcular?.refraccion?.avccc_oi
                            || '20 BI' }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
                <div class="col-md-6">
                  <!-- Refracci√≥n Final -->
                  <div class="mb-4">
                    <h6 class="text-primary">üìê Refracci√≥n Final segun tipo de Lente</h6>
                    <table class="table table-sm table-bordered">
                      <thead class="table-light">
                        <tr>
                          <th style="text-align: center;">Ojo</th>
                          <th style="text-align: center;">ESF</th>
                          <th style="text-align: center;">CIL</th>
                          <th style="text-align: center;">EJE</th>
                          <th style="text-align: center;">ADD</th>
                          <th style="text-align: center;">ALT</th>
                          <th style="text-align: center;">DP</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td style="text-align: center;">OD</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.esf_od }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.cil_od }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.eje_od }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.add_od }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.alt_od }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.dp_od }}</td>
                        </tr>
                        <tr>
                          <td style="text-align: center;">OI</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.esf_oi }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.cil_oi }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.eje_oi }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.add_oi }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.alt_oi }}</td>
                          <td style="text-align: center;">{{
                            historiaSeleccionada?.examenOcular?.refraccionFinal?.dp_oi }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Diagn√≥stico y tratamiento -->
              <div class="row mb-1">
                <div class="col-md-6 mb-1">
                  <h6 class="text-primary">üìù Diagn√≥stico</h6>
                  <p class="bg-light rounded p-2">
                    {{ historiaSeleccionada?.diagnosticoTratamiento?.diagnostico || 'No especificado' }}
                  </p>
                </div>
                <div class="col-md-6 mb-1">
                  <h6 class="text-primary">üíä Tratamiento</h6>
                  <p class="bg-light rounded p-2">
                    {{ historiaSeleccionada?.diagnosticoTratamiento?.tratamiento || 'No especificado' }}
                  </p>
                </div>
              </div>

              <!-- Recomendaciones del historial m√©dico -->
              <div *ngIf="historiaSeleccionada?.recomendaciones as recomendaciones; else sinRecomendaciones"
                class="mb-4">
                <h6 class="text-primary">üßë‚Äçüíº Recomendaciones</h6>

                <div *ngFor="let rec of recomendaciones; let i = index" class="border rounded p-3 mb-3">
                  <h6 class="text-secondary mb-3">Lente #{{ i + 1 }}</h6>
                  <div class="row">
                    <div class="col-md-4 mb-0">
                      <strong>Tipo de cristal:</strong><br>
                      <p class="ms-0 bg-light rounded p-2">{{ rec.cristal || 'No especificado' }}</p>
                    </div>
                    <div class="col-md-4 mb-0">
                      <strong>Material:</strong><br>
                      <p class="ms-0 bg-light rounded p-2">
                        {{ getMaterialLabel(rec.material) }}
                      </p>



                    </div>
                    <div class="col-md-4 mb-0">
                      <strong>Montura sugerida:</strong><br>
                      <p class="ms-0 bg-light rounded p-2">{{ rec.montura || 'No especificada' }}</p>
                    </div>
                    <div class="col-md-12 mt-2">
                      <strong>Observaciones:</strong><br>
                      <p class="ms-0 bg-light rounded p-2">{{ rec.observaciones || 'Sin observaciones' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Si no hay recomendaciones registradas -->
              <ng-template #sinRecomendaciones>
                <div class="mb-4">
                  <h6 class="text-primary">üßë‚Äçüíº Recomendaciones</h6>
                  <p class="text-muted">No se registraron recomendaciones de lentes para este historial.</p>
                </div>
              </ng-template>
            </div>
          </div>
        </div>
        <div class="card-footer text-end">
          <button class="btn btn-outline-secondary me-2">
            <i class="bi bi-printer"></i> Imprimir
          </button>
          <button class="btn btn-primary" (click)="iniciarFlujoHistoria()">
            <i class="bi bi-pencil-square"></i> Editar
          </button>
        </div>


      </div>
    </div>

    <!-- Modal para agregar/editar historia -->
    <div class="modal fade" id="historiaModal" tabindex="-1" aria-labelledby="historiaModalLabel"
      data-bs-backdrop="static" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

          <!-- Card Header -->
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="historiaModalLabel">
              {{ modoEdicion ? '‚úèÔ∏è Editar Historia M√©dica' : 'üë®‚Äç‚öïÔ∏è Nueva Historia M√©dica' }}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <!-- Card Body -->
          <div class="modal-body" style="padding: 25px;">
            <form [formGroup]="historiaForm" (ngSubmit)="iniciarFlujoHistoria()">
              <!-- Secci√≥n Paciente -->
              <div class="mb-5">
                <h6 class="text-primary mb-2" style="font-size: 20px; margin-bottom: 0px;">üìå Datos del Paciente</h6>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Paciente</label>
                    <ng-select [items]="pacientesFiltrados" bindLabel="nombreCompleto" formControlName="pacienteId"
                      [searchable]="true" placeholder="Buscar paciente...">
                    </ng-select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Motivo de Consulta</label>
                    <ng-select [items]="motivosConsulta" [multiple]="true" formControlName="motivo"
                      [compareWith]="compareStrings" [appendTo]="'body'" (change)="onMotivoChange($event)"
                      placeholder="Seleccione un motivo..">
                    </ng-select>
                  </div>
                  <!-- Input para "Otro" motivo -->
                  <div *ngIf="mostrarInputOtroMotivo" class="col-md-4">
                    <label class="form-label">Especifique el motivo</label>
                    <input type="text" class="form-control" formControlName="otroMotivo"
                      placeholder="Ingrese el motivo de consulta...">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Tipo de cristal actual</label>
                    <ng-select [items]="tiposCristales" formControlName="tipoCristalActual" [searchable]="true"
                      placeholder="Seleccione un tipo...">
                    </ng-select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Fecha √∫ltima graduaci√≥n</label>
                    <input type="date" class="form-control" formControlName="ultimaGraduacion" [max]="maxDate">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">M√©dico Tratante</label>
                    <ng-select [items]="medicosTratantes" formControlName="medico" [searchable]="true"
                      placeholder="Seleccione un m√©dico..." required>
                    </ng-select>
                    <div *ngIf="historiaForm.get('medico')?.invalid && historiaForm.get('medico')?.touched"
                      class="text-danger small mt-1">
                      <i class="bi bi-exclamation-circle-fill me-1"></i> Seleccione un m√©dico tratante
                    </div>
                  </div>
                </div>
              </div>

              <!-- Secci√≥n Examen Ocular -->
              <div class="mb-5 shadow-sm tablas-optometria-container">
                <h6 class="text-primary mb-3" style="font-size: 20px;">üëÅÔ∏è Examen Ocular</h6>

                <!-- Lensometr√≠a -->
                <h6 class="mb-3 ms-3">üìê <strong>Lensometr√≠a</strong></h6>
                <div class="table-responsive-custom " style="overflow-x: auto;">
                  <table class="table table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th colspan="2" style="text-align: center;">AV Lejos</th>
                        <th colspan="2" style="text-align: center;">AV Cerca</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center align-middle">OD</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="len_esf_od" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="len_cil_od" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="len_eje_od" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="len_add_od" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avLejos']" bindLabel="label" bindValue="value"
                            formControlName="len_av_lejos_od" placeholder="AV Lejos" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                        <td rowspan="2" class="align-middle">
                          <ng-select [items]="opcionesRef['avBinocular']" bindLabel="label" bindValue="value"
                            formControlName="len_av_lejos_bi" placeholder="AV BI" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avCerca']" bindLabel="label" bindValue="value"
                            formControlName="len_av_cerca_od" placeholder="AV Cerca" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                        <td rowspan="2" class="align-middle">
                          <ng-select [items]="opcionesRef['avBinocular']" bindLabel="label" bindValue="value"
                            formControlName="len_av_bi" placeholder="AV BI" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center align-middle">OI</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="len_esf_oi" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="len_cil_oi" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="len_eje_oi" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="len_add_oi" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avLejos']" bindLabel="label" bindValue="value"
                            formControlName="len_av_lejos_oi" placeholder="AV Lejos" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avCerca']" bindLabel="label" bindValue="value"
                            formControlName="len_av_cerca_oi" placeholder="AV Cerca" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Refracci√≥n -->
                <h6 class="mb-3 ms-3">üìê <strong>Refracci√≥n</strong></h6>
                <div class="table-responsive-custom">
                  <table class="table table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th colspan="2" style="text-align: center;">AVCCL</th>
                        <th colspan="2" style="text-align: center;">AVCCC</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center align-middle">OD</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="ref_esf_od" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="ref_cil_od" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="ref_eje_od" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="ref_add_od" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avLejos']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccl_od" placeholder="AV CCL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td rowspan="2" class="align-middle">
                          <ng-select [items]="opcionesRef['avBinocular']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccl_bi" placeholder="AVCCL BI" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avCerca']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccc_od" placeholder="AV CCC" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td rowspan="2" class="align-middle">
                          <ng-select [items]="opcionesRef['avBinocular']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccc_bi" placeholder="AVCCC BI" [searchable]="true"
                            [appendTo]="'body'" class="select-optometria">
                          </ng-select>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center align-middle">OI</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="ref_esf_oi" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="ref_cil_oi" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="ref_eje_oi" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="ref_add_oi" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avLejos']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccl_oi" placeholder="AV CCL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avCerca']" bindLabel="label" bindValue="value"
                            formControlName="ref_avccc_oi" placeholder="AV CCC" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Refracci√≥n Final -->
                <h6 class="mb-3 ms-3">üìê <strong>Refracci√≥n Final</strong></h6>
                <div class="table-responsive-custom">
                  <table class="table table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">ESF</th>
                        <th style="text-align: center;">CIL</th>
                        <th style="text-align: center;">EJE</th>
                        <th style="text-align: center;">ADD</th>
                        <th style="text-align: center;">ALT</th>
                        <th style="text-align: center;">DP</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center align-middle">OD</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_esf_od" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_cil_od" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_eje_od" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_add_od" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="ref_final_alt_od" placeholder="ALT">
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="ref_final_dp_od" placeholder="DP">
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center align-middle">OI</td>
                        <td>
                          <ng-select [items]="opcionesRef['esf']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_esf_oi" placeholder="ESF" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['cil']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_cil_oi" placeholder="CIL" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['eje']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_eje_oi" placeholder="EJE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['add']" bindLabel="label" bindValue="value"
                            formControlName="ref_final_add_oi" placeholder="ADD" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="ref_final_alt_oi" placeholder="ALT">
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="ref_final_dp_oi" placeholder="DP">
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- AVSC - AVAE - OTROS -->
                <h6 class="mb-3 ms-3">üìê <strong>AVSC - AVAE - OTROS</strong></h6>
                <div class="table-responsive-custom">
                  <table class="table table-bordered">
                    <thead class="table-light">
                      <tr>
                        <th style="text-align: center;">Ojo</th>
                        <th style="text-align: center;">AVSC</th>
                        <th style="text-align: center;">AVAE</th>
                        <th style="text-align: center;">OTROS</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center align-middle">OD</td>
                        <td>
                          <ng-select [items]="opcionesRef['avsc']" bindLabel="label" bindValue="value"
                            formControlName="avsc_od" placeholder="AVSC" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avae']" bindLabel="label" bindValue="value"
                            formControlName="avae_od" placeholder="AVAE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="otros_od">
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center align-middle">OI</td>
                        <td>
                          <ng-select [items]="opcionesRef['avsc']" bindLabel="label" bindValue="value"
                            formControlName="avsc_oi" placeholder="AVSC" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <ng-select [items]="opcionesRef['avae']" bindLabel="label" bindValue="value"
                            formControlName="avae_oi" placeholder="AVAE" [searchable]="true" [appendTo]="'body'"
                            class="select-optometria">
                          </ng-select>
                        </td>
                        <td>
                          <input type="text" class="form-control" formControlName="otros_oi">
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <!-- Secci√≥n Diagn√≥stico y Tratamiento -->
                <div class="mb-5 shadow-sm">
                  <h6 class="text-primary mb-3" style="font-size: 20px;">üíä Diagn√≥stico y Tratamiento</h6>
                  <div>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">Diagn√≥stico</label>
                        <textarea class="form-control" rows="3" placeholder="Indique el diagn√≥stico encontrado.."
                          formControlName="diagnostico"></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Tratamiento</label>
                        <textarea class="form-control" placeholder="Indique el tratamiento.." rows="3"
                          formControlName="tratamiento"></textarea>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Secci√≥n Recomendaciones -->
                <div class="mb-5 shadow-sm">
                  <h6 class="text-primary mb-3 d-flex justify-content-between align-items-center"
                    style="font-size: 20px;">
                    üßë‚Äçüíº Recomendaciones
                    <button class="btn btn-sm btn-outline-primary" type="button" (click)="agregarRecomendacion()">
                      <i class="bi bi-plus-circle me-1"></i> A√±adir lente
                    </button>
                  </h6>

                  <div formArrayName="recomendaciones">
                    <div *ngFor="let grupo of recomendaciones.controls; let i = index" [formGroupName]="i"
                      class="border rounded p-3 mb-4">
                      <h6 class="text-secondary mb-3">Lente #{{ i + 1 }}</h6>
                      <div class="row g-3">

                        <!-- Tipo de cristal -->
                        <div class="col-md-4">
                          <label class="form-label">Tipo de cristal</label>
                          <ng-select [items]="tiposCristales" [searchable]="true" [appendTo]="'body'"
                            formControlName="cristal" placeholder="Seleccione el cristal...">
                          </ng-select>
                        </div>

                        <!-- Material -->
                        <div class="col-md-4">
                          <label class="form-label">Material</label>
                          <ng-select [items]="materiales" bindLabel="label" bindValue="value" formControlName="material"
                            [searchable]="true" placeholder="Seleccione un material..."
                            (change)="verificarMaterialOtro(i)">
                          </ng-select>
                        </div>

                        <!-- Campo para material personalizado -->
                        <div class="col-md-4" *ngIf="mostrarMaterialPersonalizado[i]">
                          <label class="form-label">Otro material</label>
                          <input type="text" class="form-control" [formControlName]="'materialPersonalizado'"
                            placeholder="Ingrese el material..." />
                        </div>


                        <!-- Montura -->
                        <div class="col-md-4">
                          <label class="form-label">Montura sugerida</label>
                          <input type="text" class="form-control" formControlName="montura"
                            placeholder="Ej: Rectangular met√°lica" />
                        </div>

                        <!-- Observaciones -->
                        <div class="col-md-8">
                          <label class="form-label">Observaciones</label>
                          <textarea class="form-control" rows="2" formControlName="observaciones"
                            placeholder="Notas espec√≠ficas para este lente"></textarea>
                        </div>

                        <!-- Bot√≥n eliminar -->
                        <div class="col-md-12 text-end">
                          <button class="btn btn-sm btn-outline-danger mt-2" type="button"
                            (click)="eliminarRecomendacion(i)" *ngIf="recomendaciones.length > 1">
                            <i class="bi bi-trash"></i> Quitar lente
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>


            </form>
          </div>
          <!-- Card Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="historiaForm.invalid">
              <i class="bi bi-save"></i> {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </div>
      </div>
    </div>